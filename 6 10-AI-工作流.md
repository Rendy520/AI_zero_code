---
created: 2025-12-29T15:54:45 (UTC +08:00)
tags: [,Java,Python,JavaScript,å‰ç«¯,Cè¯­è¨€,C++,Goè¯­è¨€,ç¨‹åºå‘˜,ç¼–ç¨‹å­¦ä¹ ,ITæ•™ç¨‹,è‡ªå­¦ç¼–ç¨‹,è½¯ä»¶å¼€å‘,é¡¹ç›®å®æˆ˜,ç¼–ç¨‹å¯¼èˆª,å¼€å‘è€…äº¤æµç¤¾åŒº,ç¼–ç¨‹èµ„æº,è®¡ç®—æœº]
source: https://www.codefather.cn/course/1948291549923344386/section/1955468615553167362
author: 
---

# 10 - AI å·¥ä½œæµ - ã€å¤§å‚å¿…å¤‡ã€‘LangChain4j +

> ## Excerpt
> æœ¬èŠ‚é‡ç‚¹ æœ¬èŠ‚æˆ‘ä»¬å°†ä¸º AI é›¶ä»£ç åº”ç”¨ç”Ÿæˆå¹³å°å¼•å…¥ä¸€ä¸ªå…¨æ–°çš„æŠ€æœ¯æ¶æ„ â€”â€” AI æ™ºèƒ½ä½“å·¥ä½œæµï¼Œé€šè¿‡ LangGraph4j æ¡†æ¶é‡æ„ä»£ç ç”Ÿæˆé€»è¾‘ï¼Œå¹¶è¡¥å……æœé›†å›¾ç‰‡ç´ æã€ä»£ç è´¨é‡æ£€æŸ¥ç­‰è¿‡ç¨‹ã€‚ç¼–ç¨‹å¯¼èˆªæ•™ç¨‹åˆ†äº«ï¼Œåšæ‚¨ç¼–ç¨‹å­¦ä¹ è·¯ä¸Šçš„å¯¼èˆªå‘˜ã€‚

---
## æœ¬èŠ‚é‡ç‚¹

æœ¬èŠ‚æˆ‘ä»¬å°†ä¸º AI é›¶ä»£ç åº”ç”¨ç”Ÿæˆå¹³å°å¼•å…¥ä¸€ä¸ªå…¨æ–°çš„æŠ€æœ¯æ¶â æ„ â€”â€” AI æ™ºèƒ½ä½“å·¥ä½œæµï¼Œé€šè¿‡ Lâ angGraph4j æ¡†æ¶é‡æ„ä»£ç ç”Ÿæˆé€»è¾‘ï¼Œå¹¶è¡¥å……æœé›†å›¾ç‰‡ç´ æã€ä»£ç è´¨é‡æ£€æŸ¥ç­‰è¿‡ç¨‹ï¼Œè®©ç”Ÿæˆçš„ç½‘ç«™æ›´çœŸå®å¯é ã€‚

æœ¬èŠ‚ä¸»è¦å†…å®¹å¦‚ä¸‹ï¼š

-   å·¥ä½œæµæ–¹æ¡ˆé€‰å‹
-   LangGraph4j å…¥é—¨
-   æ ¸å¿ƒå·¥ä½œæµå¼€å‘
-   LangGraph4j å·¥ä½œæµç‰¹æ€§å®æˆ˜

é±¼çš®å¯¹æœ¬èŠ‚æ•™ç¨‹ç²¾å¿ƒè®¾è®¡ï¼Œæƒ³è¦â å¿«é€Ÿå­¦ä¹  AI å·¥â ä½œæµæŠ€æœ¯çš„åŒå­¦ï¼Œå¯ä»¥å•ç‹¬å­¦ä¹ æœ¬ç« å†…å®¹ã€‚

## ä¸€ã€éœ€æ±‚åˆ†æ

ç›®å‰ç”Ÿæˆçš„ç½‘ç«™å†…çš„å›¾ç‰‡éƒ½æ˜¯éšâ æœºå ä½å›¾ç‰‡ï¼Œå®é™…ä¸Šâ å¯ä»¥æ ¹æ®ç½‘ç«™ç±»å‹è¡¥å……ç´ æå›¾ç‰‡ï¼Œè®©ç”Ÿæˆçš„ç½‘ç«™æ›´çœŸå®ã€‚

___

å¦‚æœæƒ³å¿«é€Ÿå®ç°è¿™ä¸ªéœ€æ±‚ï¼Œå…¶å®åªâ éœ€è¦æä¾›ç»™ AI å›¾â ç‰‡æœç´¢å·¥å…·å°±å¥½ï¼Œäº¤ç»™æ¡†æ¶å’Œ AI æ¥å†³å®šä»€ä¹ˆæ—¶å€™è°ƒç”¨å·¥å…·ï¼Œè‡ªåŠ¨æ‰§è¡Œã€‚

ä½†æ˜¯ï¼Œä¹‹å‰é±¼çš®ä¹Ÿæåˆ°äº†ï¼Œå¯¹äºå¯æ ‡å‡†åŒ–çš„å·¥ä½œæµç¨‹ï¼ˆæœé›†å›¾ç‰‡æ˜¯åœ¨ç”Ÿæˆç½‘ç«™å‰çš„å›ºå®šæ­¥éª¤ï¼‰ï¼Œ**èƒ½æ ‡å‡†åŒ–çš„å»ºè®®æ ‡å‡†åŒ–**ï¼Œä¸è¦äº¤ç»™ AI æ¥è‡ªä¸»åˆ¤æ–­ï¼Œè¿™æ ·å¯ä»¥å‡å°‘éšæœºæ€§å’Œè¯¯å·®ï¼Œè€Œä¸”è¿˜å¯ä»¥è‡ªä¸»å¯¹æµç¨‹è¿›è¡Œæ–°å¢ã€ç¼–æ’å’Œä¼˜åŒ–ã€‚

å› æ­¤ï¼Œæ¥ä¸‹æ¥é±¼çš®ä¼šå¸¦å¤§å®¶å­¦ä¹ â ä¸€å¥—æ–°çš„ç½‘ç«™ç”Ÿæˆæ–¹â æ¡ˆ â€”â€” åŸºäºå·¥ä½œæµæ¥å®ç°ã€‚

ğŸ’¡ æ³¨æ„ï¼Œè·Ÿä¹‹å‰å·²æœ‰çš„ 3â  ç§ç”Ÿæˆæ¨¡å¼ä¸åŒï¼Œâ æœ¬èŠ‚æˆ‘ä»¬ä¸æ˜¯åœ¨å¼€å‘ä¸€ç§æ–°çš„ç”Ÿæˆæ¨¡å¼ï¼Œè€Œæ˜¯ä¸€å¥—æ–°çš„ç³»ç»Ÿå®ç°æ–¹å¼ã€‚

åŸæœ¬æˆ‘ä»¬æ˜¯æŠŠå„ä¸ªæµç¨‹è‡ªå·±åˆ†æ•£åˆ°äº† Serviceâ  ç­‰ç±»çš„å„ä¸ªæ–¹æ³•ï¼Œæ¯”å¦‚è·å–ä»£ç ç”Ÿâ æˆç±»å‹ã€è°ƒç”¨ AI æµå¼è¾“å‡ºã€ä¿å­˜æ–‡ä»¶ã€æ‰“åŒ…æ„å»ºç­‰ã€‚è€Œç°åœ¨ï¼Œæˆ‘ä»¬éœ€è¦æŠŠè¿™ä¸€å¥—æµç¨‹ç”¨å·¥ä½œæµç»„åˆèµ·æ¥ã€‚

![](https://pic.code-nav.cn/course_picture/1608440217629360130/l1T0yRQlUs0ctxwW.webp "null")

å› æ­¤ï¼Œæœ¬èŠ‚æˆ‘ä»¬ä¸æ”¹å˜åŸæœ‰çš„ä»»ä½•ä¸šåŠ¡æµç¨‹ã€‚åªæ–°å¢â ä¸€ç§å®ç°ï¼Œé‡ç‚¹æ˜¯è®©å¤§å®¶å­¦ä¹ åˆ°å·¥â ä½œæµçš„æ€æƒ³å’Œå®ç°æ–¹å¼ã€‚è¿™æ ·ä¸€æ¥ï¼Œæœ¬èŠ‚å†…å®¹èƒ½å¤Ÿä½œä¸ºå¯é€‰é¡¹ç‹¬ç«‹å­¦ä¹ ï¼Œä¸å½±å“ä¹‹å‰å·²å®Œæˆçš„é¡¹ç›®ã€‚

## äºŒã€å·¥ä½œæµæ–¹æ¡ˆé€‰å‹

ä¸ºäº†å®ç° AI å·¥ä½œæµï¼Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘å¸‚é¢ä¸Šå¾ˆå¤šç°æˆçš„å¹³å°ï¼Œâ åƒ Difyã€Cozeã€é˜¿é‡Œäº‘ç™¾ç‚¼ï¼Œé€šâ è¿‡æ‹–æ‹½å¼çš„ç•Œé¢å°±èƒ½å¿«é€Ÿæ­å»ºå·¥ä½œæµï¼Œä¸Šæ‰‹ç®€å•ã€èƒ½å¤Ÿå¿«é€Ÿçœ‹åˆ°æ•ˆæœï¼Œéå¸¸é€‚åˆå¿«é€ŸéªŒè¯æƒ³æ³•æˆ–è€…è®©éæŠ€æœ¯äººå‘˜å‚ä¸æ„å»ºæµç¨‹ã€‚

![](https://pic.code-nav.cn/course_picture/1608440217629360130/QkvuabwkqsasZQF0.webp)

ä½†æ˜¯ï¼Œå½“æ¶‰åŠåˆ°å¤æ‚çš„ä¸šåŠ¡é€»è¾‘æ—¶ï¼Œâ€œâ ä½ä»£ç å¹³å°â€ å¯èƒ½æ— æ³•â æ»¡è¶³æˆ‘ä»¬çš„å®šåˆ¶åŒ–éœ€æ±‚ï¼Œå°¤å…¶æ˜¯å½“ç³»ç»Ÿéœ€è¦ä¸ç°æœ‰çš„ä¸šåŠ¡é€»è¾‘æ·±åº¦é›†æˆæ—¶ã€‚

ç›¸æ¯”ä¹‹ä¸‹ï¼ŒLangGraph4j è¿™æ ·çš„å·¥ä½œæµç¼–ç¨‹æ¡†æ¶è™½ç„¶éœ€è¦ä¸€å®šçš„å­¦ä¹ æˆæœ¬ï¼Œä½†å®ƒâ æä¾›äº†å®Œå…¨çš„æ§åˆ¶èƒ½åŠ›ã€‚å¯¹äºæˆ‘ä»¬è¿™ä¸ªé¡¹ç›®æ¥è¯´ï¼Œæ—¢è¦ä¸ç°æœ‰â çš„ Spring Boot ç³»ç»Ÿæ·±åº¦é›†æˆï¼Œåˆè¦å¤„ç†å›¾ç‰‡æ”¶é›†ã€AI ä»£ç ç”Ÿæˆã€è´¨é‡æ£€æŸ¥ç­‰å¤æ‚çš„ä¸šåŠ¡é€»è¾‘ï¼Œé€‰æ‹© LangGraph4j ä¼šæ›´åŠ åˆé€‚ã€‚

å½“ç„¶ï¼Œæ›´é‡è¦çš„æ˜¯ï¼ŒLangGraph4j ä½œä¸ºä¸€ä¸ªä¸“é—¨ä¸º Java ç”Ÿæ€è®¾è®¡çš„å·¥ä½œæµæ¡†æ¶ï¼Œ**å’Œ LangChain4j å…¼å®¹æ€§å¾ˆå¥½**ï¼Œèƒ½å¤Ÿæ— ç¼èå…¥æˆ‘ä»¬ç°æœ‰çš„æŠ€æœ¯æ ˆï¼Œå¯ä»¥ç›´æ¥å¤ç”¨é¡¹ç›®ä¸­å·²æœ‰çš„ Serviceã€é…ç½®å’Œå·¥å…·ç±»ï¼Œä¸éœ€è¦ä» 0 è¿›è¡Œå¼€å‘ã€‚åŒæ—¶ï¼Œå®ƒè¿˜æä¾›äº†ä¸°å¯Œçš„é«˜çº§ç‰¹æ€§ï¼Œæ¯”å¦‚æ¡ä»¶è¾¹ã€å¾ªç¯æ‰§è¡Œã€å¹¶å‘å¤„ç†ç­‰ï¼Œè®©æˆ‘ä»¬èƒ½å¤Ÿæ„å»ºå‡ºæ™ºèƒ½åŒ–çš„å·¥ä½œæµç¨‹ã€‚

ä»é•¿è¿œæ¥çœ‹ï¼Œé€‰æ‹©ç¼–ç¨‹æ¡†æ¶è€Œä¸æ˜¯åˆ«äººçš„ä½ä»£ç å·¥ä½œæµå¹³å°ï¼Œè¿˜æœ‰â ä¸€ä¸ªé‡è¦ä¼˜åŠ¿ï¼šå¯ç»´æŠ¤æ€§å’Œæ‰©å±•æ€§ã€‚éšç€ä¸šâ åŠ¡çš„å‘å±•ï¼Œæˆ‘ä»¬çš„å·¥ä½œæµå¯èƒ½ä¼šå˜å¾—è¶Šæ¥è¶Šå¤æ‚ï¼Œç¼–ç¨‹æ¡†æ¶èƒ½å¤Ÿæ›´å¥½åœ°æ”¯æŒè¿™ç§è¿­ä»£ï¼Œè€Œä¸ä¼šåƒä½ä»£ç å¹³å°é‚£æ ·é‡åˆ°å¤©èŠ±æ¿ã€‚

## ä¸‰ã€LangGraph4j å…¥é—¨

[LangGraph4j](https://langgraph4j.github.io/langgraph4j/) æ˜¯ä¸€ä¸ª Java å®ç°çš„å¼€æº AI å·¥ä½œæµæ¡†æ¶ï¼Œå®ƒå—åˆ°äº† Python ç‰ˆæœ¬ LangGraph çš„å¯å‘ï¼Œèƒ½å¤Ÿä¸ Langchain4j å’Œ Spring AI æ— ç¼é›†æˆï¼Œè€Œä¸”è¿™ä¸ªæ¡†æ¶è¿˜æ˜¯ [å¼€æº](https://github.com/langgraph4j/langgraph4j) çš„ã€‚

![](https://pic.code-nav.cn/course_picture/1608440217629360130/SsPHNdXHTQcu5Zl3.webp)

ç¾ä¸­ä¸è¶³çš„æ˜¯ï¼Œç›®å‰è¿™ä¸ªæ¡†æ¶è¿˜å¤„äº â€œä¸æˆç†ŸæœŸâ€â ï¼Œè™½ç„¶å·²ç»èƒ½å¤Ÿæ»¡è¶³å¤§å¤šæ•°å·¥ä½œæµâ å¼€å‘çš„éœ€æ±‚äº†ï¼Œä½†æ˜¯åŠŸèƒ½ä¸Šè¿˜ä¸å¤Ÿå®Œå–„ï¼Œæ–‡æ¡£å†™çš„ä¹Ÿæœ‰ç‚¹æ•·è¡äº†ï¼Œå¯èƒ½è¿˜æœ‰ä¸€äº›å‡ºå…¶ä¸æ„çš„å° Bugã€‚

ä¸è¿‡å¥½åœ¨é±¼çš®å¸®å¤§å®¶è¸©äº†ä¸€éå‘ï¼Œæˆ‘çš„å»ºè®®æ˜¯å¤§å®¶ **ä¸¥æ ¼éµå¾ªæœ¬æ•™ç¨‹ä¸­çš„ç‰ˆæœ¬å·**ï¼Œæ”¶èµ·ä½ é‚£å¥½å¥‡å¿ƒï¼Œ**ä¸è¦ç”¨å’Œé±¼çš®ä¸ä¸€è‡´çš„ç‰ˆæœ¬ã€ä¹Ÿå…ˆä¸è¦è‡ªå·±æ¢ç´¢**ï¼ŒæŠŠå·¥ä½œæµçš„å¼€å‘æ€è·¯å­¦ä¼šå°±è¶³å¤Ÿäº†ã€‚åé¢æ¡†æ¶è‚¯å®šä¼šæŒç»­æ›´æ–°çš„ï¼Œä½ çš„èƒ½åŠ›ä¸Šæ¥åå¯¹ç€å®˜æ–¹æ–‡æ¡£å»äº†è§£æ–°çš„å˜åŠ¨å°±å¥½ã€‚

æ ¹æ® [å®˜æ–¹ç‰¹æ€§æ–‡æ¡£](https://langgraph4j.github.io/langgraph4j/features/)ï¼ŒLangGraph4j æä¾›äº†ä»¥ä¸‹æ ¸å¿ƒèƒ½åŠ›ï¼Œæˆ‘ä»¬ä¾æ¬¡æ¥å­¦ä¹ ã€‚

### æ ¸å¿ƒç‰¹æ€§

#### StateGraph å·¥ä½œæµå›¾

åœ¨ LangGraph4j â ä¸­ï¼ŒStateGrâ aph æ˜¯ä¸»è¦ä½¿ç”¨çš„æ ¸å¿ƒç±»ï¼Œç”¨äºå®šä¹‰åº”ç”¨ç¨‹åºçš„ç»“æ„ã€‚

å®ƒå°†å¤æ‚çš„ AI å·¥ä½œæµæŠ½è±¡ä¸ºä¸€ä¸ª **æœ‰å‘å›¾** çš„æ¦‚å¿µã€‚æ¯ä¸ª **èŠ‚ç‚¹** ä»£è¡¨ä¸€ä¸ªå…·ä½“çš„æ“ä½œå•å…ƒï¼Œæ¯”å¦‚è°ƒç”¨ LLM ç”Ÿæˆæ–‡æœ¬ã€æœç´¢å¤–éƒ¨æ•°æ®ã€å¤„ç†ç”¨æˆ·è¾“å…¥ç­‰ã€‚èŠ‚ç‚¹ä¹‹é—´é€šè¿‡ **è¾¹** æ¥è¿æ¥ï¼Œå¤šä¸ªèŠ‚ç‚¹ä¹‹é—´é€šè¿‡ **çŠ¶æ€** æ¥å…±äº«æ•°æ®ï¼Œå½¢æˆäº†ä¸€ä¸ªå®Œæ•´çš„å¤„ç†æµç¨‹ã€‚

å’Œä¼ ç»Ÿçš„æœ‰å‘æ— ç¯å›¾ï¼ˆDAGï¼‰ä¸åŒï¼ŒLangGraâ ph4j æ”¯æŒå¾ªç¯ï¼Œæ¯”å¦‚ä¸€ä¸ªæ™ºèƒ½â ä½“å¯èƒ½éœ€è¦æ ¹æ®ç»“æœå›åˆ°ä¹‹å‰çš„æ­¥éª¤è¿›è¡Œé‡è¯•ï¼Œæˆ–è€…éœ€è¦åœ¨æŸä¸ªæ¡ä»¶æ»¡è¶³ä¹‹å‰æŒç»­å¾ªç¯æ‰§è¡ŒæŸä¸ªé€»è¾‘ã€‚

æ³¨æ„ï¼Œä½¿ç”¨å›¾ä¹‹å‰å¿…é¡»ç¼–è¯‘ï¼Œç¼–è¯‘è¿‡ç¨‹ä¸ä»…ä¼šè¿›è¡ŒåŸºç¡€çš„ç»“æ„æ£€æŸ¥ï¼ˆæ¯”å¦‚æ£€æŸ¥æ˜¯å¦æœ‰å­¤ç«‹çš„èŠ‚ç‚¹ï¼‰ï¼Œè¿˜ä¼šå®šä¹‰è¿è¡Œæ—¶å‚æ•°ï¼Œåˆ›å»ºä¸€ä¸ªä¸å¯å˜çš„ã€å¯è¿è¡Œçš„å›¾ `CompiledGraph<S extends AgentState>`ã€‚

#### AgentState çŠ¶æ€

AgentState æ˜¯æ•´ä¸ªå·¥ä½œæµçš„çŠ¶æ€è½½ä½“ï¼Œå®ƒæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª `Map`ï¼Œåœ¨ä¸åŒèŠ‚ç‚¹ä¹‹é—´ä¼ é€’ã€‚**æ¯ä¸ªèŠ‚ç‚¹éƒ½å¯ä»¥ä»è¿™ä¸ªçŠ¶æ€ä¸­è¯»å–æ•°æ®ï¼Œå¹¶è¿”å›å¯¹çŠ¶æ€çš„æ›´æ–°ã€‚**

æœ‰ä¸€äº›å’ŒçŠ¶æ€æœ‰å…³çš„æ¦‚å¿µï¼Œä»…åšäº†è§£å³å¯ï¼š

1ï¼‰Schemaï¼šçŠ¶æ€çš„ç»“æ„é€šè¿‡ Schema æ¥å®šä¹‰ï¼Œè¿™æ˜¯ä¸€ä¸ª `Map<String, Channel.Reducer>` çš„æ˜ å°„ã€‚Schema ä¸­çš„æ¯ä¸ªé”®å¯¹åº”çŠ¶æ€ä¸­çš„ä¸€ä¸ªå±æ€§ï¼Œè€Œå€¼åˆ™æ˜¯ä¸€ä¸ª Channel.Reducerï¼Œç”¨äºå®šä¹‰å¦‚ä½•å¤„ç†å¯¹è¯¥å±æ€§çš„æ›´æ–°ã€‚ï¼ˆç†è§£æˆæ•°æ®åº“çš„è¡¨ç»“æ„å°±å¥½ï¼‰

2ï¼‰Channel.Reducer æ˜¯çŠ¶æ€æ›´æ–°çš„æ ¸å¿ƒæœºåˆ¶ï¼Œå®ƒå®šä¹‰äº†å¦‚ä½•å°†æ–°å€¼ä¸ç°æœ‰å€¼è¿›è¡Œåˆå¹¶ã€‚æ¯”å¦‚ï¼Œä¸€ä¸ªæ–°å€¼å¯èƒ½ä¼šè¦†ç›–æ—§å€¼ï¼Œæˆ–è€…å¯èƒ½ä¼šè¢«æ·»åŠ åˆ°ç°æœ‰å€¼çš„åˆ—è¡¨ä¸­ã€‚

LangGraph4j æä¾›â äº†å‡ ç§å†…ç½®çš„ Reâ ducer ç±»å‹ï¼š

-   Channel.Default ä¸ºçŠ¶æ€å±æ€§æä¾›é»˜è®¤å€¼
-   Channel.Appender ä¼šå°†æ–°å€¼è¿½åŠ åˆ°ä¸çŠ¶æ€å±æ€§å…³è”çš„åˆ—è¡¨ä¸­ï¼Œè¿™å¯¹äºç´¯ç§¯æ¶ˆæ¯ã€å·¥å…·è°ƒç”¨æˆ–å…¶ä»–æ•°æ®åºåˆ—ç‰¹åˆ«æœ‰ç”¨
-   MessageChannel.Appender ä¸“ä¸ºèŠå¤©æ¶ˆæ¯è®¾è®¡ï¼Œä¸ä»…å¯ä»¥å¤„ç†æ¶ˆæ¯è¿½åŠ ï¼Œè¿˜å¯ä»¥é€šè¿‡ ID å¤„ç†æ¶ˆæ¯åˆ é™¤ã€‚

ä½ å¯ä»¥æ ¹æ®å…·ä½“çš„ä¸šåŠ¡éœ€æ±‚æ¥å®šâ ä¹‰ä¸åŒçš„ Reduâ cer ç­–ç•¥ï¼Œç¡®ä¿çŠ¶æ€åœ¨æ•´ä¸ªå·¥ä½œæµä¸­æ­£ç¡®åœ°æµè½¬å’Œæ›´æ–°ã€‚

ğŸ’¡ ä½†å®é™…åº”ç”¨ä¸­ï¼Œå¦‚æœä¸éœ€è¦åˆ©ç”¨ LangGraph4j çš„æŒä¹…åŒ–æœºåˆ¶ï¼Œå°±ä¸â æ˜¯å¾ˆå»ºè®®å¤§å®¶ç”¨å†…ç½®çš„ Schema å’Œ Reduceâ r æ¥ç»´æŠ¤çŠ¶æ€äº†ã€‚ä¸å¦‚è‡ªå·±å®šä¹‰ä¸€ä¸ª Context ä¸Šä¸‹æ–‡ç±»æ¥ç®¡ç†çŠ¶æ€ï¼Œæƒ³æ€ä¹ˆæ“ä½œçŠ¶æ€å°±æ€ä¹ˆæ“ä½œï¼Œä¸ç”¨ç†è§£ LangGraph4j è‡ªå·±çš„ä¸€å¥—è¯­æ³•ã€‚

#### Nodes å·¥ä½œèŠ‚ç‚¹

èŠ‚ç‚¹æ˜¯å›¾çš„æ„å»ºå—ï¼Œ**è´Ÿè´£æ‰§è¡Œå…·ä½“çš„æ“ä½œ**ã€‚

ä¸€ä¸ªèŠ‚ç‚¹é€šå¸¸æ˜¯ä¸€ä¸ªå‡½æ•°æˆ–ä¸€ä¸ªå®ç°äº† `NodeAction<S>` æˆ– `AsyncNodeAction<S>` æ¥å£çš„ç±»ï¼Œå¯ä»¥åœ¨å…¶ä¸­ç¼–å†™å…·ä½“çš„æ“ä½œä»£ç ã€‚

èŠ‚ç‚¹çš„å·¥ä½œæµç¨‹å¾ˆæ¸…æ™°ï¼šé¦–å…ˆæ¥æ”¶å½“å‰çš„ AgentState çŠ¶æ€ä½œä¸ºè¾“å…¥ï¼Œç„¶åæ‰§è¡ŒæŸäº›è®¡ç®—ï¼ˆæ¯”å¦‚è°ƒç”¨ LLMã€æ‰§è¡Œå·¥å…·ã€è¿è¡Œè‡ªå®šä¹‰ä¸šåŠ¡é€»è¾‘ï¼‰ï¼Œæœ€åè¿”å›ä¸€ä¸ª `Map<String, Object>`ï¼Œè¡¨ç¤ºå¯¹çŠ¶æ€çš„æ›´æ–°ã€‚è¿™äº›æ›´æ–°ä¼šæ ¹æ® Schema ä¸­å®šä¹‰çš„ Reducer åº”ç”¨åˆ° AgentState ä¸­ã€‚

èŠ‚ç‚¹å¯ä»¥æ˜¯åŒæ­¥çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯å¼‚â æ­¥çš„ï¼Œç”šè‡³å¯ä»¥å¤šä¸ªâ èŠ‚ç‚¹åŒæ—¶æ‰§è¡Œã€‚

LangGraph4j è¿˜å®šä¹‰äº†ä¸¤ä¸ªâ ç‰¹æ®Šçš„èŠ‚ç‚¹ï¼šSTART â å’Œ ENDã€‚START èŠ‚ç‚¹è¡¨ç¤ºå›¾çš„å…¥å£ç‚¹ï¼ŒEND èŠ‚ç‚¹è¡¨ç¤ºæ‰§è¡Œè·¯å¾„çš„ç»“æŸç‚¹ã€‚

```java
import static org.bsc.langgraph4j.StateGraph.START;
import static org.bsc.langgraph4j.StateGraph.END;

graph.addEdge(START, "nodeA");
graph.addEdge("nodeA", END);
```

è¿™ä¹Ÿæ˜¯å·¥ä½œæµçš„ç»å…¸è®¾è®¡äº†ï¼Œè®©â å·¥ä½œæµçš„èµ·å§‹å’Œç»“æŸâ å˜å¾—æ˜ç¡®å¯æ§ã€‚

#### Edges è¾¹

è¾¹å®šä¹‰äº†èŠ‚ç‚¹ä¹‹é—´çš„æ§åˆ¶æµï¼Œå†³â å®šäº†å·¥ä½œæµçš„æ‰§è¡Œâ è·¯å¾„ã€‚æ­£å¦‚å®˜æ–¹æ–‡æ¡£æ‰€è¯´ï¼šâ€œèŠ‚ç‚¹è´Ÿè´£å¹²æ´»ï¼Œè¾¹è´Ÿè´£å†³å®šä¸‹ä¸€æ­¥â€ã€‚

LangGraph4j æ”¯æŒå‡ ç§ä¸åŒç±»å‹çš„è¾¹ï¼š

-   æ™®é€šè¾¹ï¼šæœ€ç®€å•çš„è¾¹ç±»å‹ï¼Œæä¾›ä»ä¸€ä¸ªèŠ‚ç‚¹åˆ°å¦ä¸€ä¸ªèŠ‚ç‚¹çš„æ— æ¡ä»¶è½¬æ¢ã€‚å¯ä»¥é€šè¿‡ `addEdge(sourceNodeName, destinationNodeName)` æ¥å®šä¹‰æ™®é€šè¾¹ã€‚
-   æ¡ä»¶è¾¹ï¼šä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ˜¯æ ¹æ®å½“å‰ AgentState åŠ¨æ€ç¡®å®šçš„ï¼Œæ›´åŠ çµæ´»ã€‚å½“æºèŠ‚ç‚¹å®Œæˆåï¼Œä¼šæ‰§è¡Œä¸€ä¸ªåˆ¤æ–­å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æ¥æ”¶å½“å‰çŠ¶æ€å¹¶è¿”å›ä¸‹ä¸€ä¸ªè¦æ‰§è¡Œçš„èŠ‚ç‚¹åç§°ã€‚ç›¸å½“äºå®ç°äº† if else åˆ†æ”¯é€»è¾‘ã€‚æ¯”å¦‚æ™ºèƒ½ä½“å†³å®šä½¿ç”¨å·¥å…·ï¼Œå°±è·³è½¬åˆ° â€œæ‰§è¡Œå·¥å…·â€ èŠ‚ç‚¹ï¼Œå¦åˆ™è·³è½¬åˆ° â€œå›å¤ç”¨æˆ·â€ èŠ‚ç‚¹ã€‚
-   å…¥å£ç‚¹ï¼šå¯ä»¥å®šä¹‰å½“ç”¨æˆ·è¾“å…¥åˆ°è¾¾æ—¶é¦–å…ˆè°ƒç”¨å“ªä¸ªèŠ‚ç‚¹ï¼ŒåŒæ ·æ”¯æŒæ¡ä»¶å…¥å£ç‚¹ã€‚

é€šè¿‡æ™®é€šè¾¹å’Œæ¡ä»¶è¾¹ï¼Œå°±èƒ½ç»„åˆâ å‡ºå„ç§å·¥ä½œæµå›¾ï¼Œè€Œâ å…¥å£ç‚¹ä¸€èˆ¬æ²¡å¿…è¦ä½¿ç”¨ã€‚

#### Checkpoints æ£€æŸ¥ç‚¹

æ£€æŸ¥ç‚¹å…è®¸ä½ ä¿å­˜å›¾åœ¨ä»»ä½•æ­¥éª¤â çš„çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯çŠ¶æ€â çš„æŒä¹…åŒ–ï¼Œæœ‰åˆ©äºè°ƒè¯•å’Œæ¢å¤å¤æ‚çš„å·¥ä½œæµã€‚

æ£€æŸ¥ç‚¹çš„æ ¸å¿ƒä½œç”¨ä¸»è¦ä½“ç°åœ¨ä¸¤ä¸ªæ–¹é¢ï¼š

1ï¼‰æ”¯æŒäººç±»æ£€æŸ¥ã€ä¸­æ–­å’Œæ‰¹å‡†å·¥ä½œæ­¥éª¤ã€‚åœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œäººç±»å¿…é¡»èƒ½å¤Ÿåœ¨ä»»ä½•æ—¶é—´ç‚¹æŸ¥çœ‹å›¾â çš„çŠ¶æ€ï¼Œå¹¶ä¸”å›¾å¿…é¡»èƒ½å¤Ÿåœ¨äººç±»å¯¹çŠ¶æ€è¿›è¡Œä»»ä½•æ›´æ–°åæ¢å¤â æ‰§è¡Œã€‚è¿™ç§ â€œäººåœ¨ç¯è·¯â€ï¼ˆhuman-in-the-loopï¼‰çš„è®¾è®¡åœ¨è®¸å¤šå®é™…åº”ç”¨ä¸­éƒ½æ˜¯å¿…éœ€çš„ï¼Œæ¯”å¦‚ Cursor åœ¨ä½¿ç”¨æ–‡ä»¶åˆ é™¤å·¥å…·æ—¶ä¼šæ‰¾ç”¨æˆ·ç¡®è®¤ã€‚

2ï¼‰å…è®¸é€šè¿‡çº¿ç¨‹éš”ç¦»ä¸åŒç”¨æˆ·çš„äº¤äº’ï¼Œå¹¶ä¸”ç›¸åŒç”¨æˆ·å¯ä»¥æ¢å¤ä¹‹å‰çš„è®°å¿†ã€‚è¿™å¯¹â äºæ„å»ºå¤šç”¨æˆ·çš„ AI åº”ç”¨æ¥è¯´ç‰¹åˆ«é‡è¦ï¼Œæ¯ä¸ªç”¨æˆ·â éƒ½å¯ä»¥æœ‰è‡ªå·±ç‹¬ç«‹çš„æ‰§è¡Œå†å²ã€‚è·Ÿæˆ‘ä»¬ä¹‹å‰å­¦ä¹ çš„ Chat Memory å¯¹è¯è®°å¿†ç±»ä¼¼ï¼Œç»™å·¥ä½œæµä¼ å…¥ä¸åŒçš„ thread\_id é…ç½®å³å¯ï¼š

```java
var config = RunnableConfig.builder()
                  .threadId("a")
                  .build();
graph.invoke(inputs, config);
```

LangGraph4j é»˜è®¤æä¾›äº†åŸºäºå†…å­˜çš„æ£€æŸ¥ç‚¹å™¨ï¼š

```java
var saver = new MemorySaver();
```

åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œè¦æ ¹æ®å…·ä½“éœ€æ±‚æ¥é€‰æ‹©åˆé€‚çš„æŒä¹…åŒ–æ–¹æ¡ˆã€‚å†…å­˜æ£€æŸ¥ç‚¹å™¨é€‚åˆå¼€å‘å’Œæµ‹è¯•ï¼Œä½†å¯¹äºç”Ÿäº§ç¯å¢ƒï¼Œéœ€è¦è€ƒè™‘æ›´æŒä¹…çš„å­˜å‚¨æ–¹æ¡ˆï¼Œæ¯”å¦‚ [ä¿å­˜åˆ° Postgre SQL](https://langgraph4j.github.io/langgraph4j/core/checkpoint-postgres/)ã€‚

### Demo

äº†è§£æ ¸å¿ƒç‰¹æ€§åï¼Œæˆ‘ä»¬ [å‚è€ƒå®˜æ–¹æ–‡æ¡£](https://langgraph4j.github.io/langgraph4j/getting-started/#your-first-graph-a-simple-example) æ¥è¿è¡Œä¸€ä¸ªå·¥ä½œæµ Demo â€”â€” `SimpleGraphApp`ï¼ŒæŠŠæ‰€æœ‰ä»£ç éƒ½æ”¾åˆ° `langgraph4j.demo` åŒ…ä¸‹ã€‚

![](https://pic.code-nav.cn/course_picture/1608440217629360130/aQJBBQIWajD8aNKn.webp)

æ³¨æ„ï¼Œä½¿ç”¨ä»¥ä¸‹ç‰ˆæœ¬çš„ä¾èµ–ï¼š

```xml
<!-- LangGraph4j -->
<dependency>
    <groupId>org.bsc.langgraph4j</groupId>
    <artifactId>langgraph4j-core</artifactId>
    <version>1.6.0-rc2</version>
</dependency>
```

### é«˜çº§ç‰¹æ€§

ä¸‹é¢å†åˆ†äº«ä¸€äº› LangGrâ aph4j çš„é«˜çº§â ç‰¹æ€§ï¼Œå…ˆä»…åšäº†è§£å³å¯ï¼Œå¾ˆå¤šç‰¹æ€§æˆ‘ä»¬éƒ½ä¼šåœ¨æœ¬é¡¹ç›®ä¸­å®æˆ˜ã€‚

#### Streaming å¼‚æ­¥å’Œæµå¼å¤„ç†

é¦–å…ˆï¼Œé€šè¿‡ CompletableFutureï¼ŒLaâ ngGraph4j å…è®¸éé˜»å¡çš„å¼‚æ­¥â æ“ä½œã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æŸä¸ªèŠ‚ç‚¹åœ¨ç­‰å¾… LLM å“åº”æ—¶ï¼Œæ•´ä¸ªåº”ç”¨ä¸ä¼šè¢«é˜»å¡ï¼Œå¯ä»¥ç»§ç»­å¤„ç†å…¶ä»–ä»»åŠ¡ã€‚

æ ¹æ® [æµå¼å¤„ç†æ–‡æ¡£](https://langgraph4j.github.io/langgraph4j/core/streaming/)ï¼ŒLangGraph4j æ”¯æŒé€šè¿‡ Java å¼‚æ­¥ç”Ÿæˆå™¨æ¥å¤„ç†æ¥è‡ª LLM å’Œå…¶ä»–æºçš„æµå¼å“åº”ï¼Œå¯ä»¥å®ç° SSE æµå¼è¾“å‡ºï¼Œæå‡ç”¨æˆ·ä½“éªŒã€‚

æ­¤å¤–ï¼Œæµå¼å¤„ç†ä¸ä»…æ”¯æŒä¸»æµçš„è¾“å‡ºï¼Œè¿˜èƒ½å¤„ç†â å­æµï¼Œå¹¶ä¸”åœ¨æ‰€æœ‰æµè¾“å‡ºå®Œæˆåâ è·å–åˆ°æœ€ç»ˆç»“æœã€‚è·Ÿä¹‹å‰ LangChain4j çš„ TokenStream ç±»ä¼¼ã€‚

#### å¯è§†åŒ–

LangGraph4j é€šè¿‡ `graph.getGraph` æ–¹æ³•æä¾›äº†å¤šç§å†…ç½®çš„å·¥ä½œæµå¯è§†åŒ–æ–¹å¼ã€‚å¯ä»¥é€‰æ‹©ä½¿ç”¨ [PlantUML](https://plantuml.com/) æˆ–è€… [Mermaid](https://mermaid.js.org/) æ–‡æœ¬ç»˜å›¾è¯­æ³•æ¥ç”Ÿæˆå·¥ä½œæµçš„ç»“æ„å›¾ï¼Œå¸®åŠ©æˆ‘ä»¬ç†è§£å¤æ‚å·¥ä½œæµçš„ç»“æ„ã€‚

å°±åƒè¿™æ ·ï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/cGIKThxXX5x372i3.webp)

#### Parallel Branch å¹¶å‘

LangGraph4j æä¾›äº† [å¹¶å‘ç‰¹æ€§](https://langgraph4j.github.io/langgraph4j/core/parallel-branch/)ï¼Œèƒ½å¤ŸåŒæ—¶æ‰§è¡Œå¤šä¸ªå·¥ä½œèŠ‚ç‚¹æˆ–åˆ†æ”¯ï¼Œä»è€Œæå‡æ•´ä½“æ€§èƒ½ã€‚

![](https://pic.code-nav.cn/course_picture/1608440217629360130/8r27gkXstNw3nluZ.png)

ä½†æ˜¯ç›®å‰å¹¶å‘å¤„ç†å­˜åœ¨ä¸€äº›é™åˆ¶â ï¼Œæ¯”å¦‚ä¸æ”¯æŒæ¡ä»¶è¾¹â ã€å¹¶ä¸”å¹¶å‘æ‰§è¡Œçš„åˆ†æ”¯ä¸­åªèƒ½æœ‰ä¸€ä¸ªå·¥ä½œèŠ‚ç‚¹ã€‚

![](https://pic.code-nav.cn/course_picture/1608440217629360130/NcShyrThIeq6vuyM.webp)

å¯¹äºå¤æ‚çš„å¹¶å‘åœºæ™¯ï¼Œå¯ä»¥é€šè¿‡å­å›¾ç‰¹æ€§æ¥è§£å†³è¿™äº›é™åˆ¶ã€‚

#### Subgraphs å­å›¾

å¦‚æœä¸€ä¸ªå·¥ä½œæµå›¾ç‰¹åˆ«å¤æ‚ï¼Œæˆ–è€…å…¶ä¸­çš„ä¸€äº›æµç¨‹éœ€è¦å¤ç”¨ï¼Œå°±å¯ä»¥è€ƒè™‘ [å­å›¾åŠŸèƒ½](https://langgraph4j.github.io/langgraph4j/core/subgraph/)ã€‚ç›¸å½“äºæŠŠä¸€ä¸ªå·¥ä½œæµæ‹†åˆ†æˆå¤šä¸ªå­æ¨¡å—ï¼Œè€Œä¸”å¤šä¸ªå­å›¾å¯ä»¥åŒæ—¶å¹¶å‘æ‰§è¡Œã€‚

![](https://pic.code-nav.cn/course_picture/1608440217629360130/0Yw25cCuH3aEmiML.webp)

æœ‰ 3 ç§ä¸åŒçš„ä½¿ç”¨æ–¹å¼ï¼Œé€‚åˆä¸åŒçš„åœºæ™¯ã€‚

1ï¼‰ç›´æ¥æ·»åŠ ï¼šè¿™ç§æ–¹å¼ä¼šå°†å­å›¾å®Œå…¨â åˆå¹¶åˆ°çˆ¶å›¾ä¸­ï¼Œæ— ç¼â é›†æˆã€‚åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œçˆ¶å›¾å’Œå­å›¾å…±äº«æ‰€æœ‰çŠ¶æ€ï¼Œå­å›¾å°±åƒæ˜¯çˆ¶å›¾çš„ä¸€ä¸ªæ‰©å±•éƒ¨åˆ†ã€‚

```java
stateGraph.addNode("subgraph", workflowChild)
```

2ï¼‰ç¼–è¯‘æ·»åŠ ï¼šè¿™ç§æ–¹å¼è®©å­å›¾å’Œâ çˆ¶å›¾ä¿æŒä¸€å®šçš„ç‹¬ç«‹æ€§â ï¼Œåªå…±äº«éƒ¨åˆ†çŠ¶æ€ã€‚é€‚åˆéœ€è¦ä¸€å®šç‹¬ç«‹æ€§ä½†åˆéœ€è¦ä¸ä¸»æµç¨‹äº¤äº’çš„åœºæ™¯ã€‚

```java
stateGraph.addNode("subgraph", workflowChild.compile())
```

3ï¼‰æ“ä½œèŠ‚ç‚¹ï¼šå¯ä»¥è‡ªå·±å®šä¹‰å­å›¾â å’Œçˆ¶å›¾ä¹‹é—´çš„äº¤äº’é€»è¾‘â ï¼ŒåŒ…æ‹¬çŠ¶æ€çš„è½¬æ¢ã€æ•°æ®çš„ä¼ é€’ç­‰ï¼Œæœ€çµæ´»ã€‚é€‚åˆéœ€è¦å¤æ‚äº¤äº’é€»è¾‘çš„åœºæ™¯ã€‚

```java
StateGraph.addNode( "subgraph",  state -> {
    var input =  Map.<String,Object>of( "subgraphKey", state.lastMessage().orElseThrow() );
    return compiledWorkflowChild.stream( input )
        .forEachAsync( System.out::println )
        .thenApply( ( res ) -> state.data() );
    });
```

å­å›¾åŠŸèƒ½ä¸ä»…æ”¯æŒå¯è§†åŒ–ï¼ˆå¯ä»¥åœ¨â å›¾è¡¨ä¸­çœ‹åˆ°å­å›¾çš„ç»“æ„â ï¼‰ï¼Œè¿˜æ”¯æŒæµå¼å¤„ç†ã€‚ä¸è¿‡åœ¨æ“ä½œèŠ‚ç‚¹æ–¹å¼ä¸‹ï¼Œä½ éœ€è¦è‡ªå·±å¤„ç†æµçš„ä¼ é€’ã€‚

#### Breakpoints æ–­ç‚¹

æœ‰æ—¶æˆ‘ä»¬éœ€è¦åœ¨æŸä¸ªå…³é”®èŠ‚ç‚¹æš‚åœæ‰§è¡Œï¼Œç­‰å¾…äººå·¥å®¡æ ¸æˆ–ç¡®è®¤ï¼ŒLangGraph4j çš„ [æ–­ç‚¹åŠŸèƒ½](https://langgraph4j.github.io/langgraph4j/core/low_level/#breakpoints) æ­£æ˜¯ä¸ºè¿™ç§åœºæ™¯è®¾è®¡çš„ã€‚

æ–­ç‚¹å¯ä»¥åœ¨ç¼–è¯‘æ—¶é™æ€æŒ‡å®šï¼Œä¹Ÿå¯ä»¥é€šè¿‡è®©èŠ‚â ç‚¹æ“ä½œå®ç°ç‰¹å®šæ¥å£æ¥åœ¨è¿è¡Œâ æ—¶åŠ¨æ€è®¾ç½®ã€‚å½“å›¾æ‰§è¡Œåˆ°è®¾ç½®äº†æ–­ç‚¹çš„èŠ‚ç‚¹æ—¶ï¼Œå®ƒä¼šè‡ªåŠ¨æš‚åœï¼Œç­‰å¾…å¤–éƒ¨ä¿¡å·æ‰ä¼šç»§ç»­æ‰§è¡Œã€‚

```java
// é™æ€æŒ‡å®š
var compileConfig = CompileConfig.builder()
                        .checkpointSaver(saver)
                        .interruptBefore( "tools")
                        .build();

// åŠ¨æ€è®¾ç½®
public interface InterruptableAction<State extends AgentState> {
   Optional<InterruptionMetadata<State>> interrupt(String nodeId, State state);
}
```

è¿™ä¸ªç‰¹æ€§åœ¨å®ç° â€œäººåœ¨ç¯è·¯â€ çš„ AI ç³»ç»Ÿæ—¶â ç‰¹åˆ«æœ‰ç”¨ã€‚æ¯”å¦‚åœ¨ä»£ç ç”Ÿæˆç³»ç»Ÿä¸­â ï¼Œå¯èƒ½å¸Œæœ›åœ¨ç”Ÿæˆä»£ç åæš‚åœæ‰§è¡Œï¼Œè®©äººå·¥å®¡æ ¸ä»£ç è´¨é‡ï¼Œç¡®è®¤æ— è¯¯åå†ç»§ç»­åç»­çš„æ„å»ºå’Œéƒ¨ç½²æµç¨‹ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ**ä½¿ç”¨æ–­ç‚¹åŠŸèƒ½æ—¶å¿…é¡»é…åˆæ£€æŸ¥ç‚¹å™¨ä½¿ç”¨**ã€‚å› ä¸ºå›¾éœ€è¦èƒ½å¤Ÿä¿å­˜å½“å‰çŠ¶æ€å¹¶åœ¨ç¨åæ¢å¤æ‰§è¡Œã€‚è¦æ¢å¤æ‰§è¡Œï¼Œåªéœ€è¦è°ƒç”¨ `GraphInput.resume()` å³å¯ã€‚

### å·¥å…·

#### Studio å¼€å‘ç¯å¢ƒ

[Studio](https://langgraph4j.github.io/langgraph4j/studio/) æ˜¯ LangGraph4j æä¾›çš„å¼€å‘ç¯å¢ƒï¼Œå®ƒæ˜¯ä¸€ä¸ª Web ç•Œé¢ï¼Œå¯ä»¥å¯¹ Langgraph4j å·¥ä½œæµè¿›è¡Œå¯è§†åŒ–äº¤äº’å’Œè°ƒè¯•ã€‚

é€šè¿‡ Studioï¼Œä½ å¯ä»¥å®æ—¶è§‚å¯Ÿå·¥â ä½œæµçš„æ‰§è¡ŒçŠ¶æ€ï¼ŒæŸ¥çœ‹æ¯ä¸ªâ èŠ‚ç‚¹çš„è¾“å…¥è¾“å‡ºï¼Œç†è§£çŠ¶æ€åœ¨ä¸åŒèŠ‚ç‚¹ä¹‹é—´çš„æµè½¬è¿‡ç¨‹ï¼Œæœ‰åŠ©äºå¤æ‚å·¥ä½œæµçš„å¼€å‘è°ƒè¯•ã€‚

![](https://pic.code-nav.cn/course_picture/1608440217629360130/6lDCRedX19b9Yde5.webp)

Studio æ”¯æŒå’Œ Spriâ ng Bootã€Quâ arkus å’Œ Jetty å¿«é€Ÿé›†æˆï¼Œæœ¬èŠ‚åé¢æˆ‘ä»¬ä¹Ÿä¼šå®æˆ˜ã€‚

#### Builder æ„å»ºå·¥å…·

LangGraph4j æä¾›äº†ä¸€ä¸ª [å¯è§†åŒ–çš„å·¥ä½œæµæ„å»ºå·¥å…·](https://github.com/langgraph4j/langgraph4j-builder)ï¼Œå¯ä»¥é€šè¿‡æ‹–æ‹‰æ‹½çš„æ–¹å¼å¼€å‘å·¥ä½œæµï¼Œè‡ªåŠ¨ç”Ÿæˆå¯¹åº”çš„ Java ä»£ç ã€‚

![](https://pic.code-nav.cn/course_picture/1608440217629360130/axagwaFCZbl1wTuj.webp)

è¿™é‡Œé±¼çš®åˆ©ç”¨ [äº‘æ‰˜ç®¡å¹³å°](https://cloud.weixin.qq.com/cloudrun/service) å¿«é€Ÿä»¥å®¹å™¨çš„æ–¹å¼è¿è¡Œå·¥å…·ï¼Œå…ˆåˆ©ç”¨å®˜æ–¹æä¾›çš„å®¹å™¨é•œåƒæ„å»ºæœåŠ¡ï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/pF0CmstWgmvKrRDz.webp "null")

éœ€è¦æ­£ç¡®è®¾ç½®ç¯å¢ƒå˜é‡ï¼š

```markdown
-e NODE_ENV=production \
-e LANGRAPH4J_GEN=generator-1.6-SNAPSHOT-jar-with-dependencies.jar
```

æ³¨æ„ï¼Œä¸è¦æŒ‰ç…§ä½œè€…æ–‡æ¡£ä¸­çš„è®¾ç½® `-e RUNNING_IN_DOCKER=true`ï¼Œå¯èƒ½å¯¼è‡´æ— æ³•ç”Ÿæˆä»£ç ï¼

![](https://pic.code-nav.cn/course_picture/1608440217629360130/VdxTkAH62VRXDn88.webp)

ç¡®ä¿æœåŠ¡æˆåŠŸå¯åŠ¨ï¼šâ€‚â€‚â€‚â€‚â€‚â â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â â€‚â€‚â€‰â€‰â€‰â€‰â€‰â€‚â€‰â€‰â€‰â€‰â€‚â€‚â€‚â€‰â€‚â€‚

![](https://pic.code-nav.cn/course_picture/1608440217629360130/J1lDQt3MCdwRkX4y.webp)

ç¬¬ä¸€æ¬¡è¿›å…¥æ—¶ï¼Œå¯ä»¥è·Ÿç€ç½‘é¡µçš„â æç¤ºå­¦ä¹ ç”¨æ³•ï¼Œå…¶å®â å°±æ˜¯ç”»æµç¨‹å›¾ï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/56LHHCerWP1vLEkv.webp)

æ„å»ºå™¨é¢„ç½®äº† 2 ä¸ªæ¨¡æ¿ï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/MUqdDGdA9mmMpP2C.webp)

å¯ä»¥é€šè¿‡ç®€å•çš„æ‹–æ‹½æ“ä½œæ¥è®¾è®¡â å·¥ä½œæµï¼Œç„¶åè‡ªåŠ¨ç”Ÿâ æˆå¯¹åº”çš„ Java ä»£ç ï¼Œæé«˜å¼€å‘æ•ˆç‡ï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/JkZaz2BtIcbfaxca.webp)

ç”Ÿæˆçš„ä»£ç å¯ä»¥ç»™æˆ‘ä»¬ä½œä¸ºå‚è€ƒï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/o9bDeBzryK0RKXBf.webp)

ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¯¹äºåŒ…å«å¾ªç¯çš„å¤æ‚å·¥ä½œæµï¼Œç”Ÿæˆçš„ä»£ç å¯èƒ½â ä¸å¤Ÿå‡†ç¡®ï¼Œè€Œä¸”ä¼šåŒ…å«ä¸€äº›å†—ä½™å†…å®¹ï¼Œæ‰€ä»¥â æˆ‘ä¸ªäººä¸å¤ªå–œæ¬¢ç”¨è¿™ä¸ªå·¥å…·ï¼ˆç›®å‰ä¹Ÿæ²¡å¤šå°‘äººç”¨ï¼‰ï¼Œè¿˜ä¸å¦‚ç”¨ AI æ¥æ ¹æ®æˆ‘ä»¬æè¿°å¥½çš„æµç¨‹å›¾æ¥ç”Ÿæˆå·¥ä½œæµä»£ç ã€‚

### é›†æˆ

LangGraph4j å¯ä»¥å¿«é€Ÿå’Œ Langchain4j / Spring AI è¿›è¡Œ [é›†æˆ](https://langgraph4j.github.io/langgraph4j/integration/)ã€‚

æ¯”å¦‚é€šè¿‡ AgentExecutoâ rï¼Œå¯ä»¥å¿«é€Ÿå°† Chaâ tModel å’Œ Tools è½¬æ¢ä¸º ReACT Agent å·¥ä½œæµï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/CD0Or9C6uQZMBFHO.png)

ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“éœ€è¦ç”¨åˆ°å·¥ä½œæµæ—¶ï¼Œæˆ‘ä»¬ä¸éœ€è¦é‡æ–°å­¦â ä¹ å…¨æ–°çš„ AI æ¡†æ¶å’Œ APIâ ï¼Œè€Œæ˜¯åœ¨ç°æœ‰çš„ Langchain4j æˆ– Spring AI åŸºç¡€ä¸Šæ·»åŠ å·¥ä½œæµçš„èƒ½åŠ›å³å¯ã€‚

### æ›´å¤šç¤ºä¾‹

LangGraph4j æä¾›äº†ä¸€äº› [å®ç”¨ç¤ºä¾‹](https://langgraph4j.github.io/langgraph4j/how-tos/adaptiverag/)ï¼Œä¸ä»…æä¾›äº†ä»£ç å‚è€ƒï¼Œè€Œä¸”è¿˜å¯ä»¥åšä¸ºä¸åŒåœºæ™¯ä¸‹çš„æœ€ä½³å®è·µã€‚

![](https://pic.code-nav.cn/course_picture/1608440217629360130/gOMzibKWnZ6WNMut.webp)

å…¶ä¸­æˆ‘è§‰å¾—è‡ªé€‚åº” RAG ç³»ç»Ÿâ çš„ç¤ºä¾‹æ˜¯å€¼å¾—å­¦ä¹ çš„ï¼Œâ å®ƒå±•ç¤ºäº†å¦‚ä½•æ ¹æ®ç”¨æˆ·æè¿°æ™ºèƒ½é€‰æ‹©æœç´¢å¼•æ“å’ŒçŸ¥è¯†åº“æ¥å›ç­”é—®é¢˜ã€‚

![](https://pic.code-nav.cn/course_picture/1608440217629360130/C0UpmDgGvrcpFFxp.webp)

å…¶ä»–å‡ ä¸ªå€¼å¾—å­¦ä¹ çš„ä¾‹å­ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯è‡ªè¡Œå­¦ä¹ ï¼š

-   [ç­‰å¾…äººå·¥è¾“å…¥](https://langgraph4j.github.io/langgraph4j/how-tos/wait-user-input/)ï¼šæ¼”ç¤ºäº†å¦‚ä½•åœ¨å·¥ä½œæµä¸­å®ç°äººæœºäº¤äº’ï¼Œæ„å»ºéœ€è¦äººå·¥ç¡®è®¤çš„ AI ç³»ç»Ÿæ—¶å¯ä»¥å‚è€ƒ
-   [LangChain4j æµå¼è¾“å‡ºé›†æˆ](https://langgraph4j.github.io/langgraph4j/how-tos/llm-streaming/)ï¼šå±•ç¤ºäº†å¦‚ä½•å¤„ç†å®æ—¶çš„ AI å“åº”æµã€‚
-   [MCP å¯¹æ¥](https://github.com/langgraph4j/langgraph4j-examples/tree/main/langchain4j/mcp-client-agent)ï¼šåœ¨ LangGraph4j ä¸­æ•´åˆ MCP æœåŠ¡
-   [ç®¡ç†æ¨¡å¼çš„å¤šæ™ºèƒ½ä½“æ¶æ„](https://langgraph4j.github.io/langgraph4j/how-tos/multi-agent-supervisor/)ï¼šä½¿ç”¨ LLM å¯¹æ™ºèƒ½ä½“è¿›è¡Œç¼–æ’

![](https://pic.code-nav.cn/course_picture/1608440217629360130/iYhL1jEKL8ze4eje.webp)

## å››ã€æ ¸å¿ƒå·¥ä½œæµå¼€å‘

äº†è§£äº† LangGraph4â j çš„ç‰¹æ€§åï¼Œä¸‹é¢â æˆ‘ä»¬ç›´æ¥åœ¨é¡¹ç›®ä¸­å®æˆ˜ã€‚

### å·¥ä½œæµå¼€å‘æ­¥éª¤

å·¥ä½œæµå¼€å‘çš„æ ¸å¿ƒæ˜¯ï¼šèŠ‚ç‚¹ + è¾¹ + çŠ¶æ€ + å…¶ä»–ç‰¹æ€§

å…·ä½“æ­¥éª¤ï¼š

1.  å®šä¹‰å·¥ä½œæµç»“æ„ï¼ˆæ‰€æœ‰å·¥ä½œèŠ‚ç‚¹å…ˆåªæ˜¯ä¸´æ—¶è¾“å‡ºã€ä¹Ÿæ— éœ€è®°å½•çŠ¶æ€ï¼‰
2.  å®šä¹‰çŠ¶æ€
3.  å®šä¹‰å·¥ä½œèŠ‚ç‚¹ï¼Œå…ˆé€šè¿‡å‡æ•°æ®æ¨¡æ‹ŸçŠ¶æ€æµè½¬
4.  å¼€å‘çœŸå®çš„å·¥ä½œèŠ‚ç‚¹
5.  å·¥ä½œæµä¸­ä½¿ç”¨èŠ‚ç‚¹ï¼Œæä¾›å®Œæ•´çš„å·¥ä½œæµæœåŠ¡

### å®šä¹‰å·¥ä½œæµç»“æ„

æ ¹æ®æˆ‘ä»¬çš„éœ€æ±‚æ¢³ç†å‡ºå·¥ä½œæµç¨‹ï¼š

1.  è¾“å…¥åŸå§‹ Prompt
    
2.  è·å–å›¾ç‰‡ç´ æ Agentï¼šé€šè¿‡å·¥å…·è°ƒç”¨ä»ä¸åŒçš„æ¸ é“è·å–å›¾ç‰‡
    
3.  å†…å®¹å›¾ç‰‡ï¼špexels ç½‘é¡µæœç´¢
    
4.  æ’ç”»å›¾ç‰‡ï¼šundraw æŠ“å–
    
5.  ç”»æ¶æ„å›¾ï¼šæ–‡æœ¬ç»˜å›¾ + ä¸Šä¼ åˆ° COS
    
6.  Logo ç­‰è®¾è®¡å›¾ç‰‡ï¼šAI ç”Ÿæˆæˆ–è€… MCP
    
7.  æç¤ºè¯å¢å¼ºï¼šå…³è”å›¾ç‰‡å†…å®¹åˆ°åŸå§‹æç¤ºè¯
    
8.  æ™ºèƒ½è·¯ç”± Agentï¼šé€‰ç”¨å“ªç§æ¨¡å¼ç”Ÿæˆç½‘ç«™ï¼Ÿ
    
9.  åŸç”Ÿ HTML
    
10.  åŸç”Ÿå¤šæ–‡ä»¶
    
11.  Vue å·¥ç¨‹
    
12.  ç½‘ç«™ç”Ÿæˆ Agentï¼šåˆ©ç”¨æœé›†åˆ°çš„å›¾ç‰‡ï¼Œæ ¹æ®ä¸Šä¸€æ­¥ç¡®è®¤çš„ç”Ÿæˆæ¨¡å¼æ¥ç”Ÿæˆç½‘ç«™
    
13.  é¡¹ç›®æ„å»ºå™¨ï¼šæ–‡ä»¶ä¿å­˜ / æ‰“åŒ…æ„å»º
    

![](https://pic.code-nav.cn/course_picture/1608440217629360130/TXRVc36FSrQ6wZ4K.webp)

æœ‰äº†è¯¦ç»†çš„å·¥ä½œæµç¨‹æè¿°åï¼Œå¯ä»¥åˆ©ç”¨ â AIï¼Œæ ¹æ® LangGrâ aph4j çš„å®˜æ–¹æ–‡æ¡£å’Œç¤ºä¾‹ï¼Œå¿«é€Ÿç”ŸæˆåŸºç¡€çš„å·¥ä½œæµç»“æ„ä»£ç ï¼Œæ¯”å¦‚ä¸‹åˆ—æç¤ºè¯ï¼š

```markdown
å¸®æˆ‘ç”Ÿæˆ LangGraph4j å·¥ä½œæµçš„ä»£ç 

## å·¥ä½œæµçš„æµç¨‹æè¿°

// ... è¡¥å……å…·ä½“çš„æµç¨‹

## è¦æ±‚

å…ˆç”ŸæˆåŸºç¡€çš„å·¥ä½œæµç»“æ„ä»£ç ï¼Œæ¯ä¸ªå·¥ä½œèŠ‚ç‚¹ä¸­åªè¾“å‡ºä¸€å¥ä¿¡æ¯å°±å¤Ÿäº†ï¼Œä¸ç”¨çœŸæ­£å®ç°å…·ä½“çš„ä¸šåŠ¡é€»è¾‘ã€‚

## å‚è€ƒä¿¡æ¯

å®˜æ–¹æ–‡æ¡£ï¼š@https://langgraph4j.github.io/langgraph4j/core/low_level/
ç¤ºä¾‹å·¥ä½œæµå®ç°ï¼š@https://github.com/langgraph4j/langgraph4j-examples/blob/main/langchain4j/adaptive-rag/src/main/java/dev/langchain4j/adaptiverag/AdaptiveRag.java
```

å¾—åˆ°ç®€åŒ–ç‰ˆçš„å·¥ä½œæµç»“æ„ä»£ç å¦‚ä¸‹ï¼Œå­˜æ”¾åˆ° `langgraph4j` åŒ…ä¸‹ï¼š

```java
/**
 * ç®€åŒ–ç‰ˆç½‘ç«™ç”Ÿæˆå·¥ä½œæµåº”ç”¨ - ä½¿ç”¨ MessagesState
 */
@Slf4j
public class SimpleWorkflowApp {

    /**
     * åˆ›å»ºå·¥ä½œèŠ‚ç‚¹çš„é€šç”¨æ–¹æ³•
     */
    static AsyncNodeAction<MessagesState<String>> makeNode(String message) {
        return node_async(state -> {
            log.info("æ‰§è¡ŒèŠ‚ç‚¹: {}", message);
            return Map.of("messages", message);
        });
    }

    public static void main(String[] args) throws GraphStateException {
        // åˆ›å»ºå·¥ä½œæµå›¾
        CompiledGraph<MessagesState<String>> workflow = new MessagesStateGraph<String>()
                // æ·»åŠ èŠ‚ç‚¹
                .addNode("image_collector", makeNode("è·å–å›¾ç‰‡ç´ æ"))
                .addNode("prompt_enhancer", makeNode("å¢å¼ºæç¤ºè¯"))
                .addNode("router", makeNode("æ™ºèƒ½è·¯ç”±é€‰æ‹©"))
                .addNode("code_generator", makeNode("ç½‘ç«™ä»£ç ç”Ÿæˆ"))
                .addNode("project_builder", makeNode("é¡¹ç›®æ„å»º"))

                // æ·»åŠ è¾¹
                .addEdge(START, "image_collector")                // å¼€å§‹ -> å›¾ç‰‡æ”¶é›†
                .addEdge("image_collector", "prompt_enhancer")    // å›¾ç‰‡æ”¶é›† -> æç¤ºè¯å¢å¼º
                .addEdge("prompt_enhancer", "router")             // æç¤ºè¯å¢å¼º -> æ™ºèƒ½è·¯ç”±
                .addEdge("router", "code_generator")              // æ™ºèƒ½è·¯ç”± -> ä»£ç ç”Ÿæˆ
                .addEdge("code_generator", "project_builder")     // ä»£ç ç”Ÿæˆ -> é¡¹ç›®æ„å»º
                .addEdge("project_builder", END)                  // é¡¹ç›®æ„å»º -> ç»“æŸ

                // ç¼–è¯‘å·¥ä½œæµ
                .compile();

        log.info("å¼€å§‹æ‰§è¡Œå·¥ä½œæµ");

        GraphRepresentation graph = workflow.getGraph(GraphRepresentation.Type.MERMAID);
        log.info("å·¥ä½œæµå›¾: \n{}", graph.content());

        // æ‰§è¡Œå·¥ä½œæµ
        int stepCounter = 1;
        for (NodeOutput<MessagesState<String>> step : workflow.stream(Map.of())) {
            log.info("--- ç¬¬ {} æ­¥å®Œæˆ ---", stepCounter);
            log.info("æ­¥éª¤è¾“å‡º: {}", step);
            stepCounter++;
        }

        log.info("å·¥ä½œæµæ‰§è¡Œå®Œæˆï¼");
    }
}
```

ä¸Šè¿°ä»£ç çš„å‡ ä¸ªå…³é”®ï¼š

1.  ä½¿ç”¨äº† LangGraph4j å†…ç½®çš„ `MessageState` æ¶ˆæ¯åˆ—è¡¨ä½œä¸ºçŠ¶æ€
2.  ç›´æ¥æä¾›äº†ä¸€ä¸ªåˆ›å»ºèŠ‚ç‚¹çš„æ–¹æ³•ï¼Œæ¯ä¸ªå·¥ä½œèŠ‚ç‚¹éƒ½åªæ˜¯æ‰“å°ä¸ªæ—¥å¿—ï¼Œä¾¿äºå¿«é€ŸéªŒè¯å·¥ä½œæµç»“æ„
3.  é€šè¿‡å¯è§†åŒ–èƒ½åŠ›æ‰“å°å‡ºå·¥ä½œæµå›¾çš„ç»“æ„

æ‰§è¡Œå·¥ä½œæµç¨‹åºï¼Œå¯ä»¥çœ‹åˆ°è¾“å‡ºâ çš„å·¥ä½œæµå›¾ç»“æ„ï¼ˆMâ ermaid è¯­æ³•ï¼‰ï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/UvPEdGiqO3DAmJvO.webp)

ä»¥åŠæ¯ä¸€æ­¥å·¥ä½œæµçš„èŠ‚ç‚¹æ‰§è¡Œå’ŒçŠ¶æ€ä¿¡æ¯ï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/m2Vc2vnMWgaLtuuv.webp)

å¯ä»¥å°†æ–‡æœ¬ç»˜å›¾çš„ä»£ç å¤åˆ¶åˆ° [Mermaid å¯è§†åŒ–å·¥å…·](https://mermaid-live.nodejs.cn/edit) æ¥éªŒè¯ä¸‹æµç¨‹ï¼š

![](https://www.codefather.cn/_next/static/media/defaultCode.6873fc9a.png)

### å®šä¹‰çŠ¶æ€

éœ€è¦å°†å„ä¸ªå·¥ä½œèŠ‚ç‚¹ä¸­å…±äº«çš„æ•°æ®å®šä¹‰ä¸ºçŠ¶æ€ã€‚

#### 1ã€æ¢³ç†çŠ¶æ€

ç”¨ä¸€ä¸ªè¡¨æ ¼æ¥æ¢³ç†ï¼š



|å·¥ä½œæ­¥éª¤|è¾“å…¥çŠ¶æ€|è¾“å‡ºçŠ¶æ€|
|---|---|---|
|å›¾ç‰‡æ”¶é›†|originalPrompt åŸå§‹æç¤ºè¯|images å›¾ç‰‡èµ„æºåˆ—è¡¨æ¯ä¸€ä¸ªå›¾ç‰‡éƒ½åº”è¯¥æ˜¯å¯¹è±¡ç»“æ„ï¼ˆå›¾ç‰‡ç±»åˆ«ã€æè¿°ã€åœ°å€ï¼‰å›¾ç‰‡ç±»åˆ«ï¼šcontent å†…å®¹å›¾ç‰‡URLsillustration æ’ç”»å›¾ç‰‡URLsarchitecture æ¶æ„å›¾URLlogo Logoå›¾ç‰‡URL|
|æç¤ºè¯å¢å¼º|originalPrompt åŸå§‹æç¤ºè¯ images å›¾ç‰‡èµ„æº|enhancedPrompt å¢å¼ºåçš„æç¤ºè¯ï¼ŒåŒ…å«å›¾ç‰‡æè¿°å’Œå¼•ç”¨|
|æ™ºèƒ½è·¯ç”±â |originalPromptenhancedPrompt å¢å¼ºåçš„æç¤ºè¯|generationTâ ype ç”Ÿæˆç±»å‹|
|ä»£ç ç”Ÿæˆ|enhancedPromptgenerationType ç”Ÿæˆç±»å‹images|generatedCodeDir ç”Ÿæˆçš„ä»£ç ç›®å½•|
|é¡¹ç›®æ„å»º|generatedCodeDir ç”Ÿæˆçš„ä»£ç ç›®å½•|buildResultDir æ„å»ºæˆåŠŸçš„ç›®å½•|

#### 2ã€å®šä¹‰çŠ¶æ€ç±»

è¿˜è®°å¾—ä¹ˆï¼Ÿå®˜æ–¹æä¾›çš„é»˜è®¤çŠ¶æ€ç±»æ˜¯ **æ¶ˆæ¯åˆ—è¡¨** ç»“æ„ï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/EuSJEKnLmPsANjmN.webp)

ä½†æ˜¾ç„¶ï¼Œæˆ‘ä»¬éœ€è¦ç»´æŠ¤çš„çŠ¶æ€åŒ…å«å¤šä¸ªå­—æ®µï¼Œåº”è¯¥æ˜¯â ä¸€ä¸ª Map æˆ–è€…ç±»çš„ç»“æ„ï¼Œå› â æ­¤æˆ‘ä»¬ä¸å¦‚å®šä¹‰ä¸€ä¸ªè‡ªå·±çš„ WorkflowContext ä¸Šä¸‹æ–‡ç±»ï¼Œç»Ÿä¸€ç»´æŠ¤æ‰€æœ‰éœ€è¦çš„å­—æ®µã€‚

è€Œä¸”ä¸ºäº†å’Œ LangGraph4j å·¥ä½œæµå›¾éœ€è¦çš„ AgentState å…¼å®¹ï¼Œæˆ‘ä»¬å¯ä»¥å°† WorkflowContext å¯¹è±¡ä½œä¸ºä¸€ä¸ª key / value å­˜æ”¾åœ¨ MessageState ä¸­ï¼Œéœ€è¦ä½¿ç”¨æ—¶é€šè¿‡ `state.data().getKey` è·å–å³å¯ã€‚

![](https://pic.code-nav.cn/course_picture/1608440217629360130/JiS9YFUpQNZrSeHQ.webp)

åœ¨ `langgraph4j.state` åŒ…ä¸‹æ–°å»ºå·¥ä½œæµä¸Šä¸‹æ–‡ç±»ï¼š

```java
/**
 * å·¥ä½œæµä¸Šä¸‹æ–‡ - å­˜å‚¨æ‰€æœ‰çŠ¶æ€ä¿¡æ¯
 */
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class WorkflowContext implements Serializable {

    /**
     * WorkflowContext åœ¨ MessagesState ä¸­çš„å­˜å‚¨key
     */
    public static final String WORKFLOW_CONTEXT_KEY = "workflowContext";

    /**
     * å½“å‰æ‰§è¡Œæ­¥éª¤
     */
    private String currentStep;

    /**
     * ç”¨æˆ·åŸå§‹è¾“å…¥çš„æç¤ºè¯
     */
    private String originalPrompt;

    /**
     * å›¾ç‰‡èµ„æºå­—ç¬¦ä¸²
     */
    private String imageListStr;

    /**
     * å›¾ç‰‡èµ„æºåˆ—è¡¨
     */
    private List<ImageResource> imageList;

    /**
     * å¢å¼ºåçš„æç¤ºè¯
     */
    private String enhancedPrompt;

    /**
     * ä»£ç ç”Ÿæˆç±»å‹
     */
    private CodeGenTypeEnum generationType;

    /**
     * ç”Ÿæˆçš„ä»£ç ç›®å½•
     */
    private String generatedCodeDir;

    /**
     * æ„å»ºæˆåŠŸçš„ç›®å½•
     */
    private String buildResultDir;

    /**
     * é”™è¯¯ä¿¡æ¯
     */
    private String errorMessage;

    @Serial
    private static final long serialVersionUID = 1L;

    // ========== ä¸Šä¸‹æ–‡æ“ä½œæ–¹æ³• ==========

    /**
     * ä» MessagesState ä¸­è·å– WorkflowContext
     */
    public static WorkflowContext getContext(MessagesState<String> state) {
        return (WorkflowContext) state.data().get(WORKFLOW_CONTEXT_KEY);
    }

    /**
     * å°† WorkflowContext ä¿å­˜åˆ° MessagesState ä¸­
     */
    public static Map<String, Object> saveContext(WorkflowContext context) {
        return Map.of(WORKFLOW_CONTEXT_KEY, context);
    }
}
```

ImageResource ç±»ï¼š

```java
/**
 * å›¾ç‰‡èµ„æºå¯¹è±¡
 */
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class ImageResource implements Serializable {

    /**
     * å›¾ç‰‡ç±»åˆ«
     */
    private ImageCategoryEnum category;

    /**
     * å›¾ç‰‡æè¿°
     */
    private String description;

    /**
     * å›¾ç‰‡åœ°å€
     */
    private String url;

    @Serial
    private static final long serialVersionUID = 1L;
}
```

å›¾ç‰‡ç±»å‹æšä¸¾ç±»ï¼š

```java
@Getter
public enum ImageCategoryEnum {

    CONTENT("å†…å®¹å›¾ç‰‡", "CONTENT"),
    LOGO("LOGOå›¾ç‰‡", "LOGO"),
    ILLUSTRATION("æ’ç”»å›¾ç‰‡", "ILLUSTRATION"),
    ARCHITECTURE("æ¶æ„å›¾ç‰‡", "ARCHITECTURE");


    private final String text;

    private final String value;

    ImageCategoryEnum(String text, String value) {
        this.text = text;
        this.value = value;
    }

    /**
     * æ ¹æ® value è·å–æšä¸¾
     *
     * @param value æšä¸¾å€¼çš„value
     * @return æšä¸¾å€¼
     */
    public static ImageCategoryEnum getEnumByValue(String value) {
        if (ObjUtil.isEmpty(value)) {
            return null;
        }
        for (ImageCategoryEnum anEnum : ImageCategoryEnum.values()) {
            if (anEnum.value.equals(value)) {
                return anEnum;
            }
        }
        return null;
    }
}
```

#### 3ã€ä¿®æ”¹å·¥ä½œæµå›¾ - å¼•å…¥çŠ¶æ€

å®Œå–„ä¸Šä¸€æ­¥å¾—åˆ°çš„ç®€å•å·¥ä½œæµï¼š

1.  åˆ›å»ºå¸¦çŠ¶æ€æ„ŸçŸ¥çš„å·¥ä½œèŠ‚ç‚¹ï¼ˆèƒ½å¤Ÿè¯»å–å’Œè®¾ç½®çŠ¶æ€ï¼‰ï¼Œåªéœ€è¦å…ˆè·å–åˆ° WorkflowContextï¼Œä¿®æ”¹å­—æ®µåå†ä¿å­˜å³å¯ã€‚
2.  æ‰§è¡Œå·¥ä½œæµæ—¶ï¼Œä¼ å…¥åˆå§‹ä¸Šä¸‹æ–‡å¯¹è±¡

å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š

```java
/**
 * ç®€åŒ–ç‰ˆå¸¦çŠ¶æ€å®šä¹‰çš„å·¥ä½œæµ - åªå®šä¹‰çŠ¶æ€ç»“æ„ï¼Œä¸å®ç°å…·ä½“æµè½¬
 */
@Slf4j
public class SimpleStatefulWorkflowApp {

    /**
     * åˆ›å»ºå¸¦çŠ¶æ€æ„ŸçŸ¥çš„å·¥ä½œèŠ‚ç‚¹
     */
    static AsyncNodeAction<MessagesState<String>> makeStatefulNode(String nodeName, String message) {
        return node_async(state -> {
            WorkflowContext context = WorkflowContext.getContext(state);
            log.info("æ‰§è¡ŒèŠ‚ç‚¹: {} - {}", nodeName, message);
            // åªè®°å½•å½“å‰æ­¥éª¤ï¼Œä¸åšå…·ä½“çš„çŠ¶æ€æµè½¬
            if (context != null) {
                context.setCurrentStep(nodeName);
            }
            return WorkflowContext.saveContext(context);
        });
    }

    public static void main(String[] args) throws GraphStateException {
        // åˆ›å»ºå·¥ä½œæµå›¾
        CompiledGraph<MessagesState<String>> workflow = new MessagesStateGraph<String>()
                // æ·»åŠ èŠ‚ç‚¹ - ä½¿ç”¨å¸¦çŠ¶æ€æ„ŸçŸ¥çš„èŠ‚ç‚¹
                .addNode("image_collector", makeStatefulNode("image_collector", "è·å–å›¾ç‰‡ç´ æ"))
                .addNode("prompt_enhancer", makeStatefulNode("prompt_enhancer", "å¢å¼ºæç¤ºè¯"))
                .addNode("router", makeStatefulNode("router", "æ™ºèƒ½è·¯ç”±é€‰æ‹©"))
                .addNode("code_generator", makeStatefulNode("code_generator", "ç½‘ç«™ä»£ç ç”Ÿæˆ"))
                .addNode("project_builder", makeStatefulNode("project_builder", "é¡¹ç›®æ„å»º"))

                // æ·»åŠ è¾¹
                .addEdge(START, "image_collector")
                .addEdge("image_collector", "prompt_enhancer")
                .addEdge("prompt_enhancer", "router")
                .addEdge("router", "code_generator")
                .addEdge("code_generator", "project_builder")
                .addEdge("project_builder", END)

                // ç¼–è¯‘å·¥ä½œæµ
                .compile();

        // åˆå§‹åŒ– WorkflowContext - åªè®¾ç½®åŸºæœ¬ä¿¡æ¯
        WorkflowContext initialContext = WorkflowContext.builder()
                .originalPrompt("åˆ›å»ºä¸€ä¸ªé±¼çš®çš„ä¸ªäººåšå®¢ç½‘ç«™")
                .currentStep("åˆå§‹åŒ–")
                .build();

        log.info("åˆå§‹è¾“å…¥: {}", initialContext.getOriginalPrompt());
        log.info("å¼€å§‹æ‰§è¡Œå·¥ä½œæµ");

        // æ˜¾ç¤ºå·¥ä½œæµå›¾
        GraphRepresentation graph = workflow.getGraph(GraphRepresentation.Type.MERMAID);
        log.info("å·¥ä½œæµå›¾:\n{}", graph.content());

        // æ‰§è¡Œå·¥ä½œæµ
        int stepCounter = 1;
        for (NodeOutput<MessagesState<String>> step : workflow.stream(Map.of(WorkflowContext.WORKFLOW_CONTEXT_KEY, initialContext))) {
            log.info("--- ç¬¬ {} æ­¥å®Œæˆ ---", stepCounter);
            // æ˜¾ç¤ºå½“å‰çŠ¶æ€
            WorkflowContext currentContext = WorkflowContext.getContext(step.state());
            if (currentContext != null) {
                log.info("å½“å‰æ­¥éª¤ä¸Šä¸‹æ–‡: {}", currentContext);
            }
            stepCounter++;
        }
        log.info("å·¥ä½œæµæ‰§è¡Œå®Œæˆï¼");
    }
}
```

æ‰§è¡Œå¹¶æŸ¥çœ‹è¾“å‡ºç»“æœï¼Œåº”è¯¥å’Œä¹‹â å‰ä¸€æ ·ï¼Œèƒ½å¤Ÿçœ‹åˆ°æ¯â ä¸€ä¸ªæ­¥éª¤çš„çŠ¶æ€ã€‚

### å®šä¹‰å·¥ä½œèŠ‚ç‚¹ - æ¨¡æ‹ŸçŠ¶æ€æµè½¬

#### 1ã€å®šä¹‰å·¥ä½œèŠ‚ç‚¹

åœ¨ `langgraph4j.node` åŒ…ä¸‹æ–°å»ºæ¯ä¸€ä¸ªæ­¥éª¤å¯¹åº”çš„å·¥ä½œèŠ‚ç‚¹ï¼Œæ¯ä¸ªèŠ‚ç‚¹ä¸­åªéœ€è¦ Mock ä¸€äº›å‡æ•°æ®æ¥æ¨¡æ‹ŸçŠ¶æ€æµè½¬ï¼Œä¸ç”¨çœŸæ­£å®ç°ä¸šåŠ¡é€»è¾‘ã€‚

å›¾ç‰‡æ”¶é›†èŠ‚ç‚¹ï¼š

```java
@Slf4j
public class ImageCollectorNode {
    public static AsyncNodeAction<MessagesState<String>> create() {
        return node_async(state -> {
            WorkflowContext context = WorkflowContext.getContext(state);
            log.info("æ‰§è¡ŒèŠ‚ç‚¹: å›¾ç‰‡æ”¶é›†");
            
            // TODO: å®é™…æ‰§è¡Œå›¾ç‰‡æ”¶é›†é€»è¾‘
            
            // ç®€å•çš„å‡æ•°æ®
            List<ImageResource> imageList = Arrays.asList(
                ImageResource.builder()
                    .category(ImageCategoryEnum.CONTENT)
                    .description("å‡æ•°æ®å›¾ç‰‡1")
                    .url("https://www.codefather.cn/logo.png")
                    .build(),
                ImageResource.builder()
                    .category(ImageCategoryEnum.LOGO)
                    .description("å‡æ•°æ®å›¾ç‰‡2")
                    .url("https://www.codefather.cn/logo.png")
                    .build()
            );
            
            // æ›´æ–°çŠ¶æ€
            context.setCurrentStep("å›¾ç‰‡æ”¶é›†");
            context.setImageList(imageList);
            log.info("å›¾ç‰‡æ”¶é›†å®Œæˆï¼Œå…±æ”¶é›† {} å¼ å›¾ç‰‡", imageList.size());
            return WorkflowContext.saveContext(context);
        });
    }
}
```

æç¤ºè¯å¢å¼ºèŠ‚ç‚¹ï¼š

```java
@Slf4j
public class PromptEnhancerNode {
    public static AsyncNodeAction<MessagesState<String>> create() {
        return node_async(state -> {
            WorkflowContext context = WorkflowContext.getContext(state);
            log.info("æ‰§è¡ŒèŠ‚ç‚¹: æç¤ºè¯å¢å¼º");
            
            // TODO: å®é™…æ‰§è¡Œæç¤ºè¯å¢å¼ºé€»è¾‘
            
            // ç®€å•çš„å‡æ•°æ®
            String enhancedPrompt = "è¿™æ˜¯å¢å¼ºåçš„å‡æ•°æ®æç¤ºè¯";
            
            // æ›´æ–°çŠ¶æ€
            context.setCurrentStep("æç¤ºè¯å¢å¼º");
            context.setEnhancedPrompt(enhancedPrompt);
            log.info("æç¤ºè¯å¢å¼ºå®Œæˆ");
            return WorkflowContext.saveContext(context);
        });
    }
}
```

æ™ºèƒ½è·¯ç”±èŠ‚ç‚¹ï¼š

```java
@Slf4j
public class RouterNode {
    public static AsyncNodeAction<MessagesState<String>> create() {
        return node_async(state -> {
            WorkflowContext context = WorkflowContext.getContext(state);
            log.info("æ‰§è¡ŒèŠ‚ç‚¹: æ™ºèƒ½è·¯ç”±");
            
            // TODO: å®é™…æ‰§è¡Œæ™ºèƒ½è·¯ç”±é€»è¾‘
            
            // ç®€å•çš„å‡æ•°æ®
            CodeGenTypeEnum generationType = CodeGenTypeEnum.HTML;
            // æ›´æ–°çŠ¶æ€
            context.setCurrentStep("æ™ºèƒ½è·¯ç”±");
            context.setGenerationType(generationType);
            log.info("è·¯ç”±å†³ç­–å®Œæˆï¼Œé€‰æ‹©ç±»å‹: {}", generationType.getText());
            return WorkflowContext.saveContext(context);
        });
    }
}
```

ä»£ç ç”ŸæˆèŠ‚ç‚¹ï¼š

```java
@Slf4j
public class CodeGeneratorNode {
    public static AsyncNodeAction<MessagesState<String>> create() {
        return node_async(state -> {
            WorkflowContext context = WorkflowContext.getContext(state);
            log.info("æ‰§è¡ŒèŠ‚ç‚¹: ä»£ç ç”Ÿæˆ");
            
            // TODO: å®é™…æ‰§è¡Œä»£ç ç”Ÿæˆé€»è¾‘
            
            // ç®€å•çš„å‡æ•°æ®
            String generatedCodeDir = "/tmp/generated/fake-code";
            // æ›´æ–°çŠ¶æ€
            context.setCurrentStep("ä»£ç ç”Ÿæˆ");
            context.setGeneratedCodeDir(generatedCodeDir);
            log.info("ä»£ç ç”Ÿæˆå®Œæˆï¼Œç›®å½•: {}", generatedCodeDir);
            return WorkflowContext.saveContext(context);
        });
    }
}
```

é¡¹ç›®æ„å»ºèŠ‚ç‚¹ï¼š

```java
@Slf4j
public class ProjectBuilderNode {
    public static AsyncNodeAction<MessagesState<String>> create() {
        return node_async(state -> {
            WorkflowContext context = WorkflowContext.getContext(state);
            log.info("æ‰§è¡ŒèŠ‚ç‚¹: é¡¹ç›®æ„å»º");
            
            // TODO: å®é™…æ‰§è¡Œé¡¹ç›®æ„å»ºé€»è¾‘
            
            // ç®€å•çš„å‡æ•°æ®
            String buildResultDir = "/tmp/build/fake-build";
            
            // æ›´æ–°çŠ¶æ€
            context.setCurrentStep("é¡¹ç›®æ„å»º");
            context.setBuildResultDir(buildResultDir);
            log.info("é¡¹ç›®æ„å»ºå®Œæˆï¼Œç»“æœç›®å½•: {}", buildResultDir);
            return WorkflowContext.saveContext(context);
        });
    }
}
```

#### 2ã€å·¥ä½œæµå›¾åº”ç”¨å·¥ä½œèŠ‚ç‚¹

`langgraph4j` åŒ…ä¸‹æ–°å»ºä¸€ä¸ª WorkflowAppï¼Œåº”ç”¨å„ä¸ªå·¥ä½œèŠ‚ç‚¹ç±»ï¼Œä»£ç å¦‚ä¸‹ï¼š

```java
@Slf4j
public class WorkflowApp {

    public static void main(String[] args) throws GraphStateException {
        // åˆ›å»ºå·¥ä½œæµå›¾
        CompiledGraph<MessagesState<String>> workflow = new MessagesStateGraph<String>()
                // æ·»åŠ èŠ‚ç‚¹ - ä½¿ç”¨çœŸå®çš„å·¥ä½œèŠ‚ç‚¹
                .addNode("image_collector", ImageCollectorNode.create())
                .addNode("prompt_enhancer", PromptEnhancerNode.create())
                .addNode("router", RouterNode.create())
                .addNode("code_generator", CodeGeneratorNode.create())
                .addNode("project_builder", ProjectBuilderNode.create())
                // æ·»åŠ è¾¹
                .addEdge(START, "image_collector")
                .addEdge("image_collector", "prompt_enhancer")
                .addEdge("prompt_enhancer", "router")
                .addEdge("router", "code_generator")
                .addEdge("code_generator", "project_builder")
                .addEdge("project_builder", END)
                // ç¼–è¯‘å·¥ä½œæµ
                .compile();

        // åˆå§‹åŒ– WorkflowContext - åªè®¾ç½®åŸºæœ¬ä¿¡æ¯
        WorkflowContext initialContext = WorkflowContext.builder()
                .originalPrompt("åˆ›å»ºä¸€ä¸ªé±¼çš®çš„ä¸ªäººåšå®¢ç½‘ç«™")
                .currentStep("åˆå§‹åŒ–")
                .build();
        log.info("åˆå§‹è¾“å…¥: {}", initialContext.getOriginalPrompt());
        log.info("å¼€å§‹æ‰§è¡Œå·¥ä½œæµ");

        // æ˜¾ç¤ºå·¥ä½œæµå›¾
        GraphRepresentation graph = workflow.getGraph(GraphRepresentation.Type.MERMAID);
        log.info("å·¥ä½œæµå›¾:\n{}", graph.content());

        // æ‰§è¡Œå·¥ä½œæµ
        int stepCounter = 1;
        for (NodeOutput<MessagesState<String>> step : workflow.stream(Map.of(WorkflowContext.WORKFLOW_CONTEXT_KEY, initialContext))) {
            log.info("--- ç¬¬ {} æ­¥å®Œæˆ ---", stepCounter);
            // æ˜¾ç¤ºå½“å‰çŠ¶æ€
            WorkflowContext currentContext = WorkflowContext.getContext(step.state());
            if (currentContext != null) {
                log.info("å½“å‰æ­¥éª¤ä¸Šä¸‹æ–‡: {}", currentContext);
            }
            stepCounter++;
        }
        log.info("å·¥ä½œæµæ‰§è¡Œå®Œæˆï¼");
    }
}
```

æ‰§è¡Œå¹¶æŸ¥çœ‹è¾“å‡ºç»“æœï¼Œåº”è¯¥å’Œä¹‹â å‰ä¸€æ ·ï¼Œèƒ½å¤Ÿçœ‹åˆ°æ¯â ä¸€ä¸ªæ­¥éª¤çš„çŠ¶æ€ã€‚

æ¥ä¸‹æ¥ï¼Œéœ€è¦ä¾æ¬¡å¼€å‘çœŸå®çš„å·¥ä½œèŠ‚ç‚¹ï¼Œå·¥ä½œé‡ä¸å°ã€‚

### å›¾ç‰‡æ”¶é›†èŠ‚ç‚¹

å›¾ç‰‡æ”¶é›†èŠ‚ç‚¹çš„ä½œç”¨æ˜¯æ ¹æ®ç”¨æˆ·æç¤ºè¯è·å–åˆ°ç½‘ç«™æ‰€éœ€çš„å›¾ç‰‡ã€‚

æˆ‘ä»¬æ€ä¹ˆçŸ¥é“ç½‘ç«™éœ€è¦ä»€ä¹ˆå›¾ç‰‡å‘¢ï¼Ÿ

ä¸å¦¨è®© AI æ¥åˆ¤æ–­å§ï¼é€šè¿‡ç»™ AI æä¾›å„ç§â ä¸åŒç±»å‹çš„å›¾ç‰‡æ”¶é›†å·¥å…·ï¼Œæ¥ Aâ I è°ƒç”¨å·¥å…·æ¥è·å–ç½‘ç«™æ‰€éœ€çš„ä¸åŒç±»å‹çš„å›¾ç‰‡ï¼Œå¹¶ä¸”ç›´æ¥åˆ©ç”¨ç»“æ„åŒ–è¾“å‡ºç‰¹æ€§è·å–åˆ°æœ€ç»ˆçš„å›¾ç‰‡åˆ—è¡¨ã€‚

#### 1ã€å†…å®¹å›¾ç‰‡æ”¶é›†å·¥å…·

å¯¹äºå¤§å¤šæ•°æ™®é€šçš„å›¾ç‰‡ï¼ˆæ¯”å¦‚ç‰©å“å›¾ç‰‡ã€äººç‰©å›¾ç‰‡ï¼‰ï¼Œå¯ä»¥ç›´æ¥åœ¨å…è´¹çš„å›¾ç‰‡ç½‘ç«™æœç´¢è·å–ã€‚æ¯”å¦‚ [Pexels å…è´¹å›¾ç‰‡èµ„æº](https://www.pexels.com/api/) æä¾›äº† APIï¼Œèƒ½å¤Ÿè®©æˆ‘ä»¬è½»æ¾åœ°æ ¹æ®å…³é”®è¯æ¥è·å–å›¾ç‰‡ã€‚

å…ˆåˆ° Pexels æ³¨å†Œï¼Œå¹¶ç”Ÿæˆ API å¯†é’¥ï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/g2mo3PujszNumxAi.webp "null")

å‚è€ƒ [API æ–‡æ¡£](https://www.pexels.com/api/)ï¼Œç¼–å†™å†…å®¹å›¾ç‰‡æ”¶é›†å·¥å…·çš„ä»£ç ï¼Œå·¥ä½œæµéœ€è¦ç”¨åˆ°çš„å·¥å…·ç»Ÿä¸€æ”¾åˆ° `langgraph4j.tools` åŒ…ä¸‹ï¼š

```java
@Slf4j
@Component
public class ImageSearchTool {

    private static final String PEXELS_API_URL = "https://api.pexels.com/v1/search";

    @Value("${pexels.api-key}")
    private String pexelsApiKey;

    @Tool("æœç´¢å†…å®¹ç›¸å…³çš„å›¾ç‰‡ï¼Œç”¨äºç½‘ç«™å†…å®¹å±•ç¤º")
    public List<ImageResource> searchContentImages(@P("æœç´¢å…³é”®è¯") String query) {
        List<ImageResource> imageList = new ArrayList<>();
        int searchCount = 12;
        // è°ƒç”¨ APIï¼Œæ³¨æ„é‡Šæ”¾èµ„æº
        try (HttpResponse response = HttpRequest.get(PEXELS_API_URL)
                .header("Authorization", pexelsApiKey)
                .form("query", query)
                .form("per_page", searchCount)
                .form("page", 1)
                .execute()) {
            if (response.isOk()) {
                JSONObject result = JSONUtil.parseObj(response.body());
                JSONArray photos = result.getJSONArray("photos");
                for (int i = 0; i < photos.size(); i++) {
                    JSONObject photo = photos.getJSONObject(i);
                    JSONObject src = photo.getJSONObject("src");
                    imageList.add(ImageResource.builder()
                            .category(ImageCategoryEnum.CONTENT)
                            .description(photo.getStr("alt", query))
                            .url(src.getStr("medium"))
                            .build());
                }
            }
        } catch (Exception e) {
            log.error("Pexels API è°ƒç”¨å¤±è´¥: {}", e.getMessage(), e);
        }
        return imageList;
    }
}
```

å¡«å†™é…ç½®ï¼š

```yaml
# Pexels å›¾ç‰‡æœç´¢é…ç½®
pexels:
  api-key: <Your API Key>
```

ç¼–å†™å•å…ƒæµ‹è¯•ï¼š

```java
@SpringBootTest
class ImageSearchToolTest {

    @Resource
    private ImageSearchTool imageSearchTool;

    @Test
    void testSearchContentImages() {
        // æµ‹è¯•æ­£å¸¸æœç´¢
        List<ImageResource> images = imageSearchTool.searchContentImages("technology");
        assertNotNull(images);
        assertFalse(images.isEmpty());
        // éªŒè¯è¿”å›çš„å›¾ç‰‡èµ„æº
        ImageResource firstImage = images.get(0);
        assertEquals(ImageCategoryEnum.CONTENT, firstImage.getCategory());
        assertNotNull(firstImage.getDescription());
        assertNotNull(firstImage.getUrl());
        assertTrue(firstImage.getUrl().startsWith("http"));
        System.out.println("æœç´¢åˆ° " + images.size() + " å¼ å›¾ç‰‡");
        images.forEach(image ->
                System.out.println("å›¾ç‰‡: " + image.getDescription() + " - " + image.getUrl())
        );
    }
}
```

æ‰§è¡Œå•å…ƒæµ‹è¯•ï¼Œæ•ˆæœå¦‚å›¾ï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/CgayEZqiakbOz2rP.webp "null")

#### 2ã€æ’ç”»å›¾ç‰‡æ”¶é›†å·¥å…·

å¯ä»¥é€šè¿‡å…è´¹æ’ç”»å›¾ç‰‡ç½‘ç«™ [unDraw](https://undraw.co/) çš„æ¥å£è·å–ï¼Œé€šè¿‡å¼€å‘è€…å·¥å…·è·å–åˆ°æ¥å£åœ°å€ä¸ºï¼š[https://undraw.co/\_next/data/mMWmJSt23qpgo8cLTD\_pB/search/happy.json?term=happy](https://undraw.co/_next/data/mMWmJSt23qpgo8cLTD_pB/search/happy.json?term=happy)

è¿”å›å€¼ç¤ºä¾‹ï¼š

```json
{
  "pageProps": {
    "initialResults": [
      {
        "_id": "6744eb233c000f0016260c54",
        "title": "Happy",
        "newSlug": "happy_kals",
        "
      }
    ]
  }
}
```

ç¼–å†™å·¥å…·ç±»ä»£ç ï¼š

```java
@Slf4j
@Component
public class UndrawIllustrationTool {

    private static final String UNDRAW_API_URL = "https://undraw.co/_next/data/mMWmJSt23qpgo8cLTD_pB/search/%s.json?term=%s";

    @Tool("æœç´¢æ’ç”»å›¾ç‰‡ï¼Œç”¨äºç½‘ç«™ç¾åŒ–å’Œè£…é¥°")
    public List<ImageResource> searchIllustrations(@P("æœç´¢å…³é”®è¯") String query) {
        List<ImageResource> imageList = new ArrayList<>();
        int searchCount = 12;
        String apiUrl = String.format(UNDRAW_API_URL, query, query);

        // ä½¿ç”¨ try-with-resources è‡ªåŠ¨é‡Šæ”¾ HTTP èµ„æº
        try (HttpResponse response = HttpRequest.get(apiUrl).timeout(10000).execute()) {
            if (!response.isOk()) {
                return imageList;
            }
            JSONObject result = JSONUtil.parseObj(response.body());
            JSONObject pageProps = result.getJSONObject("pageProps");
            if (pageProps == null) {
                return imageList;
            }
            JSONArray initialResults = pageProps.getJSONArray("initialResults");
            if (initialResults == null || initialResults.isEmpty()) {
                return imageList;
            }
            int actualCount = Math.min(searchCount, initialResults.size());
            for (int i = 0; i < actualCount; i++) {
                JSONObject illustration = initialResults.getJSONObject(i);
                String title = illustration.getStr("title", "æ’ç”»");
                String media = illustration.getStr("media", "");
                if (StrUtil.isNotBlank(media)) {
                    imageList.add(ImageResource.builder()
                            .category(ImageCategoryEnum.ILLUSTRATION)
                            .description(title)
                            .url(media)
                            .build());
                }
            }
        } catch (Exception e) {
            log.error("æœç´¢æ’ç”»å¤±è´¥ï¼š{}", e.getMessage(), e);
        }
        return imageList;
    }
}
```

ç¼–å†™å•å…ƒæµ‹è¯•ï¼š

```java
@SpringBootTest
class UndrawIllustrationToolTest {

    @Resource
    private UndrawIllustrationTool undrawIllustrationTool;

    @Test
    void testSearchIllustrations() {
        // æµ‹è¯•æ­£å¸¸æœç´¢æ’ç”»
        List<ImageResource> illustrations = undrawIllustrationTool.searchIllustrations("happy");
        assertNotNull(illustrations);
        // éªŒè¯è¿”å›çš„æ’ç”»èµ„æº
        ImageResource firstIllustration = illustrations.get(0);
        assertEquals(ImageCategoryEnum.ILLUSTRATION, firstIllustration.getCategory());
        assertNotNull(firstIllustration.getDescription());
        assertNotNull(firstIllustration.getUrl());
        assertTrue(firstIllustration.getUrl().startsWith("http"));
        System.out.println("æœç´¢åˆ° " + illustrations.size() + " å¼ æ’ç”»");
        illustrations.forEach(illustration -> 
            System.out.println("æ’ç”»: " + illustration.getDescription() + " - " + illustration.getUrl())
        );
    }
}
```

æ‰§è¡Œå•å…ƒæµ‹è¯•ï¼Œæ•ˆæœå¦‚å›¾ï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/HAidc9to7uUrdSsi.webp "null")

#### 3ã€æ¶æ„å›¾ç»˜åˆ¶å·¥å…·

ç”±äºæ¶æ„å›¾æ˜¯éœ€è¦æ ¹æ®ç‰¹å®šçš„æè¿°æ¥å®šåˆ¶çš„ï¼Œâ ä¸èƒ½ç›´æ¥ä¸Šç½‘æœç´¢ï¼Œå› æ­¤æˆ‘ä»¬â çš„æ€è·¯æ˜¯å°† AI è°ƒç”¨å·¥å…·æ—¶ä¼ å…¥çš„ Mermaid æ–‡æœ¬ç»˜å›¾ä»£ç è½¬æ¢æˆå›¾ç‰‡ã€‚

è¿™é‡Œæœ‰å‡ ç§æ–¹æ¡ˆï¼š

1ï¼‰mermaid-cli + COSï¼ˆæ¨èï¼‰ï¼šå…ˆåˆ©ç”¨ Mermaid CLI å·¥å…·å°†æ–‡æœ¬ç»˜å›¾ä»£ç è½¬æ¢ä¸ºå›¾ç‰‡ï¼Œä¹‹åä¸Šä¼ åˆ° COS å¯¹è±¡å­˜å‚¨æ‹¿åˆ°å¯¹åº”çš„ URL åœ°å€æ–¹ä¾¿åç»­ä½¿ç”¨ã€‚

2ï¼‰Mermaid æ–‡æœ¬ç”Ÿå›¾ APIï¼šæ¯”å¦‚ [Kroki](https://kroki.io/)ã€[Mermaid Ink](http://mermaid.ink/) ç­‰ï¼Œå¯ä»¥ç›´æ¥åœ¨çº¿ç”Ÿæˆã€‚ä¼˜ç‚¹æ˜¯ä½¿ç”¨æ–¹ä¾¿ç¼ºç‚¹ï¼Œç¼ºç‚¹æ˜¯ç”Ÿæˆæ…¢ã€è€Œä¸”å›¾ç‰‡åœ°å€å¤ªé•¿ï¼

![](https://pic.code-nav.cn/course_picture/1608440217629360130/GtnX21HsDNzVdYo0.webp)

3ï¼‰Mermaid æ–‡æœ¬ç”Ÿå›¾ MCPï¼šæœ‰ä¸€äº› [å¼€æºçš„ MCP æœåŠ¡](https://github.com/peng-shawn/mermaid-mcp-server)ï¼Œä¼˜ç‚¹æ˜¯ä½¿ç”¨æ–¹ä¾¿ï¼Œç¼ºç‚¹æ˜¯ä¸æ–¹ä¾¿å®šåˆ¶ã€è€Œä¸”å›¾ç‰‡ä¼šäº¤ç»™åˆ«äººæ¥å­˜å‚¨ã€‚

æ¨èæ–¹æ¡ˆä¸€ï¼Œå®ç°æˆæœ¬ä¹Ÿä¸å¤§ã€‚

é¦–å…ˆå®‰è£…å¿…å¤‡çš„ mermaid-cli å·¥å…·ï¼š

```shell
npm install -g @mermaid-js/mermaid-cli
```

ç¼–å†™å·¥å…·ä»£ç ï¼Œé€šè¿‡è°ƒç”¨ç»ˆç«¯æ‰§â è¡Œ mermaidâ -cli å‘½ä»¤å°†æ–‡æœ¬è½¬ä¸ºå›¾ç‰‡ï¼Œç„¶åä¸Šä¼ åˆ° COS å¯¹è±¡å­˜å‚¨ä¸­ï¼š

```java
@Slf4j
@Component
public class MermaidDiagramTool {

    @Resource
    private CosManager cosManager;
    
    @Tool("å°† Mermaid ä»£ç è½¬æ¢ä¸ºæ¶æ„å›¾å›¾ç‰‡ï¼Œç”¨äºå±•ç¤ºç³»ç»Ÿç»“æ„å’ŒæŠ€æœ¯å…³ç³»")
    public List<ImageResource> generateMermaidDiagram(@P("Mermaid å›¾è¡¨ä»£ç ") String mermaidCode,
                                                      @P("æ¶æ„å›¾æè¿°") String description) {
        if (StrUtil.isBlank(mermaidCode)) {
            return new ArrayList<>();
        }
        try {
            // è½¬æ¢ä¸ºSVGå›¾ç‰‡
            File diagramFile = convertMermaidToSvg(mermaidCode);
            // ä¸Šä¼ åˆ°COS
            String keyName = String.format("/mermaid/%s/%s",
                    RandomUtil.randomString(5), diagramFile.getName());
            String cosUrl = cosManager.uploadFile(keyName, diagramFile);
            // æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            FileUtil.del(diagramFile);
            if (StrUtil.isNotBlank(cosUrl)) {
                return Collections.singletonList(ImageResource.builder()
                        .category(ImageCategoryEnum.ARCHITECTURE)
                        .description(description)
                        .url(cosUrl)
                        .build());
            }
        } catch (Exception e) {
            log.error("ç”Ÿæˆæ¶æ„å›¾å¤±è´¥: {}", e.getMessage(), e);
        }
        return new ArrayList<>();
    }

    /**
     * å°†Mermaidä»£ç è½¬æ¢ä¸ºSVGå›¾ç‰‡
     */
    private File convertMermaidToSvg(String mermaidCode) {
        // åˆ›å»ºä¸´æ—¶è¾“å…¥æ–‡ä»¶
        File tempInputFile = FileUtil.createTempFile("mermaid_input_", ".mmd", true);
        FileUtil.writeUtf8String(mermaidCode, tempInputFile);
        // åˆ›å»ºä¸´æ—¶è¾“å‡ºæ–‡ä»¶
        File tempOutputFile = FileUtil.createTempFile("mermaid_output_", ".svg", true);
        // æ ¹æ®æ“ä½œç³»ç»Ÿé€‰æ‹©å‘½ä»¤
        String command = SystemUtil.getOsInfo().isWindows() ? "mmdc.cmd" : "mmdc";
        // æ„å»ºå‘½ä»¤
        String cmdLine = String.format("%s -i %s -o %s -b transparent",
                command,
                tempInputFile.getAbsolutePath(),
                tempOutputFile.getAbsolutePath()
        );
        // æ‰§è¡Œå‘½ä»¤
        RuntimeUtil.execForStr(cmdLine);
        // æ£€æŸ¥è¾“å‡ºæ–‡ä»¶
        if (!tempOutputFile.exists() || tempOutputFile.length() == 0) {
            throw new BusinessException(ErrorCode.SYSTEM_ERROR, "Mermaid CLI æ‰§è¡Œå¤±è´¥");
        }
        // æ¸…ç†è¾“å…¥æ–‡ä»¶ï¼Œä¿ç•™è¾“å‡ºæ–‡ä»¶ä¾›ä¸Šä¼ ä½¿ç”¨
        FileUtil.del(tempInputFile);
        return tempOutputFile;
    }
}
```

ä¸Šè¿°ä»£ç ä¸­çš„å‡ ä¸ªæ³¨æ„äº‹é¡¹ï¼š

1.  é€šè¿‡ Hutool çš„ `SystemUtil.getOsInfo().isWindows()` åˆ¤æ–­æ“ä½œç³»ç»Ÿ
2.  é€šè¿‡ Hutool çš„ `RuntimeUtil` æ‰§è¡Œç»ˆç«¯å‘½ä»¤

ç¼–å†™å•å…ƒæµ‹è¯•ï¼š

```java
@SpringBootTest
class MermaidDiagramToolTest {

    @Resource
    private MermaidDiagramTool mermaidDiagramTool;

    @Test
    void testGenerateMermaidDiagram() {
        // æµ‹è¯•ç”Ÿæˆ Mermaid æ¶æ„å›¾
        String mermaidCode = """
                flowchart LR
                    Start([å¼€å§‹]) --> Input[è¾“å…¥æ•°æ®]
                    Input --> Process[å¤„ç†æ•°æ®]
                    Process --> Decision{æ˜¯å¦æœ‰æ•ˆ?}
                    Decision -->|æ˜¯| Output[è¾“å‡ºç»“æœ]
                    Decision -->|å¦| Error[é”™è¯¯å¤„ç†]
                    Output --> End([ç»“æŸ])
                    Error --> End
                """;
        String description = "ç®€å•ç³»ç»Ÿæ¶æ„å›¾";
        List<ImageResource> diagrams = mermaidDiagramTool.generateMermaidDiagram(mermaidCode, description);
        assertNotNull(diagrams);
        // å¦‚æœæœ‰ç»“æœï¼ŒéªŒè¯å›¾è¡¨èµ„æº
        ImageResource firstDiagram = diagrams.get(0);
        assertEquals(ImageCategoryEnum.ARCHITECTURE, firstDiagram.getCategory());
        assertEquals(description, firstDiagram.getDescription());
        assertNotNull(firstDiagram.getUrl());
        assertTrue(firstDiagram.getUrl().startsWith("http"));
        System.out.println("ç”Ÿæˆäº†æ¶æ„å›¾: " + firstDiagram.getUrl());
    }
}
```

æ‰§è¡Œå•å…ƒæµ‹è¯•ï¼Œæ•ˆæœå¦‚å›¾ï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/QSXCtJSyKX3MsnNC.webp "null")

#### 4ã€Logo å›¾ç‰‡ç”Ÿæˆå·¥å…·

ç”±äº Logo å›¾ç‰‡ä¹Ÿæ˜¯éœ€è¦æ ¹æ®æ–‡å­—â å®šåˆ¶ç”Ÿæˆçš„ï¼Œå› æ­¤éœ€è¦ç”¨åˆ°â  AI æ–‡ç”Ÿå›¾æ¨¡å‹ï¼Œæˆ–è€…æ–‡ç”Ÿå›¾ MCP æœåŠ¡ï¼ˆæ¯”å¦‚ MiniMaxï¼‰ã€‚

æ­¤å¤„é€‰æ‹©æ¥å…¥é˜¿é‡Œäº‘ç™¾ç‚¼å¹³å°çš„â  AI å¤§æ¨¡å‹ï¼Œä¼šâ æ¯” MCP æœåŠ¡æ›´çµæ´»ã€‚

![](https://pic.code-nav.cn/course_picture/1608440217629360130/s5Ku6ICyCnJ2YB1l.webp)

ç”¨æ³•å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼š

-   SDK æ–‡æ¡£ï¼š[https://bailian.console.aliyun.com/?type=model&tab=api#/api/?type=model&url=https%3A%2F%2Fhelp.aliyun.com%2Fdocument\_detail%2F2712193.html&renderType=iframe](https://bailian.console.aliyun.com/?type=model&tab=api#/api/?type=model&url=https%3A%2F%2Fhelp.aliyun.com%2Fdocument_detail%2F2712193.html&renderType=iframe)
-   æ–‡ç”Ÿå›¾ API å‚è€ƒï¼š[https://help.aliyun.com/zh/model-studio/text-to-image-v2-api-reference](https://help.aliyun.com/zh/model-studio/text-to-image-v2-api-reference)

1ï¼‰å¼•å…¥ä¾èµ–ï¼š

```xml
<!-- é˜¿é‡Œäº‘ DashScope SDK -->
<dependency>
    <groupId>com.alibaba</groupId>
    <artifactId>dashscope-sdk-java</artifactId>
    <version>2.21.1</version>
</dependency>
```

2ï¼‰ä»æ§åˆ¶å° [è·å– API Key](https://bailian.console.aliyun.com/?type=model&tab=model#/api-key)ï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/nf0RMvL2lrcNy0pv.webp)

ç¼–å†™é…ç½®ï¼š

```yaml
# é˜¿é‡Œäº‘ DashScope é…ç½®
dashscope:
  api-key: <Your API Key>
  image-model: wan2.2-t2i-flash
```

3ï¼‰ç¼–å†™å·¥å…·ç±»ä»£ç ï¼Œè¯»å–é…ç½®â å¹¶æ„é€ å‘ AI çš„â è¯·æ±‚ï¼Œç„¶åå¾—åˆ°å›¾ç‰‡åˆ—è¡¨ã€‚

```java
@Slf4j
@Component
public class LogoGeneratorTool {

    @Value("${dashscope.api-key:}")
    private String dashScopeApiKey;

    @Value("${dashscope.image-model:wan2.2-t2i-flash}")
    private String imageModel;

    @Tool("æ ¹æ®æè¿°ç”Ÿæˆ Logo è®¾è®¡å›¾ç‰‡ï¼Œç”¨äºç½‘ç«™å“ç‰Œæ ‡è¯†")
    public List<ImageResource> generateLogos(@P("Logo è®¾è®¡æè¿°ï¼Œå¦‚åç§°ã€è¡Œä¸šã€é£æ ¼ç­‰ï¼Œå°½é‡è¯¦ç»†") String description) {
        List<ImageResource> logoList = new ArrayList<>();
        try {
            // æ„å»º Logo è®¾è®¡æç¤ºè¯
            String logoPrompt = String.format("ç”Ÿæˆ Logoï¼ŒLogo ä¸­ç¦æ­¢åŒ…å«ä»»ä½•æ–‡å­—ï¼Logo ä»‹ç»ï¼š%s", description);
            ImageSynthesisParam param = ImageSynthesisParam.builder()
                    .apiKey(dashScopeApiKey)
                    .model(imageModel)
                    .prompt(logoPrompt)
                    .size("512*512")
                    .n(1) // ç”Ÿæˆ 1 å¼ è¶³å¤Ÿï¼Œå› ä¸º AI ä¸çŸ¥é“å“ªå¼ æœ€å¥½
                    .build();
            ImageSynthesis imageSynthesis = new ImageSynthesis();
            ImageSynthesisResult result = imageSynthesis.call(param);
            if (result != null && result.getOutput() != null && result.getOutput().getResults() != null) {
                List<Map<String, String>> results = result.getOutput().getResults();
                for (Map<String, String> imageResult : results) {
                    String imageUrl = imageResult.get("url");
                    if (StrUtil.isNotBlank(imageUrl)) {
                        logoList.add(ImageResource.builder()
                                .category(ImageCategoryEnum.LOGO)
                                .description(description)
                                .url(imageUrl)
                                .build());
                    }
                }
            }
        } catch (Exception e) {
            log.error("ç”Ÿæˆ Logo å¤±è´¥: {}", e.getMessage(), e);
        }
        return logoList;
    }
}
```

æ³¨æ„ï¼Œè™½ç„¶ API æ”¯æŒä¸€æ¬¡æ€§ç”Ÿæˆå¤šå¼ å›¾ç‰‡ï¼Œä½†å¯¹æˆ‘ä»¬æ¥â è¯´ 1 å¼ è¶³å¤Ÿäº†ï¼Œèƒ½çœåˆ™çœï¼Œæ¯•ç«Ÿç¨‹åºâ ä¹Ÿåˆ¤æ–­ä¸å‡ºæ¥è¦ç”¨å“ªå¼  Logoã€‚ä¸è¿‡è¿”å›å€¼è¿˜æ˜¯ä½¿ç”¨åˆ—è¡¨ï¼Œè¿™æ—¶ä¸ºäº†ä¾¿äº AI ç†è§£ï¼Œç”Ÿæˆå¤±è´¥å°±æ˜¯åˆ—è¡¨ä¸ºç©ºã€‚

è¿™ç©æ„æŒºè´µçš„ï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/1FTjFNXHhbi89Bwy.webp)

ç¼–å†™å•å…ƒæµ‹è¯•ï¼š

```java
@SpringBootTest
class LogoGeneratorToolTest {

    @Resource
    private LogoGeneratorTool logoGeneratorTool;

    @Test
    void testGenerateLogos() {
        // æµ‹è¯•ç”ŸæˆLogo
        List<ImageResource> logos = logoGeneratorTool.generateLogos("æŠ€æœ¯å…¬å¸ç°ä»£ç®€çº¦é£æ ¼Logo");
        assertNotNull(logos);
        ImageResource firstLogo = logos.getFirst();
        assertEquals(ImageCategoryEnum.LOGO, firstLogo.getCategory());
        assertNotNull(firstLogo.getDescription());
        assertNotNull(firstLogo.getUrl());
        logos.forEach(logo ->
                System.out.println("Logo: " + logo.getDescription() + " - " + logo.getUrl())
        );
    }
}
```

æ‰§è¡Œå•å…ƒæµ‹è¯•ï¼Œæ•ˆæœå¦‚å›¾ï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/VAieXJqXgr0B866G.webp "null")

ğŸ’¡ æ³¨æ„ï¼Œæ¨¡å‹ç”Ÿæˆçš„å›¾åƒå­˜å‚¨äºé˜¿é‡Œäº‘ OSSï¼Œæ¯å¼ å›¾åƒä¼šè¢«åˆ†é…ä¸€ä¸ªOSSé“¾æ¥ï¼Œå¦‚`https://dashscope-result-xx.oss-cn-xxxx.aliyuncs.com/xxx.png`ã€‚OSS é“¾æ¥å…è®¸å…¬å¼€è®¿é—®ï¼Œå¯ä»¥ä½¿ç”¨æ­¤é“¾æ¥æŸ¥çœ‹æˆ–è€…ä¸‹è½½å›¾ç‰‡ï¼Œ**ä½†æ˜¯é“¾æ¥ä»…åœ¨ 24 å°æ—¶å†…æœ‰æ•ˆ**ã€‚å› æ­¤å»ºè®®å°†å›¾ç‰‡ä¸‹è½½å¹¶ä¿å­˜åˆ°è‡ªå·±çš„å¯¹è±¡å­˜å‚¨ä¸­ã€‚

#### 5ã€å›¾ç‰‡æ”¶é›† AI æœåŠ¡

å†™ä¸€æ®µ AI æ”¶é›†å›¾ç‰‡çš„æç¤ºè¯ï¼Œå•ç‹¬ä¿å­˜åœ¨èµ„æºæ–‡ä»¶ `image-collection-system-prompt.txt` ä¸­ï¼š

```markdown
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å›¾ç‰‡æ”¶é›†åŠ©æ‰‹ã€‚æ ¹æ®ç”¨æˆ·çš„ç½‘ç«™éœ€æ±‚ï¼Œæ™ºèƒ½é€‰æ‹©å¹¶è°ƒç”¨ç›¸åº”çš„å·¥å…·æ”¶é›†ä¸åŒç±»å‹çš„å›¾ç‰‡èµ„æºã€‚

ä½ å¯ä»¥æ ¹æ®éœ€è¦è°ƒç”¨ä¸‹é¢å¤šä¸ªå·¥å…·ï¼Œæ”¶é›†å…¨é¢çš„å›¾ç‰‡èµ„æºï¼š
1. searchContentImages - æœç´¢å†…å®¹ç›¸å…³å›¾ç‰‡ï¼Œç”¨äºç½‘ç«™å†…å®¹å±•ç¤º
2. searchIllustrations - æœç´¢æ’ç”»å›¾ç‰‡ï¼Œç”¨äºç½‘ç«™ç¾åŒ–å’Œè£…é¥°  
3. generateArchitectureDiagram - æ ¹æ®æŠ€æœ¯ä¸»é¢˜ç”Ÿæˆæ¶æ„å›¾ï¼Œç”¨äºå±•ç¤ºç³»ç»Ÿç»“æ„å’ŒæŠ€æœ¯å…³ç³»
4. generateLogos - æ ¹æ®æè¿°ç”ŸæˆLogoè®¾è®¡å›¾ç‰‡ï¼Œç”¨äºç½‘ç«™å“ç‰Œæ ‡è¯†

è¯·æ ¹æ®ç”¨æˆ·çš„éœ€æ±‚åˆ†æï¼Œä¼˜å…ˆé€‰æ‹©ä¸ç”¨æˆ·éœ€æ±‚æœ€ç›¸å…³çš„å›¾ç‰‡ç±»å‹ï¼š
- å¦‚æœæ¶‰åŠæŠ€æœ¯ã€ç³»ç»Ÿã€æ¶æ„ç­‰å†…å®¹ï¼Œè°ƒç”¨ generateArchitectureDiagram ç”Ÿæˆæ¶æ„å›¾
- å¦‚æœéœ€è¦å“ç‰Œæ ‡è¯†ã€Logoè®¾è®¡ï¼Œè°ƒç”¨ generateLogos ç”ŸæˆLogo
- å¦‚æœéœ€è¦å†…å®¹ç›¸å…³å›¾ç‰‡ï¼Œè°ƒç”¨ searchContentImages æœç´¢å›¾ç‰‡
- å¦‚æœéœ€è¦è£…é¥°æ€§æ’ç”»ï¼Œè°ƒç”¨ searchIllustrations æœç´¢æ’ç”»

ä½ å¿…é¡»æŒ‰ç…§ JSON æ ¼å¼è¾“å‡ºï¼
```

ç„¶åç¼–å†™å›¾ç‰‡æ”¶é›† AI æœâ åŠ¡ã€‚ç†æƒ³æƒ…å†µä¸‹ AIâ  æœåŠ¡è‚¯å®šæ˜¯é‡‡ç”¨ç»“æ„åŒ–è¾“å‡ºï¼š

```java
/**
 * å›¾ç‰‡æ”¶é›† AI æœåŠ¡æ¥å£
 * ä½¿ç”¨ AI è°ƒç”¨å·¥å…·æ”¶é›†ä¸åŒç±»å‹çš„å›¾ç‰‡èµ„æº
 */
public interface ImageCollectionService {

    /**
     * æ ¹æ®ç”¨æˆ·æç¤ºè¯æ”¶é›†æ‰€éœ€çš„å›¾ç‰‡èµ„æº
     * AI ä¼šæ ¹æ®éœ€æ±‚è‡ªä¸»é€‰æ‹©è°ƒç”¨ç›¸åº”çš„å·¥å…·
     */
    @SystemMessage(fromResource = "prompt/image-collection-system-prompt.txt")
    List<ImageResource> collectImages(@UserMessage String userPrompt);
}
```

ä½†ç”±äºæˆ‘ä»¬è¿”å›çš„æ˜¯ `List<POJO>` ç±»å‹ï¼Œè¿™é‡Œä¼šé‡åˆ°ä¸€äº›å‘ï¼

é¦–å…ˆï¼Œè¦é…ç½®ç»“æ„åŒ–è¾“å‡ºçš„ [JSON Schema](https://docs.langchain4j.dev/tutorials/structured-outputs#supported-types)ï¼Œå¿…é¡»è¦å¼€å¯ä¸‹åˆ—è®¾ç½®æ‰èƒ½æ”¯æŒè¿”å›è¿™ç§ç±»å‹ï¼š

```java
supportedCapabilities(RESPONSE_FORMAT_JSON_SCHEMA)
```

![](https://pic.code-nav.cn/course_picture/1608440217629360130/HrS3qu8JuyiWmcQR.webp)

å¦åˆ™ä¼šæŠ¥é”™ï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/7jyIseXHhU2rEh4N.webp "null")

ä½†æ˜¯ï¼ŒDeepSeek æ¨¡å‹åˆä¸æ”¯æŒè¿™ä¸ªå‚æ•°ï¼å’‹åŠï¼Ÿ

è¿™é‡Œé±¼çš®å…ˆå°è¯•äº† [é˜¿é‡Œäº‘ç™¾ç‚¼æ¨¡å‹](https://help.aliyun.com/zh/model-studio/use-qwen-by-calling-api)ï¼Œå› ä¸ºå®ƒä¹Ÿå…¼å®¹ Open AIï¼Œä½†æ˜¯å¿…é¡»è¦åœ¨æç¤ºè¯ä¸­å¼•å¯¼ AI å›å¤ JSON æ ¼å¼ï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/LR785Zx0A6GXMBZw.webp)

å¦åˆ™ä¼šæŠ¥é”™ï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/XQTafKjhF0Dm0RC6.webp "null")

ç»“æœï¼Œæˆ‘æµ‹è¯•é˜¿é‡Œäº‘ç™¾ç‚¼å¤§æ¨¡å‹â æ—¶å‘ç°ï¼ŒAI çš„å·¥â å…·è°ƒç”¨æ„å›¾è¢«é”™è¯¯åœ°å°è¯•è§£æä¸ºç»“æ„åŒ–è¾“å‡ºçš„è¿”å›å€¼ï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/A84m2ldEI1ry4Jjj.webp "null")

æ‰€ä»¥ï¼Œæœ€ç»ˆçš„è§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨ DeepSeek æ¨¡å‹ï¼Œâ ä½†æ˜¯ä¸ä½¿ç”¨ç»“æ„åŒ–è¾“å‡ºèƒ½åŠ›ï¼Œæ–¹æ³•ç›´æ¥â è¿”å› Stringï¼Œåœ¨åç»­çš„æç¤ºè¯å¢å¼ºèŠ‚ç‚¹ä¸­ç›´æ¥ä½¿ç”¨ AI è¾“å‡ºçš„ä¿¡æ¯å³å¯ï¼Œå¹²è„†å°±ä¸ç»“æ„åŒ–äº†ã€‚

å› æ­¤å¯ä»¥å…ˆå¤ç”¨åŸæœ‰çš„ Chaâ tModel é…ç½®â ï¼Œæ— éœ€æ–°è‡ªå®šä¹‰ ChatModelã€‚

1ï¼‰åœ¨ `langgraph4j.ai` åŒ…ä¸‹åˆ›å»ºå›¾ç‰‡æ”¶é›† AI æœåŠ¡ï¼š

```java
public interface ImageCollectionService {

    /**
     * æ ¹æ®ç”¨æˆ·æç¤ºè¯æ”¶é›†æ‰€éœ€çš„å›¾ç‰‡èµ„æº
     * AI ä¼šæ ¹æ®éœ€æ±‚è‡ªä¸»é€‰æ‹©è°ƒç”¨ç›¸åº”çš„å·¥å…·
     */
    @SystemMessage(fromResource = "prompt/image-collection-system-prompt.txt")
    String collectImages(@UserMessage String userPrompt);
}
```

2ï¼‰åˆ›å»º AI æœåŠ¡åˆ›å»ºå·¥å‚â ï¼Œæ³¨å…¥æŒ‡å®šçš„ châ atModel å’Œå„ç§å›¾ç‰‡æ”¶é›†å·¥å…·ï¼š

```java
@Slf4j
@Configuration
public class ImageCollectionServiceFactory {

    @Resource
    private ChatModel chatModel;

    @Resource
    private ImageSearchTool imageSearchTool;

    @Resource
    private UndrawIllustrationTool undrawIllustrationTool;

    @Resource
    private MermaidDiagramTool mermaidDiagramTool;

    @Resource
    private LogoGeneratorTool logoGeneratorTool;

    /**
     * åˆ›å»ºå›¾ç‰‡æ”¶é›† AI æœåŠ¡
     */
    @Bean
    public ImageCollectionService createImageCollectionService() {
        return AiServices.builder(ImageCollectionService.class)
                .chatModel(chatModel)
                .tools(
                        imageSearchTool,
                        undrawIllustrationTool,
                        mermaidDiagramTool,
                        logoGeneratorTool
                )
                .build();
    }
}
```

3ï¼‰ç»™ WorkflowCoâ ntext çŠ¶æ€æ–°â å¢å›¾ç‰‡èµ„æºå­—ç¬¦ä¸²å­—æ®µï¼Œç”¨äºæ¥æ”¶ AI è¾“å‡ºçš„å›¾ç‰‡ä¿¡æ¯ï¼š

```java
/**
 * å›¾ç‰‡èµ„æºå­—ç¬¦ä¸²
 */
private String imageListStr;
```

4ï¼‰ç¼–å†™å•å…ƒæµ‹è¯•ï¼ŒéªŒè¯ AI å›¾ç‰‡æ”¶é›†æœåŠ¡ï¼š

```java
@SpringBootTest
class ImageCollectionServiceTest {

    @Resource
    private ImageCollectionService imageCollectionService;

    @Test
    void testTechWebsiteImageCollection() {
        String result = imageCollectionService.collectImages("åˆ›å»ºä¸€ä¸ªæŠ€æœ¯åšå®¢ç½‘ç«™ï¼Œéœ€è¦å±•ç¤ºç¼–ç¨‹æ•™ç¨‹å’Œç³»ç»Ÿæ¶æ„");
        Assertions.assertNotNull(result);
        System.out.println("æŠ€æœ¯ç½‘ç«™æ”¶é›†åˆ°çš„å›¾ç‰‡: " + result);
    }

    @Test
    void testEcommerceWebsiteImageCollection() {
        String result = imageCollectionService.collectImages("åˆ›å»ºä¸€ä¸ªç”µå•†è´­ç‰©ç½‘ç«™ï¼Œéœ€è¦å±•ç¤ºå•†å“å’Œå“ç‰Œå½¢è±¡");
        Assertions.assertNotNull(result);
        System.out.println("ç”µå•†ç½‘ç«™æ”¶é›†åˆ°çš„å›¾ç‰‡: " + result);
    }
}
```

æ‰§è¡Œæ•ˆæœå¦‚å›¾ï¼Œè¿˜æŒºä¸é”™çš„ï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/XmxbvY9LTYuWxa8F.webp)

#### 6ã€å·¥ä½œèŠ‚ç‚¹å¼€å‘

å·¥ä½œèŠ‚ç‚¹éœ€è¦è°ƒç”¨ AI æœåŠ¡â æ”¶é›†å›¾ç‰‡ï¼Œå¹¶æ›´æ–°çŠ¶â æ€çš„ imageListStr å­—æ®µã€‚

ç”±äºç›®å‰æˆ‘ä»¬çš„å·¥ä½œèŠ‚ç‚¹ç±»éƒ½æ˜¯é€šè¿‡é™æ€æ–¹æ³•æä¾›å·¥ä½œèŠ‚ç‚¹çš„ï¼Œå¯ä»¥å†™ä¸€ä¸ªè·å– Spring Bean çš„é™æ€å·¥å…·ç±»ï¼Œå°±å¯ä»¥åœ¨é™æ€æ–¹æ³•ä¸­è·å–åˆ° `ImageCollectionService` äº†ï¼Œè¿™æ ·å°±ä¸ç”¨ä¿®æ”¹åŸæœ¬çš„ä»£ç ã€‚

```java
/**
 * Springä¸Šä¸‹æ–‡å·¥å…·ç±»
 * ç”¨äºåœ¨é™æ€æ–¹æ³•ä¸­è·å–Spring Bean
 */
@Component
public class SpringContextUtil implements ApplicationContextAware {

    private static ApplicationContext applicationContext;

    @Override
    public void setApplicationContext(ApplicationContext applicationContext) throws BeansException {
        SpringContextUtil.applicationContext = applicationContext;
    }

    /**
     * è·å–Spring Bean
     */
    public static <T> T getBean(Class<T> clazz) {
        return applicationContext.getBean(clazz);
    }

    /**
     * è·å–Spring Bean
     */
    public static Object getBean(String name) {
        return applicationContext.getBean(name);
    }

    /**
     * æ ¹æ®åç§°å’Œç±»å‹è·å–Spring Bean
     */
    public static <T> T getBean(String name, Class<T> clazz) {
        return applicationContext.getBean(name, clazz);
    }
}
```

åœ¨é™æ€æ–¹æ³•ä¸­è·å–æŒ‡å®š Beanï¼š

```java
// è·å–AIå›¾ç‰‡æ”¶é›†æœåŠ¡
ImageCollectionService imageCollectionService = SpringContextUtil.getBean(ImageCollectionService.class);
```

ä»£ç å¦‚ä¸‹ï¼š

```java
/**
 * å›¾ç‰‡æ”¶é›†èŠ‚ç‚¹
 * ä½¿ç”¨AIè¿›è¡Œå·¥å…·è°ƒç”¨ï¼Œæ”¶é›†ä¸åŒç±»å‹çš„å›¾ç‰‡
 */
@Slf4j
public class ImageCollectorNode {

    public static AsyncNodeAction<MessagesState<String>> create() {
        return node_async(state -> {
            WorkflowContext context = WorkflowContext.getContext(state);
            String originalPrompt = context.getOriginalPrompt();
            String imageListStr = "";
            try {
                // è·å–AIå›¾ç‰‡æ”¶é›†æœåŠ¡
                ImageCollectionService imageCollectionService = SpringContextUtil.getBean(ImageCollectionService.class);
                // ä½¿ç”¨ AI æœåŠ¡è¿›è¡Œæ™ºèƒ½å›¾ç‰‡æ”¶é›†
                imageListStr = imageCollectionService.collectImages(originalPrompt);
                imageCollectionService.collectImages(originalPrompt);
            } catch (Exception e) {
                log.error("å›¾ç‰‡æ”¶é›†å¤±è´¥: {}", e.getMessage(), e);
            }
            // æ›´æ–°çŠ¶æ€
            context.setCurrentStep("å›¾ç‰‡æ”¶é›†");
            context.setImageListStr(imageListStr);
            return WorkflowContext.saveContext(context);
        });
    }
}
```

### æç¤ºè¯å¢å¼ºèŠ‚ç‚¹

å°†è·å–åˆ°çš„å›¾ç‰‡ä¿¡æ¯æ‹¼æ¥åˆ°åŸå§‹â æç¤ºè¯ä¸‹ï¼Œå¹¶åœ¨æ‹¼æ¥â æç¤ºè¯æ—¶å¼•å¯¼ AI åˆ©ç”¨è¿™äº›å›¾ç‰‡ä¿¡æ¯ä½œä¸ºç½‘ç«™ç´ æã€‚

æ‹¼æ¥çš„æç¤ºè¯ç¤ºä¾‹ï¼š

```markdown
## å¯ç”¨ç´ æèµ„æº
è¯·åœ¨ç”Ÿæˆç½‘ç«™ä½¿ç”¨ä»¥ä¸‹å›¾ç‰‡èµ„æºï¼Œå°†è¿™äº›å›¾ç‰‡åˆç†åœ°åµŒå…¥åˆ°ç½‘ç«™çš„ç›¸åº”ä½ç½®ä¸­ã€‚
- æ¶æ„å›¾ï¼šç¼–ç¨‹å­¦ä¹ ç½‘ç«™æ¶æ„ï¼ˆhttps://www.codefather.cn/logo.pngï¼‰
- Logoå›¾ç‰‡ï¼šç¼–ç¨‹å¯¼èˆªå­¦ä¹ åœˆçš„ Logoï¼ˆhttps://www.codefather.cn/logo.pngï¼‰
```

ç¼–å†™å·¥ä½œèŠ‚ç‚¹ä»£ç ï¼š

```java
@Slf4j
public class PromptEnhancerNode {

    public static AsyncNodeAction<MessagesState<String>> create() {
        return node_async(state -> {
            WorkflowContext context = WorkflowContext.getContext(state);
            log.info("æ‰§è¡ŒèŠ‚ç‚¹: æç¤ºè¯å¢å¼º");
            // è·å–åŸå§‹æç¤ºè¯å’Œå›¾ç‰‡åˆ—è¡¨
            String originalPrompt = context.getOriginalPrompt();
            String imageListStr = context.getImageListStr();
            List<ImageResource> imageList = context.getImageList();
            // æ„å»ºå¢å¼ºåçš„æç¤ºè¯
            StringBuilder enhancedPromptBuilder = new StringBuilder();
            enhancedPromptBuilder.append(originalPrompt);
            // å¦‚æœæœ‰å›¾ç‰‡èµ„æºï¼Œåˆ™æ·»åŠ å›¾ç‰‡ä¿¡æ¯
            if (CollUtil.isNotEmpty(imageList) || StrUtil.isNotBlank(imageListStr)) {
                enhancedPromptBuilder.append("\n\n## å¯ç”¨ç´ æèµ„æº\n");
                enhancedPromptBuilder.append("è¯·åœ¨ç”Ÿæˆç½‘ç«™ä½¿ç”¨ä»¥ä¸‹å›¾ç‰‡èµ„æºï¼Œå°†è¿™äº›å›¾ç‰‡åˆç†åœ°åµŒå…¥åˆ°ç½‘ç«™çš„ç›¸åº”ä½ç½®ä¸­ã€‚\n");
                if (CollUtil.isNotEmpty(imageList)) {
                    for (ImageResource image : imageList) {
                        enhancedPromptBuilder.append("- ")
                                .append(image.getCategory().getText())
                                .append("ï¼š")
                                .append(image.getDescription())
                                .append("ï¼ˆ")
                                .append(image.getUrl())
                                .append("ï¼‰\n");
                    }
                } else {
                    enhancedPromptBuilder.append(imageListStr);
                }
            }
            String enhancedPrompt = enhancedPromptBuilder.toString();
            // æ›´æ–°çŠ¶æ€
            context.setCurrentStep("æç¤ºè¯å¢å¼º");
            context.setEnhancedPrompt(enhancedPrompt);
            log.info("æç¤ºè¯å¢å¼ºå®Œæˆï¼Œå¢å¼ºåé•¿åº¦: {} å­—ç¬¦", enhancedPrompt.length());
            return WorkflowContext.saveContext(context);
        });
    }
}
```

æ³¨æ„ï¼Œæ‹¼æ¥æç¤ºè¯æ—¶è¦å…¼å®¹è¯»å–å›¾â ç‰‡åˆ—è¡¨å­—ç¬¦ä¸²ã€ä»¥åŠå›¾â ç‰‡å¯¹è±¡åˆ—è¡¨ã€‚è™½ç„¶ç°åœ¨å›¾ç‰‡å¯¹è±¡åˆ—è¡¨æ²¡æœ‰èµ‹å€¼ï¼Œä½†ä¹‹åæˆ‘ä»¬ä¼šä¼˜åŒ–ã€‚

### æ™ºèƒ½è·¯ç”±èŠ‚ç‚¹

æ ¹æ®ç”¨æˆ·çš„åŸå§‹æç¤ºè¯é€‰æ‹©å¯¹åº”çš„ç½‘ç«™ç”Ÿæˆæ–¹å¼ï¼Œåˆ©ç”¨é¡¹ç›®å·²æœ‰çš„ `AiCodeGenTypeRoutingService` å®ç°å³å¯ï¼Œé€»è¾‘å‚è€ƒ `createApp` æ–¹æ³•çš„å®ç°ã€‚

ç¼–å†™æ™ºèƒ½è·¯ç”±å·¥ä½œèŠ‚ç‚¹ï¼š

```java
@Slf4j
public class RouterNode {

    public static AsyncNodeAction<MessagesState<String>> create() {
        return node_async(state -> {
            WorkflowContext context = WorkflowContext.getContext(state);
            log.info("æ‰§è¡ŒèŠ‚ç‚¹: æ™ºèƒ½è·¯ç”±");

            CodeGenTypeEnum generationType;
            try {
                // è·å–AIè·¯ç”±æœåŠ¡
                AiCodeGenTypeRoutingService routingService = SpringContextUtil.getBean(AiCodeGenTypeRoutingService.class);
                // æ ¹æ®åŸå§‹æç¤ºè¯è¿›è¡Œæ™ºèƒ½è·¯ç”±
                generationType = routingService.routeCodeGenType(context.getOriginalPrompt());
                log.info("AIæ™ºèƒ½è·¯ç”±å®Œæˆï¼Œé€‰æ‹©ç±»å‹: {} ({})", generationType.getValue(), generationType.getText());
            } catch (Exception e) {
                log.error("AIæ™ºèƒ½è·¯ç”±å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤HTMLç±»å‹: {}", e.getMessage());
                generationType = CodeGenTypeEnum.HTML;
            }

            // æ›´æ–°çŠ¶æ€
            context.setCurrentStep("æ™ºèƒ½è·¯ç”±");
            context.setGenerationType(generationType);
            return WorkflowContext.saveContext(context);
        });
    }
}
```

### ä»£ç ç”ŸæˆèŠ‚ç‚¹

é¦–å…ˆæ ¹æ®ä»£ç ç”Ÿæˆç±»å‹ï¼Œè°ƒç”¨ `AiCodeGeneratorFacade` ç”Ÿæˆä»£ç ï¼Œè·å¾—æµå¼è¾“å‡ºã€‚ç„¶åè¿˜éœ€è¦åŒæ­¥ç­‰å¾…æµå¼è¾“å‡ºå®Œæˆï¼Œå°†ä»£ç ç”Ÿæˆç›®å½•ä¿å­˜åˆ°çŠ¶æ€ä¸­ï¼Œäº¤ç»™ä¸‹ä¸€ä¸ªå·¥ä½œèŠ‚ç‚¹å»å¤„ç†ã€‚

ä»£ç ç”Ÿæˆå·¥ä½œèŠ‚ç‚¹ä»£ç å¦‚ä¸‹ï¼š

```java
@Slf4j
public class CodeGeneratorNode {

    public static AsyncNodeAction<MessagesState<String>> create() {
        return node_async(state -> {
            WorkflowContext context = WorkflowContext.getContext(state);
            log.info("æ‰§è¡ŒèŠ‚ç‚¹: ä»£ç ç”Ÿæˆ");

            // ä½¿ç”¨å¢å¼ºæç¤ºè¯ä½œä¸ºå‘ç»™ AI çš„ç”¨æˆ·æ¶ˆæ¯
            String userMessage = context.getEnhancedPrompt();
            CodeGenTypeEnum generationType = context.getGenerationType();
            // è·å– AI ä»£ç ç”Ÿæˆå¤–è§‚æœåŠ¡
            AiCodeGeneratorFacade codeGeneratorFacade = SpringContextUtil.getBean(AiCodeGeneratorFacade.class);
            log.info("å¼€å§‹ç”Ÿæˆä»£ç ï¼Œç±»å‹: {} ({})", generationType.getValue(), generationType.getText());
            // å…ˆä½¿ç”¨å›ºå®šçš„ appId (åç»­å†æ•´åˆåˆ°ä¸šåŠ¡ä¸­)
            Long appId = 0L;
            // è°ƒç”¨æµå¼ä»£ç ç”Ÿæˆ
            Flux<String> codeStream = codeGeneratorFacade.generateAndSaveCodeStream(userMessage, generationType, appId);
            // åŒæ­¥ç­‰å¾…æµå¼è¾“å‡ºå®Œæˆ
            codeStream.blockLast(Duration.ofMinutes(10)); // æœ€å¤šç­‰å¾… 10 åˆ†é’Ÿ
            // æ ¹æ®ç±»å‹è®¾ç½®ç”Ÿæˆç›®å½•
            String generatedCodeDir = String.format("%s/%s_%s", AppConstant.CODE_OUTPUT_ROOT_DIR, generationType.getValue(), appId);
            log.info("AI ä»£ç ç”Ÿæˆå®Œæˆï¼Œç”Ÿæˆç›®å½•: {}", generatedCodeDir);

            // æ›´æ–°çŠ¶æ€
            context.setCurrentStep("ä»£ç ç”Ÿæˆ");
            context.setGeneratedCodeDir(generatedCodeDir);
            return WorkflowContext.saveContext(context);
        });
    }
}
```

### é¡¹ç›®æ„å»ºèŠ‚ç‚¹

å¦‚æœæ˜¯ Vue å·¥ç¨‹é¡¹ç›®ç±»å‹ï¼Œè°ƒç”¨é¡¹ç›®å·²æœ‰çš„ â VueProjectBuildâ er æ‰“åŒ…æ„å»ºï¼›å¦‚æœæ˜¯å…¶ä»–ç±»å‹ï¼Œç›´æ¥å¿½ç•¥ï¼ˆå› ä¸ºä¸Šä¸€æ­¥æ–‡ä»¶å·²ç»é€šè¿‡ AI å·¥å…·è°ƒç”¨ä¿å­˜ï¼‰ã€‚

é¡¹ç›®æ„å»ºèŠ‚ç‚¹çš„ä»£ç å¦‚ä¸‹ï¼š

```java
@Slf4j
public class ProjectBuilderNode {

    public static AsyncNodeAction<MessagesState<String>> create() {
        return node_async(state -> {
            WorkflowContext context = WorkflowContext.getContext(state);
            log.info("æ‰§è¡ŒèŠ‚ç‚¹: é¡¹ç›®æ„å»º");

            // è·å–å¿…è¦çš„å‚æ•°
            String generatedCodeDir = context.getGeneratedCodeDir();
            CodeGenTypeEnum generationType = context.getGenerationType();
            String buildResultDir;
            // Vue é¡¹ç›®ç±»å‹ï¼šä½¿ç”¨ VueProjectBuilder è¿›è¡Œæ„å»º
            if (generationType == CodeGenTypeEnum.VUE_PROJECT) {
                try {
                    VueProjectBuilder vueBuilder = SpringContextUtil.getBean(VueProjectBuilder.class);
                    // æ‰§è¡Œ Vue é¡¹ç›®æ„å»ºï¼ˆnpm install + npm run buildï¼‰
                    boolean buildSuccess = vueBuilder.buildProject(generatedCodeDir);
                    if (buildSuccess) {
                        // æ„å»ºæˆåŠŸï¼Œè¿”å› dist ç›®å½•è·¯å¾„
                        buildResultDir = generatedCodeDir + File.separator + "dist";
                        log.info("Vue é¡¹ç›®æ„å»ºæˆåŠŸï¼Œdist ç›®å½•: {}", buildResultDir);
                    } else {
                        throw new BusinessException(ErrorCode.SYSTEM_ERROR, "Vue é¡¹ç›®æ„å»ºå¤±è´¥");
                    }
                } catch (Exception e) {
                    log.error("Vue é¡¹ç›®æ„å»ºå¼‚å¸¸: {}", e.getMessage(), e);
                    buildResultDir = generatedCodeDir; // å¼‚å¸¸æ—¶è¿”å›åŸè·¯å¾„
                }
            } else {
                // HTML å’Œ MULTI_FILE ä»£ç ç”Ÿæˆæ—¶å·²ç»ä¿å­˜äº†ï¼Œç›´æ¥ä½¿ç”¨ç”Ÿæˆçš„ä»£ç ç›®å½•
                buildResultDir = generatedCodeDir;
            }

            // æ›´æ–°çŠ¶æ€
            context.setCurrentStep("é¡¹ç›®æ„å»º");
            context.setBuildResultDir(buildResultDir);
            log.info("é¡¹ç›®æ„å»ºèŠ‚ç‚¹å®Œæˆï¼Œæœ€ç»ˆç›®å½•: {}", buildResultDir);
            return WorkflowContext.saveContext(context);
        });
    }
}
```

### å·¥ä½œæµä½¿ç”¨å·¥ä½œèŠ‚ç‚¹

æœ€åï¼Œå°†åŸæœ¬çš„ WorkflowApp æ”¹é€ ä¸ºä¸€â ä¸ªæ–°çš„å·¥ä½œæµ CodeGenWoâ rkflowï¼Œä½œä¸ºæ­£å¼å¯ç”¨çš„ç±»ã€‚ä¸å†æ˜¯é€šè¿‡ main æ–¹æ³•è¿è¡Œï¼Œè€Œæ˜¯æä¾›æ‰§è¡Œå·¥ä½œæµçš„æ–¹æ³•ã€‚

ä»£ç å¦‚ä¸‹ï¼š

```java
@Slf4j
public class CodeGenWorkflow {

    /**
     * åˆ›å»ºå®Œæ•´çš„å·¥ä½œæµ
     */
    public CompiledGraph<MessagesState<String>> createWorkflow() {
        try {
            return new MessagesStateGraph<String>()
                    // æ·»åŠ èŠ‚ç‚¹ - ä½¿ç”¨å®Œæ•´å®ç°çš„èŠ‚ç‚¹
                    .addNode("image_collector", ImageCollectorNode.create())
                    .addNode("prompt_enhancer", PromptEnhancerNode.create())
                    .addNode("router", RouterNode.create())
                    .addNode("code_generator", CodeGeneratorNode.create())
                    .addNode("project_builder", ProjectBuilderNode.create())

                    // æ·»åŠ è¾¹
                    .addEdge(START, "image_collector")
                    .addEdge("image_collector", "prompt_enhancer")
                    .addEdge("prompt_enhancer", "router")
                    .addEdge("router", "code_generator")
                    .addEdge("code_generator", "project_builder")
                    .addEdge("project_builder", END)

                    // ç¼–è¯‘å·¥ä½œæµ
                    .compile();
        } catch (GraphStateException e) {
            throw new BusinessException(ErrorCode.OPERATION_ERROR, "å·¥ä½œæµåˆ›å»ºå¤±è´¥");
        }
    }

    /**
     * æ‰§è¡Œå·¥ä½œæµ
     */
    public WorkflowContext executeWorkflow(String originalPrompt) {
        CompiledGraph<MessagesState<String>> workflow = createWorkflow();

        // åˆå§‹åŒ– WorkflowContext
        WorkflowContext initialContext = WorkflowContext.builder()
                .originalPrompt(originalPrompt)
                .currentStep("åˆå§‹åŒ–")
                .build();

        GraphRepresentation graph = workflow.getGraph(GraphRepresentation.Type.MERMAID);
        log.info("å·¥ä½œæµå›¾:\n{}", graph.content());
        log.info("å¼€å§‹æ‰§è¡Œä»£ç ç”Ÿæˆå·¥ä½œæµ");

        WorkflowContext finalContext = null;
        int stepCounter = 1;
        for (NodeOutput<MessagesState<String>> step : workflow.stream(
                Map.of(WorkflowContext.WORKFLOW_CONTEXT_KEY, initialContext))) {
            log.info("--- ç¬¬ {} æ­¥å®Œæˆ ---", stepCounter);
            // æ˜¾ç¤ºå½“å‰çŠ¶æ€
            WorkflowContext currentContext = WorkflowContext.getContext(step.state());
            if (currentContext != null) {
                finalContext = currentContext;
                log.info("å½“å‰æ­¥éª¤ä¸Šä¸‹æ–‡: {}", currentContext);
            }
            stepCounter++;
        }
        log.info("ä»£ç ç”Ÿæˆå·¥ä½œæµæ‰§è¡Œå®Œæˆï¼");
        return finalContext;
    }
}
```

### æµ‹è¯•

æœ€åï¼Œç¼–å†™å•å…ƒæµ‹è¯•æ¥éªŒè¯ç›®å‰å®Œæ•´çš„å·¥ä½œæµï¼š

```java
@SpringBootTest
class CodeGenWorkflowTest {

    @Test
    void testTechBlogWorkflow() {
        WorkflowContext result = new CodeGenWorkflow().executeWorkflow("åˆ›å»ºä¸€ä¸ªæŠ€æœ¯åšå®¢ç½‘ç«™ï¼Œéœ€è¦å±•ç¤ºç¼–ç¨‹æ•™ç¨‹å’Œç³»ç»Ÿæ¶æ„");
        Assertions.assertNotNull(result);
        System.out.println("ç”Ÿæˆç±»å‹: " + result.getGenerationType());
        System.out.println("ç”Ÿæˆçš„ä»£ç ç›®å½•: " + result.getGeneratedCodeDir());
        System.out.println("æ„å»ºç»“æœç›®å½•: " + result.getBuildResultDir());
    }

    @Test
    void testCorporateWorkflow() {
        WorkflowContext result = new CodeGenWorkflow().executeWorkflow("åˆ›å»ºä¼ä¸šå®˜ç½‘ï¼Œå±•ç¤ºå…¬å¸å½¢è±¡å’Œä¸šåŠ¡ä»‹ç»");
        Assertions.assertNotNull(result);
        System.out.println("ç”Ÿæˆç±»å‹: " + result.getGenerationType());
        System.out.println("ç”Ÿæˆçš„ä»£ç ç›®å½•: " + result.getGeneratedCodeDir());
        System.out.println("æ„å»ºç»“æœç›®å½•: " + result.getBuildResultDir());
    }

    @Test
    void testVueProjectWorkflow() {
        WorkflowContext result = new CodeGenWorkflow().executeWorkflow("åˆ›å»ºä¸€ä¸ªVueå‰ç«¯é¡¹ç›®ï¼ŒåŒ…å«ç”¨æˆ·ç®¡ç†å’Œæ•°æ®å±•ç¤ºåŠŸèƒ½");
        Assertions.assertNotNull(result);
        System.out.println("ç”Ÿæˆç±»å‹: " + result.getGenerationType());
        System.out.println("ç”Ÿæˆçš„ä»£ç ç›®å½•: " + result.getGeneratedCodeDir());
        System.out.println("æ„å»ºç»“æœç›®å½•: " + result.getBuildResultDir());
    }

    @Test
    void testSimpleHtmlWorkflow() {
        WorkflowContext result = new CodeGenWorkflow().executeWorkflow("åˆ›å»ºä¸€ä¸ªç®€å•çš„ä¸ªäººä¸»é¡µ");
        Assertions.assertNotNull(result);
        System.out.println("ç”Ÿæˆç±»å‹: " + result.getGenerationType());
        System.out.println("ç”Ÿæˆçš„ä»£ç ç›®å½•: " + result.getGeneratedCodeDir());
        System.out.println("æ„å»ºç»“æœç›®å½•: " + result.getBuildResultDir());
    }
}
```

è¿™é‡Œä¸¾ä¸ªä¾‹å­ï¼Œæ¯”å¦‚è®© AI â åšä¸ªæŠ€æœ¯åšå®¢ï¼Œå¯ä»¥â é€šè¿‡ Debug æŸ¥çœ‹çŠ¶æ€ï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/sEc8LQhr2AylznBx.webp)

æŸ¥çœ‹ç”Ÿæˆçš„ç½‘ç«™æ•ˆæœï¼Œå·²ç»å¾—åˆ°äº†å†…å®¹ç›¸å…³çš„å›¾ç‰‡ï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/yGkRIqrXqBXAaDpy.webp)

æ˜¾ç„¶ï¼Œæ¯”ä¹‹å‰ç”¨éšæœºå ä½å›¾ç‰‡çš„æ•ˆæœè¦å¥½å¾ˆå¤šï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/t5ZEbrQeo2uT4oxp.webp)

## äº”ã€LangGraph4j å·¥ä½œæµç‰¹æ€§å®æˆ˜

åˆšåˆšæˆ‘ä»¬å·²ç»è·‘é€šäº†æ ¸å¿ƒçš„å·¥ä½œâ æµï¼Œä½†æ˜¯å¥½åƒè¿˜æ²¡æœ‰â ä½“ç°å‡ºå·¥ä½œæµçš„ä¼˜åŠ¿ï¼Œå°±æ˜¯åˆ©ç”¨å·¥ä½œæµæŠŠé€»è¾‘ä¸²èµ·æ¥äº†è€Œå·²ã€‚

å…¶å® LangGraph4jâ  å·¥ä½œæµè¿˜æœ‰æ›´å¤šç‰¹â æ€§ï¼Œè®©æˆ‘ä»¬æ¥ä¾æ¬¡å®æˆ˜ã€‚

### è·³è¿‡æ„å»º - æ¡ä»¶è¾¹

å¯¹äº HTML å’Œ MULTI\_Fâ ILE ç½‘ç«™ç”Ÿæˆç±»å‹ï¼Œâ ç½‘ç«™ç”Ÿæˆå·¥ä½œèŠ‚ç‚¹ä¸­å·²ç»ä¼šè‡ªåŠ¨ä¿å­˜ç½‘ç«™æ–‡ä»¶ï¼Œä¸éœ€è¦è¿›å…¥é¡¹ç›®æ„å»ºèŠ‚ç‚¹ã€‚

é™¤äº†åœ¨é¡¹ç›®æ„å»ºå·¥ä½œèŠ‚ç‚¹ä¸­å†™ if-else å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ [LangGraph4j çš„æ¡ä»¶è¾¹ç‰¹æ€§](https://langgraph4j.github.io/langgraph4j/core/low_level/#conditional-edges)ï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/OMRGwjtGaFyIQNtT.webp)

1ï¼‰å·¥ä½œæµæ–°å¢è·¯ç”±å‡½æ•°å’Œæ¡ä»¶è¾¹é…ç½®ï¼š

```java
.addEdge("router", "code_generator")
// ä½¿ç”¨æ¡ä»¶è¾¹ï¼šæ ¹æ®ä»£ç ç”Ÿæˆç±»å‹å†³å®šæ˜¯å¦éœ€è¦æ„å»º
.addConditionalEdges("code_generator",
        edge_async(this::routeBuildOrSkip),
        Map.of(
                "build", "project_builder",  // éœ€è¦æ„å»ºçš„æƒ…å†µ
                "skip_build", END             // è·³è¿‡æ„å»ºç›´æ¥ç»“æŸ
        ))
.addEdge("project_builder", END)
```

ğŸ’¡ å¦‚æœå¤šæ¬¡ç”¨åˆ°åŒä¸€å·¥ä½œèŠ‚â ç‚¹çš„ keyï¼Œå»ºè®®â ç»Ÿä¸€æ”¾åˆ°å¸¸é‡ç±»ä¸­ç»´æŠ¤ã€‚

2ï¼‰è·¯ç”±å‡½æ•°å†³å®šä»£ç ç”Ÿæˆåæ˜¯å¦éœ€è¦é¡¹ç›®æ„å»ºï¼š

```java
private String routeBuildOrSkip(MessagesState<String> state) {
    WorkflowContext context = WorkflowContext.getContext(state);
    CodeGenTypeEnum generationType = context.getGenerationType();
    // HTML å’Œ MULTI_FILE ç±»å‹ä¸éœ€è¦æ„å»ºï¼Œç›´æ¥ç»“æŸ
    if (generationType == CodeGenTypeEnum.HTML || generationType == CodeGenTypeEnum.MULTI_FILE) {
        return "skip_build";
    }
    // VUE_PROJECT éœ€è¦æ„å»º
    return "build";
}
```

3ï¼‰é¡¹ç›®æ„å»ºå·¥ä½œèŠ‚ç‚¹ä¸­ç§»é™¤ if-else é€»è¾‘ï¼š

```java
String buildResultDir;
// ä¸€å®šæ˜¯ Vue é¡¹ç›®ç±»å‹ï¼šä½¿ç”¨ VueProjectBuilder è¿›è¡Œæ„å»º
try {
    VueProjectBuilder vueBuilder = SpringContextUtil.getBean(VueProjectBuilder.class);
    // æ‰§è¡Œ Vue é¡¹ç›®æ„å»ºï¼ˆnpm install + npm run buildï¼‰
    boolean buildSuccess = vueBuilder.buildProject(generatedCodeDir);
    if (buildSuccess) {
        // æ„å»ºæˆåŠŸï¼Œè¿”å› dist ç›®å½•è·¯å¾„
        buildResultDir = generatedCodeDir + File.separator + "dist";
        log.info("Vue é¡¹ç›®æ„å»ºæˆåŠŸï¼Œdist ç›®å½•: {}", buildResultDir);
    } else {
        throw new BusinessException(ErrorCode.SYSTEM_ERROR, "Vue é¡¹ç›®æ„å»ºå¤±è´¥");
    }
} catch (Exception e) {
    log.error("Vue é¡¹ç›®æ„å»ºå¼‚å¸¸: {}", e.getMessage(), e);
    buildResultDir = generatedCodeDir; // å¼‚å¸¸æ—¶è¿”å›åŸè·¯å¾„
}
```

è¿™ç§è®¾è®¡æ¯”åœ¨ ProjectBuilâ derNode ä¸­å†™ iâ f-else æ›´åŠ ä¼˜é›…ï¼Œç¬¦åˆ LangGraph4j å’Œå·¥ä½œæµçš„è®¾è®¡ç†å¿µã€‚

ç”¨æ¡ä»¶è¾¹çš„ä¼˜åŠ¿æ˜¯ï¼š

1.  å¯è§†åŒ–æ›´æ¸…æ™°ï¼šå·¥ä½œæµå›¾èƒ½ç›´è§‚æ˜¾ç¤ºä¸åŒè·¯å¾„
2.  æ€§èƒ½æ›´å¥½ï¼šç›´æ¥è·³è¿‡ä¸éœ€è¦çš„èŠ‚ç‚¹ï¼Œé¿å…æ— ç”¨çš„ Bean åŠ è½½
3.  å…³æ³¨ç‚¹åˆ†ç¦»ï¼šèŠ‚ç‚¹ä¸“æ³¨ä¸šåŠ¡é€»è¾‘ï¼Œè¾¹ä¸“æ³¨æµç¨‹æ§åˆ¶

### è´¨é‡æ£€æŸ¥ - å¾ªç¯è¾¹

æ–°å¢ä»£ç è´¨æ£€ Agent å·¥ä½œèŠ‚ç‚¹ï¼Œâ åœ¨ç”Ÿæˆä»£ç åï¼Œæ£€éªŒä»£ç æ˜¯â å¦æœ‰å¼‚å¸¸ã€èƒ½å¦æ­£å¸¸æ‰“åŒ…ï¼Œå¦‚æœæœ‰å¼‚å¸¸åˆ™è¿”å›åˆ°ç½‘ç«™ç”Ÿæˆ Agent é‡æ–°ç”Ÿæˆã€‚

è¯¥èŠ‚ç‚¹æ‰€éœ€çš„çŠ¶æ€ï¼š`generatedCodeDir` + `generationType`

è¯¥èŠ‚ç‚¹è¿”å›çš„çŠ¶æ€ï¼š`qualityResult` è´¨æ£€ç»“æœ

-   `isValid` æ˜¯å¦é€šè¿‡
-   `errors` é”™è¯¯åˆ—è¡¨
-   `suggestions` æ”¹è¿›å»ºè®®

å…·ä½“æ€ä¹ˆæ£€æŸ¥å‘¢ï¼Ÿ

æˆ‘çš„æƒ³æ³•æ˜¯å¼€å‘ä¸€ä¸ªå·¥å…·æ¥è¯»å–å¹¶æ‹¼æ¥é¡¹ç›®ç”Ÿæˆçš„æ‰€æœ‰ä»£ç æ–‡ä»¶ï¼Œè®© Aâ I æ¥æ£€æŸ¥ï¼›å¦‚æœæœ‰é—®é¢˜ï¼Œå›åˆ°ç½‘ç«™ç”Ÿæˆ Agâ entï¼Œæç¤ºè¯ä¸­é¢å¤–æ‹¼æ¥æ£€æŸ¥å¾—åˆ°çš„é”™è¯¯åˆ—è¡¨å’Œæ”¹è¿›å»ºè®®ï¼Œè®© AI åœ¨ç°æœ‰ä»£ç åŸºç¡€ä¸Šè¿›è¡Œä¿®æ”¹ï¼Œè€Œä¸æ˜¯å®Œå…¨ä» 0 å¼€å§‹ç”Ÿæˆã€‚

#### æ–¹æ¡ˆæ€è€ƒ

å¥‡æ€ªäº†ï¼Œæ£€æŸ¥ä»£ç è´¨é‡æ˜¯å¦è¿‡å…³â ä¸åº”è¯¥æ˜¯ä¸ªåˆ¤æ–­é€»è¾‘â ä¹ˆï¼Ÿä¸ºä»€ä¹ˆé‡‡ç”¨å·¥ä½œèŠ‚ç‚¹ï¼Œè€Œä¸æ˜¯æ¡ä»¶è¾¹æ¥å®ç°å‘¢ï¼Ÿ

è¿™é‡Œæˆ‘ä»¬å…¨éƒ½è¦ï¼Œåº”è¯¥ç”¨ï¼š**å·¥ä½œèŠ‚ç‚¹ + æ¡ä»¶è¾¹çš„ç»„åˆ**

åŸå› å¦‚ä¸‹ï¼š

1ï¼‰ä»£ç è´¨æ£€æœ¬èº«æ˜¯ä¸€ä¸ªå¤æ‚çš„å·¥ä½œä»»åŠ¡ï¼š

-   éœ€è¦è¯»å–å¹¶æ‹¼æ¥ä»£ç æ–‡ä»¶
-   è°ƒç”¨ AI è¿›è¡Œä»£ç åˆ†æ
-   ç”Ÿæˆè´¨æ£€ç»“æœï¼ˆé”™è¯¯ã€å»ºè®®ç­‰ï¼‰
-   è¿™æ˜¯å®é™…çš„ä¸šåŠ¡é€»è¾‘ï¼Œåº”è¯¥ç”¨å·¥ä½œèŠ‚ç‚¹

2ï¼‰æ ¹æ®è´¨æ£€ç»“æœçš„è·¯ç”±å†³ç­–ï¼š

-   è´¨æ£€é€šè¿‡ â†’ ç»§ç»­åˆ°é¡¹ç›®æ„å»º
-   è´¨æ£€å¤±è´¥ â†’ å›åˆ°ä»£ç ç”ŸæˆèŠ‚ç‚¹
-   è¿™æ˜¯æµç¨‹æ§åˆ¶é€»è¾‘ï¼Œåº”è¯¥ç”¨æ¡ä»¶è¾¹

äºŒè€…ç»„åˆï¼Œå½¢æˆäº†å®Œæ•´çš„å·¥ä½œæµç¨‹ï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/DD33LQ1Q1drgEGb4.webp)

ğŸ’¡ å…¶å®å¯ä»¥ä¸“é—¨å†æä¾›ä¸€ä¸ª `é¡¹ç›®ä¿®å¤èŠ‚ç‚¹`ï¼Œæ¥å—æ£€æŸ¥å‡ºçš„é”™è¯¯ä¿¡æ¯ï¼Œå¹¶ä½¿ç”¨ä¿®å¤é¡¹ç›®æç¤ºè¯ã€‚åŒºåˆ†åˆ›å»ºå’Œä¿®æ”¹ï¼Œæ•ˆæœå¯èƒ½ä¼šæ›´ä½³ã€‚

ä¸‹é¢è¿›è¡Œå¼€å‘ã€‚

#### 1ã€å®šä¹‰æ•°æ®æ¨¡å‹

`langgraph4j.model` ä¸‹å¢åŠ  `QualityResult` ç±»ï¼š

```java
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class QualityResult implements Serializable {
    
    @Serial
    private static final long serialVersionUID = 1L;
    
    /**
     * æ˜¯å¦é€šè¿‡è´¨æ£€
     */
    private Boolean isValid;
    
    /**
     * é”™è¯¯åˆ—è¡¨
     */
    private List<String> errors;
    
    /**
     * æ”¹è¿›å»ºè®®
     */
    private List<String> suggestions;
}
```

WorkflowContext çŠ¶æ€è¡¥å……å­—æ®µï¼š

```java
/**
 * è´¨é‡æ£€æŸ¥ç»“æœ
 */
private QualityResult qualityResult;
```

#### 2ã€è´¨é‡æ£€æŸ¥ AI æœåŠ¡

1ï¼‰ç¼–å†™è´¨é‡æ£€æŸ¥ AI æç¤ºè¯ `code-quality-check-system-prompt.txt`ï¼Œæç¤ºè¯é‡ç‚¹çªå‡º **æ£€æŸ¥è¯­æ³•é”™è¯¯**ï¼Œå¹¶ä¸”å¼ºè°ƒç»“æ„åŒ–è¾“å‡ºçš„ JSON æ ¼å¼ã€‚

```markdown
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ä»£ç è´¨é‡æ£€æŸ¥ä¸“å®¶ã€‚ä½ çš„ä»»åŠ¡æ˜¯åˆ†æç”¨æˆ·æä¾›çš„ç½‘ç«™ä»£ç ï¼Œæ£€æŸ¥è¯­æ³•é”™è¯¯ç­‰æ–¹é¢çš„é—®é¢˜ï¼Œç¡®ä¿é¡¹ç›®å¯ä»¥æ­£å¸¸è¿è¡Œå’Œæ‰“åŒ…ã€‚

## æ£€æŸ¥é‡ç‚¹

### 1. è¯­æ³•å’Œç»“æ„é”™è¯¯
- HTML æ ‡ç­¾æ˜¯å¦æ­£ç¡®é—­åˆ
- CSS è¯­æ³•æ˜¯å¦æ­£ç¡®
- JavaScript è¯­æ³•é”™è¯¯
- æ–‡ä»¶å¼•ç”¨è·¯å¾„æ˜¯å¦æ­£ç¡®
- ç¼ºå¤±çš„ä¾èµ–æˆ–èµ„æº

### 2. ä»£ç è´¨é‡
- ä»£ç ç»“æ„æ˜¯å¦åˆç†
- å‘½åè§„èŒƒæ˜¯å¦ä¸€è‡´
- ä»£ç é‡å¤æ€§æ£€æŸ¥

### 3. åŠŸèƒ½å®Œæ•´æ€§
- é¡µé¢åŠŸèƒ½æ˜¯å¦å®Œæ•´
- äº¤äº’é€»è¾‘æ˜¯å¦æ­£ç¡®
- å“åº”å¼è®¾è®¡æ£€æŸ¥

## è¾“å‡ºæ ¼å¼

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹ JSON æ ¼å¼è¿”å›æ£€æŸ¥ç»“æœï¼š

json
{
  "isValid": true/false,
  "errors": [
    "å…·ä½“çš„é”™è¯¯æè¿°1",
    "å…·ä½“çš„é”™è¯¯æè¿°2"
  ],
  "suggestions": [
    "æ”¹è¿›å»ºè®®1",
    "æ”¹è¿›å»ºè®®2"
  ]
}


 ## åˆ¤æ–­æ ‡å‡†

- isValid = true: ä»£ç æ— ä¸¥é‡è¯­æ³•é”™è¯¯ï¼Œèƒ½å¤Ÿæ­£å¸¸è¿è¡Œå’Œæ‰“åŒ…
- isValid = false: å­˜åœ¨è¯­æ³•é”™è¯¯ã€ç»“æ„é—®é¢˜æˆ–å…¶ä»–ä¼šå¯¼è‡´æ— æ³•æ­£å¸¸è¿è¡Œçš„é—®é¢˜
- errors: å¿…é¡»ä¿®å¤çš„é—®é¢˜ï¼Œå¦‚è¯­æ³•é”™è¯¯ã€ç¼ºå¤±æ–‡ä»¶ç­‰
- suggestions: å…³äºå¦‚ä½•ä¿®å¤é”™è¯¯å’Œæ”¹è¿›ä»£ç çš„å»ºè®®

è¯·ä»”ç»†åˆ†æä»£ç ï¼Œæä¾›ä¸“ä¸šçš„è´¨é‡æ£€æŸ¥ç»“æœã€‚
```

2ï¼‰å¼€å‘ AI æœåŠ¡ï¼Œåˆ©ç”¨ç»“æ„åŒ–è¾“å‡ºï¼š

```java
public interface CodeQualityCheckService {

    /**
     * æ£€æŸ¥ä»£ç è´¨é‡
     * AI ä¼šåˆ†æä»£ç å¹¶è¿”å›è´¨é‡æ£€æŸ¥ç»“æœ
     */
    @SystemMessage(fromResource = "prompt/code-quality-check-system-prompt.txt")
    QualityResult checkCodeQuality(@UserMessage String codeContent);
}
```

3ï¼‰å¼€å‘åˆ›å»º AI æœåŠ¡çš„å·¥å‚ï¼š

```java
@Slf4j
@Configuration
public class CodeQualityCheckServiceFactory {

    @Resource
    private ChatModel chatModel;

    /**
     * åˆ›å»ºä»£ç è´¨é‡æ£€æŸ¥ AI æœåŠ¡
     */
    @Bean
    public CodeQualityCheckService createCodeQualityCheckService() {
        return AiServices.builder(CodeQualityCheckService.class)
                .chatModel(chatModel)
                .build();
    }
}
```

#### 3ã€å¼€å‘è´¨é‡æ£€æŸ¥å·¥ä½œèŠ‚ç‚¹

ä»£ç è¾ƒå¤æ‚ï¼Œæˆ‘ä»¬å¯ä»¥åˆ†ä¸º 2 æ­¥å®Œæˆã€‚

1ï¼‰å¼€å‘ä¸€ä¸ªæ–¹æ³•æ¥è¯»å–ç”Ÿæˆä»£ç â çš„æ–‡ä»¶ç»“æ„å’Œå…·ä½“å†…å®¹â ï¼Œæ‹¼æ¥å¥½åäº¤ç»™ AI æ¥æ£€æŸ¥ï¼Œå¯ä»¥åˆ©ç”¨ Hutool å·¥å…·ç±»å®Œæˆã€‚

```java
/**
 * éœ€è¦æ£€æŸ¥çš„æ–‡ä»¶æ‰©å±•å
 */
private static final List<String> CODE_EXTENSIONS = Arrays.asList(
        ".html", ".htm", ".css", ".js", ".json", ".vue", ".ts", ".jsx", ".tsx"
);

/**
 * è¯»å–å¹¶æ‹¼æ¥ä»£ç ç›®å½•ä¸‹çš„æ‰€æœ‰ä»£ç æ–‡ä»¶
 */
private static String readAndConcatenateCodeFiles(String codeDir) {
    if (StrUtil.isBlank(codeDir)) {
        return "";
    }
    File directory = new File(codeDir);
    if (!directory.exists() || !directory.isDirectory()) {
        log.error("ä»£ç ç›®å½•ä¸å­˜åœ¨æˆ–ä¸æ˜¯ç›®å½•: {}", codeDir);
        return "";
    }
    StringBuilder codeContent = new StringBuilder();
    codeContent.append("# é¡¹ç›®æ–‡ä»¶ç»“æ„å’Œä»£ç å†…å®¹\n\n");
    // ä½¿ç”¨ Hutool çš„ walkFiles æ–¹æ³•éå†æ‰€æœ‰æ–‡ä»¶
    FileUtil.walkFiles(directory, file -> {
        // è¿‡æ»¤æ¡ä»¶ï¼šè·³è¿‡éšè—æ–‡ä»¶ã€ç‰¹å®šç›®å½•ä¸‹çš„æ–‡ä»¶ã€éä»£ç æ–‡ä»¶
        if (shouldSkipFile(file, directory)) {
            return;
        }
        if (isCodeFile(file)) {
            String relativePath = FileUtil.subPath(directory.getAbsolutePath(), file.getAbsolutePath());
            codeContent.append("## æ–‡ä»¶: ").append(relativePath).append("\n\n");
            String fileContent = FileUtil.readUtf8String(file);
            codeContent.append(fileContent).append("\n\n");
        }
    });
    return codeContent.toString();
}

/**
 * åˆ¤æ–­æ˜¯å¦åº”è¯¥è·³è¿‡æ­¤æ–‡ä»¶
 */
private static boolean shouldSkipFile(File file, File rootDir) {
    String relativePath = FileUtil.subPath(rootDir.getAbsolutePath(), file.getAbsolutePath());
    // è·³è¿‡éšè—æ–‡ä»¶
    if (file.getName().startsWith(".")) {
        return true;
    }
    // è·³è¿‡ç‰¹å®šç›®å½•ä¸‹çš„æ–‡ä»¶
    return relativePath.contains("node_modules" + File.separator) ||
            relativePath.contains("dist" + File.separator) ||
            relativePath.contains("target" + File.separator) ||
            relativePath.contains(".git" + File.separator);
}

/**
 * åˆ¤æ–­æ˜¯å¦æ˜¯éœ€è¦æ£€æŸ¥çš„ä»£ç æ–‡ä»¶
 */
private static boolean isCodeFile(File file) {
    String fileName = file.getName().toLowerCase();
    return CODE_EXTENSIONS.stream().anyMatch(fileName::endsWith);
}
```

ğŸ’¡ ä¸Šè¿°ä»£ç ä¸­ï¼Œç”¨åˆ°äº† Huâ tool çš„ walâ kFiles æ–¹æ³•æ¥éå†æ–‡ä»¶ï¼Œè¿™é‡Œç”¨åˆ°äº†è®¾è®¡æ¨¡å¼ â€”â€” è®¿é—®è€…æ¨¡å¼ã€‚

è®¿é—®è€…æ¨¡å¼å…è®¸ä½ åœ¨ä¸ä¿®æ”¹å¯¹è±¡ç»“æ„çš„æƒ…å†µä¸‹ï¼Œå®šä¹‰ä½œç”¨äºè¿™äº›å¯¹è±¡çš„æ–°æ“ä½œã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼ŒwalkFâ iles æ–¹æ³•éå†æ–‡ä»¶æ ‘ç»“æ„ï¼Œè€Œæˆ‘ä»¬ä¼ å…¥çš„ lambda è¡¨è¾¾â å¼å°±æ˜¯è®¿é—®è€…ï¼Œå®ƒå®šä¹‰äº†å¯¹æ¯ä¸ªæ–‡ä»¶è¦æ‰§è¡Œçš„å…·ä½“æ“ä½œã€‚è¿™æ ·çš„è®¾è®¡è®©æ–‡ä»¶éå†é€»è¾‘å’Œæ–‡ä»¶å¤„ç†é€»è¾‘å®Œå…¨åˆ†ç¦»ï¼Œå¯ä»¥çµæ´»åœ°å®šä¹‰ä¸åŒçš„æ–‡ä»¶å¤„ç†ç­–ç•¥ï¼Œè€Œä¸éœ€è¦ä¿®æ”¹éå†æ–‡ä»¶çš„æ ¸å¿ƒä»£ç ã€‚

![](https://pic.code-nav.cn/course_picture/1608440217629360130/2cxzIXNCchhGdxfL.webp)

2ï¼‰å¼€å‘å…·ä½“çš„ä»£ç è´¨é‡æ£€æŸ¥é€»â è¾‘ï¼Œè°ƒç”¨ AI å®Œâ æˆæ£€æŸ¥ï¼Œå¹¶æ›´æ–°è´¨é‡æ£€æŸ¥ç»“æœçŠ¶æ€ï¼š

```java
/**
 * ä»£ç è´¨é‡æ£€æŸ¥èŠ‚ç‚¹
 */
@Slf4j
public class CodeQualityCheckNode {

    public static AsyncNodeAction<MessagesState<String>> create() {
        return node_async(state -> {
            WorkflowContext context = WorkflowContext.getContext(state);
            log.info("æ‰§è¡ŒèŠ‚ç‚¹: ä»£ç è´¨é‡æ£€æŸ¥");
            String generatedCodeDir = context.getGeneratedCodeDir();
            QualityResult qualityResult;
            try {
                // 1. è¯»å–å¹¶æ‹¼æ¥ä»£ç æ–‡ä»¶å†…å®¹
                String codeContent = readAndConcatenateCodeFiles(generatedCodeDir);
                if (StrUtil.isBlank(codeContent)) {
                    log.warn("æœªæ‰¾åˆ°å¯æ£€æŸ¥çš„ä»£ç æ–‡ä»¶");
                    qualityResult = QualityResult.builder()
                            .isValid(false)
                            .errors(List.of("æœªæ‰¾åˆ°å¯æ£€æŸ¥çš„ä»£ç æ–‡ä»¶"))
                            .suggestions(List.of("è¯·ç¡®ä¿ä»£ç ç”ŸæˆæˆåŠŸ"))
                            .build();
                } else {
                    // 2. è°ƒç”¨ AI è¿›è¡Œä»£ç è´¨é‡æ£€æŸ¥
                    CodeQualityCheckService qualityCheckService = SpringContextUtil.getBean(CodeQualityCheckService.class);
                    qualityResult = qualityCheckService.checkCodeQuality(codeContent);
                    log.info("ä»£ç è´¨é‡æ£€æŸ¥å®Œæˆ - æ˜¯å¦é€šè¿‡: {}", qualityResult.getIsValid());
                }
            } catch (Exception e) {
                log.error("ä»£ç è´¨é‡æ£€æŸ¥å¼‚å¸¸: {}", e.getMessage(), e);
                qualityResult = QualityResult.builder()
                        .isValid(true) // å¼‚å¸¸ç›´æ¥è·³åˆ°ä¸‹ä¸€ä¸ªæ­¥éª¤
                        .build();
            }
            // 3. æ›´æ–°çŠ¶æ€
            context.setCurrentStep("ä»£ç è´¨é‡æ£€æŸ¥");
            context.setQualityResult(qualityResult);
            return WorkflowContext.saveContext(context);
        });
    }
}
```

#### 4ã€ä¿®æ”¹ä»£ç ç”ŸæˆèŠ‚ç‚¹

ä»£ç ç”ŸæˆèŠ‚ç‚¹è¦åˆ¤æ–­çŠ¶æ€ä¸­æœ‰æ²¡â æœ‰é”™è¯¯ä¿¡æ¯ï¼Œå¦‚æœæœ‰â çš„è¯ï¼Œéœ€è¦æ ¹æ®é”™è¯¯ä¿¡æ¯æ„é€ æç¤ºè¯ï¼Œå¼•å¯¼ AI ä¿®å¤é”™è¯¯ã€‚

1ï¼‰ç¼–å†™æ„é€ ç”¨æˆ·æ¶ˆæ¯çš„æ–¹æ³•ï¼Œâ å¦‚æœå­˜åœ¨è´¨æ£€å¤±è´¥ç»“â æœåˆ™æ·»åŠ é”™è¯¯ä¿®å¤ä¿¡æ¯ï¼š

```java
/**
 * æ„é€ ç”¨æˆ·æ¶ˆæ¯ï¼Œå¦‚æœå­˜åœ¨è´¨æ£€å¤±è´¥ç»“æœåˆ™æ·»åŠ é”™è¯¯ä¿®å¤ä¿¡æ¯
 */
private static String buildUserMessage(WorkflowContext context) {
    String userMessage = context.getEnhancedPrompt();
    // æ£€æŸ¥æ˜¯å¦å­˜åœ¨è´¨æ£€å¤±è´¥ç»“æœ
    QualityResult qualityResult = context.getQualityResult();
    if (isQualityCheckFailed(qualityResult)) {
        // ç›´æ¥å°†é”™è¯¯ä¿®å¤ä¿¡æ¯ä½œä¸ºæ–°çš„æç¤ºè¯ï¼ˆèµ·åˆ°äº†ä¿®æ”¹çš„ä½œç”¨ï¼‰
        userMessage = buildErrorFixPrompt(qualityResult);
    }
    return userMessage;
}

/**
 * åˆ¤æ–­è´¨æ£€æ˜¯å¦å¤±è´¥
 */
private static boolean isQualityCheckFailed(QualityResult qualityResult) {
    return qualityResult != null && 
           !qualityResult.getIsValid() && 
           qualityResult.getErrors() != null && 
           !qualityResult.getErrors().isEmpty();
}

/**
 * æ„é€ é”™è¯¯ä¿®å¤æç¤ºè¯
 */
private static String buildErrorFixPrompt(QualityResult qualityResult) {
    StringBuilder errorInfo = new StringBuilder();
    errorInfo.append("\n\n## ä¸Šæ¬¡ç”Ÿæˆçš„ä»£ç å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼Œè¯·ä¿®å¤ï¼š\n");
    // æ·»åŠ é”™è¯¯åˆ—è¡¨
    qualityResult.getErrors().forEach(error -> 
        errorInfo.append("- ").append(error).append("\n"));
    // æ·»åŠ ä¿®å¤å»ºè®®ï¼ˆå¦‚æœæœ‰ï¼‰
    if (qualityResult.getSuggestions() != null && !qualityResult.getSuggestions().isEmpty()) {
        errorInfo.append("\n## ä¿®å¤å»ºè®®ï¼š\n");
        qualityResult.getSuggestions().forEach(suggestion -> 
            errorInfo.append("- ").append(suggestion).append("\n"));
    }
    errorInfo.append("\nè¯·æ ¹æ®ä¸Šè¿°é—®é¢˜å’Œå»ºè®®é‡æ–°ç”Ÿæˆä»£ç ï¼Œç¡®ä¿ä¿®å¤æ‰€æœ‰æåˆ°çš„é—®é¢˜ã€‚");
    return errorInfo.toString();
}
```

2ï¼‰èŠ‚ç‚¹æ–¹æ³•ä¸­è°ƒç”¨æ„é€ ç”¨æˆ·æ¶ˆæ¯ï¼š

```java
// æ„é€ ç”¨æˆ·æ¶ˆæ¯ï¼ˆåŒ…å«åŸå§‹æç¤ºè¯å’Œå¯èƒ½çš„é”™è¯¯ä¿®å¤ä¿¡æ¯ï¼‰
String userMessage = buildUserMessage(context);
```

#### 5ã€ä¿®æ”¹å·¥ä½œæµ

1ï¼‰æ–°å¢èŠ‚ç‚¹å’Œè¾¹ï¼Œè´¨æ£€æ¡ä»¶è¾¹å¯ä»¥å’Œä¹‹å‰çš„æ„å»ºæ¡ä»¶è¾¹åˆå¹¶ï¼š

```java
.addNode("code_quality_check", CodeQualityCheckNode.create())
// ...
.addEdge("code_generator", "code_quality_check")
// æ–°å¢è´¨æ£€æ¡ä»¶è¾¹ï¼šæ ¹æ®è´¨æ£€ç»“æœå†³å®šä¸‹ä¸€æ­¥
.addConditionalEdges("code_quality_check",
        edge_async(this::routeAfterQualityCheck),
        Map.of(
                "build", "project_builder",   // è´¨æ£€é€šè¿‡ä¸”éœ€è¦æ„å»º
                "skip_build", END,            // è´¨æ£€é€šè¿‡ä½†è·³è¿‡æ„å»º
                "fail", "code_generator"      // è´¨æ£€å¤±è´¥ï¼Œé‡æ–°ç”Ÿæˆ
        ))
```

2ï¼‰æ–°å†™ä¸€ä¸ªè·¯ç”±å‡½æ•°ï¼Œæ ¹æ®è´¨æ£€ç»“æœå†³å®šä¸‹ä¸€æ­¥ï¼Œç›´æ¥å¤ç”¨ä¹‹å‰çš„ `routeBuildOrSkip` æ–¹æ³•ï¼š

```java
private String routeAfterQualityCheck(MessagesState<String> state) {
    WorkflowContext context = WorkflowContext.getContext(state);
    QualityResult qualityResult = context.getQualityResult();
    // å¦‚æœè´¨æ£€å¤±è´¥ï¼Œé‡æ–°ç”Ÿæˆä»£ç 
    if (qualityResult == null || !qualityResult.getIsValid()) {
        log.error("ä»£ç è´¨æ£€å¤±è´¥ï¼Œéœ€è¦é‡æ–°ç”Ÿæˆä»£ç ");
        return "fail";
    }
    // è´¨æ£€é€šè¿‡ï¼Œä½¿ç”¨åŸæœ‰çš„æ„å»ºè·¯ç”±é€»è¾‘
    log.info("ä»£ç è´¨æ£€é€šè¿‡ï¼Œç»§ç»­åç»­æµç¨‹");
    return routeBuildOrSkip(state);
}
```

#### 6ã€å•å…ƒæµ‹è¯•

æ‰§è¡Œä¹‹å‰å¼€å‘çš„å·¥ä½œæµå•å…ƒæµ‹è¯•ï¼Œå¯ä»¥çœ‹â åˆ° AI ç»™å‡ºä¿®æ”¹å»ºè®®çš„â åŒæ—¶ï¼ŒisValid ä»ç„¶ä¸º trueï¼Œå¹¶æ²¡æœ‰è§¦å‘å¤šä½™çš„ä¿®æ”¹ï¼Œæ•ˆæœä¸é”™ï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/Hq33c00jMgc5Nh1i.webp)

### å›¾ç‰‡æ”¶é›†ä¼˜åŒ– - å¹¶å‘å’Œå­å›¾

ç›®å‰é€šè¿‡å·¥å…·è°ƒç”¨è·å–å›¾ç‰‡éœ€è¦â å’Œ AI è¿›è¡Œå¤šè½®â äº¤äº’ï¼Œä¸ä»…è€—è´¹æ—¶é—´é•¿ã€æ€§èƒ½ä½ã€è¿˜ä¼šæ¶ˆè€—å¤§é‡ tokenã€‚

#### ä¼˜åŒ–æ–¹æ¡ˆ

å…¶å®å¯ä»¥è½¬å˜æ€è·¯ï¼Œå…ˆé€šè¿‡è°ƒç”¨ AI è·å–â è¦æ”¶é›†çš„å›¾ç‰‡ç±»åˆ«å’Œå‚æ•°ï¼ˆè¾“â å‡ºå›¾ç‰‡æ”¶é›†ä»»åŠ¡ï¼‰ï¼Œåˆ©ç”¨ç»“æ„åŒ–è¾“å‡ºè¿”å›è¿™äº›ä¿¡æ¯ï¼Œç„¶åå¹¶å‘è°ƒç”¨å¯¹åº”çš„å›¾ç‰‡æ”¶é›†å·¥å…·æ‰§è¡Œã€‚

æ¥ä¸‹æ¥ï¼Œå…·ä½“çš„å¹¶å‘å®ç°æ–¹æ¡ˆæœ‰ 3 ç§ï¼š

1ï¼‰å·¥ä½œèŠ‚ç‚¹å†…éƒ¨å®ç°å¹¶å‘ï¼ˆæ¨èï¼‰

åœ¨å›¾ç‰‡æ”¶é›†èŠ‚ç‚¹å†…éƒ¨é€šè¿‡ Coâ mpletableâ Future å¹¶å‘è°ƒç”¨å·¥å…·è¿›è¡Œæ”¶é›†ï¼Œå¹¶æ›´æ–°ç»“æœã€‚

2ï¼‰åˆ©ç”¨ LangGraph4j çš„å¹¶å‘èƒ½åŠ›

æŠŠæ¯ä¸ªå›¾ç‰‡æ”¶é›†å·¥å…·å®šä¹‰æˆå·¥ä½œâ èŠ‚ç‚¹ï¼Œå¹¶å‘æ‰§è¡Œè¿™äº›â å·¥å…·ï¼Œæœ€åå†ç»Ÿä¸€æ±‡æ€»ç»“æœã€‚

3ï¼‰åˆ©ç”¨ LangGraph4j çš„å­å›¾èƒ½åŠ›

æŠŠæ¯ä¸ªå›¾ç‰‡æ”¶é›†å·¥å…·å®šä¹‰æˆå­å›¾â ï¼Œå¹¶å‘æ‰§è¡Œè¿™äº›å·¥å…·â ï¼Œæœ€åå†ç»Ÿä¸€æ±‡æ€»ç»“æœã€‚

å…¶å® 2 å’Œ 3 çš„æ€è·¯ç±»ä¼¼ï¼Œâ ä½†æ˜¯å»ºè®®åªæœ‰å¹¶å‘åˆ†æ”¯â ä¸‹æœ‰å¤šä¸ªæ­¥éª¤æ—¶ï¼Œæ‰è€ƒè™‘ä½¿ç”¨å­å›¾èƒ½åŠ›ï¼Œå¦åˆ™å°±æœ‰ç‚¹ä¸ºäº†å°è£…è€Œå°è£…äº†ã€‚

#### å›¾ç‰‡æ”¶é›†è§„åˆ’å®ç°

1ï¼‰ç¼–å†™ AI æ”¶é›†å›¾ç‰‡çš„æç¤ºè¯ `image-collection-plan-system-prompt.txt`ï¼š

```markdown
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å›¾ç‰‡æ”¶é›†è§„åˆ’å¸ˆã€‚ä½ çš„ä»»åŠ¡æ˜¯åˆ†æç”¨æˆ·çš„ç½‘ç«™éœ€æ±‚ï¼Œåˆ¶å®šåˆç†çš„å›¾ç‰‡æ”¶é›†è®¡åˆ’ã€‚

## å›¾ç‰‡ç±»å‹è¯´æ˜

### 1. å†…å®¹å›¾ç‰‡ (contentImageTasks)
- ç”¨é€”ï¼šç½‘ç«™çš„ä¸»è¦å†…å®¹é…å›¾
- æ¥æºï¼šé€šè¿‡å…³é”®è¯æœç´¢è·å–
- ç¤ºä¾‹ï¼šäº§å“å›¾ç‰‡ã€åœºæ™¯å›¾ç‰‡ã€äººç‰©å›¾ç‰‡ç­‰

### 2. æ’ç”»å›¾ç‰‡ (illustrationTasks) 
- ç”¨é€”ï¼šè£…é¥°æ€§æ’ç”»ï¼Œæå‡é¡µé¢ç¾è§‚åº¦
- æ¥æºï¼šUndraw æ’ç”»åº“
- ç¤ºä¾‹ï¼šæŠ½è±¡æ’ç”»ã€æ¦‚å¿µå›¾è§£ç­‰

### 3. æ¶æ„å›¾ (diagramTasks)
- ç”¨é€”ï¼šå±•ç¤ºç³»ç»Ÿæ¶æ„ã€æµç¨‹å›¾ç­‰æŠ€æœ¯å›¾è¡¨
- æ¥æºï¼šé€šè¿‡ Mermaid ä»£ç ç”Ÿæˆ
- ç¤ºä¾‹ï¼šç³»ç»Ÿæ¶æ„å›¾ã€æµç¨‹å›¾ã€ç»„ç»‡ç»“æ„å›¾ç­‰

### 4. Logoå›¾ç‰‡ (logoTasks)
- ç”¨é€”ï¼šå“ç‰Œæ ‡è¯†ã€å›¾æ ‡ç­‰
- æ¥æºï¼šAI ç”Ÿæˆ
- ç¤ºä¾‹ï¼šå…¬å¸Logoã€äº§å“å›¾æ ‡ç­‰

## è§„åˆ’åŸåˆ™

1. éœ€æ±‚å¯¼å‘ï¼šæ ¹æ®ç”¨æˆ·æè¿°çš„ç½‘ç«™ç±»å‹å’Œç”¨é€”æ¥è§„åˆ’å›¾ç‰‡
2. é€‚é‡åŸåˆ™ï¼šæ¯ç§ç±»å‹çš„å›¾ç‰‡æ•°é‡è¦åˆç†ï¼Œé¿å…è¿‡å¤šæˆ–è¿‡å°‘
3. å…³é”®è¯ç²¾å‡†ï¼šé€‰æ‹©æœ€èƒ½ä½“ç°éœ€æ±‚çš„å…³é”®è¯
4. æè¿°æ¸…æ™°ï¼šä¸ºä»»åŠ¡æä¾›æ¸…æ™°çš„æè¿°è¯´æ˜

## è¾“å‡ºè¦æ±‚

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹ JSON æ ¼å¼è¿”å›å›¾ç‰‡æ”¶é›†è®¡åˆ’ï¼š

json
{
  "contentImageTasks": [
    {
      "query": "æœç´¢å…³é”®è¯"
    }
  ],
  "illustrationTasks": [
    {
      "query": "æ’ç”»å…³é”®è¯"
    }
  ],
  "diagramTasks": [
    {
      "mermaidCode": "mermaidå›¾è¡¨ä»£ç ",
      "description": "å›¾è¡¨ç”¨é€”æè¿°"
    }
  ],
  "logoTasks": [
    {
      "description": "Logoè®¾è®¡æè¿°ï¼Œå¦‚åç§°ã€è¡Œä¸šã€é£æ ¼ç­‰"
    }
  ]
}


æ³¨æ„ï¼š
- å¦‚æœæŸç§ç±»å‹çš„å›¾ç‰‡ä¸éœ€è¦ï¼Œå¯¹åº”æ•°ç»„å¯ä»¥ä¸ºç©º
- æ¯ä¸ªä»»åŠ¡çš„ description è¦è¯´æ˜å›¾ç‰‡çš„å…·ä½“ç”¨é€”å’Œä½ç½®
- mermaidCode è¦æ˜¯æœ‰æ•ˆçš„ Mermaid è¯­æ³•ä»£ç 
- å…³é”®è¯è¦ä½¿ç”¨ä¸­æ–‡æˆ–è‹±æ–‡ï¼Œé€‰æ‹©æœç´¢æ•ˆæœæœ€å¥½çš„è¯­è¨€
```

2ï¼‰åœ¨ `model` åŒ…ä¸‹å®šä¹‰ `ImageCollectionPlan` æ•°æ®æ¨¡å‹ï¼Œç”¨äºä¿å­˜å›¾ç‰‡æ”¶é›†ä»»åŠ¡ï¼š

```java
@Data
public class ImageCollectionPlan implements Serializable {
    
    /**
     * å†…å®¹å›¾ç‰‡æœç´¢ä»»åŠ¡åˆ—è¡¨
     */
    private List<ImageSearchTask> contentImageTasks;
    
    /**
     * æ’ç”»å›¾ç‰‡æœç´¢ä»»åŠ¡åˆ—è¡¨
     */
    private List<IllustrationTask> illustrationTasks;
    
    /**
     * æ¶æ„å›¾ç”Ÿæˆä»»åŠ¡åˆ—è¡¨
     */
    private List<DiagramTask> diagramTasks;
    
    /**
     * Logoç”Ÿæˆä»»åŠ¡åˆ—è¡¨
     */
    private List<LogoTask> logoTasks;
    
    /**
     * å†…å®¹å›¾ç‰‡æœç´¢ä»»åŠ¡
     * å¯¹åº” ImageSearchTool.searchContentImages(String query)
     */
    public record ImageSearchTask(String query) implements Serializable {}
    
    /**
     * æ’ç”»å›¾ç‰‡æœç´¢ä»»åŠ¡
     * å¯¹åº” UndrawIllustrationTool.searchIllustrations(String query)
     */
    public record IllustrationTask(String query) implements Serializable {}
    
    /**
     * æ¶æ„å›¾ç”Ÿæˆä»»åŠ¡
     * å¯¹åº” MermaidDiagramTool.generateMermaidDiagram(String mermaidCode, String description)
     */
    public record DiagramTask(String mermaidCode, String description) implements Serializable {}
    
    /**
     * Logoç”Ÿæˆä»»åŠ¡
     * å¯¹åº” LogoGeneratorTool.generateLogos(String description)
     */
    public record LogoTask(String description) implements Serializable {}
}
```

ä¸Šè¿°ä»£ç ä¸­ï¼Œä½¿ç”¨ recorâ d æ¥ç®€åŒ–æ¯ç§å›¾ç‰‡â æœé›†ä»»åŠ¡çš„å®šä¹‰ã€‚

3ï¼‰ç¼–å†™å›¾ç‰‡æ”¶é›† AI æœåŠ¡

```java
public interface ImageCollectionPlanService {

    /**
     * æ ¹æ®ç”¨æˆ·æç¤ºè¯åˆ†æéœ€è¦æ”¶é›†çš„å›¾ç‰‡ç±»å‹å’Œå‚æ•°
     */
    @SystemMessage(fromResource = "prompt/image-collection-plan-system-prompt.txt")
    ImageCollectionPlan planImageCollection(@UserMessage String userPrompt);
}
```

4ï¼‰ç¼–å†™å¯¹åº”çš„ AI æœåŠ¡å·¥â å‚ï¼Œæš‚æ—¶å…ˆå¤ç”¨ Câ hatModel æ¨¡å‹ï¼š

```java
@Configuration
public class ImageCollectionPlanServiceFactory {

    @Resource
    private ChatModel chatModel;

    @Bean
    public ImageCollectionPlanService createImageCollectionPlanService() {
        return AiServices.builder(ImageCollectionPlanService.class)
                .chatModel(chatModel)
                .build();
    }
}
```

#### CompletableFuture å¹¶å‘å®ç°ï¼ˆæ¨èï¼‰

ç›´æ¥ä¿®æ”¹å›¾ç‰‡æ”¶é›†å·¥ä½œèŠ‚ç‚¹ã€‚å…ˆè°ƒâ ç”¨ AI è¿›è¡Œè§„åˆ’ï¼Œâ ç„¶åå¹¶å‘æ”¶é›†å›¾ç‰‡å¹¶æ±‡æ€»ï¼Œæœ€åè®¾ç½® imageList çŠ¶æ€ã€‚

ä»£ç å¦‚ä¸‹ï¼š

```java
@Slf4j
public class ImageCollectorNode {

    public static AsyncNodeAction<MessagesState<String>> create() {
        return node_async(state -> {
            WorkflowContext context = WorkflowContext.getContext(state);
            String originalPrompt = context.getOriginalPrompt();
            List<ImageResource> collectedImages = new ArrayList<>();
            
            try {
                // ç¬¬ä¸€æ­¥ï¼šè·å–å›¾ç‰‡æ”¶é›†è®¡åˆ’
                ImageCollectionPlanService planService = SpringContextUtil.getBean(ImageCollectionPlanService.class);
                ImageCollectionPlan plan = planService.planImageCollection(originalPrompt);
                log.info("è·å–åˆ°å›¾ç‰‡æ”¶é›†è®¡åˆ’ï¼Œå¼€å§‹å¹¶å‘æ‰§è¡Œ");
                
                // ç¬¬äºŒæ­¥ï¼šå¹¶å‘æ‰§è¡Œå„ç§å›¾ç‰‡æ”¶é›†ä»»åŠ¡
                List<CompletableFuture<List<ImageResource>>> futures = new ArrayList<>();
                // å¹¶å‘æ‰§è¡Œå†…å®¹å›¾ç‰‡æœç´¢
                if (plan.getContentImageTasks() != null) {
                    ImageSearchTool imageSearchTool = SpringContextUtil.getBean(ImageSearchTool.class);
                    for (ImageCollectionPlan.ImageSearchTask task : plan.getContentImageTasks()) {
                        futures.add(CompletableFuture.supplyAsync(() -> 
                            imageSearchTool.searchContentImages(task.query())));
                    }
                }
                // å¹¶å‘æ‰§è¡Œæ’ç”»å›¾ç‰‡æœç´¢
                if (plan.getIllustrationTasks() != null) {
                    UndrawIllustrationTool illustrationTool = SpringContextUtil.getBean(UndrawIllustrationTool.class);
                    for (ImageCollectionPlan.IllustrationTask task : plan.getIllustrationTasks()) {
                        futures.add(CompletableFuture.supplyAsync(() -> 
                            illustrationTool.searchIllustrations(task.query())));
                    }
                }
                // å¹¶å‘æ‰§è¡Œæ¶æ„å›¾ç”Ÿæˆ
                if (plan.getDiagramTasks() != null) {
                    MermaidDiagramTool diagramTool = SpringContextUtil.getBean(MermaidDiagramTool.class);
                    for (ImageCollectionPlan.DiagramTask task : plan.getDiagramTasks()) {
                        futures.add(CompletableFuture.supplyAsync(() -> 
                            diagramTool.generateMermaidDiagram(task.mermaidCode(), task.description())));
                    }
                }
                // å¹¶å‘æ‰§è¡ŒLogoç”Ÿæˆ
                if (plan.getLogoTasks() != null) {
                    LogoGeneratorTool logoTool = SpringContextUtil.getBean(LogoGeneratorTool.class);
                    for (ImageCollectionPlan.LogoTask task : plan.getLogoTasks()) {
                        futures.add(CompletableFuture.supplyAsync(() -> 
                            logoTool.generateLogos(task.description())));
                    }
                }
                
                // ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆå¹¶æ”¶é›†ç»“æœ
                CompletableFuture<Void> allTasks = CompletableFuture.allOf(
                    futures.toArray(new CompletableFuture[0]));
                allTasks.join();
                // æ”¶é›†æ‰€æœ‰ç»“æœ
                for (CompletableFuture<List<ImageResource>> future : futures) {
                    List<ImageResource> images = future.get();
                    if (images != null) {
                        collectedImages.addAll(images);
                    }
                }
                log.info("å¹¶å‘å›¾ç‰‡æ”¶é›†å®Œæˆï¼Œå…±æ”¶é›†åˆ° {} å¼ å›¾ç‰‡", collectedImages.size());
            } catch (Exception e) {
                log.error("å›¾ç‰‡æ”¶é›†å¤±è´¥: {}", e.getMessage(), e);
            }
            // æ›´æ–°çŠ¶æ€
            context.setCurrentStep("å›¾ç‰‡æ”¶é›†");
            context.setImageList(collectedImages);
            return WorkflowContext.saveContext(context);
        });
    }
}
```

è¿™ç§æ–¹æ¡ˆå¯¹è°ƒç”¨æ–¹çš„æ”¹åŠ¨æœ€å°ï¼Œâ è€Œä¸”æŠŠå›¾ç‰‡æ”¶é›†å·¥ä½œâ èšåˆåœ¨äº†ä¸€ä¸ªç±»ä¸­ï¼Œæœ€æ¨èè¿™ç§æ–¹å¼ã€‚

æ‰§è¡Œå•å…ƒæµ‹è¯•ï¼ŒæŸ¥çœ‹æ”¶é›†åˆ°çš„å›¾ç‰‡ï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/TBXQu9tFDzGp061w.webp "null")

æŸ¥çœ‹ç”Ÿæˆçš„ç½‘ç«™ï¼Œæ˜¾ç„¶æœ‰äº†å›¾ç‰‡â è§„åˆ’åï¼Œç½‘ç«™çš„ç”Ÿæˆâ æ•ˆæœå¥½äº†å¾ˆå¤šï¼

![](https://pic.code-nav.cn/course_picture/1608440217629360130/z5ompvXPTcG051fv.webp "null")

![](https://pic.code-nav.cn/course_picture/1608440217629360130/Pa201OUaIrRhZqg0.webp "null")

![](https://pic.code-nav.cn/course_picture/1608440217629360130/N3AYeEo9xMo8Wi9V.webp "null")

![](https://pic.code-nav.cn/course_picture/1608440217629360130/VjwzKBc3JMyqi5Nb.webp "null")

å¯ä»¥é€šè¿‡åœ¨å›¾ç‰‡æ”¶é›†èŠ‚ç‚¹å†…å¢åŠ â  Spring çš„â  StopWatch æ¥å¯¹æ¯”æ€§èƒ½ï¼š

```java
// å¼€å¤´è®¡æ—¶
StopWatch stopWatch = new StopWatch();
stopWatch.start();

// ... ä¸šåŠ¡é€»è¾‘

// ç»“å°¾åœæ­¢è®¡æ—¶å¹¶è¾“å‡ºç»“æœ
stopWatch.stop();
log.info("å›¾ç‰‡æ”¶é›†æ€»è€—æ—¶: {} ms", stopWatch.getTotalTimeMillis());
```

ä½¿ç”¨å¹¶å‘å‰ï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/Bp1lMd5c07g5uzpb.webp)

ä½¿ç”¨å¹¶å‘åï¼Œ**æ€§èƒ½æå‡äº†å‡ å€ï¼Œç¼©çŸ­äº† 70 å¤šç§’ï¼**

![](https://pic.code-nav.cn/course_picture/1608440217629360130/8P835NKsjmLCWyer.webp)

ğŸ’¡ å¯ä»¥æŒ‰éœ€è°ƒæ•´è·å–å›¾ç‰‡çš„æœ€å¤§æ•°é‡ï¼Œé˜²æ­¢æç¤ºè¯è¿‡é•¿ã€‚

#### LangGraph4j å¹¶å‘å®ç°

åˆ©ç”¨ LangGraph4j çš„ [Parallel Branch](https://langgraph4j.github.io/langgraph4j/core/parallel-branch/) ç‰¹æ€§ï¼Œå°†æ¯ä¸ªå›¾ç‰‡æ”¶é›†å·¥å…·éƒ½å®šä¹‰ä¸ºä¸€ä¸ªå·¥ä½œèŠ‚ç‚¹ï¼Œè¿™äº›å·¥ä½œèŠ‚ç‚¹å¯å¹¶å‘æ‰§è¡Œã€‚

å·¥ä½œæµç¨‹å˜ä¸ºï¼šå›¾ç‰‡è§„åˆ’ => å¹¶å‘æ”¶é›† => å›¾ç‰‡èšåˆ

å¦‚å›¾ï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/tCcpLBXnnmVDzqNP.webp)

WorkflowContext çŠ¶æ€æ–°å¢å­—æ®µï¼š

```java
/**
 * å›¾ç‰‡æ”¶é›†è®¡åˆ’
 */
private ImageCollectionPlan imageCollectionPlan;


/**
 * å¹¶å‘å›¾ç‰‡æ”¶é›†çš„ä¸­é—´ç»“æœå­—æ®µ
 */
private List<ImageResource> contentImages;
private List<ImageResource> illustrations;
private List<ImageResource> diagrams;
private List<ImageResource> logos;
```

åœ¨ `node.concurrent` åŒ…ä¸‹å¼€å‘å¹¶å‘ç›¸å…³çš„æ–°å·¥ä½œèŠ‚ç‚¹ï¼ŒåŒ…æ‹¬ï¼š

-   1 ä¸ªè§„åˆ’èŠ‚ç‚¹
-   4 ä¸ªæ”¶é›†èŠ‚ç‚¹
-   1 ä¸ªæ±‡æ€»èŠ‚ç‚¹

![](https://pic.code-nav.cn/course_picture/1608440217629360130/C77kjGvYlwm5XTKZ.webp)

æ¥ä¸‹æ¥åˆ†åˆ«å¼€å‘è¿™äº›èŠ‚ç‚¹ã€‚

1ï¼‰å›¾ç‰‡è®¡åˆ’èŠ‚ç‚¹ï¼šåˆ†æç”¨æˆ·éœ€â æ±‚ï¼Œç”Ÿæˆå›¾ç‰‡æ”¶é›†è®¡â åˆ’ï¼Œä¸ºå¹¶å‘æ‰§è¡Œåšå‡†å¤‡

```java
@Slf4j
public class ImagePlanNode {

    public static AsyncNodeAction<MessagesState<String>> create() {
        return node_async(state -> {
            WorkflowContext context = WorkflowContext.getContext(state);
            String originalPrompt = context.getOriginalPrompt();
            try {
                // è·å–å›¾ç‰‡æ”¶é›†è®¡åˆ’æœåŠ¡
                ImageCollectionPlanService planService = SpringContextUtil.getBean(ImageCollectionPlanService.class);
                ImageCollectionPlan plan = planService.planImageCollection(originalPrompt);
                log.info("ç”Ÿæˆå›¾ç‰‡æ”¶é›†è®¡åˆ’ï¼Œå‡†å¤‡å¯åŠ¨å¹¶å‘åˆ†æ”¯");
                // å°†è®¡åˆ’å­˜å‚¨åˆ°ä¸Šä¸‹æ–‡ä¸­
                context.setImageCollectionPlan(plan);
                context.setCurrentStep("å›¾ç‰‡è®¡åˆ’");
            } catch (Exception e) {
                log.error("å›¾ç‰‡è®¡åˆ’ç”Ÿæˆå¤±è´¥: {}", e.getMessage(), e);
            }
            return WorkflowContext.saveContext(context);
        });
    }
}
```

2ï¼‰å†…å®¹å›¾ç‰‡æ”¶é›†èŠ‚ç‚¹ï¼šå¹¶å‘æ‰§â è¡Œå†…å®¹å›¾ç‰‡æœç´¢ä»»åŠ¡â ï¼ˆç›´æ¥è°ƒç”¨ä¹‹å‰å·²å¼€å‘çš„å·¥å…·ï¼‰

```java
@Slf4j
public class ContentImageCollectorNode {

    public static AsyncNodeAction<MessagesState<String>> create() {
        return node_async(state -> {
            WorkflowContext context = WorkflowContext.getContext(state);
            List<ImageResource> contentImages = new ArrayList<>();
            try {
                ImageCollectionPlan plan = context.getImageCollectionPlan();
                if (plan != null && plan.getContentImageTasks() != null) {
                    ImageSearchTool imageSearchTool = SpringContextUtil.getBean(ImageSearchTool.class);
                    log.info("å¼€å§‹å¹¶å‘æ”¶é›†å†…å®¹å›¾ç‰‡ï¼Œä»»åŠ¡æ•°: {}", plan.getContentImageTasks().size());
                    for (ImageCollectionPlan.ImageSearchTask task : plan.getContentImageTasks()) {
                        List<ImageResource> images = imageSearchTool.searchContentImages(task.query());
                        if (images != null) {
                            contentImages.addAll(images);
                        }
                    }
                    log.info("å†…å®¹å›¾ç‰‡æ”¶é›†å®Œæˆï¼Œå…±æ”¶é›†åˆ° {} å¼ å›¾ç‰‡", contentImages.size());
                }
            } catch (Exception e) {
                log.error("å†…å®¹å›¾ç‰‡æ”¶é›†å¤±è´¥: {}", e.getMessage(), e);
            }
            // å°†æ”¶é›†åˆ°çš„å›¾ç‰‡å­˜å‚¨åˆ°ä¸Šä¸‹æ–‡çš„ä¸­é—´å­—æ®µä¸­
            context.setContentImages(contentImages);
            context.setCurrentStep("å†…å®¹å›¾ç‰‡æ”¶é›†");
            return WorkflowContext.saveContext(context);
        });
    }
}
```

3ï¼‰æ’ç”»å›¾ç‰‡æ”¶é›†èŠ‚ç‚¹ï¼š

```java
@Slf4j
public class IllustrationCollectorNode {

    public static AsyncNodeAction<MessagesState<String>> create() {
        return node_async(state -> {
            WorkflowContext context = WorkflowContext.getContext(state);
            List<ImageResource> illustrations = new ArrayList<>();
            try {
                ImageCollectionPlan plan = context.getImageCollectionPlan();
                if (plan != null && plan.getIllustrationTasks() != null) {
                    UndrawIllustrationTool illustrationTool = SpringContextUtil.getBean(UndrawIllustrationTool.class);
                    log.info("å¼€å§‹å¹¶å‘æ”¶é›†æ’ç”»å›¾ç‰‡ï¼Œä»»åŠ¡æ•°: {}", plan.getIllustrationTasks().size());
                    for (ImageCollectionPlan.IllustrationTask task : plan.getIllustrationTasks()) {
                        List<ImageResource> images = illustrationTool.searchIllustrations(task.query());
                        if (images != null) {
                            illustrations.addAll(images);
                        }
                    }
                    log.info("æ’ç”»å›¾ç‰‡æ”¶é›†å®Œæˆï¼Œå…±æ”¶é›†åˆ° {} å¼ å›¾ç‰‡", illustrations.size());
                }
            } catch (Exception e) {
                log.error("æ’ç”»å›¾ç‰‡æ”¶é›†å¤±è´¥: {}", e.getMessage(), e);
            }
            context.setIllustrations(illustrations);
            context.setCurrentStep("æ’ç”»å›¾ç‰‡æ”¶é›†");
            return WorkflowContext.saveContext(context);
        });
    }
}
```

4ï¼‰æ¶æ„å›¾ç»˜åˆ¶èŠ‚ç‚¹ï¼š

```java
@Slf4j
public class DiagramCollectorNode {

    public static AsyncNodeAction<MessagesState<String>> create() {
        return node_async(state -> {
            WorkflowContext context = WorkflowContext.getContext(state);
            List<ImageResource> diagrams = new ArrayList<>();
            try {
                ImageCollectionPlan plan = context.getImageCollectionPlan();
                if (plan != null && plan.getDiagramTasks() != null) {
                    MermaidDiagramTool diagramTool = SpringContextUtil.getBean(MermaidDiagramTool.class);
                    log.info("å¼€å§‹å¹¶å‘ç”Ÿæˆæ¶æ„å›¾ï¼Œä»»åŠ¡æ•°: {}", plan.getDiagramTasks().size());
                    for (ImageCollectionPlan.DiagramTask task : plan.getDiagramTasks()) {
                        List<ImageResource> images = diagramTool.generateMermaidDiagram(
                                task.mermaidCode(), task.description());
                        if (images != null) {
                            diagrams.addAll(images);
                        }
                    }
                    log.info("æ¶æ„å›¾ç”Ÿæˆå®Œæˆï¼Œå…±ç”Ÿæˆ {} å¼ å›¾ç‰‡", diagrams.size());
                }
            } catch (Exception e) {
                log.error("æ¶æ„å›¾ç”Ÿæˆå¤±è´¥: {}", e.getMessage(), e);
            }
            context.setDiagrams(diagrams);
            context.setCurrentStep("æ¶æ„å›¾ç”Ÿæˆ");
            return WorkflowContext.saveContext(context);
        });
    }
}
```

5ï¼‰Logo ç”ŸæˆèŠ‚ç‚¹ï¼š

```java
@Slf4j
public class LogoCollectorNode {

    public static AsyncNodeAction<MessagesState<String>> create() {
        return node_async(state -> {
            WorkflowContext context = WorkflowContext.getContext(state);
            List<ImageResource> logos = new ArrayList<>();
            try {
                ImageCollectionPlan plan = context.getImageCollectionPlan();
                if (plan != null && plan.getLogoTasks() != null) {
                    LogoGeneratorTool logoTool = SpringContextUtil.getBean(LogoGeneratorTool.class);
                    log.info("å¼€å§‹å¹¶å‘ç”ŸæˆLogoï¼Œä»»åŠ¡æ•°: {}", plan.getLogoTasks().size());
                    for (ImageCollectionPlan.LogoTask task : plan.getLogoTasks()) {
                        List<ImageResource> images = logoTool.generateLogos(task.description());
                        if (images != null) {
                            logos.addAll(images);
                        }
                    }
                    log.info("Logoç”Ÿæˆå®Œæˆï¼Œå…±ç”Ÿæˆ {} å¼ å›¾ç‰‡", logos.size());
                }
            } catch (Exception e) {
                log.error("Logoç”Ÿæˆå¤±è´¥: {}", e.getMessage(), e);
            }
            context.setLogos(logos);
            context.setCurrentStep("Logoç”Ÿæˆ");
            return WorkflowContext.saveContext(context);
        });
    }
}
```

6ï¼‰å›¾ç‰‡èšåˆèŠ‚ç‚¹ï¼šæ±‡èšæ‰€æœ‰å¹¶å‘åˆ†æ”¯æ”¶é›†åˆ°çš„å›¾ç‰‡

```java
@Slf4j
public class ImageAggregatorNode {

    public static AsyncNodeAction<MessagesState<String>> create() {
        return node_async(state -> {
            WorkflowContext context = WorkflowContext.getContext(state);
            List<ImageResource> allImages = new ArrayList<>();
            log.info("å¼€å§‹èšåˆå¹¶å‘æ”¶é›†çš„å›¾ç‰‡");
            // ä»å„ä¸ªä¸­é—´å­—æ®µèšåˆå›¾ç‰‡
            if (context.getContentImages() != null) {
                allImages.addAll(context.getContentImages());
            }
            if (context.getIllustrations() != null) {
                allImages.addAll(context.getIllustrations());
            }
            if (context.getDiagrams() != null) {
                allImages.addAll(context.getDiagrams());
            }
            if (context.getLogos() != null) {
                allImages.addAll(context.getLogos());
            }
            log.info("å›¾ç‰‡èšåˆå®Œæˆï¼Œæ€»å…± {} å¼ å›¾ç‰‡", allImages.size());
            // æ›´æ–°æœ€ç»ˆçš„å›¾ç‰‡åˆ—è¡¨
            context.setImageList(allImages);
            context.setCurrentStep("å›¾ç‰‡èšåˆ");
            return WorkflowContext.saveContext(context);
        });
    }
}
```

___

ç¼–å†™ä¸€ä¸ªæ–°çš„å·¥ä½œæµ `CodeGenConcurrentWorkflow`ï¼Œä½¿ç”¨ LangGraph4j çš„å¹¶å‘èƒ½åŠ›å®ç°å›¾ç‰‡æ”¶é›†çš„å¹¶å‘æ‰§è¡Œï¼š

```java
@Slf4j
public class CodeGenConcurrentWorkflow {

    /**
     * åˆ›å»ºå¹¶å‘å·¥ä½œæµ
     */
    public CompiledGraph<MessagesState<String>> createWorkflow() {
        try {
            return new MessagesStateGraph<String>()
                    // æ·»åŠ èŠ‚ç‚¹
                    .addNode("image_plan", ImagePlanNode.create())
                    .addNode("prompt_enhancer", PromptEnhancerNode.create())
                    .addNode("router", RouterNode.create())
                    .addNode("code_generator", CodeGeneratorNode.create())
                    .addNode("code_quality_check", CodeQualityCheckNode.create())
                    .addNode("project_builder", ProjectBuilderNode.create())

                    // æ·»åŠ å¹¶å‘å›¾ç‰‡æ”¶é›†èŠ‚ç‚¹
                    .addNode("content_image_collector", ContentImageCollectorNode.create())
                    .addNode("illustration_collector", IllustrationCollectorNode.create())
                    .addNode("diagram_collector", DiagramCollectorNode.create())
                    .addNode("logo_collector", LogoCollectorNode.create())
                    .addNode("image_aggregator", ImageAggregatorNode.create())

                    // æ·»åŠ è¾¹
                    .addEdge(START, "image_plan")

                    // å¹¶å‘åˆ†æ”¯ï¼šä»è®¡åˆ’èŠ‚ç‚¹åˆ†å‘åˆ°å„ä¸ªæ”¶é›†èŠ‚ç‚¹
                    .addEdge("image_plan", "content_image_collector")
                    .addEdge("image_plan", "illustration_collector")
                    .addEdge("image_plan", "diagram_collector")
                    .addEdge("image_plan", "logo_collector")

                    // æ±‡èšï¼šæ‰€æœ‰æ”¶é›†èŠ‚ç‚¹éƒ½æ±‡èšåˆ°èšåˆå™¨
                    .addEdge("content_image_collector", "image_aggregator")
                    .addEdge("illustration_collector", "image_aggregator")
                    .addEdge("diagram_collector", "image_aggregator")
                    .addEdge("logo_collector", "image_aggregator")

                    // ç»§ç»­ä¸²è¡Œæµç¨‹
                    .addEdge("image_aggregator", "prompt_enhancer")
                    .addEdge("prompt_enhancer", "router")
                    .addEdge("router", "code_generator")
                    .addEdge("code_generator", "code_quality_check")

                    // è´¨æ£€æ¡ä»¶è¾¹
                    .addConditionalEdges("code_quality_check",
                            edge_async(this::routeAfterQualityCheck),
                            Map.of(
                                    "build", "project_builder",
                                    "skip_build", END,
                                    "fail", "code_generator"
                            ))
                    .addEdge("project_builder", END)
                    .compile();
        } catch (GraphStateException e) {
            throw new BusinessException(ErrorCode.OPERATION_ERROR, "å¹¶å‘å·¥ä½œæµåˆ›å»ºå¤±è´¥");
        }
    }

    /**
     * æ‰§è¡Œå¹¶å‘å·¥ä½œæµ
     */
    public WorkflowContext executeWorkflow(String originalPrompt) {
        CompiledGraph<MessagesState<String>> workflow = createWorkflow();
        WorkflowContext initialContext = WorkflowContext.builder()
                .originalPrompt(originalPrompt)
                .currentStep("åˆå§‹åŒ–")
                .build();
        GraphRepresentation graph = workflow.getGraph(GraphRepresentation.Type.MERMAID);
        log.info("å¹¶å‘å·¥ä½œæµå›¾:\n{}", graph.content());
        log.info("å¼€å§‹æ‰§è¡Œå¹¶å‘ä»£ç ç”Ÿæˆå·¥ä½œæµ");
        WorkflowContext finalContext = null;
        int stepCounter = 1;
        for (NodeOutput<MessagesState<String>> step : workflow.stream(
                Map.of(WorkflowContext.WORKFLOW_CONTEXT_KEY, initialContext)
        )) {
            log.info("--- ç¬¬ {} æ­¥å®Œæˆ ---", stepCounter);
            WorkflowContext currentContext = WorkflowContext.getContext(step.state());
            if (currentContext != null) {
                finalContext = currentContext;
                log.info("å½“å‰æ­¥éª¤ä¸Šä¸‹æ–‡: {}", currentContext);
            }
            stepCounter++;
        }
        log.info("å¹¶å‘ä»£ç ç”Ÿæˆå·¥ä½œæµæ‰§è¡Œå®Œæˆï¼");
        return finalContext;
    }

    /**
     * è·¯ç”±å‡½æ•°ï¼šæ ¹æ®è´¨æ£€ç»“æœå†³å®šä¸‹ä¸€æ­¥
     */
    private String routeAfterQualityCheck(MessagesState<String> state) {
        WorkflowContext context = WorkflowContext.getContext(state);
        QualityResult qualityResult = context.getQualityResult();

        if (qualityResult == null || !qualityResult.getIsValid()) {
            log.error("ä»£ç è´¨æ£€å¤±è´¥ï¼Œéœ€è¦é‡æ–°ç”Ÿæˆä»£ç ");
            return "fail";
        }
        log.info("ä»£ç è´¨æ£€é€šè¿‡ï¼Œç»§ç»­åç»­æµç¨‹");
        CodeGenTypeEnum generationType = context.getGenerationType();
        if (generationType == CodeGenTypeEnum.VUE_PROJECT) {
            return "build";
        } else {
            return "skip_build";
        }
    }
}
```

ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦ä¸ºåŒä¸€â ä¸ªå·¥ä½œèŠ‚ç‚¹åˆ›é€ è¿æ¥â åˆ°å¤šä¸ªä¸åŒå›¾ç‰‡æ”¶é›†å·¥ä½œèŠ‚ç‚¹çš„è¾¹ï¼Œæ¡†æ¶å°±ä¼šè‡ªåŠ¨ä½œä¸ºå¹¶å‘åˆ†æ”¯å¤„ç†ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç¼–å†™å¹¶å‘ä»£ç ç”Ÿæˆå·¥ä½œæµçš„å•å…ƒæµ‹è¯•ï¼š

```java
@SpringBootTest
class CodeGenConcurrentWorkflowTest {

    @Test
    void testConcurrentWorkflow() {
        WorkflowContext result = new CodeGenConcurrentWorkflow().executeWorkflow("åˆ›å»ºä¸€ä¸ªæŠ€æœ¯åšå®¢ç½‘ç«™ï¼Œéœ€è¦å±•ç¤ºç¼–ç¨‹æ•™ç¨‹å’Œç³»ç»Ÿæ¶æ„");
        Assertions.assertNotNull(result);
        System.out.println("ç”Ÿæˆç±»å‹: " + result.getGenerationType());
        System.out.println("ç”Ÿæˆçš„ä»£ç ç›®å½•: " + result.getGeneratedCodeDir());
        System.out.println("æ„å»ºç»“æœç›®å½•: " + result.getBuildResultDir());
        System.out.println("æ”¶é›†çš„å›¾ç‰‡æ•°é‡: " + (result.getImageList() != null ? result.getImageList().size() : 0));
    }

    @Test
    void testEcommerceWorkflow() {
        WorkflowContext result = new CodeGenConcurrentWorkflow().executeWorkflow("åˆ›å»ºä¸€ä¸ªç”µå­å•†åŠ¡ç½‘ç«™ï¼Œéœ€è¦å•†å“å±•ç¤ºã€è´­ç‰©è½¦å’Œæ”¯ä»˜åŠŸèƒ½");
        Assertions.assertNotNull(result);
        System.out.println("ç”Ÿæˆç±»å‹: " + result.getGenerationType());
        System.out.println("ç”Ÿæˆçš„ä»£ç ç›®å½•: " + result.getGeneratedCodeDir());
        System.out.println("æ”¶é›†çš„å›¾ç‰‡æ•°é‡: " + (result.getImageList() != null ? result.getImageList().size() : 0));
    }
}
```

æ‰§è¡Œå•å…ƒæµ‹è¯•ï¼Œä½†æ˜¯æŸ¥çœ‹æ—¥å¿—å‘ç°ç«Ÿç„¶è¿˜æ˜¯æŒ‰é¡ºåºä¸²è¡Œæ‰§è¡Œçš„ï¼Ÿï¼

![](https://pic.code-nav.cn/course_picture/1608440217629360130/L659FsUEBlvL2yMT.webp)

è¿™æ—¶ç”±äºä¹‹å‰ LangGraph4j çš„æ—§ç‰ˆæœ¬æ˜¯ä¸æ”¯æŒå¹¶å‘çš„ï¼Œå³ä½¿æŒ‰ç…§è¦æ±‚å†™ä»£ç ï¼Œå¹¶å‘åˆ†æ”¯ä»ç„¶æ˜¯ä¸²è¡Œæ‰§è¡Œï¼›ä» `1.6.0-rc2` ç‰ˆæœ¬åï¼Œå°±æ”¯æŒé…ç½®çº¿ç¨‹æ± äº†ã€‚

ç›¸å…³ issue ä¿¡æ¯ï¼š

-   [https://github.com/langgraph4j/langgraph4j/issues/151](https://github.com/langgraph4j/langgraph4j/issues/151)
-   [https://github.com/langgraph4j/langgraph4j/discussions/191](https://github.com/langgraph4j/langgraph4j/discussions/191)

éœ€è¦é…ç½®çº¿ç¨‹æ± å’Œè¿è¡Œæ—¶é…ç½®ï¼š

```java
// é…ç½®å¹¶å‘æ‰§è¡Œ
ExecutorService pool = ExecutorBuilder.create()
        .setCorePoolSize(10)
        .setMaxPoolSize(20)
        .setWorkQueue(new LinkedBlockingQueue<>(100))
        .setThreadFactory(ThreadFactoryBuilder.create().setNamePrefix("Parallel-Image-Collect").build())
        .build();
RunnableConfig runnableConfig = RunnableConfig.builder()
        .addParallelNodeExecutor("image_plan", pool)
        .build();
for (NodeOutput<MessagesState<String>> step : workflow.stream(
        Map.of(WorkflowContext.WORKFLOW_CONTEXT_KEY, initialContext),
        runnableConfig)) {}
```

å†æ¬¡æ‰§è¡Œå•å…ƒæµ‹è¯•ï¼Œè¿™æ¬¡å¹¶å‘ç”Ÿæ•ˆï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/Zp3GJQ7QMduTlPgB.webp)

ç­‰å¹¶å‘åˆ†æ”¯éƒ½æ‰§è¡Œå®Œåï¼Œæ‰ä¼šè¿›è¡Œä¸‹ä¸€æ­¥èšåˆå›¾ç‰‡ï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/wCnUYG2nZNlX84j7.webp)

#### LangGraph4j å­å›¾å®ç°

å…¶å®åœ¨ç›®å‰æˆ‘ä»¬çš„åœºæ™¯é‡Œæ˜¯ç”¨ä¸åˆ° [å­å›¾](https://langgraph4j.github.io/langgraph4j/core/parallel-branch/#use-compiled-sub-graph-as-parallel-node) çš„ï¼Œæ­¤å¤„åªæ˜¯ç»™å¤§å®¶ä½œä¸ºç¤ºä¾‹ã€‚å¦‚æœå¹¶å‘åˆ†æ”¯æ­¥éª¤è¶…å‡º 1 ä¸ªï¼Œå†è€ƒè™‘ä½¿ç”¨ã€‚

![](https://pic.code-nav.cn/course_picture/1608440217629360130/yNW4SzhKhfKWW7uV.webp)

è¿˜è®°å¾—å­å›¾çš„ 3 ç§åˆ›å»ºæ–¹å¼ä¹ˆï¼Ÿ

1.  ç›´æ¥æ·»åŠ ï¼šè¿™ç§æ–¹å¼ä¼šå°†å­å›¾å®Œå…¨åˆå¹¶åˆ°çˆ¶å›¾ä¸­ï¼Œæ— ç¼é›†æˆã€‚åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œçˆ¶å›¾å’Œå­å›¾å…±äº«æ‰€æœ‰çŠ¶æ€ï¼Œå­å›¾å°±åƒæ˜¯çˆ¶å›¾çš„ä¸€ä¸ªæ‰©å±•éƒ¨åˆ†ã€‚
2.  ç¼–è¯‘æ·»åŠ ï¼šè¿™ç§æ–¹å¼è®©å­å›¾å’Œçˆ¶å›¾ä¿æŒä¸€å®šçš„ç‹¬ç«‹æ€§ï¼Œåªå…±äº«éƒ¨åˆ†çŠ¶æ€ã€‚é€‚åˆéœ€è¦ä¸€å®šç‹¬ç«‹æ€§ä½†åˆéœ€è¦ä¸ä¸»æµç¨‹äº¤äº’çš„åœºæ™¯ã€‚
3.  æ“ä½œèŠ‚ç‚¹ï¼šå¯ä»¥è‡ªå·±å®šä¹‰å­å›¾å’Œçˆ¶å›¾ä¹‹é—´çš„äº¤äº’é€»è¾‘ï¼ŒåŒ…æ‹¬çŠ¶æ€çš„è½¬æ¢ã€æ•°æ®çš„ä¼ é€’ç­‰ï¼Œæœ€çµæ´»ã€‚é€‚åˆéœ€è¦å¤æ‚äº¤äº’é€»è¾‘çš„åœºæ™¯ã€‚

æ­¤å¤„æˆ‘ä»¬é€‰æ‹©ç¬¬ 1 ç§ï¼Œ**å­å›¾çˆ¶å›¾çŠ¶æ€å¯ä»¥å®Œå…¨å…±äº«**ï¼Œå› ä¸ºå­å›¾ä¸éœ€è¦è¢«å¤ç”¨ã€‚

è¿™é‡Œæˆ‘ä»¬å¯ä»¥ç¼–å†™ä¸€ä¸ªæ–°çš„å·¥ä½œæµï¼Œä½¿ç”¨ LangGâ raph4j çš„å­å›¾èƒ½åŠ›å®ç°å›¾ç‰‡â æ”¶é›†çš„å¹¶å‘æ‰§è¡Œã€‚è¿™æ®µä»£ç ä»…ä¾›å‚è€ƒï¼Œå®é™…æœªè¿›è¡Œå¹¶å‘ç›¸å…³çš„é…ç½®ï¼Œå¤§å®¶äº†è§£ä¸€ä¸‹å°±å¥½ï¼Œä¸ç”¨è‡ªå·±å®ç°ã€‚

```java
@Slf4j
public class CodeGenSubgraphWorkflow {

    /**
     * åˆ›å»ºå†…å®¹å›¾ç‰‡æ”¶é›†å­å›¾
     */
    private StateGraph<MessagesState<String>> createContentImageSubgraph() {
        try {
            return new MessagesStateGraph<String>()
                    .addNode("content_collect", ContentImageCollectorNode.create())
                    .addEdge(START, "content_collect")
                    .addEdge("content_collect", END);
        } catch (GraphStateException e) {
            throw new BusinessException(ErrorCode.OPERATION_ERROR, "å†…å®¹å›¾ç‰‡å­å›¾åˆ›å»ºå¤±è´¥");
        }
    }

    /**
     * åˆ›å»ºæ’ç”»æ”¶é›†å­å›¾
     */
    private StateGraph<MessagesState<String>> createIllustrationSubgraph() {
        try {
            return new MessagesStateGraph<String>()
                    .addNode("illustration_collect", IllustrationCollectorNode.create())
                    .addEdge(START, "illustration_collect")
                    .addEdge("illustration_collect", END);
        } catch (GraphStateException e) {
            throw new BusinessException(ErrorCode.OPERATION_ERROR, "æ’ç”»å­å›¾åˆ›å»ºå¤±è´¥");
        }
    }

    /**
     * åˆ›å»ºæ¶æ„å›¾ç”Ÿæˆå­å›¾
     */
    private StateGraph<MessagesState<String>> createDiagramSubgraph() {
        try {
            return new MessagesStateGraph<String>()
                    .addNode("diagram_generate", DiagramCollectorNode.create())
                    .addEdge(START, "diagram_generate")
                    .addEdge("diagram_generate", END);
        } catch (GraphStateException e) {
            throw new BusinessException(ErrorCode.OPERATION_ERROR, "æ¶æ„å›¾å­å›¾åˆ›å»ºå¤±è´¥");
        }
    }

    /**
     * åˆ›å»ºLogoç”Ÿæˆå­å›¾
     */
    private StateGraph<MessagesState<String>> createLogoSubgraph() {
        try {
            return new MessagesStateGraph<String>()
                    .addNode("logo_generate", LogoCollectorNode.create())
                    .addEdge(START, "logo_generate")
                    .addEdge("logo_generate", END);
        } catch (GraphStateException e) {
            throw new BusinessException(ErrorCode.OPERATION_ERROR, "Logoå­å›¾åˆ›å»ºå¤±è´¥");
        }
    }

    /**
     * åˆ›å»ºå­å›¾å·¥ä½œæµ
     */
    public CompiledGraph<MessagesState<String>> createWorkflow() {
        try {
            // è·å–å„ä¸ªæœªç¼–è¯‘çš„å­å›¾ï¼ˆè·Ÿçˆ¶å›¾å®Œå…¨å…±äº«çŠ¶æ€ï¼‰
            StateGraph<MessagesState<String>> contentImageSubgraph = createContentImageSubgraph();
            StateGraph<MessagesState<String>> illustrationSubgraph = createIllustrationSubgraph();
            StateGraph<MessagesState<String>> diagramSubgraph = createDiagramSubgraph();
            StateGraph<MessagesState<String>> logoSubgraph = createLogoSubgraph();

            return new MessagesStateGraph<String>()
                    // æ·»åŠ å¸¸è§„èŠ‚ç‚¹
                    .addNode("image_plan", ImagePlanNode.create())
                    .addNode("prompt_enhancer", PromptEnhancerNode.create())
                    .addNode("router", RouterNode.create())
                    .addNode("code_generator", CodeGeneratorNode.create())
                    .addNode("code_quality_check", CodeQualityCheckNode.create())
                    .addNode("project_builder", ProjectBuilderNode.create())
                    
                    // æ·»åŠ ç¼–è¯‘åçš„å­å›¾ä½œä¸ºèŠ‚ç‚¹
                    .addNode("content_image_subgraph", contentImageSubgraph)
                    .addNode("illustration_subgraph", illustrationSubgraph)
                    .addNode("diagram_subgraph", diagramSubgraph)
                    .addNode("logo_subgraph", logoSubgraph)
                    
                    // æ·»åŠ å›¾ç‰‡èšåˆèŠ‚ç‚¹
                    .addNode("image_aggregator", ImageAggregatorNode.create())

                    // æ·»åŠ è¾¹ - ä¸²è¡Œéƒ¨åˆ†
                    .addEdge(START, "image_plan")
                    
                    // å¹¶å‘å­å›¾åˆ†æ”¯ï¼šä»è®¡åˆ’èŠ‚ç‚¹åˆ†å‘åˆ°å„ä¸ªå­å›¾
                    .addEdge("image_plan", "content_image_subgraph")
                    .addEdge("image_plan", "illustration_subgraph")
                    .addEdge("image_plan", "diagram_subgraph")
                    .addEdge("image_plan", "logo_subgraph")
                    
                    // æ±‡èšï¼šæ‰€æœ‰å­å›¾éƒ½æ±‡èšåˆ°èšåˆå™¨
                    .addEdge("content_image_subgraph", "image_aggregator")
                    .addEdge("illustration_subgraph", "image_aggregator")
                    .addEdge("diagram_subgraph", "image_aggregator")
                    .addEdge("logo_subgraph", "image_aggregator")
                    
                    // ç»§ç»­ä¸²è¡Œæµç¨‹
                    .addEdge("image_aggregator", "prompt_enhancer")
                    .addEdge("prompt_enhancer", "router")
                    .addEdge("router", "code_generator")
                    .addEdge("code_generator", "code_quality_check")

                    // è´¨æ£€æ¡ä»¶è¾¹
                    .addConditionalEdges("code_quality_check",
                            edge_async(this::routeAfterQualityCheck),
                            Map.of(
                                    "build", "project_builder",
                                    "skip_build", END,
                                    "fail", "code_generator"
                            ))
                    .addEdge("project_builder", END)

                    .compile();
        } catch (GraphStateException e) {
            throw new BusinessException(ErrorCode.OPERATION_ERROR, "å­å›¾å·¥ä½œæµåˆ›å»ºå¤±è´¥");
        }
    }

    /**
     * è·¯ç”±å‡½æ•°ï¼šæ ¹æ®è´¨æ£€ç»“æœå†³å®šä¸‹ä¸€æ­¥
     */
    private String routeAfterQualityCheck(MessagesState<String> state) {
        WorkflowContext context = WorkflowContext.getContext(state);
        QualityResult qualityResult = context.getQualityResult();

        if (qualityResult == null || !qualityResult.getIsValid()) {
            log.error("ä»£ç è´¨æ£€å¤±è´¥ï¼Œéœ€è¦é‡æ–°ç”Ÿæˆä»£ç ");
            return "fail";
        }

        log.info("ä»£ç è´¨æ£€é€šè¿‡ï¼Œç»§ç»­åç»­æµç¨‹");
        CodeGenTypeEnum generationType = context.getGenerationType();
        if (generationType == CodeGenTypeEnum.VUE_PROJECT) {
            return "build";
        } else {
            return "skip_build";
        }
    }

    /**
     * æ‰§è¡Œå­å›¾å·¥ä½œæµ
     */
    public WorkflowContext executeWorkflow(String originalPrompt) {
        CompiledGraph<MessagesState<String>> workflow = createWorkflow();

        WorkflowContext initialContext = WorkflowContext.builder()
                .originalPrompt(originalPrompt)
                .currentStep("åˆå§‹åŒ–")
                .build();

        GraphRepresentation graph = workflow.getGraph(GraphRepresentation.Type.MERMAID);
        log.info("å­å›¾å·¥ä½œæµå›¾:\n{}", graph.content());
        log.info("å¼€å§‹æ‰§è¡Œå­å›¾ä»£ç ç”Ÿæˆå·¥ä½œæµ");

        WorkflowContext finalContext = null;
        int stepCounter = 1;
        for (NodeOutput<MessagesState<String>> step : workflow.stream(
                Map.of(WorkflowContext.WORKFLOW_CONTEXT_KEY, initialContext))) {
            log.info("--- ç¬¬ {} æ­¥å®Œæˆ ---", stepCounter);
            WorkflowContext currentContext = WorkflowContext.getContext(step.state());
            if (currentContext != null) {
                finalContext = currentContext;
                log.info("å½“å‰æ­¥éª¤ä¸Šä¸‹æ–‡: {}", currentContext);
            }
            stepCounter++;
        }
        log.info("å­å›¾ä»£ç ç”Ÿæˆå·¥ä½œæµæ‰§è¡Œå®Œæˆï¼");
        return finalContext;
    }
}
```

åˆ›å»ºå•å…ƒæµ‹è¯•ï¼š

```java
@SpringBootTest
class CodeGenSubgraphWorkflowTest {

    @Test
    void testSubgraphWorkflow() {
        WorkflowContext result = new CodeGenSubgraphWorkflow().executeWorkflow("åˆ›å»ºä¸€ä¸ªåœ¨çº¿å­¦ä¹ å¹³å°ï¼Œéœ€è¦è¯¾ç¨‹å±•ç¤ºã€è§†é¢‘æ’­æ”¾å’Œå­¦ä¹ è¿›åº¦è·Ÿè¸ª");
        Assertions.assertNotNull(result);
        System.out.println("ç”Ÿæˆç±»å‹: " + result.getGenerationType());
        System.out.println("ç”Ÿæˆçš„ä»£ç ç›®å½•: " + result.getGeneratedCodeDir());
        System.out.println("æ„å»ºç»“æœç›®å½•: " + result.getBuildResultDir());
        System.out.println("æ”¶é›†çš„å›¾ç‰‡æ•°é‡: " + (result.getImageList() != null ? result.getImageList().size() : 0));
    }

    @Test
    void testPortfolioWorkflow() {
        WorkflowContext result = new CodeGenSubgraphWorkflow().executeWorkflow("åˆ›å»ºä¸€ä¸ªä¸ªäººä½œå“é›†ç½‘ç«™ï¼Œå±•ç¤ºé¡¹ç›®æ¡ˆä¾‹å’ŒæŠ€èƒ½ä»‹ç»");
        Assertions.assertNotNull(result);
        System.out.println("ç”Ÿæˆç±»å‹: " + result.getGenerationType());
        System.out.println("ç”Ÿæˆçš„ä»£ç ç›®å½•: " + result.getGeneratedCodeDir());
        System.out.println("æ”¶é›†çš„å›¾ç‰‡æ•°é‡: " + (result.getImageList() != null ? result.getImageList().size() : 0));
    }
}
```

æ‰§è¡Œå•å…ƒæµ‹è¯•ï¼Œå‘ç°æˆåŠŸæœé›†åˆ°â äº†å¤šç±»å›¾ç‰‡ï¼Œå­çˆ¶å›¾â çŠ¶æ€å®Œå…¨å…±äº«ï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/HSUsD93DGnN4fyEG.webp "null")

#### ä¸‰ç§å¹¶å‘æ–¹æ¡ˆå¯¹æ¯”

æœ€åï¼Œå†ç»™å¤§å®¶æä¾›ä¸Šè¿° 3 ç§å¹¶å‘æ–¹æ¡ˆçš„å¯¹æ¯”è¡¨ï¼š



|æ–¹é¢|æ–¹æ¡ˆ1 (CompletableFuture)|æ–¹æ¡ˆ2 (LangGraph4j å¹¶å‘)|æ–¹æ¡ˆ3 (LangGraph4j å­å›¾)|
|---|---|---|---|
|å®ç°å¤æ‚åº¦|ä¸­ç­‰|ä¸­ç­‰|é«˜|
|å¯ç»´æŠ¤æ€§|ä¸­ç­‰|é«˜|æœ€é«˜|
|å¯é‡ç”¨æ€§|ä½|ä¸­ç­‰|â æœ€é«˜|
|ç‹¬ç«‹æµ‹è¯•|éš¾|ä¸­ç­‰|å®¹æ˜“|
|çŠ¶â æ€ç®¡ç†|æ‰‹åŠ¨|æ¡†æ¶è‡ªåŠ¨|æ¡†æ¶è‡ªåŠ¨|
|å¯è§†åŒ–|å•èŠ‚ç‚¹|å¤šèŠ‚ç‚¹|å­å›¾ç»“æ„|
|å›¢é˜Ÿåä½œ|éš¾|ä¸­ç­‰|æœ€ä½³|

é±¼çš®çš„å»ºè®®æ˜¯ï¼Œå¦‚æœä½ çš„ç³»ç»Ÿæœ¬èº«å°±æ˜¯åŸºäºå·¥ä½œâ æµè¿›è¡Œè®¾è®¡å®ç°çš„ï¼Œé‡‡ç”¨æ–¹æ¡ˆ â 2 æˆ–æ–¹æ¡ˆ 3ã€‚å­å›¾å°¤å…¶é€‚åˆéœ€è¦æ¨¡å—åŒ–å¼€å‘çš„å¤§å‹é¡¹ç›®ã€æˆ–è€…éœ€è¦å¤ç”¨æŸäº›å·¥ä½œæµç‰‡æ®µçš„åœºæ™¯ã€‚

å¦‚æœä½ åªæ˜¯å•çº¯ä¸ºäº†å®ç°å¹¶å‘ï¼Œæ–¹æ¡ˆ 1 å°±è¶³å¤Ÿäº†ã€‚

### Studio

å‚è€ƒ [å®˜æ–¹æ–‡æ¡£](https://langgraph4j.github.io/langgraph4j/studio/#use-spring-boot-implementation) ç›´æ¥ä½¿ç”¨ Spring Boot æ•´åˆ Studioï¼Œå¯ä»¥å®ç°è¿è¡Œ Langgraph4j å·¥ä½œæµçš„å¯è§†åŒ–äº¤äº’å’Œè°ƒè¯•ã€‚

1ï¼‰å…ˆå¼•å…¥ä¾èµ–ï¼š

```xml
<!-- LangGraph4j Studio -->
<dependency>
    <groupId>org.bsc.langgraph4j</groupId>
    <artifactId>langgraph4j-studio-springboot</artifactId>
    <version>1.6.0-rc2</version>
</dependency>
```

2ï¼‰ç„¶ååœ¨ `langgraph4j.config` åŒ…ä¸‹æ–°å»ºé…ç½®ç±»ï¼Œåˆ›å»ºä»£ç ç”Ÿæˆå·¥ä½œæµçš„çŠ¶æ€å›¾ï¼Œæä¾› LangGraphFlow ç±»å‹çš„ Bean å°±å¥½ï¼š

```java
@Configuration
public class LangGraphStudioSampleConfig extends AbstractLangGraphStudioConfig {

    final LangGraphFlow flow;

    public LangGraphStudioSampleConfig() throws GraphStateException {
        var workflow = new CodeGenWorkflow().createWorkflow().stateGraph;
        // define your workflow   
        this.flow = LangGraphFlow.builder()
                .title("LangGraph Studio")
                .stateGraph(workflow)
                .build();
    }

    @Override
    public LangGraphFlow getFlow() {
        return this.flow;
    }
}
```

3ï¼‰å¯åŠ¨é¡¹ç›®å¹¶æŸ¥çœ‹ Studio

è¿™é‡Œæœ‰ç‚¹å‘ï¼Œå®˜æ–¹æ–‡æ¡£çƒ‚çš„ä¸€æ‰¹â ï¼Œç”šè‡³ä¸æ„¿æ„å‘Šè¯‰æˆ‘â  Studio çš„è®¿é—®åœ°å€åœ¨å“ªé‡Œï¼

æˆ‘æ‘¸ç´¢äº†ä¸€ç•ªï¼Œå‘ç°è®¿é—®åç«¯æ ¹åœ°å€ `/api` å°±èƒ½è®¿é—®äº†ï¼Œä½†é»˜è®¤ä¼šæŠ¥é”™ï¼Œå› ä¸ºè¯·æ±‚æ¥å£çš„åœ°å€æ²¡æœ‰åŠ  `/api` å‰ç¼€ï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/Q7O8d3Faoz7WDHcd.webp "null")

ä¸´æ—¶æ³¨é‡Šé…ç½®æ–‡ä»¶çš„ `/api` è·¯å¾„ï¼ŒæŸ¥çœ‹å®é™…æ•ˆæœï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/E1j486jIi1BJ9fR8.webp "null")

ç»“æœåˆæ˜¯å„ç§æŠ¥é”™ï¼Œæˆ‘åªèƒ½è¯´ç›®â å‰æ•ˆæœçƒ‚çš„ä¸€æ‰¹ï¼Œå¼ºâ çƒˆä¸æ¨èä½¿ç”¨ï¼è¿˜ä¸å¦‚è‡ªå·± Debug è°ƒè¯•ã€‚

### SSE æµå¼è¾“å‡º

ä¹‹å‰æˆ‘ä»¬å·²ç»é€šè¿‡ `workflow.stream` è·å–åˆ°å·¥ä½œæµçš„æ¯ä¸€æ­¥å†…å®¹ï¼Œä½†å¦‚æœæƒ³è®©æŸä¸€ä¸ªå·¥ä½œèŠ‚ç‚¹ï¼ˆæ¯”å¦‚ç½‘ç«™ç”Ÿæˆï¼‰çš„å†…å®¹ä¹Ÿæµå¼è¾“å‡ºï¼Œå°±æ¯”è¾ƒéº»çƒ¦äº†ã€‚

å®˜ç½‘è™½ç„¶æä¾›äº† [SSE æ”¯æŒ](https://langgraph4j.github.io/langgraph4j/core/streaming/)ï¼Œä½†æ˜¯éœ€è¦å’Œ ChatModel é…åˆï¼Œå¹¶ä¸çµæ´»ã€‚

æˆ‘çš„å»ºè®®æ˜¯ä½¿ç”¨ `SseEmitter` æˆ–è€…è‡ªå·±æ„é€  Flux å“åº”å¼æ•°æ®æµï¼Œæ¯”å¦‚æ¯æ¬¡æ‰§è¡Œå·¥ä½œæµæ—¶æ–°å»º SseEmitterï¼Œé€šè¿‡å®ƒæ¥çµæ´»æ§åˆ¶è¦è¾“å‡ºä»€ä¹ˆå†…å®¹ã€‚ï¼ˆæ–¹æ³•çš„è¿”å›å€¼å¯ä»¥æ˜¯ SseEmitterï¼‰

ä¸‹é¢ç»™ 2 ç§å‚è€ƒå®ç°æ–¹æ¡ˆï¼š

#### æ¨è - Flux å®ç°ï¼ˆå› ä¸ºå…¼å®¹ç°æœ‰é¡¹ç›®ï¼‰

1ï¼‰CodeGenWorkflow å·¥ä½œæµæ–°å¢ â SSE è¾“å‡ºç‰ˆæœ¬çš„æ‰§è¡Œå·¥ä½œæµæ–¹æ³•â ï¼Œè‡ªå·±æ„é€  Flux å“åº”æµï¼šâ€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‰â€‰â€‰â€‰â€‰â€‚â€‰â€‰â€‰â€‰â€‚â€‚â€‚â€‰â€‚â€‚

```java
/**
 * æ‰§è¡Œå·¥ä½œæµï¼ˆFlux æµå¼è¾“å‡ºç‰ˆæœ¬ï¼‰
 */
public Flux<String> executeWorkflowWithFlux(String originalPrompt) {
    return Flux.create(sink -> {
        Thread.startVirtualThread(() -> {
            try {
                CompiledGraph<MessagesState<String>> workflow = createWorkflow();
                WorkflowContext initialContext = WorkflowContext.builder()
                        .originalPrompt(originalPrompt)
                        .currentStep("åˆå§‹åŒ–")
                        .build();
                sink.next(formatSseEvent("workflow_start", Map.of(
                        "message", "å¼€å§‹æ‰§è¡Œä»£ç ç”Ÿæˆå·¥ä½œæµ",
                        "originalPrompt", originalPrompt
                )));
                GraphRepresentation graph = workflow.getGraph(GraphRepresentation.Type.MERMAID);
                log.info("å·¥ä½œæµå›¾:\n{}", graph.content());

                int stepCounter = 1;
                for (NodeOutput<MessagesState<String>> step : workflow.stream(
                        Map.of(WorkflowContext.WORKFLOW_CONTEXT_KEY, initialContext))) {
                    log.info("--- ç¬¬ {} æ­¥å®Œæˆ ---", stepCounter);
                    WorkflowContext currentContext = WorkflowContext.getContext(step.state());
                    if (currentContext != null) {
                        sink.next(formatSseEvent("step_completed", Map.of(
                                "stepNumber", stepCounter,
                                "currentStep", currentContext.getCurrentStep()
                        )));
                        log.info("å½“å‰æ­¥éª¤ä¸Šä¸‹æ–‡: {}", currentContext);
                    }
                    stepCounter++;
                }
                sink.next(formatSseEvent("workflow_completed", Map.of(
                        "message", "ä»£ç ç”Ÿæˆå·¥ä½œæµæ‰§è¡Œå®Œæˆï¼"
                )));
                log.info("ä»£ç ç”Ÿæˆå·¥ä½œæµæ‰§è¡Œå®Œæˆï¼");
                sink.complete();
            } catch (Exception e) {
                log.error("å·¥ä½œæµæ‰§è¡Œå¤±è´¥: {}", e.getMessage(), e);
                sink.next(formatSseEvent("workflow_error", Map.of(
                        "error", e.getMessage(),
                        "message", "å·¥ä½œæµæ‰§è¡Œå¤±è´¥"
                )));
                sink.error(e);
            }
        });
    });
}

/**
 * æ ¼å¼åŒ– SSE äº‹ä»¶çš„è¾…åŠ©æ–¹æ³•
 */
private String formatSseEvent(String eventType, Object data) {
    try {
        String jsonData = JSONUtil.toJsonStr(data);
        return "event: " + eventType + "\ndata: " + jsonData + "\n\n";
    } catch (Exception e) {
        log.error("æ ¼å¼åŒ– SSE äº‹ä»¶å¤±è´¥: {}", e.getMessage(), e);
        return "event: error\ndata: {\"error\":\"æ ¼å¼åŒ–å¤±è´¥\"}\n\n";
    }
}
```

2ï¼‰ç¼–å†™å·¥ä½œæµæ‰§è¡Œæ¥å£ï¼š

```java
/**
 * å·¥ä½œæµ SSE æ§åˆ¶å™¨
 * æ¼”ç¤º LangGraph4j å·¥ä½œæµçš„æµå¼è¾“å‡ºåŠŸèƒ½
 */
@RestController
@RequestMapping("/workflow")
@Slf4j
public class WorkflowSseController {

    /**
     * åŒæ­¥æ‰§è¡Œå·¥ä½œæµ
     */
    @PostMapping("/execute")
    public WorkflowContext executeWorkflow(@RequestParam String prompt) {
        log.info("æ”¶åˆ°åŒæ­¥å·¥ä½œæµæ‰§è¡Œè¯·æ±‚: {}", prompt);
        return new CodeGenWorkflow().executeWorkflow(prompt);
    }

    /**
     * Flux æµå¼æ‰§è¡Œå·¥ä½œæµ
     */
    @GetMapping(value = "/execute-flux", produces = MediaType.TEXT_EVENT_STREAM_VALUE)
    public Flux<String> executeWorkflowWithFlux(@RequestParam String prompt) {
        log.info("æ”¶åˆ° Flux å·¥ä½œæµæ‰§è¡Œè¯·æ±‚: {}", prompt);
        return new CodeGenWorkflow().executeWorkflowWithFlux(prompt);
    }
}
```

3ï¼‰ç¼–å†™ä¸€ä¸ªç”¨äºæµ‹è¯•çš„å‰ç«¯ç½‘ç«™ï¼š

```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LangGraph4j å·¥ä½œæµ SSE æ¼”ç¤º</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .input-section {
            margin-bottom: 30px;
        }
        label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: #555;
        }
        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box;
        }
        .button-group {
            margin: 20px 0;
            text-align: center;
        }
        button {
            padding: 12px 24px;
            margin: 0 10px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        .btn-primary:hover {
            background-color: #0056b3;
        }
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #545b62;
        }
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        .btn-success:hover {
            background-color: #1e7e34;
        }
        .output-section {
            margin-top: 30px;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-weight: bold;
        }
        .status.connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.connecting {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .events {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 20px;
            max-height: 500px;
            overflow-y: auto;
        }
        .event {
            margin-bottom: 15px;
            padding: 10px;
            border-left: 4px solid #007bff;
            background-color: white;
            border-radius: 3px;
        }
        .event-type {
            font-weight: bold;
            color: #007bff;
            margin-bottom: 5px;
        }
        .event-data {
            font-family: 'Courier New', monospace;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
            white-space: pre-wrap;
        }
        .timestamp {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ LangGraph4j å·¥ä½œæµ SSE æ¼”ç¤º</h1>
        
        <div class="input-section">
            <label for="promptInput">è¾“å…¥æç¤ºè¯ï¼š</label>
            <input type="text" id="promptInput" placeholder="ä¾‹å¦‚ï¼šåˆ›å»ºä¸€ä¸ªåšå®¢ç½‘ç«™ï¼ŒåŒ…å«æ–‡ç« åˆ—è¡¨å’Œè¯¦æƒ…é¡µé¢" 
                   value="åˆ›å»ºä¸€ä¸ªåœ¨çº¿æ•™è‚²å¹³å°ï¼ŒåŒ…å«è¯¾ç¨‹å±•ç¤ºå’Œå­¦ä¹ è¿›åº¦è·Ÿè¸ªåŠŸèƒ½">
        </div>
        
        <div class="button-group">
            <button class="btn-primary" onclick="startWorkflowFlux()">ğŸ”„ å¼€å§‹ Flux å·¥ä½œæµ</button>
            <button class="btn-secondary" onclick="clearEvents()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
        </div>
        
        <div class="output-section">
            <div id="status" class="status disconnected">çŠ¶æ€: æœªè¿æ¥</div>
            <div class="events" id="events">
                <div class="event">
                    <div class="event-type">ç³»ç»Ÿæ¶ˆæ¯</div>
                    <div class="event-data">ç­‰å¾…è¿æ¥...</div>
                    <div class="timestamp">å‡†å¤‡å°±ç»ª</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let eventSource = null;

        function updateStatus(message, className) {
            const status = document.getElementById('status');
            status.textContent = 'çŠ¶æ€: ' + message;
            status.className = 'status ' + className;
        }

        function addEvent(type, data, timestamp) {
            const events = document.getElementById('events');
            const event = document.createElement('div');
            event.className = 'event';
            
            const eventType = document.createElement('div');
            eventType.className = 'event-type';
            eventType.textContent = type;
            
            const eventData = document.createElement('div');
            eventData.className = 'event-data';
            eventData.textContent = typeof data === 'object' ? JSON.stringify(data, null, 2) : data;
            
            const eventTime = document.createElement('div');
            eventTime.className = 'timestamp';
            eventTime.textContent = timestamp || new Date().toLocaleTimeString();
            
            event.appendChild(eventType);
            event.appendChild(eventData);
            event.appendChild(eventTime);
            
            events.appendChild(event);
            events.scrollTop = events.scrollHeight;
        }

        function startWorkflowFlux() {
            const prompt = document.getElementById('promptInput').value.trim();
            if (!prompt) {
                alert('è¯·è¾“å…¥æç¤ºè¯');
                return;
            }
            
            if (eventSource) {
                eventSource.close();
            }
            
            updateStatus('å·¥ä½œæµæ‰§è¡Œä¸­...', 'connecting');
            addEvent('ç³»ç»Ÿæ¶ˆæ¯', 'å¼€å§‹æ‰§è¡Œå·¥ä½œæµ: ' + prompt, new Date().toLocaleTimeString());
            
            const url = `http://localhost:8123/api/workflow/execute-flux?prompt=${encodeURIComponent(prompt)}`;
            eventSource = new EventSource(url);
            
            eventSource.onopen = function() {
                updateStatus('å·¥ä½œæµè¿æ¥å·²å»ºç«‹', 'connected');
                addEvent('è¿æ¥äº‹ä»¶', 'å·¥ä½œæµ Flux è¿æ¥æˆåŠŸå»ºç«‹', new Date().toLocaleTimeString());
                console.log('EventSource è¿æ¥å·²å»ºç«‹');
            };
            
            // é€šç”¨æ¶ˆæ¯ç›‘å¬å™¨ï¼Œæ•è·æ‰€æœ‰äº‹ä»¶
            eventSource.onmessage = function(event) {
                console.log('æ”¶åˆ°é€šç”¨æ¶ˆæ¯:', event);
                try {
                    const data = JSON.parse(event.data);
                    addEvent('ğŸ“¨ é€šç”¨æ¶ˆæ¯', data, new Date().toLocaleTimeString());
                } catch (e) {
                    addEvent('ğŸ“¨ é€šç”¨æ¶ˆæ¯', event.data, new Date().toLocaleTimeString());
                }
            };
            
            eventSource.addEventListener('workflow_start', function(event) {
                console.log('æ”¶åˆ° workflow_start äº‹ä»¶:', event.data);
                const data = JSON.parse(event.data);
                addEvent('ğŸš€ å·¥ä½œæµå¼€å§‹', data, new Date().toLocaleTimeString());
            });
            
            eventSource.addEventListener('step_completed', function(event) {
                console.log('æ”¶åˆ° step_completed äº‹ä»¶:', event.data);
                const data = JSON.parse(event.data);
                addEvent(`âœ… æ­¥éª¤ ${data.stepNumber} å®Œæˆ: ${data.currentStep}`, data, new Date().toLocaleTimeString());
            });
            
            eventSource.addEventListener('workflow_completed', function(event) {
                const data = JSON.parse(event.data);
                addEvent('ğŸ‰ å·¥ä½œæµå®Œæˆ', data, new Date().toLocaleTimeString());
                setTimeout(() => {
                    eventSource.close();
                    updateStatus('å·¥ä½œæµå®Œæˆï¼Œè¿æ¥å·²å…³é—­', 'disconnected');
                }, 1000);
            });
            
            eventSource.addEventListener('workflow_error', function(event) {
                const data = JSON.parse(event.data);
                addEvent('âŒ å·¥ä½œæµé”™è¯¯', data, new Date().toLocaleTimeString());
                setTimeout(() => {
                    eventSource.close();
                    updateStatus('å·¥ä½œæµå¤±è´¥ï¼Œè¿æ¥å·²å…³é—­', 'disconnected');
                }, 1000);
            });
            
            eventSource.onerror = function(event) {
                console.error('EventSource é”™è¯¯:', event);
                updateStatus('è¿æ¥é”™è¯¯', 'disconnected');
                addEvent('é”™è¯¯äº‹ä»¶', 'å·¥ä½œæµè¿æ¥å‘ç”Ÿé”™è¯¯', new Date().toLocaleTimeString());
                eventSource.close();
            };
        }

        function clearEvents() {
            const events = document.getElementById('events');
            events.innerHTML = '<div class="event"><div class="event-type">ç³»ç»Ÿæ¶ˆæ¯</div><div class="event-data">æ—¥å¿—å·²æ¸…ç©º</div><div class="timestamp">' + new Date().toLocaleTimeString() + '</div></div>';
        }

        // é¡µé¢å¸è½½æ—¶å…³é—­è¿æ¥
        window.addEventListener('beforeunload', function() {
            if (eventSource) {
                eventSource.close();
            }
        });
    </script>
</body>
</html>
```

æ•ˆæœå¦‚å›¾ï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/GOATxnlE823ozLtm.webp)

#### æ‰©å±•çŸ¥è¯† - SseEmitter å®ç°

1ï¼‰CodeGenWorkflâ ow å·¥ä½œæµæ–°å¢ Sâ SE è¾“å‡ºç‰ˆæœ¬çš„æ‰§è¡Œå·¥ä½œæµæ–¹æ³•ï¼Œè¿”å›å€¼ä¸º SseEmitterï¼š

```java
/**
 * æ‰§è¡Œå·¥ä½œæµï¼ˆSSE æµå¼è¾“å‡ºç‰ˆæœ¬ï¼‰
 */
public SseEmitter executeWorkflowWithSse(String originalPrompt) {
    SseEmitter emitter = new SseEmitter(30 * 60 * 1000L);
    Thread.startVirtualThread(() -> {
        try {
            CompiledGraph<MessagesState<String>> workflow = createWorkflow();
            WorkflowContext initialContext = WorkflowContext.builder()
                    .originalPrompt(originalPrompt)
                    .currentStep("åˆå§‹åŒ–")
                    .build();
            sendSseEvent(emitter, "workflow_start", Map.of(
                    "message", "å¼€å§‹æ‰§è¡Œä»£ç ç”Ÿæˆå·¥ä½œæµ",
                    "originalPrompt", originalPrompt
            ));
            GraphRepresentation graph = workflow.getGraph(GraphRepresentation.Type.MERMAID);
            log.info("å·¥ä½œæµå›¾:\n{}", graph.content());

            int stepCounter = 1;
            for (NodeOutput<MessagesState<String>> step : workflow.stream(
                    Map.of(WorkflowContext.WORKFLOW_CONTEXT_KEY, initialContext))) {
                log.info("--- ç¬¬ {} æ­¥å®Œæˆ ---", stepCounter);
                WorkflowContext currentContext = WorkflowContext.getContext(step.state());
                if (currentContext != null) {
                    sendSseEvent(emitter, "step_completed", Map.of(
                            "stepNumber", stepCounter,
                            "currentStep", currentContext.getCurrentStep()
                    ));
                    log.info("å½“å‰æ­¥éª¤ä¸Šä¸‹æ–‡: {}", currentContext);
                }
                stepCounter++;
            }
            sendSseEvent(emitter, "workflow_completed", Map.of(
                    "message", "ä»£ç ç”Ÿæˆå·¥ä½œæµæ‰§è¡Œå®Œæˆï¼"
            ));
            log.info("ä»£ç ç”Ÿæˆå·¥ä½œæµæ‰§è¡Œå®Œæˆï¼");
            emitter.complete();
        } catch (Exception e) {
            log.error("å·¥ä½œæµæ‰§è¡Œå¤±è´¥: {}", e.getMessage(), e);
            sendSseEvent(emitter, "workflow_error", Map.of(
                    "error", e.getMessage(),
                    "message", "å·¥ä½œæµæ‰§è¡Œå¤±è´¥"
            ));
            emitter.completeWithError(e);
        }
    });
    return emitter;
}

/**
 * å‘é€ SSE äº‹ä»¶çš„è¾…åŠ©æ–¹æ³•
 */
private void sendSseEvent(SseEmitter emitter, String eventType, Object data) {
    try {
        emitter.send(SseEmitter.event()
                .name(eventType)
                .data(data));
    } catch (IOException e) {
        log.error("å‘é€ SSE äº‹ä»¶å¤±è´¥: {}", e.getMessage(), e);
    }
}
```

2ï¼‰æ–°å¢ä¸€ä¸ª SSE å·¥ä½œæµæ¥å£ï¼š

```java
/**
 * å·¥ä½œæµ SSE æ§åˆ¶å™¨
 * æ¼”ç¤º LangGraph4j å·¥ä½œæµçš„æµå¼è¾“å‡ºåŠŸèƒ½
 */
@RestController
@RequestMapping("/workflow")
@Slf4j
public class WorkflowSseController {

    /**
     * åŒæ­¥æ‰§è¡Œå·¥ä½œæµ
     */
    @PostMapping("/execute")
    public WorkflowContext executeWorkflow(@RequestParam String prompt) {
        log.info("æ”¶åˆ°åŒæ­¥å·¥ä½œæµæ‰§è¡Œè¯·æ±‚: {}", prompt);
        return new CodeGenWorkflow().executeWorkflow(prompt);
    }

    /**
     * SSE æµå¼æ‰§è¡Œå·¥ä½œæµ
     */
    @GetMapping(value = "/execute-sse", produces = MediaType.TEXT_EVENT_STREAM_VALUE)
    public SseEmitter executeWorkflowWithSse(@RequestParam String prompt) {
        log.info("æ”¶åˆ° SSE å·¥ä½œæµæ‰§è¡Œè¯·æ±‚: {}", prompt);
        return new CodeGenWorkflow().executeWorkflowWithSse(prompt);
    }
}
```

3ï¼‰ç”¨ AI ç”Ÿæˆå·¥ä½œæµæ¼”ç¤º Demo ç½‘ç«™ï¼š

```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LangGraph4j å·¥ä½œæµ SSE æ¼”ç¤º</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .input-section {
            margin-bottom: 30px;
        }
        label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: #555;
        }
        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box;
        }
        .button-group {
            margin: 20px 0;
            text-align: center;
        }
        button {
            padding: 12px 24px;
            margin: 0 10px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        .btn-primary:hover {
            background-color: #0056b3;
        }
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #545b62;
        }
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        .btn-success:hover {
            background-color: #1e7e34;
        }
        .output-section {
            margin-top: 30px;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-weight: bold;
        }
        .status.connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.connecting {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .events {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 20px;
            max-height: 500px;
            overflow-y: auto;
        }
        .event {
            margin-bottom: 15px;
            padding: 10px;
            border-left: 4px solid #007bff;
            background-color: white;
            border-radius: 3px;
        }
        .event-type {
            font-weight: bold;
            color: #007bff;
            margin-bottom: 5px;
        }
        .event-data {
            font-family: 'Courier New', monospace;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
            white-space: pre-wrap;
        }
        .timestamp {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ LangGraph4j å·¥ä½œæµ SSE æ¼”ç¤º</h1>
        
        <div class="input-section">
            <label for="promptInput">è¾“å…¥æç¤ºè¯ï¼š</label>
            <input type="text" id="promptInput" placeholder="ä¾‹å¦‚ï¼šåˆ›å»ºä¸€ä¸ªåšå®¢ç½‘ç«™ï¼ŒåŒ…å«æ–‡ç« åˆ—è¡¨å’Œè¯¦æƒ…é¡µé¢" 
                   value="åˆ›å»ºä¸€ä¸ªåœ¨çº¿æ•™è‚²å¹³å°ï¼ŒåŒ…å«è¯¾ç¨‹å±•ç¤ºå’Œå­¦ä¹ è¿›åº¦è·Ÿè¸ªåŠŸèƒ½">
        </div>
        
        <div class="button-group">
            <button class="btn-primary" onclick="startWorkflowSse()">ğŸ”„ å¼€å§‹ SSE å·¥ä½œæµ</button>
            <button class="btn-secondary" onclick="clearEvents()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
        </div>
        
        <div class="output-section">
            <div id="status" class="status disconnected">çŠ¶æ€: æœªè¿æ¥</div>
            <div class="events" id="events">
                <div class="event">
                    <div class="event-type">ç³»ç»Ÿæ¶ˆæ¯</div>
                    <div class="event-data">ç­‰å¾…è¿æ¥...</div>
                    <div class="timestamp">å‡†å¤‡å°±ç»ª</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let eventSource = null;

        function updateStatus(message, className) {
            const status = document.getElementById('status');
            status.textContent = 'çŠ¶æ€: ' + message;
            status.className = 'status ' + className;
        }

        function addEvent(type, data, timestamp) {
            const events = document.getElementById('events');
            const event = document.createElement('div');
            event.className = 'event';
            
            const eventType = document.createElement('div');
            eventType.className = 'event-type';
            eventType.textContent = type;
            
            const eventData = document.createElement('div');
            eventData.className = 'event-data';
            eventData.textContent = typeof data === 'object' ? JSON.stringify(data, null, 2) : data;
            
            const eventTime = document.createElement('div');
            eventTime.className = 'timestamp';
            eventTime.textContent = timestamp || new Date().toLocaleTimeString();
            
            event.appendChild(eventType);
            event.appendChild(eventData);
            event.appendChild(eventTime);
            
            events.appendChild(event);
            events.scrollTop = events.scrollHeight;
        }

        function startWorkflowSse() {
            const prompt = document.getElementById('promptInput').value.trim();
            if (!prompt) {
                alert('è¯·è¾“å…¥æç¤ºè¯');
                return;
            }
            
            if (eventSource) {
                eventSource.close();
            }
            
            updateStatus('å·¥ä½œæµæ‰§è¡Œä¸­...', 'connecting');
            addEvent('ç³»ç»Ÿæ¶ˆæ¯', 'å¼€å§‹æ‰§è¡Œå·¥ä½œæµ: ' + prompt, new Date().toLocaleTimeString());
            
            const url = `http://localhost:8123/api/workflow/execute-sse?prompt=${encodeURIComponent(prompt)}`;
            eventSource = new EventSource(url);
            
            eventSource.onopen = function() {
                updateStatus('å·¥ä½œæµè¿æ¥å·²å»ºç«‹', 'connected');
                addEvent('è¿æ¥äº‹ä»¶', 'å·¥ä½œæµ SSE è¿æ¥æˆåŠŸå»ºç«‹', new Date().toLocaleTimeString());
            };
            
            eventSource.addEventListener('workflow_start', function(event) {
                const data = JSON.parse(event.data);
                addEvent('ğŸš€ å·¥ä½œæµå¼€å§‹', data, new Date().toLocaleTimeString());
            });
            
            eventSource.addEventListener('step_completed', function(event) {
                const data = JSON.parse(event.data);
                addEvent(`âœ… æ­¥éª¤ ${data.stepNumber} å®Œæˆ: ${data.currentStep}`, data, new Date().toLocaleTimeString());
            });
            
            eventSource.addEventListener('workflow_completed', function(event) {
                const data = JSON.parse(event.data);
                addEvent('ğŸ‰ å·¥ä½œæµå®Œæˆ', data, new Date().toLocaleTimeString());
                setTimeout(() => {
                    eventSource.close();
                    updateStatus('å·¥ä½œæµå®Œæˆï¼Œè¿æ¥å·²å…³é—­', 'disconnected');
                }, 1000);
            });
            
            eventSource.addEventListener('workflow_error', function(event) {
                const data = JSON.parse(event.data);
                addEvent('âŒ å·¥ä½œæµé”™è¯¯', data, new Date().toLocaleTimeString());
                setTimeout(() => {
                    eventSource.close();
                    updateStatus('å·¥ä½œæµå¤±è´¥ï¼Œè¿æ¥å·²å…³é—­', 'disconnected');
                }, 1000);
            });
            
            eventSource.onerror = function(event) {
                updateStatus('è¿æ¥é”™è¯¯', 'disconnected');
                addEvent('é”™è¯¯äº‹ä»¶', 'å·¥ä½œæµè¿æ¥å‘ç”Ÿé”™è¯¯', new Date().toLocaleTimeString());
                eventSource.close();
            };
        }

        function clearEvents() {
            const events = document.getElementById('events');
            events.innerHTML = '<div class="event"><div class="event-type">ç³»ç»Ÿæ¶ˆæ¯</div><div class="event-data">æ—¥å¿—å·²æ¸…ç©º</div><div class="timestamp">' + new Date().toLocaleTimeString() + '</div></div>';
        }

        // é¡µé¢å¸è½½æ—¶å…³é—­è¿æ¥
        window.addEventListener('beforeunload', function() {
            if (eventSource) {
                eventSource.close();
            }
        });
    </script>
</body>
</html>
```

æµ‹è¯•è¿è¡Œï¼Œæ•ˆæœå¦‚å›¾ï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/T7xp4ehuUmfu5jpq.webp)

#### æ‰©å±•æ€è·¯

åœ¨å®é™…åº”ç”¨ä¸­ï¼Œå¤§å®¶å¯ä»¥æ ¹æ®ä¸šåŠ¡éœ€æ±‚â çµæ´»é€‰æ‹© SSE è¾“å‡ºâ çš„å†…å®¹ï¼Œæ¯”å¦‚å®æ—¶æ¨é€æœé›†åˆ°çš„å›¾ç‰‡ä¿¡æ¯ã€ä»£ç ç”Ÿæˆè¿›åº¦æˆ–è€…è´¨é‡æ£€æŸ¥ç»“æœã€‚

å¦‚æœæƒ³è¦å®ç°æ›´ç»†ç²’åº¦çš„å®æ—¶åé¦ˆï¼Œè¿˜å¯ä»¥è€ƒè™‘å°† SseEmitter ä¼ é€’â åˆ°å…·ä½“çš„å·¥ä½œèŠ‚ç‚¹å†…éƒ¨ï¼Œè®©æ¯ä¸ªèŠ‚ç‚¹éƒ½èƒ½ç›´æ¥è¾“å‡ºå¤„ç†â çŠ¶æ€ã€‚å¯ä»¥é€šè¿‡ ThreadLocal åœ¨åŒä¸€çº¿ç¨‹å†…ä¼ é€’ SseEmitter å¯¹è±¡ï¼Œæˆ–è€…å°†å…¶ä½œä¸ºçŠ¶æ€çš„ä¸€éƒ¨åˆ†åœ¨èŠ‚ç‚¹é—´ä¼ é€’æ¥å®ç°ã€‚

## æ‰©å±•æ€è·¯ - å’Œç°æœ‰ä¸šåŠ¡æ•´åˆ

è™½ç„¶å¼€ç¯‡æåˆ°äº†ï¼Œè¿™æ˜¯å¦ä¸€ç§å®ç°æ¨¡å¼ï¼›ä½†å¦‚æœä¸€å®šè¦æ•´åˆï¼Œå…¶å®ä¹Ÿä¸éº»çƒ¦ï¼Œ**ä½†æ˜¯æˆ‘ä¸å»ºè®®å¤§å®¶å®ç°ï¼Œä½¿ç”¨ä¹‹å‰çš„æ¨¡å¼å°±å¤Ÿäº†ã€‚**

ä»¥ä¸‹ä»…ä¸ºå‚è€ƒï¼Œå®é™…è¦ä¿®æ”¹çš„å†…å®¹å¯èƒ½ä¼šæ›´å¤šã€‚

### åç«¯ä¿®æ”¹

å¤ç”¨åŸæœ‰å¯¹è¯æ¥å£æˆæœ¬æœ€ä½ï¼Œåªéœ€â è¦æŠŠåŸæœ¬è°ƒç”¨ AI â é—¨é¢ç”Ÿæˆä»£ç æ”¹ä¸ºæ ¹æ®ç”Ÿæˆæ¨¡å¼é€‰æ‹©ä½¿ç”¨å·¥ä½œæµè¿˜æ˜¯ AI é—¨é¢å³å¯ã€‚

#### 1ã€WorkflowContext æ”¯æŒ appId

æ·»åŠ äº† appId å­—æ®µï¼Œé»˜è®¤å€¼ä¸º 0L

```java
/**
 * åº”ç”¨ ID
 */
private Long appId = 0L;
```

#### 2ã€CodeGenWorkflow æ”¯æŒ appId å‚æ•°

-   å‚æ•°å˜æ›´ä¸º executeWorkflowWithFlux(String, Long) - æµå¼ç‰ˆæœ¬
-   åˆå§‹åŒ–æ—¶å°† appId ä¼ é€’åˆ° WorkflowContext
-   æä¾›ä¸€ä¸ªå…¼å®¹ä¸ä¼  appId çš„æ–¹æ³•

ä»£ç å¦‚ä¸‹ï¼š

```java
/**
 * æ‰§è¡Œå·¥ä½œæµï¼ˆFlux æµå¼è¾“å‡ºç‰ˆæœ¬ï¼‰
 */
public Flux<String> executeWorkflowWithFlux(String originalPrompt, Long appId) {
    return Flux.create(sink -> {
        Thread.startVirtualThread(() -> {
            try {
                CompiledGraph<MessagesState<String>> workflow = createWorkflow();
                WorkflowContext initialContext = WorkflowContext.builder()
                        .appId(appId)
                        .originalPrompt(originalPrompt)
                        .currentStep("åˆå§‹åŒ–")
                        .build();
                // ...
            }
        })
    })
}

/**
 * æ‰§è¡Œå·¥ä½œæµï¼ˆFlux æµå¼è¾“å‡ºç‰ˆæœ¬ï¼‰
 */
public Flux<String> executeWorkflowWithFlux(String originalPrompt) {
    return executeWorkflowWithFlux(originalPrompt, 0L);
}
```

#### 3ã€AppService æ¥å£å¢åŠ  agent å‚æ•°

-   å‚æ•°å˜æ›´ä¸º chatToGenCode(Long, String, User, Boolean)
-   agent å‚æ•°é»˜è®¤ä¸º falseï¼Œå¯é€‰ä¼ å…¥

ä»£ç å¦‚ä¸‹ï¼š

```java
/**
 * åº”ç”¨èŠå¤©ç”Ÿæˆä»£ç ï¼ˆæµå¼ï¼‰
 *
 * @param appId   åº”ç”¨ ID
 * @param message ç”¨æˆ·æ¶ˆæ¯
 * @param loginUser ç™»å½•ç”¨æˆ·
 * @param agent æ˜¯å¦å¯ç”¨ Agent æ¨¡å¼
 * @return ç”Ÿæˆçš„ä»£ç æµ
 */
Flux<String> chatToGenCode(Long appId, String message, User loginUser, boolean agent);
```

#### 4ã€AppServiceImpl å®ç° agent æ¨¡å¼åˆ‡æ¢

ä»£ç å¦‚ä¸‹ï¼š

```java
// 6. æ ¹æ® agent å‚æ•°é€‰æ‹©ç”Ÿæˆæ–¹å¼
Flux<String> codeStream;
if (agent) {
    // Agent æ¨¡å¼ï¼šä½¿ç”¨å·¥ä½œæµç”Ÿæˆä»£ç 
    codeStream = new CodeGenWorkflow().executeWorkflowWithFlux(message, appId);
} else {
    // ä¼ ç»Ÿæ¨¡å¼ï¼šè°ƒç”¨ AI ç”Ÿæˆä»£ç ï¼ˆæµå¼ï¼‰
    codeStream = aiCodeGeneratorFacade.generateAndSaveCodeStream(message, codeGenTypeEnum, appId);
}
```

#### 5ã€AppController æ”¯æŒ agent å‚æ•°

-   æ·»åŠ è¯·æ±‚å‚æ•°
-   è°ƒç”¨æ—¶ä¼ é€’ agent å‚æ•°åˆ°æœåŠ¡å±‚

ä»£ç å¦‚ä¸‹ï¼š

```java
public Flux<ServerSentEvent<String>> chatToGenCode(
    @RequestParam Long appId,
    @RequestParam String message,
    @RequestParam(defaultValue = "false") boolean agent,
    HttpServletRequest request){}

// è°ƒç”¨æœåŠ¡ç”Ÿæˆä»£ç ï¼ˆæµå¼ï¼‰
Flux<String> contentFlux = appService.chatToGenCode(appId, message, loginUser, agent);
```

#### 6ã€å·¥å…·å…¼å®¹

CodeGeneratorNâ ode è¡¥å……è·å– â appId çš„é€»è¾‘ï¼š

```java
// è·å– appId
Long appId = context.getAppId();
```

### å‰ç«¯ä¿®æ”¹

å‰ç«¯å¯ä»¥æ–°å¢ agent æ¨¡å¼ï¼Œä¼ é€’ `agent = true`ã€‚

é‡æ–°æ‰§è¡Œ openAPI å·¥â å…·ï¼Œæµ‹è¯•æ—¶å…ˆä¿®æ”¹ç”Ÿâ æˆä»£ç çš„å‚æ•°ï¼š

```typescript
// æ„å»ºURLå‚æ•°
const params = new URLSearchParams({
  appId: appId.value || '',
  message: userMessage,
  agent: "true",
})

const url = `${baseURL}/app/chat/gen/code?${params}`
```

éœ€è¦æ ¹æ®è‡ªå·±çš„éœ€è¦ä¿®æ”¹å‰åç«¯ä¼ é€’çš„å‚æ•°ï¼Œä»¥è¾¾åˆ°æ›´å¥½çš„æ•ˆæœã€‚

ä¸è¿‡ç›®å‰è¿˜ä¸æ˜¯æ·±åº¦æ•´åˆï¼Œå…¶å®åº”è¯¥åœ¨å·¥ä½œæµä¸­â è®¾ç½® app çš„ codeGâ enEnumã€ä¿å­˜ç”¨æˆ·çš„å¯¹è¯è®°å½•ç­‰ç­‰ï¼Œä½†è¿™æ ·æ•´ä¸ªæµç¨‹éƒ½è¦å‘ç”Ÿè¿›ä¸€æ­¥å˜åŒ–ï¼Œæ²¡æœ‰å¿…è¦äº†ã€‚

è€Œä¸”å·¥ä½œæµç›®å‰æ²¡æœ‰åŒºåˆ†æ–°å»ºå’Œâ ä¿®æ”¹ï¼Œå¦‚æœæ˜¯ä¿®æ”¹çš„â è¯ï¼Œä¸éœ€è¦é‡å¤æœå›¾ã€å¢å¼ºæç¤ºè¯ç­‰æ­¥éª¤ã€‚

## æ€»ç»“

åœ¨è¿™ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬æ·±å…¥å­¦ä¹ äº† AI å·¥ä½œæµçš„æ¦‚å¿µå’Œå®â ç°ã€‚é€šè¿‡ LangGraph4j æ¡†â æ¶ï¼Œæˆ‘ä»¬ä¸ä»…é‡æ„äº†ä¸€å¥—æ–°çš„ä»£ç ç”Ÿæˆé€»è¾‘ï¼Œè¿˜ä¸ºç³»ç»Ÿå¢åŠ äº†æ™ºèƒ½å›¾ç‰‡æ”¶é›†åŠŸèƒ½ï¼Œè®©ç”Ÿæˆçš„ç½‘ç«™æ›´åŠ çœŸå®ç”ŸåŠ¨ã€‚


