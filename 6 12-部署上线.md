---
source: https://www.codefather.cn/course/1948291549923344386/section/1955932608684142594
---

# 12 - 部署上线 - 【大厂必备】LangChain4j + 工作流

> ## Excerpt
> 本节重点 本节重点内容是项目部署上线，可以独立学习，希望大家能够掌握这种快速上线项目的方法。 包括： 服务器初始化 部署规划 安装依赖 后端部署。编程导航教程分享，做您编程学习路上的导航员。

---
## 本节重点

本节重点内容是项目部署上线，⁠可以独立学习，希望⁠大家能够掌握这种快速上线项目的方法。

包括：

1.  服务器初始化
2.  部署规划
3.  安装依赖
4.  后端部署
5.  前端部署
6.  应用部署
7.  测试验证
8.  扩展知识

本期视频：[https://www.bilibili.com/video/BV1Kwb6zLEee/](https://www.bilibili.com/video/BV1Kwb6zLEee/)

## 一、服务器初始化

首先购买一台服务器，各大云服务商的新用户都比较便宜，建议先看 [云产品](https://curl.qcloud.com/ke6zvAHm) 页面。

推荐选择轻量应用服务器，提供⁠了很多开箱即用的模⁠板，帮我们预装了环境和软件，省时省力。

鱼皮这里选择一台预装了 `1Panel Linux 面板` 的轻量应用服务器，配置为 2 核 2 G，部署咱们的项目足够了。**但是不能低于这个配置，否则卡爆！**

应用模板一般选择最新版本就好了，如下图：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/LTFox8vzWWp8myHW.webp)

[1Panel](https://1panel.cn/) 是一个现代化、开源的 Linux 服务器运维管理面板，跟宝塔 Linux 类似。提供可视化的服务器管理界面，支持应用商店、容器管理、文件管理、数据库管理等功能，适合中小团队或者个人学习使用，告别使用黑漆漆的命令行来操作服务器。

购买好服务器后，进入控制台，⁠可以看到新增的服务⁠器信息，注意不要主动对外暴露公网 IP！

![](https://pic.code-nav.cn/course_picture/1608440217629360130/rVCSj66x6O8OUuyB.webp)

点击服务器进入详情页，在防火墙标签页⁠中可以看到默认开启了 8⁠090 端口，这是 1Panel 面板的默认端口，如果关闭的话将无法访问。

![](https://pic.code-nav.cn/course_picture/1608440217629360130/WyHUxnlaichnyqzh.webp)

进入应用管理标签页，登录 1Pan⁠el 面板。首次登录时⁠，需要先登录服务器，通过输入命令的方式获取面板的默认账号密码，如图：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/tdbyfvspkbCk4Fix.webp)

点击登录后，进入到 web ⁠终端，复制脚本并执⁠行，根据指示更新自己设置的密码：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/zoyUzrO5dwadrym2.webp)

根据终端输出的信息，访问面板，输入初始用户名和密码：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/joF1rsUIbKbhV18q.webp)

成功登入面板，豁然开朗，服务器的状态尽收眼底：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/Ev3XZtHsZ8bm71kT.webp)

建议首次进入面板后，先修改面⁠板的默认用户名： ⁠                               

![](https://pic.code-nav.cn/course_picture/1608440217629360130/klEQWLbNJqSqpKEB.webp)

## 二、部署规划

在正式操作前后端部署前，我们⁠要先进行一个规划，⁠比如要部署哪些项目和服务、需要哪些依赖、占用哪些端口等。

### 1、获取源码

本项目代码开源：[https://github.com/liyupi/yu-ai-code-mother](https://github.com/liyupi/yu-ai-code-mother)

后续这个项目会改造为微服务，⁠建议新手学习和部署⁠根目录的后端项目，使用传统的分层架构。

![](https://pic.code-nav.cn/course_picture/1608440217629360130/wBAqzOljjkHoZfb9.webp)

### 2、部署方案

为了提高效率，本项目前端和后⁠端均使用 1Pan⁠el 面板进行部署。

涉及到具体的部署方式：

1）前端：遵循 Vue 项目⁠的部署模式，基于 ⁠Nginx 运行

2）后端：直接运行 Jar 包进行部署

\*\*注意，强烈不建议通过 Docker 来部署本项目的后端！\*\*因为涉及到 NPM 命令执行、依赖安装、Selenium 自动化操作浏览器、文件持久化等，制作 Docker 的成本会很大，而且有可能出现内存不足。

此外，这个项目还涉及到部署 ⁠AI 生成的应用，⁠需要利用 Nginx 配置进行代理。

___

💡 鱼皮在 [编程导航](https://codefather.cn/) 带大家做过十几套项目了，几乎每种部署方式都给大家讲解过：

-   [代码生成器共享平台项目](https://www.codefather.cn/course/1790980795074654209)：宝塔面板 + Nginx 前端 + Java 项目管理器（jar 包）后端部署
-   [AI 答题应用平台项目](https://www.codefather.cn/course/1790274408835506178)： Vercel 前端 + Docker 后端 + 云托管平台部署
-   [AI 超级智能体项目](https://www.codefather.cn/course/1915010091721236482)：Docker 前端 + Docker 后端 + 云托管平台部署
-   [OJ 在线判题项目](https://www.codefather.cn/course/1790980707917017089)：Docker Compose 后端微服务部署

基本上学会这几种部署方式，能够应对绝大多数部署需求了。

### 3、地址规划

前端：通过 Nginx 提供网站访问服务，访问地址为 `http://{域名}`。

后端：通过 Nginx 进行转发，访问地址为 `http://{域名}/api`，实际运行在 8123 端口

AI 生成的应用：通过 Nginx 提供网站访问服务，根据请求地址转发到不同的应用，访问地址为 `http://{域名}/dist`（如果你有多个域名的话，那就不需要子路径来映射）

💡 注意，使用 Nginx 转发是为了让前端和⁠后端域名一致，保证不会出现跨域⁠问题。此外，本项目的可视化修改能力要求生成的网站和前端网站同源，也通过 Nginx 满足了。

### 4、端口规划

等下我们会依次安装依赖，端口占用情况如下：



|组件|端口|作用|
|---|---|---|
|Nginx|80|Web服务器，处理 HTTP 请求和反向代理|
|数据库|3306|数据存储⁠，管理应用的持久化数据⁠|
|Redis|6379|缓存服务，提供高性能的内存数据存储|

需要在服务器控制台的防火墙中⁠开通需要外网访问的⁠服务端口，比如 MySQL 和 Redis：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/ShGNdqg3o58bdIgV.webp)

## 三、安装依赖

### 1、Nginx

进入 `网站` 板块，面板会提醒我们安装 OpenResty：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/wcqswE2xwgIQw6tf.webp)

OpenResty 是一个基于 Ng⁠inx 与 Lua 集成⁠的高性能 Web 平台，可用于快速开发高并发、可扩展的 Web 应用、网关等。

简单来说，它是对 Nginx⁠ 的增强，为了便于⁠理解，后面我们统一称为 Nginx。

安装 OpenResty，使用默认配置即可：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/gXv6TOikAU9YuCWL.webp)

安装中，可以看到其实面板是通过容器来运行应用的：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/XV2F19iNaXh5ACLi.webp)

进入到 `网站` 板块，看到 OpenResty 成功运行：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/QJvqVPUetjkkPV1j.webp)

访问服务器地址，能看到 Nginx 字样就表示安装成功：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/PMYrTItvrb92p7FC.webp)

### 2、MySQL

进入 `数据库` 板块去安装：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/UWPUhzjFzdASso8h.webp)

安装时选择 8.x 版本、修⁠改 Root 密码⁠、开启端口外部访问：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/ZIC8eXNfi01PVqRX.webp)

安装完成后，可以看到 MySQL 已启动：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/SRE6vUJroGFSfKJa.webp)

先为后端项目创建一个数据库。数据库名称和我们项目需要的数据库名称保持一致（此处为 `yu_ai_code_mother`），注意用户名、密码和访问权限：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/7ROTghl3a7LDPEWj.webp)

创建成功，可以看到数据库的信息：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/S2H3yS3aO8Oim8Vn.webp)

尝试利用数据库管理软件连接数据⁠库。比如在 ID⁠EA 中打开后端项目，通过数据库面板在本地检查连接是否正常：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/i4FwYHFT14s490sc.webp)

执行鱼皮提供的 SQL 脚本，初始化库表：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/hMzR28DhMpjq5JKa.webp)

记得验证数据库表是否创建成功，如图：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/tIBRJXya3hLmkcA7.webp)

### 3、Redis

进入 `数据库` 面板的 Redis 标签页，安装 Redis：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/HlLmbI77Aw9WBzCn.webp)

版本选择默认的即可，需要配置密⁠码、开启远程访问： ⁠                               

![](https://pic.code-nav.cn/course_picture/1608440217629360130/0KTp53SYZAgSkxf8.webp)

安装完成：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/j1xppmZlQ0FbQZZy.webp)

最后，在 IDEA 数据库面板中验证⁠本地能否连接远程 Red⁠is：                                

![](https://pic.code-nav.cn/course_picture/1608440217629360130/UtNxhgsPUuNNVol2.webp)

注意，由于我们没有设置 Redis 的用户名，但是又设置了 Redis 的密码，所以要修改后端代码中 Redis 对话记忆存储的配置 `RedisChatMemoryStoreConfig`，指定默认用户名：

```java
@Bean
public RedisChatMemoryStore redisChatMemoryStore() {
    RedisChatMemoryStore.Builder builder = RedisChatMemoryStore.builder()
            .host(host)
            .port(port)
            .password(password)
            .ttl(ttl);
    if (StrUtil.isNotBlank(password)) {
        builder.user("default");
    }
    return builder.build();
}
```

### 4、Java 环境

JDK 是运行后端项目的基础。

虽然 1Panel 也提供了可视化配置 Java 运⁠行环境的方式，但是跟应用是强绑定的⁠，封装在容器内，而我们需要后端项目能调用终端执行 NPM 命令和应用截图等操作，所以需要手动安装。

![](https://pic.code-nav.cn/course_picture/1608440217629360130/iPJ9cpjxgl1MWOe9.webp)

可以利用 [SDKMAN](https://sdkman.io/) 快速安装和管理 JDK 等依赖。

SDKMAN 需要用到压缩和⁠解压缩命令，因此需⁠要先进入终端安装这些命令：

```shell
sudo apt install zip unzip -y
```

![](https://pic.code-nav.cn/course_picture/1608440217629360130/zuwzcSwFe3bEuVT8.webp)

然后执行命令来安装 SDKMAN：

```shell
curl -s "https://get.sdkman.io" | bash
```

安装后，查看可用的 Java 版本：

```shell
sdk list java
```

如图，一定要选择 JDK 21：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/hf8hEnOMS4BaziFQ.webp)

接下来安装 JDK 21 并设置为默认版本：

```shell
# 安装
sdk install java 21.0.8-amzn
# 设置为默认版本
sdk default java 21.0.8-amzn
```

安装成功，可以输入 `java -version` 命令验证：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/PCxYqWlO9S0Zva7o.webp)

【可选】如果你希望在服务器上⁠拉取后端源码并打包⁠，还需要安装 Maven 依赖管理工具：

```shell
# 列出所有可用的 Maven 版本
sdk list maven

# 安装最新版本的 Maven
sdk install maven

# 安装指定版本的 Maven
sdk install maven 3.9.10

# 设置为默认版本
sdk default maven 3.9.10
```

### 5、Node.js 环境

本项目的业务中，生成 Vue 工程项目时需要打包构建、AI 工作流生成架构图时也需要用到 Mermaid CLI 等，这些都依赖 Node.js 环境和 NPM 包管理工具。

虽然面板提供了 Node.js 运行环境，但是跟面板上的应用是强绑定的，封装在容器内，而我们需要后端项目能调用终端执行 NPM 命令，所以需要手动安装。

![](https://pic.code-nav.cn/course_picture/1608440217629360130/70qkCvb5WQJTEex4.webp)

直接去 [Node.js 官网](https://nodejs.org/zh-cn/download) 安装，选择 Linux 系统，会看到一堆命令，作用是安装 nvm 这样一个 Node.js 管理器：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/ocRQW2L1c6dhJpB2.webp)

复制命令到终端执行：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/SBDLOK15Gb4q4m2U.webp)

检查是否安装成功：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/LFKBlLDR15uj4Mj4.webp)

【可选】为了更快下载 NPM 依赖，可以设置加速镜像源：

```shell
# 查看当前镜像源
npm config get registry
# 设置加速镜像源
npm config set registry https://registry.npmmirror.com
```

【可选】如果你需要将教程中的⁠ AI 智能体工作⁠流整合到业务中，还需要全局安装 Mermaid 图片生成工具：

```shell
npm install -g @mermaid-js/mermaid-cli
```

### 6、Chrome 浏览器

由于本项目包含 Seleni⁠um 网页截图功能⁠，需要安装一个浏览器，首推 Chrome。

执行下列命令即可安装：

```shell
curl -fsSL https://dl.google.com/linux/linux_signing_key.pub | sudo gpg --dearmor -o /usr/share/keyrings/google-chrome.gpg && echo "deb [arch=amd64 signed-by=/usr/share/keyrings/google-chrome.gpg] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list && sudo apt update && sudo apt install -y google-chrome-stable
```

执行命令检查 Chrome 是否安装成功：

```shell
google-chrome -version
```

![](https://pic.code-nav.cn/course_picture/1608440217629360130/hP5QxTbYWfsJZD9y.png)

还要安装中文字体，否则网页无⁠法显示中文（这里我⁠让 AI 帮我随便选了，也可以安装别的）：

```shell
sudo apt install -y fonts-wqy-zenhei fonts-noto-cjk && sudo fc-cache -fv
```

### 7、其他服务

项目还用到了一些第三方服务，比如 [腾讯云 COS 对象存储](https://console.cloud.tencent.com/cos/bucket)、[DeepSeek API](https://api-docs.deepseek.com/zh-cn/)、[阿里云百炼 API](https://click.aliyun.com/m/1000400408/)，可以去对应的官网开通。

![](https://pic.code-nav.cn/course_picture/1608440217629360130/Vq5QAmCLCghtQgZV.webp)

注意，最好给对象存储增加部署前端的⁠服务器 IP（或者实际⁠访问的前端域名）的跨域配置，否则有些场景下可能无法正确访问图片。

![](https://pic.code-nav.cn/course_picture/1608440217629360130/AzDsKMybsXBV51Hw.webp)

接下来，我们依次进行后端和前端部署。

## 四、后端部署

### 1、编写生产环境配置

修改 `application-prod` 生产环境配置，包括数据库、Redis、对象存储、各种大模型的 API Key 等，替换为上述安装依赖时指定的配置（如用户名、密码）。

注意，为了性能和安全，最好关闭 MyBa⁠tis Flex 的日志、⁠以及 AI 相关的日志，还要给 Knife4j 接口文档设置用户名和密码。

参考配置如下：

```yaml
# 线上配置文件
# @author <a href="https://github.com/liyupi">程序员鱼皮</a>
# @from <a href="https://codefather.cn">编程导航</a>
spring:
  # mysql
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://110.42.141.105:3306/yu_ai_code_mother
    username: yu_ai_code_mother_user
    password: 12345678
  # redis
  data:
    redis:
      host: 110.42.141.105
      port: 6379
      database: 0
      password: 12345678
      ttl: 3600
# AI
langchain4j:
  open-ai:
    chat-model:
      base-url: https://api.deepseek.com
      api-key: <your-api-key>
      model-name: deepseek-chat
      max-tokens: 8192
      log-requests: false
      log-responses: false
    streaming-chat-model:
      base-url: https://api.deepseek.com
      api-key: <your-api-key>
      model-name: deepseek-chat
      max-tokens: 8192
      log-requests: false
      log-responses: false
    # 推理 AI 模型配置（用于复杂的推理任务）
    reasoning-streaming-chat-model:
      base-url: https://api.deepseek.com
      api-key: <your-api-key>
      model-name: deepseek-chat
      max-tokens: 8192
      temperature: 0.1
      log-requests: false
      log-responses: false
    # 智能路由 AI 模型配置
    routing-chat-model:
      base-url: https://dashscope.aliyuncs.com/compatible-mode/v1
      api-key: <your-api-key>
      model-name: qwen-turbo
      max-tokens: 100
      log-requests: false
      log-responses: false
# 添加 COS 对象存储配置（需要从腾讯云获取）
cos:
  client:
    host: <your-custom-domain.com>
    secretId: <your-secret-id>
    secretKey: <your-secret-key>
    region: <your-region>
    bucket: <your-bucket-name>
# 阿里云 DashScope 配置
dashscope:
  api-key: <your-api-key>
  image-model: wan2.2-t2i-flash
# Pexels 图片搜索配置
pexels:
  api-key: <your-api-key>
# 生产环境关闭日志
mybatis-flex:
  configuration:
    log-impl: ''
# 接口文档配置
knife4j:
  basic:
    enable: true
    username: root
    password: 123456
# 部署路径
code:
  deploy-host: http://110.42.141.105/dist
```

💡 建议把这个配置文件添加到 `.gitignore` 中，别不小心开源出来了。

之前我们的老版本项目中，部署路径是⁠通过常量指定的，现在需⁠要修改为读取配置文件获取。修改 AppServiceImpl 的代码：

```java
@Value("${code.deploy-host:http://localhost}")
private String deployHost;

// 10. 构建应用访问 URL
String appDeployUrl = String.format("%s/%s/", deployHost, deployKey);
```

### 2、打包运行

首先更改 `pom.xml` 文件的打包配置，删除掉 maven 插件配置的 `excludes` 块：

```xml
<build>
    <plugins>
        <plugin>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-maven-plugin</artifactId>
            <configuration>
                <excludes>
                    <exclude>
                        <groupId>org.projectlombok</groupId>
                        <artifactId>lombok</artifactId>
                        <version>1.18.38</version>
                    </exclude>
                </excludes>
            </configuration>
        </plugin>
    </plugins>
</build>
```

否则可能打包时会遇到这个报错：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/dm60BGANiGpA4z50.webp)

在 IDEA 中打开后端项目，忽略测试并打包：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/9LWD7oT1ujWEzMWc.webp)

打包成功，得到 jar 包文件：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/HvdTUe34mWHFtvfP.webp)

建议先在本地终端输入命令以 ⁠prod 模式运行⁠ jar 包，看看项目能否正常启动：

```shell
java -jar yu-ai-code-mother-0.0.1-SNAPSHOT.jar --spring.profiles.active=prod
```

发现项目可以正常运行、各个功能也都正常，再进行后续操作：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/qwSyb81ybYj0bDeF.webp)

### 3、部署到服务器

将打好的 jar 包通过面板上传到服务器的指定目录下，我这里是 `/project/yu-ai-code-mother-backend`：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/nhyUKJ0liUZRLNUv.webp)

💡 当然也可以将代码上传到 GitHub 上，然后用 `git clone` 命令下载代码，再执行 Maven 打包。

接下来进入 jar 包所在目录 `/project/yu-ai-code-mother-backend` 的终端，先在前台运行 jar 包：

```bash
java -jar yu-ai-code-mother-0.0.1-SNAPSHOT.jar --spring.profiles.active=prod
```

查看输出信息，确定项目启动成功：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/cEZg9tWdwR57Bgkw.webp)

然后在后台运行 jar 包，这样终端关闭后项目依然会运行：

```bash
nohup java -jar yu-ai-code-mother-0.0.1-SNAPSHOT.jar --spring.profiles.active=prod > app.log 2>&1 &
```

可以在 jar 包相同目录下看到日志文件：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/lg42kZyj4ZGznIOv.webp)

### 4、Nginx 配置

#### 后端转发配置

我们的预期是：如果访问的是后端接口（地址有 `/api` 前缀），则 Nginx 将请求转发到后端服务。

先创建一个网站（相当于新建 Nginx 站点），选择 `反向代理` 类型，域名填写当前服务器 IP 或者自己的域名，代号最好用项目名称：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/DFUwTB4F5WevyrqD.webp)

创建好网站后，点击配置：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/wAVVqM1oIAmKyrOz.webp)

编辑反向代理的配置：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/P3CQzlmh8lgzLG77.webp)

修改反向代理的前端请求路径为 `/api`：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/3eEZGpl4PpH4gNkO.webp)

修改后的配置如图：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/1sUyoL6i8xCYaHIk.webp)

💡 如果不用面板，而是自己⁠部署 Nginx，⁠需要手动修改配置：

```nginx
location /api {
  proxy_pass  http://127.0.0.1:8123;
  proxy_set_header Host $proxy_host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_buffering off;
  proxy_set_header Connection "";
}
```

#### SSE 配置

我们为了防止 AI 生成的 ⁠SSE 请求超时，⁠需要修改反向代理配置。

由于 Nginx 是通过容器部署，需要找到容器内 `/www` 对应挂载的服务器目录：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/8TBzwDsSHKyVCiMb.webp)

找到实际的反向代理配置文件，加上一行配置：

```nginx
proxy_read_timeout 900s; # 读取超时延长，避免长连接被中断
```

![](https://pic.code-nav.cn/course_picture/1608440217629360130/j8OHCQXudbUpSszs.webp)

现在就能够直接通过 80 端口（可省略）正常访问后端接口文档：[http://{你的服务器 IP}/api/doc.html](http://110.42.141.105/api/doc.html)

![](https://pic.code-nav.cn/course_picture/1608440217629360130/6hhpf8gKGeXzcEqf.webp)

输入密码后就看到接口文档了：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/nlKc9QRaJwf4L4Os.webp)

## 五、前端部署

前端部署可以参考 [Vite 官方文档](https://cn.vitejs.dev/guide/static-deploy.html)，分为编写生产环境配置、打包构建、部署和 Nginx 配置这 4 个步骤。

### 1、编写生产环境配置

新建 `.env.production` 文件，直接使用相对路径，这样前端域名、请求域名和生成网站的部署域名都保持一致，解决跨域和同源问题。

```java
VITE_DEPLOY_DOMAIN=/dist

VITE_API_BASE_URL=/api
```

### 2、打包构建

直接执行前端项目 `package.json` 文件中的 `build` 命令：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/cjN9aaBEH1v473Ak.webp)

构建成功后，可以看到 dist 目录：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/H1nfRgcs3ERYzHEB.webp)

#### 构建失败怎么办？

常见的构建失败原因是类型校验错误，如图：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/QkR7piEeoJhs67OO.webp)

这是由于脚手架内置的 `build` 命令会执行类型检查，如果项目代码中有任何类型不规范的地方，都会导致打包失败！

虽然可以自己一个个修复类型，但是太影响效率了，得不偿失，所以引入一个 **不执行类型检查** 的构建命令。

在 `package.json` 文件中定义 `pure-build` 命令：

```json
{
  "scripts": {
    "dev": "vite",
    "pure-build": "vite build",
    "build": "run-p type-check \"build-only {@}\" --",
  }
}
```

然后执行 `pure-build` 命令，执行打包构建即可。

注意，如果 Node.js 版本较低，也可能会构建失败，这时可以到 [官网](https://nodejs.org/zh-cn) 安装更新的版本，最好 >= 20 版本。

### 3、部署到服务器

一般来说，用户无法直接访问服⁠务器上的文件，需要⁠使用 Nginx 提供静态文件的访问能力。

把 dist 目录内的所有文⁠件上传到服务器上，⁠为了方便，直接上传到之前配置的网站的 root 目录下：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/HsroJSJWMhODlicF.webp)

如图：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/xKmwogWtwNIncYXt.webp)

但是，如果访问服务器，你会发现还是默认网⁠站。也就是说，默认并⁠没有从 1Panel 的网站目录加载网站！需要我们手动修改 Nginx 配置。

![](https://pic.code-nav.cn/course_picture/1608440217629360130/Yu8AxSi34jobpOJy.webp)

### 4、Nginx 配置

查看 Nginx 配置文件，⁠果然缺少 root⁠ 网站根目录配置：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/d5edfgOGPkUuUg29.webp)

加上一行配置就好：

```nginx
# 主前端网站根目录
root /www/sites/yu-ai-code-mother/index;
```

![](https://pic.code-nav.cn/course_picture/1608440217629360130/gWYTzRFUqtOgQS0B.webp)

然后输入服务器 IP（或者你配置的域名）就能访问了：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/AM6kSLtXrVafP9YI.webp)

但是经过验证，目前访问除了主页外的其他页面（比如 `/user/login`），如果刷新页面，就会出现 404 错误。

![](https://pic.code-nav.cn/course_picture/1608440217629360130/aUpcfiryE35cWJOR.png)

这个问题是由于 Vue 是单页面应用（前端路由），打包后的文件只有 `index.html`，服务器上不存在对应的页面文件（比如 `/user/login.html`），所以需要在 Nginx 配置访问规则。如果找不到某个页面文件，就加载主页 index.html 文件。

修改 Nginx 配置，补充下列代码：

```nginx
# 处理主网站的路径访问，防止单页面应用 404
location / {
    try_files $uri $uri/ /index.html =404;
}
```

![](https://pic.code-nav.cn/course_picture/1608440217629360130/lvMpfkWhIy6Omf2q.webp)

保存并重载配置后，再次刷新页面，可以正常访问。

![](https://pic.code-nav.cn/course_picture/1608440217629360130/RDfJg37jLCdAeK1Q.webp)

## 六、应用部署

这个项目比较特殊，除了前后端⁠部署外，还需要为 ⁠AI 生成的应用提供部署地址。

由于前端是通过 Nginx 容⁠器部署的，有些服务器⁠上的文件路径是无法直接在容器内访问到的，除非利用容器的挂载能力。

前面也提到了，Nginx 的 `/www` 路径映射到了服务器本机目录，也就是说 Nginx 能访问到 `/opt/1panel/www` 路径下的文件，这就是一个突破口，后端只要把 AI 生成的应用也存放到这个路径下就可以了。

![](https://pic.code-nav.cn/course_picture/1608440217629360130/3hmfwmi8kLzFoWdS.webp)

这里我们约定，后端需要确保在 `/www/sites/yu-ai-code-mother/tmp` 目录下生成临时文件。最简单的办法就是把 jar 包移动到这个 `/www/sites/yu-ai-code-mother` 目录下运行（或者通过配置文件修改后端写入文件的路径）。

直接复制 jar 包：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/DpJilw2Y2bYERppt.webp)

关闭之前已经启动的进程：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/zG6oyHL7OjvtAhqw.webp)

执行命令重新启动 jar 包：

```shell
nohup java -jar yu-ai-code-mother-0.0.1-SNAPSHOT.jar --spring.profiles.active=prod > app.log 2>&1 &
```

修改前端的 Nginx 配置，配置请求 `/dist` 路径时到项目部署根目录去寻找网页文件：

```nginx
# 为生成的网站提供部署访问能力
location /dist/ {
    # 生成的网站部署根目录
    alias /www/sites/yu-ai-code-mother/tmp/code_deploy/;
    try_files $uri $uri/ /dist/index.html =404;
}
```

![](https://pic.code-nav.cn/course_picture/1608440217629360130/OYmB4qQdaUFgsqof.webp)

可以在 `/www/sites/yu-ai-code-mother/tmp/code_deploy/` 目录下自己新建一个网站目录来测试能否访问。比如：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/fNKF5uqRsaxedO3f.webp)

能够成功访问：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/RDbYFdWYn28FmZ4K.webp)

## 七、测试验证

最后，我们来对上线效果进行验证。

1）用户注册登录

![](https://pic.code-nav.cn/course_picture/1608440217629360130/OYuDwT7UZddQBnKz.webp)

然后通过修改数据库的方式，将⁠该用户的角色设置为⁠管理员，从而使用更多功能。

2）进入主页，和 AI 对话来生成一个网站：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/leywmEJpF7zaSNqs.webp)

3）进入对话页面，发现 AI⁠ 自动选择了生成模⁠式，并且能够流式输出代码：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/ju7v706XxPnZGu1J.webp)

4）网站生成完后，可以立刻看到生成的效果：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/2N9S9IS7aJImESHg.webp)

还可以查看生成的应用详情：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/BQ9I1lDGODsjDLhn.webp)

5）支持修改和删除自己的应用信息：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/3NbmY4tBKmnGhxJh.webp)

6）再来生成一个更复杂的网站⁠，通过 AI 智能⁠路由触发 Vue 工程项目生成模式。

可以实时看到工具调用的过程，⁠并且在完成后自动构⁠建，然后展示出网站的运行效果：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/wwJa9EGLaA2kw2a7.webp)

7）可以进入编辑模式，可视化修改网站的内容：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/fWMlzxXDjO20sLIj.webp)

很快就修改完成了，效果如图：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/uSbYHJJIzE0Kc7s7.webp)

8）部署生成的应用：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/8oOzTsUQMCB6KORM.webp)

能够访问到部署的网站应用：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/k00EkX7CO8vm7EUi.webp)

9）部署网站成功后，稍等一会⁠儿回到主页，可以看⁠到自动生成了应用的封面图：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/iQeTBWetB9BPeFKW.webp)

10）管理员可以管理和精选应用：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/bihW0oT7Eo4wnplw.webp)

11）过几分钟后（有缓存），⁠主页就会展示出精选应⁠用啦。至此，网站部署完成！

![](https://pic.code-nav.cn/course_picture/1608440217629360130/kj3qUvjxzwWmlUI9.webp)

## 八、扩展知识 - 利用 Docker 部署

可以把 Docker 容器技术理解为安装操⁠作系统时的镜像、或者安装 A⁠PP 时的安装包，只要定义好 Docker 配置文件，就能快速基于配置启动服务或项目。

相信你已经发现了，1Pane⁠l 面板下的应用都⁠是通过 Docker 运行的！

如果我们要利用 Docker⁠ 部署后端，流程是⁠先构建容器镜像，然后根据镜像启动容器。

**⚠️** **注意！再次强调！！这部分只是扩展知识，由于本项目涉及的依赖较多，不推荐使用 Docker 部署！！！**

### 构建镜像

我们需要编写 Dockerf⁠ile，将后端项目⁠打包为 Docker 容器镜像。

Dockerfile 是一个文本配置文件⁠，包含一系列指令，用于自动⁠化构建 Docker 容器镜像。我们需要在 Dockerfile 中定义：

-   基础环境（比如预装 JDK 的 Linux 系统）
-   有哪些原始文件？（比如项目源代码）
-   如何构建项目？（比如 maven package 命令打包）
-   如何启动项目？（比如 java -jar 命令）

这里我们有 2 种编写 Do⁠ckerfile ⁠的方式，各有优缺点：

#### 方法 1 - 运行时打包

只把源代码复制到 Docke⁠r 工作空间中，在⁠构造镜像时执行 Maven 打包。

Dockerfile 代码如下：

```dockerfile
# 注意，本文件仅为示例！由于本项目涉及的依赖较多，不推荐使用 Docker 部署
# 使用预装 Maven 和 JDK21 的镜像
FROM maven:3.9-amazoncorretto-21
WORKDIR /app

# 只复制必要的源代码和配置文件
COPY pom.xml .
COPY src ./src

# 使用 Maven 执行打包
RUN mvn clean package -DskipTests

# 暴露应用端口
EXPOSE 8123

# 使用生产环境配置启动应用
CMD ["java", "-jar", "/app/target/yu-ai-code-mother-0.0.1-SNAPSHOT.jar", "--spring.profiles.active=prod"]
```

不会自己写 Dockerfi⁠le 也完全没关系⁠，可以用 AI 生成或者找其他开源项目的文件即可，比如：

-   [鱼皮的 AI 答题应用平台后端 Dockerfile](https://github.com/liyupi/yudada/blob/master/yudada-backend/Dockerfile)
-   [鱼皮的 AI 答题应用平台前端 Dockerfile](https://github.com/liyupi/yudada/blob/master/yudada-frontend/Dockerfile)

#### 方法 2 - 预打包

提前在自己的电脑上把 jar 包构建好，⁠直接把得到的 target⁠ 目录下的 jar 包复制到 Docker 工作空间中，无需在构造镜像时打包。

Dockerfile 代码如下：

```dockerfile
# 注意，本文件仅为示例！由于本项目涉及的依赖较多，不推荐使用 Docker 部署
# 使用轻量级 JDK21 运行环境
FROM openjdk:21-slim

# 工作目录
WORKDIR /app

# 复制已经打包好的 JAR 文件（假设已放在当前目录）
COPY target/yu-ai-code-mother-0.0.1-SNAPSHOT.jar app.jar

# 暴露应用端口
EXPOSE 8123

# 使用生产环境配置启动应用
CMD ["java", "-jar", "app.jar", "--spring.profiles.active=prod"]
```

显然，第一种方式的优点是更加自动化，不用每次部署项目都手动打 jar 包，减少人工部署的成本和误差；但缺点是每次构建镜像时都要拉取 Maven 依赖，耗时更长。鱼皮建议大家 **优先选择第一种方式**，如果容器平台在构建镜像的过程中耗时过长、或者无法拉取依赖，那么再选择第二种方式。

这里鱼皮为了节省时间，给大家⁠演示第二种方式，在⁠项目下新建 Dockerfile 文件：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/2SsQDpcCwgTyrXJe.webp)

#### 构建镜像

将构建镜像需要的文件（Dockerfile 和包含打好 jar 包的 target 目录）通过面板上传到服务器的目录下，我这里是 `/project/yu-ai-code-mother-backend`。

![](https://pic.code-nav.cn/course_picture/1608440217629360130/OfR4AXbQyrWsyV3r.webp)

然后进入容器面板，构建镜像，⁠配置镜像名称和 D⁠ockerfile 文件路径：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/nW41Rkf5zgAvesW1.webp)

等待构建成功：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/uXq2YMwKzdLTXr9A.webp)

构建成功后，可以看到镜像：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/56CQMilHHLPexVOs.webp)

### 启动容器

创建容器：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/7Abtu61jhKUP5SyO.webp)

注意开放端口：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/JujKeZBt4KNJNo0d.webp)

容器启动成功：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/nUWmoRt3ikAv5qRN.webp)

可以通过日志确认启动成功，或者获取错误信息来排查：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/7IfJNhkCdSssrKrm.webp)

但是，我们现在无法通过浏览器访问后端接口文档：[http://{你的服务器 IP}/api/doc.html](http://110.42.141.105/api/doc.html)。这是因为我们的服务器防火墙没有放开 8123 端口。**这里我们故意不放开**，因为在之前的部署规划中，后端需要通过 Nginx 进行转发，从而解决跨域问题。

### 容器编排

再分享一种更快部署后端的方法⁠，可以利用 Doc⁠ker Compose 快速部署后端依赖和后端项目本身。

Docker Compose⁠ 可以组合编排多个⁠ Docker 容器，按照顺序快速启动多个服务或项目。

给大家提供一个示例的 Docker Compo⁠se 配置文件，定义了 MyS⁠QL、Redis 和 Spring Boot 项目的启动，大家可以基于这个文件进行定制修改：

```yaml
# Docker Compose 文件，用于 Spring Boot 项目，依赖 MySQL 和 Redis

version: '3.8'
services:
  # MySQL 数据库服务
  mysql:
    image: mysql:8.0
    container_name: mysql_db
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root           # 设置 MySQL root 用户的密码
      MYSQL_DATABASE: yu_ai_code_mother   # 设置数据库名称
      MYSQL_USER: root                    # 设置用户名
      MYSQL_PASSWORD: 123456              # 设置密码
      TZ: Asia/Shanghai                    # 设置时区为东八区
    ports:
      - "3306:3306"                       # 映射 MySQL 端口到主机
    volumes:
      - mysql_data:/var/lib/mysql         # 数据持久化到宿主机（使用 Docker 管理的命名卷）
    command: --default-authentication-plugin=mysql_native_password
  # Redis 缓存服务
  redis:
    image: redis:5.0
    container_name: redis_cache
    restart: always
    ports:
      - "6379:6379"                      # 映射 Redis 端口到主机
    volumes:
      - redis_data:/data                  # 数据持久化到宿主机（使用 Docker 管理的命名卷）
    environment:
      TZ: Asia/Shanghai                    # 设置时区为东八区
  # Spring Boot 应用服务
  springboot_app:
    image: openjdk:11-jre-slim
    container_name: springboot_app
    working_dir: /app
    volumes:
      - .:/app                            # 挂载本地目录到容器中
    ports:
      - "8123:8123"                      # 映射 Spring Boot 端口到主机
    environment:
      TZ: Asia/Shanghai                   # 设置时区为东八区
    command: [ "java", "-jar", "target/yu-ai-code-mother-0.0.1-SNAPSHOT.jar", "--spring.profiles.active=prod" ]  # 使用 prod 配置文件启动 Spring Boot 应用
    depends_on:
      - mysql
      - redis
# 使用 Docker 管理的命名卷
volumes:
  mysql_data:
  redis_data:
```

有了配置文件后，就可以利用面⁠板自带的容器编排能⁠力，去进行项目的部署了，感兴趣的同学可以尝试一下：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/KW99usFeXH052Ytr.webp)

💡 在鱼皮编程导航的 [OJ 在线判题项目教程](https://www.codefather.cn/course/1790980707917017089) 中，讲解过基于 Docker + Docker Compose 快速部署微服务项目的方法，[观看视频教程](https://www.bilibili.com/video/BV1Cp4y1F7eA)。

## 最后

我个人感觉对新手来说，1Pa⁠nel 不如宝塔面⁠板更友好，毕竟全容器操作，新手很容易在路径和依赖上踩一些坑。

至此，整个项目已经完成上线，希望大家能通⁠过这个项目掌握企业级 AI⁠ 项目的开发、优化和上线方法，得到全方面编程能力和 AI 应用开发技巧的提升。

## 本期作业

1）完成项目的上线

2）尝试给项目绑定域名、或者⁠申请 HTTPS ⁠证书（通过自行查阅资料实现）

3）完成整个项目，并且自行增加 2⁠ - 3 个扩展点，可⁠以新增功能、也可以是某个优化、还可以将其他项目的知识点融合到本项目中。

## 常见问题

本教程每一个步骤和细节都尽可⁠能给大家提供了，如⁠果还有错误，只可能是几个原因：

1.  没有认真看教程，跳过了步骤，请回到出错前的步骤重新来过
2.  没有使用跟教程一致的版本号或代码，请确保版本号跟鱼皮的完全一致！
3.  网络原因，导致依赖无法安装，那就尝试更换服务器的网络
4.  服务器配置原因，请确保内存 >= 2G，不然怎么卡住的都不知道

举个例子，如果发现无法截图应用封面图⁠，可以查看日志，如果报错⁠信息是找不到浏览器，那就退回到安装 Chrome 浏览器的内容重新来过：

![](https://pic.code-nav.cn/course_picture/1608440217629360130/Z5hOF0TloMxtheVm.webp)


