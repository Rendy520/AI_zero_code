---
created: 2025-12-29T15:54:18 (UTC +08:00)
tags: [,Java,Python,JavaScript,å‰ç«¯,Cè¯­è¨€,C++,Goè¯­è¨€,ç¨‹åºå‘˜,ç¼–ç¨‹å­¦ä¹ ,ITæ•™ç¨‹,è‡ªå­¦ç¼–ç¨‹,è½¯ä»¶å¼€å‘,é¡¹ç›®å®æˆ˜,ç¼–ç¨‹å¯¼èˆª,å¼€å‘è€…äº¤æµç¤¾åŒº,ç¼–ç¨‹èµ„æº,è®¡ç®—æœº]
source: https://www.codefather.cn/course/1948291549923344386/section/1951123843887325185
author: 
---

# 6 - å¯¹è¯å†å²æ¨¡å— - ã€å¤§å‚å¿…å¤‡ã€‘LangChain4j +

> ## Excerpt
> æœ¬èŠ‚é‡ç‚¹ æœ¬èŠ‚æˆ‘ä»¬å°†ä¸º AI é›¶ä»£ç åº”ç”¨ç”Ÿæˆå¹³å°æ·»åŠ å¯¹è¯å†å²ç®¡ç†åŠŸèƒ½ï¼Œè®©ç”¨æˆ·èƒ½å¤ŸæŸ¥çœ‹å’Œç®¡ç†å†å²å¯¹è¯è®°å½•ã€‚è¿™ä¸€èŠ‚çš„æ ¸å¿ƒåœ¨äºå®ç°å®Œæ•´çš„å¯¹è¯è®°å¿†ä½“ç³»ï¼Œè®© AI èƒ½å¤ŸåŸºäºå†å²ä¸Šä¸‹æ–‡è¿›è¡Œç½‘ç«™çš„è¿­ä»£ä¼˜ã€‚ç¼–ç¨‹å¯¼èˆªæ•™ç¨‹åˆ†äº«ï¼Œåšæ‚¨ç¼–ç¨‹å­¦ä¹ è·¯ä¸Šçš„å¯¼èˆªå‘˜ã€‚

---
## æœ¬èŠ‚é‡ç‚¹

æœ¬èŠ‚æˆ‘ä»¬å°†ä¸º AI é›¶ä»£ç åº”ç”¨ç”Ÿæˆå¹³å°æ·»åŠ å¯¹è¯å†å²ç®¡ç†åŠŸèƒ½ï¼Œè®©ç”¨æˆ·â èƒ½å¤ŸæŸ¥çœ‹å’Œç®¡ç†å†å²å¯¹è¯è®°å½•ã€‚è¿™ä¸€èŠ‚çš„æ ¸å¿ƒåœ¨äºâ å®ç°å®Œæ•´çš„å¯¹è¯è®°å¿†ä½“ç³»ï¼Œè®© AI èƒ½å¤ŸåŸºäºå†å²ä¸Šä¸‹æ–‡è¿›è¡Œç½‘ç«™çš„è¿­ä»£ä¼˜åŒ–ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡å¤šè½®å¯¹è¯æ¥å®Œå–„å’Œä¼˜åŒ–ç”Ÿæˆçš„ç½‘ç«™åº”ç”¨ã€‚

æœ¬èŠ‚ä¸»è¦å†…å®¹ï¼š

-   å¯¹è¯å†å²æ¸¸æ ‡æ–¹æ¡ˆè®¾è®¡
-   å¯¹è¯å†å²çš„ä¿å­˜å’ŒæŸ¥è¯¢ï¼ˆåç«¯ + å‰ç«¯ï¼‰
-   å¯¹è¯è®°å¿†æŒä¹…åŒ–
-   Redis åˆ†å¸ƒå¼ Session

## ä¸€ã€éœ€æ±‚åˆ†æ

åœ¨å‰é¢çš„ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬å®ç°äº† AI ç”Ÿæˆåº”ç”¨çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œä½†å­˜åœ¨ä¸€ä¸ªæ˜æ˜¾çš„é—®é¢˜ï¼š\*\*æ¯æ¬¡å¯¹è¯éƒ½æ˜¯ç‹¬ç«‹çš„ï¼ŒAI æ— æ³•è®°ä½ä¹‹å‰çš„äº¤äº’å†…å®¹ã€‚\*\*è¿™å¯¼è‡´ç”¨æˆ·æ— æ³•åŸºäºå·²ç”Ÿæˆçš„ç½‘ç«™è¿›è¡Œè¿­ä»£æ”¹è¿›ï¼Œæå¤§åœ°é™åˆ¶äº†å¹³å°çš„å®ç”¨æ€§ã€‚

ä¸¾ä¸ªä¾‹å­ï¼šç”¨æˆ·é¦–å…ˆè®© AI ç”Ÿæˆä¸€ä¸ªåšå®¢ç½‘ç«™ï¼Œç„¶åå¸Œæœ›åœ¨æ­¤åŸºâ ç¡€ä¸Šæ·»åŠ è¯„è®ºåŠŸèƒ½ï¼Œæœ€åå†ä¼˜åŒ–ä¸€ä¸‹é¡µé¢â æ ·å¼ã€‚åœ¨æ²¡æœ‰å¯¹è¯è®°å¿†çš„æƒ…å†µä¸‹ï¼Œæ¯æ¬¡éƒ½éœ€è¦é‡æ–°æè¿°å®Œæ•´éœ€æ±‚ï¼ŒAI ä¹Ÿä¼šé‡æ–°ç”Ÿæˆæ•´ä¸ªç½‘ç«™ï¼Œè€Œä¸æ˜¯åœ¨åŸæœ‰åŸºç¡€ä¸Šè¿›è¡Œæ”¹è¿›ã€‚

å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦å®ç°ä»¥ä¸‹éœ€æ±‚ï¼š

1ï¼‰å¯¹è¯å†å²çš„æŒä¹…åŒ–å­˜å‚¨ï¼šç”¨æˆ·å‘é€æ¶ˆæ¯æ—¶ï¼Œâ éœ€è¦ä¿å­˜ç”¨æˆ·æ¶ˆæ¯ï¼›AI æˆåŠŸâ å›å¤åï¼Œéœ€è¦ä¿å­˜ AI æ¶ˆæ¯ã€‚å³ä½¿ AI å›å¤å¤±è´¥ï¼Œä¹Ÿè¦è®°å½•é”™è¯¯ä¿¡æ¯ï¼Œç¡®ä¿å¯¹è¯çš„å®Œæ•´æ€§ã€‚

2ï¼‰åº”ç”¨çº§åˆ«çš„æ•°æ®éš”ç¦»ï¼šæ¯ä¸ªåº”â ç”¨çš„å¯¹è¯å†å²éƒ½æ˜¯ç‹¬â ç«‹çš„ã€‚åˆ é™¤åº”ç”¨æ—¶ï¼Œéœ€è¦å…³è”åˆ é™¤è¯¥åº”ç”¨çš„æ‰€æœ‰å¯¹è¯å†å²ï¼Œé¿å…æ•°æ®å†—ä½™ã€‚

3ï¼‰å¯¹è¯å†å²æŸ¥è¯¢ï¼šæ”¯æŒåˆ†é¡µæŸ¥çœ‹æŸä¸ªåº”ç”¨çš„å¯¹è¯å†å²ï¼Œéœ€è¦åŒºåˆ†ç”¨æˆ·å’Œ AI æ¶ˆæ¯ã€‚ç±»ä¼¼èŠå¤©è½¯ä»¶çš„æ¶ˆæ¯åŠ è½½æœºåˆ¶ï¼Œæ¯æ¬¡åŠ è½½æœ€æ–° 10 æ¡æ¶ˆæ¯ï¼Œæ”¯æŒ **å‘å‰åŠ è½½** æ›´å¤šå†å²è®°å½•ã€‚ï¼ˆä»…åº”ç”¨åˆ›å»ºè€…å’Œç®¡ç†å‘˜å¯è§ï¼‰

è¯¦ç»†æ¥è¯´ï¼Œè¿›å…¥åº”ç”¨é¡µé¢æ—¶ï¼Œå‰ç«¯æ ¹æ®åº”ç”¨ id å…ˆåŠ è½½ä¸€æ¬¡å¯¹è¯å†å²â æ¶ˆæ¯ï¼Œå…³è”æŸ¥è¯¢æœ€æ–° 10 æ¡æ¶ˆæ¯ã€‚å¦‚æœå­˜åœ¨â å†å²å¯¹è¯ï¼Œç›´æ¥å±•ç¤ºï¼›å¦‚æœæ²¡æœ‰å†å²è®°å½•ï¼Œæ‰è‡ªåŠ¨å‘é€åˆå§‹åŒ–æç¤ºè¯ã€‚è¿™æ ·å°±è§£å†³äº†ä¹‹å‰æµè§ˆåˆ«äººçš„åº”ç”¨æ—¶æ„å¤–è§¦å‘å¯¹è¯çš„é—®é¢˜ã€‚

4ï¼‰ç®¡ç†å¯¹è¯å†å²ï¼šç®¡ç†å‘˜å¯ä»¥â æŸ¥çœ‹æ‰€æœ‰åº”ç”¨çš„å¯¹è¯â å†å²ï¼ŒæŒ‰ç…§æ—¶é—´é™åºæ’åºï¼Œä¾¿äºå†…å®¹ç›‘ç®¡ã€‚

## äºŒã€æ–¹æ¡ˆè®¾è®¡

### åˆ†é¡µæŸ¥è¯¢

å¯¹äºå¯¹è¯å†å²ï¼ˆèŠå¤©è®°å½•ï¼‰çš„åˆ†â é¡µæŸ¥è¯¢ï¼Œä¸å»ºè®®ä½¿ç”¨â ä¼ ç»Ÿåˆ†é¡µæŸ¥è¯¢ã€‚

ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ

#### ä¼ ç»Ÿåˆ†é¡µæŸ¥è¯¢çš„é—®é¢˜

åœ¨ä¼ ç»Ÿåˆ†é¡µä¸­ï¼Œæ•°æ®é€šå¸¸æ˜¯ **åŸºäºé¡µç æˆ–åç§»é‡** è¿›è¡ŒåŠ è½½çš„ã€‚å¦‚æœæ•°æ®åœ¨åˆ†é¡µè¿‡ç¨‹å‘ç”Ÿäº†å˜åŒ–ï¼Œæ¯”å¦‚æ’å…¥æ–°æ•°æ®ã€åˆ é™¤è€æ•°æ®ï¼Œç”¨æˆ·çœ‹åˆ°çš„åˆ†é¡µæ•°æ®å¯èƒ½ä¼šå‡ºç°ä¸ä¸€è‡´ï¼Œå¯¼è‡´ç”¨æˆ·é”™è¿‡æˆ–é‡å¤æŸäº›æ•°æ®ã€‚

ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾ç”¨æˆ·ä¼šæŒç»­æ”¶åˆ°æ–°çš„æ¶ˆæ¯ã€‚å¦‚æœæŒ‰ç…§ä¼ ç»Ÿåˆ†é¡µåŸºäºåç§»é‡â åŠ è½½ï¼Œç¬¬ä¸€é¡µå·²ç»åŠ è½½äº†ç¬¬ 1 - 5 è¡Œçš„â æ•°æ®ï¼Œæœ¬æ¥è¦æŸ¥è¯¢çš„ç¬¬äºŒé¡µæ•°æ®æ˜¯ç¬¬ 6 - 10 è¡Œï¼ˆå¯¹åº”çš„ SQL è¯­å¥ä¸º limit 5, 5ï¼‰ï¼Œæ•°æ®åº“è®°å½•å¦‚ä¸‹ï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/zN3TYdqHWgrbdRz8.webp "null")

ç»“æœåœ¨æŸ¥è¯¢ç¬¬äºŒé¡µå‰ï¼Œçªç„¶ç”¨æˆ·åˆâ æ”¶åˆ°äº† 5 æ¡æ–°æ¶ˆæ¯â ï¼Œæ•°æ®åº“è®°å½•å°±å˜æˆäº†ä¸‹é¢è¿™æ ·ã€‚åŸæœ¬çš„ç¬¬ä¸€é¡µï¼Œå˜æˆäº†å½“å‰çš„ç¬¬äºŒé¡µï¼

![](https://pic.code-nav.cn/course_picture/1608440217629360130/rrqWGqDgVtWSnq98.webp "null")

è¿™æ ·å°±å¯¼è‡´æŸ¥è¯¢å‡ºçš„ç¬¬äºŒé¡µæ•°æ®â ï¼Œæ­£å¥½æ˜¯ä¹‹å‰å·²ç»æŸ¥â è¯¢å‡ºçš„ç¬¬ä¸€é¡µçš„æ•°æ®ï¼Œé€ æˆäº†æ¶ˆæ¯é‡å¤åŠ è½½ã€‚

æ­¤å¤–ï¼Œä¼ ç»Ÿçš„ offset åˆ†é¡µæ–¹å¼åœ¨å¤„ç†å¤§é‡å¯¹è¯æ•°æ®æ—¶å­˜åœ¨ä¸¥é‡çš„æ€§èƒ½é—®é¢˜ã€‚å‡è®¾ä¸€ä¸ªçƒ­é—¨åº”ç”¨ç§¯ç´¯äº†å‡ ä¸‡æ¡å¯¹è¯è®°å½•åï¼Œå¦‚æœç”¨æˆ·æƒ³æŸ¥çœ‹è¾ƒæ—©çš„å†å²æ¶ˆæ¯ï¼Œæ‰§è¡Œ `LIMIT 10000, 10` è¿™æ ·çš„æŸ¥è¯¢ä¼šéå¸¸ç¼“æ…¢ã€‚

è¿™æ˜¯å› ä¸ºæ•°æ®åº“éœ€è¦å…ˆæ‰«æå’Œè·³è¿‡å‰é¢çš„ 10000 æ¡â è®°å½•ï¼Œæ‰èƒ½è¿”å›ç”¨æˆ·çœŸæ­£éœ€è¦çš„ 10 æ¡â æ•°æ®ã€‚éšç€ offset å€¼çš„å¢å¤§ï¼ŒæŸ¥è¯¢æ€§èƒ½ä¼šçº¿æ€§ä¸‹é™ï¼Œåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹å¾ˆå®¹æ˜“æˆä¸ºç³»ç»Ÿç“¶é¢ˆã€‚

#### æ¸¸æ ‡æŸ¥è¯¢

ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œå¯ä»¥ä½¿ç”¨æ¸¸æ ‡åˆ†é¡µã€‚ä½¿ç”¨ä¸€ä¸ªæ¸¸æ ‡æ¥è·Ÿè¸ªåˆ†é¡µä½ç½®ï¼Œè€Œä¸æ˜¯åŸºäºé¡µç ï¼Œ**æ¯æ¬¡è¯·æ±‚ä»ä¸Šä¸€æ¬¡è¯·æ±‚çš„æ¸¸æ ‡å¼€å§‹åŠ è½½æ•°æ®ã€‚**

ä¸€èˆ¬æˆ‘ä»¬ä¼šé€‰æ‹©æ•°æ®è®°å½•çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆä¸»é”®ï¼‰ã€æ—¶é—´æˆ³ã€æˆ–è€…å…·æœ‰æ’åºèƒ½åŠ›çš„å­—â æ®µä½œä¸ºæ¸¸æ ‡ã€‚æ¯”å¦‚å³æ—¶é€šè®¯ç³»ç»Ÿä¸­çš„æ¯ä¸ªæ¶ˆæ¯ï¼Œé€šå¸¸éƒ½â æœ‰ä¸€ä¸ªå”¯ä¸€è‡ªå¢çš„ idï¼Œå°±å¯ä»¥ä½œä¸ºæ¸¸æ ‡ã€‚æ¯æ¬¡æŸ¥è¯¢å®Œå½“å‰é¡µé¢çš„æ•°æ®åï¼Œå¯ä»¥å°†æœ€åä¸€æ¡æ¶ˆæ¯è®°å½•çš„ id ä½œä¸ºæ¸¸æ ‡å€¼ä¼ é€’ç»™å‰ç«¯ï¼ˆå®¢æˆ·ç«¯ï¼‰ã€‚

![](https://pic.code-nav.cn/course_picture/1608440217629360130/3KvKIudvl54FFHAz.webp)

å½“è¦åŠ è½½ä¸‹ä¸€é¡µæ—¶ï¼Œå‰ç«¯æºå¸¦æ¸¸æ ‡å€¼å‘èµ·â æŸ¥è¯¢ï¼Œåç«¯æ“ä½œæ•°æ®åº“ä» â id å°äºå½“å‰æ¸¸æ ‡å€¼çš„æ•°æ®å¼€å§‹æŸ¥è¯¢ï¼Œè¿™æ ·æŸ¥è¯¢ç»“æœå°±ä¸ä¼šå—åˆ°æ–°å¢æ•°æ®çš„å½±å“ã€‚

![](https://pic.code-nav.cn/course_picture/1608440217629360130/fuBKjDoKJm3BO4K2.webp)

æ ‡å‡†å®è·µå»ºè®®ä¼˜å…ˆä½¿ç”¨ id ä½œä¸ºæ¸¸æ ‡ï¼Œå› ä¸ºä¸»é”®æ€§èƒ½æœ€ä¼˜ä¸”ä¸é‡å¤ã€‚ä½†é’ˆå¯¹æˆ‘ä»¬çš„åœºæ™¯ï¼ŒæŒ‰æ—¶é—´æ’åºæ˜¯æ ¸å¿ƒéœ€æ±‚â ï¼Œè€Œä¸”åŒä¸€ä¸ª appId ä¸‹æ—¶é—´é‡å¤çš„å¯èƒ½æ€§æä½ï¼Œæ‰€ä»¥ç›´æ¥ä½¿ç”¨å¯¹è¯å†â å²çš„åˆ›å»ºæ—¶é—´ createTime ä½œä¸ºæ¸¸æ ‡æ˜¯å®Œå…¨å¯è¡Œçš„ã€‚ä¸éœ€è¦é¢å¤–å¸¦ä¸Šå¯¹è¯å†å²çš„ id ä½œä¸ºå¤åˆæ¸¸æ ‡ï¼Œç®€åŒ–äº†æ¸¸æ ‡æŸ¥è¯¢çš„é€»è¾‘â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‰â€‰â€‰â€‰â€‰â€‚â€‰â€‰â€‰â€‰â€‚â€‚â€‚â€‰â€‚â€‚

ç¤ºä¾‹ SQL è¯­å¥å¦‚ä¸‹ï¼š

```sql
SELECT * FROM chat_history 
WHERE appId = 123 AND createTime < '2025-07-29 10:30:00'
ORDER BY createTime DESC 
LIMIT 10;
```

è€Œä¸”è¿˜å¯ä»¥ç»™ appId å’Œâ  createTiâ me å¢åŠ å¤åˆç´¢å¼•ï¼Œè¿›ä¸€æ­¥æé«˜æ£€ç´¢æ•ˆç‡ã€‚è¿™æ ·æ‰§è¡Œè¿‡ç¨‹å°±å˜æˆäº†ï¼š

1.  ç›´æ¥å®šä½åˆ° (appId=123, createTime<'2025-07-29 10:30:00') çš„ç´¢å¼•ä½ç½®
2.  é¡ºåºè¯»å– 10 æ¡è®°å½•
3.  å®ŒæˆæŸ¥è¯¢

å‡ ä¹åªæœ‰ 10 æ¬¡è¯»å–æˆæœ¬ï¼

å†ä¸¾ä¸ªæ˜æ˜¾çš„å¯¹æ¯”ä¾‹å­ï¼Œå‡è®¾ä¸€ä¸ªçƒ­é—¨â èŠå¤©å®¤æœ‰ 10 ä¸‡æ¡å¯¹â è¯è®°å½•ï¼Œç”¨æˆ·è¦æŸ¥çœ‹ 1 ä¸ªæœˆå‰çš„æ¶ˆæ¯ï¼ˆå¤§çº¦åœ¨ç¬¬ 3000 é¡µï¼‰ï¼š



|æŸ¥è¯¢æ–¹å¼|SQLè¯­å¥|æ‰§è¡Œæ—¶é—´|èµ„æºæ¶ˆè€—|
|---|---|---|---|
|Offset åˆ†é¡µ|LIMIT 30000, 10|800ms|éœ€è¦æ‰«æ 30000 æ¡è®°å½•|
|æ¸¸æ ‡æŸ¥è¯¢ |createTiâ me < '2025â -07-29'|12ms|ç›´æ¥å®šä½ï¼Œä»…è¯»å– 10 æ¡|

ğŸ’¡ é±¼çš®ä¹‹å‰å†™è¿‡ä¸€ç¯‡ [å…³äºæ¸¸æ ‡çš„æ–‡ç« ](https://mp.weixin.qq.com/s/Z1Fnfju37DCeJufiu6DUiw)ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥é˜…è¯»ã€‚

### åº“è¡¨è®¾è®¡

#### 1ã€æ ¸å¿ƒè®¾è®¡

æ ¹æ®æˆ‘ä»¬çš„æ–¹æ¡ˆï¼Œå¯ä»¥è®¾è®¡å‡ºå¯¹è¯å†å²è¡¨çš„ç»“æ„ã€‚ä¸ºäº†é¿å…ä¸ AI åº“çš„ ChatMessage å†²çªï¼Œè¡¨åé‡‡ç”¨ `chat_history`ï¼š

```sql
-- å¯¹è¯å†å²è¡¨
create table chat_history
(
    id          bigint auto_increment comment 'id' primary key,
    message     text                               not null comment 'æ¶ˆæ¯',
    messageType varchar(32)                        not null comment 'user/ai',
    appId       bigint                             not null comment 'åº”ç”¨id',
    userId      bigint                             not null comment 'åˆ›å»ºç”¨æˆ·id',
    createTime  datetime default CURRENT_TIMESTAMP not null comment 'åˆ›å»ºæ—¶é—´',
    updateTime  datetime default CURRENT_TIMESTAMP not null on update CURRENT_TIMESTAMP comment 'æ›´æ–°æ—¶é—´',
    isDelete    tinyint  default 0                 not null comment 'æ˜¯å¦åˆ é™¤',
    INDEX idx_appId (appId),                       -- æå‡åŸºäºåº”ç”¨çš„æŸ¥è¯¢æ€§èƒ½
    INDEX idx_createTime (createTime),             -- æå‡åŸºäºæ—¶é—´çš„æŸ¥è¯¢æ€§èƒ½
    INDEX idx_appId_createTime (appId, createTime) -- æ¸¸æ ‡æŸ¥è¯¢æ ¸å¿ƒç´¢å¼•
) comment 'å¯¹è¯å†å²' collate = utf8mb4_unicode_ci;
```

è¿™ä¸ªè®¾è®¡ä¸­æœ€å…³é”®çš„æ˜¯å¤åˆç´¢å¼• `idx_appId_createTime`ï¼Œèƒ½å¤Ÿå¤§å¹…æé«˜æ¸¸æ ‡æŸ¥è¯¢çš„æ•ˆç‡ã€‚

#### 2ã€æ‰©å±•è®¾è®¡

1ï¼‰å¯ä»¥æŒ‰éœ€æ·»åŠ  `parentId` å­—æ®µï¼Œå°† AI æ¶ˆæ¯å’Œå¯¹åº”çš„ç”¨æˆ·æç¤ºè¯è¿›è¡Œå…³è”ï¼Œä¾¿äºç”Ÿæˆå¤±è´¥æ—¶çš„é‡è¯•ã€æˆ–è€…ç”¨æˆ·æ‰‹åŠ¨é‡æ–°ç”Ÿæˆã€‚

```sql
parentId   bigint  null comment 'çˆ¶æ¶ˆæ¯idï¼ˆç”¨äºä¸Šä¸‹æ–‡å…³è”ï¼‰',
```

2ï¼‰å¦‚æœéœ€è¦ä¿å­˜æ¯ä¸ªç‰ˆæœ¬çš„ä»£ç æ–‡ä»¶ï¼Œè¿˜å¯ä»¥æ·»åŠ  `fileList` å­—æ®µï¼Œç»“æ„ä¸º JSON æ•°ç»„æ ¼å¼ï¼Œè¿™æ ·æ¯æ¡æ¶ˆæ¯å°±å¯¹åº”ä¸€ä¸ªä»£ç ç‰ˆæœ¬ã€‚

ä¸è¿‡ä»£ç æ–‡ä»¶å¾ˆå¤§æ—¶ï¼Œå­˜åˆ°æ•°æ®åº“é‡Œä¸æ˜¯ä¸€ä¸ªåˆé€‚çš„é€‰æ‹©ã€‚

## ä¸‰ã€å¯¹è¯å†å²åç«¯å¼€å‘

### åŸºç¡€ä»£ç ç”Ÿæˆ

é¦–å…ˆä½¿ç”¨ MyBatis Flex ç”Ÿæˆå™¨ç”ŸæˆåŸºç¡€ä»£ç ï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/DYFH2Y8XZkenlb7X.webp)

å°†ç”Ÿæˆçš„æ–‡ä»¶ç§»åŠ¨åˆ°å¯¹åº”çš„åŒ…ä¸‹ã€‚

ç„¶åä¿®æ”¹ ChatHistoâ ry ç±»ï¼Œå°†ä¸»é”® â ID çš„ç”Ÿæˆç­–ç•¥æ”¹ä¸ºé›ªèŠ±ç®—æ³•ï¼š

```java
/**
 * id
 */
@Id(keyType = KeyType.Generator, value = KeyGenerators.snowFlakeId)
private Long id;
```

### ä¸šåŠ¡ä»£ç ç”Ÿæˆ - Vibe Coding

ä¹‹å‰æˆ‘ä»¬å·²ç»å†™äº†æ¸…æ™°çš„éœ€æ±‚æè¿°ï¼Œå¹¶â ä¸”é¡¹ç›®ä¸­å·²æœ‰å¤šä¸ªæ¨¡å—çš„â ä»£ç ï¼Œå¯ä»¥ç»™ AI å‚è€ƒã€‚å› æ­¤è¿™é‡Œç›´æ¥ä½¿ç”¨ AI æ¥ç”Ÿæˆä¸šåŠ¡ä»£ç ã€‚

åœ¨ Cursor ä¸­æ‰“å¼€ **åç«¯é¡¹ç›®æ ¹ç›®å½•**ï¼Œæ‰§è¡Œä»¥ä¸‹æç¤ºè¯ï¼š

```markdown
è¯·å‚è€ƒé¡¹ç›®ä¸­å·²æœ‰çš„ User å’Œ APP æ¨¡å—çš„æ–‡ä»¶å’Œä»£ç é£æ ¼ï¼Œå¸®æˆ‘æ ¹æ®ä¸‹åˆ—éœ€æ±‚ï¼Œç”Ÿæˆå®Œæ•´çš„ ChatHistory æ¨¡å—çš„åç«¯ä»£ç ã€‚

## éœ€è¦çš„åŠŸèƒ½å¦‚ä¸‹

1ï¼‰å¯¹è¯å†å²çš„æŒä¹…åŒ–å­˜å‚¨ï¼šç”¨æˆ·å‘é€æ¶ˆæ¯æ—¶ï¼Œéœ€è¦ä¿å­˜ç”¨æˆ·æ¶ˆæ¯ï¼›AI æˆåŠŸå›å¤åï¼Œéœ€è¦ä¿å­˜ AI æ¶ˆæ¯ã€‚å³ä½¿ AI å›å¤å¤±è´¥ï¼Œä¹Ÿè¦è®°å½•é”™è¯¯ä¿¡æ¯ï¼Œç¡®ä¿å¯¹è¯çš„å®Œæ•´æ€§ã€‚
2ï¼‰åº”ç”¨çº§åˆ«çš„æ•°æ®éš”ç¦»ï¼šæ¯ä¸ªåº”ç”¨çš„å¯¹è¯å†å²éƒ½æ˜¯ç‹¬ç«‹çš„ã€‚åˆ é™¤åº”ç”¨æ—¶ï¼Œéœ€è¦å…³è”åˆ é™¤è¯¥åº”ç”¨çš„æ‰€æœ‰å¯¹è¯å†å²ï¼Œé¿å…æ•°æ®å†—ä½™ã€‚
3ï¼‰å¯¹è¯å†å²æŸ¥è¯¢ï¼šæ”¯æŒåˆ†é¡µæŸ¥çœ‹æŸä¸ªåº”ç”¨çš„å¯¹è¯å†å²ï¼Œéœ€è¦åŒºåˆ†ç”¨æˆ·å’Œ AI æ¶ˆæ¯ã€‚ç±»ä¼¼èŠå¤©è½¯ä»¶çš„æ¶ˆæ¯åŠ è½½æœºåˆ¶ï¼Œæ¯æ¬¡åŠ è½½æœ€æ–° 10 æ¡æ¶ˆæ¯ï¼Œæ”¯æŒ å‘å‰åŠ è½½ æ›´å¤šå†å²è®°å½•ã€‚ï¼ˆä»…åº”ç”¨åˆ›å»ºè€…å’Œç®¡ç†å‘˜å¯è§ï¼‰
è¯¦ç»†æ¥è¯´ï¼Œè¿›å…¥åº”ç”¨é¡µé¢æ—¶ï¼Œå‰ç«¯æ ¹æ®åº”ç”¨ id å…ˆåŠ è½½ä¸€æ¬¡å¯¹è¯å†å²æ¶ˆæ¯ï¼Œå…³è”æŸ¥è¯¢æœ€æ–° 10 æ¡æ¶ˆæ¯ã€‚å¦‚æœå­˜åœ¨å†å²å¯¹è¯ï¼Œç›´æ¥å±•ç¤ºï¼›å¦‚æœæ²¡æœ‰å†å²è®°å½•ï¼Œæ‰è‡ªåŠ¨å‘é€åˆå§‹åŒ–æç¤ºè¯ã€‚è¿™æ ·å°±è§£å†³äº†ä¹‹å‰æµè§ˆåˆ«äººçš„åº”ç”¨æ—¶æ„å¤–è§¦å‘å¯¹è¯çš„é—®é¢˜ã€‚
4ï¼‰ç®¡ç†å¯¹è¯å†å²ï¼šç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹æ‰€æœ‰åº”ç”¨çš„å¯¹è¯å†å²ï¼ŒæŒ‰ç…§æ—¶é—´é™åºæ’åºï¼Œä¾¿äºå†…å®¹ç›‘ç®¡ã€‚

## å®ç°æç¤º

1ï¼‰éœ€è¦ä¸º messageType åˆ›å»ºä¸€ä¸ªæšä¸¾ç±»
```

æ³¨æ„ï¼Œä¸Šè¿°æç¤ºè¯ä¸­ï¼Œæˆ‘ç‰¹åœ°ç»™â  AI äº†ä¸€ä¸ªå¼•å¯¼â ï¼Œè®©å®ƒä¸º messageType åˆ›å»ºä¸€ä¸ªæšä¸¾ç±»ã€‚

ç”Ÿæˆè¿‡ç¨‹å¦‚å›¾ï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/GC1Tu6PfXdeN1D6P.webp "null")

AI ç”Ÿæˆäº†å®Œæ•´çš„æšä¸¾ç±»ï¼Œä»£ç å¦‚ä¸‹ï¼š

```java
@Getter
public enum ChatHistoryMessageTypeEnum {

    USER("ç”¨æˆ·", "user"),
    AI("AI", "ai");

    private final String text;

    private final String value;

    ChatHistoryMessageTypeEnum(String text, String value) {
        this.text = text;
        this.value = value;
    }

    /**
     * æ ¹æ® value è·å–æšä¸¾
     *
     * @param value æšä¸¾å€¼çš„value
     * @return æšä¸¾å€¼
     */
    public static ChatHistoryMessageTypeEnum getEnumByValue(String value) {
        if (ObjUtil.isEmpty(value)) {
            return null;
        }
        for (ChatHistoryMessageTypeEnum anEnum : ChatHistoryMessageTypeEnum.values()) {
            if (anEnum.value.equals(value)) {
                return anEnum;
            }
        }
        return null;
    }
}
```

æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦å¯¹ç…§éœ€æ±‚ï¼Œé€ä¸€æ£€æŸ¥å’Œå®Œå–„ç”Ÿæˆçš„ä»£ç ã€‚

### æ ¸å¿ƒåŠŸèƒ½å®ç°

#### 1ã€æ–°å¢å¯¹è¯å†å²

å¯¹è¯å†å²çš„ä¿å­˜éœ€è¦åœ¨ **ç”¨æˆ·å‘é€æ¶ˆæ¯** å’Œ **AI å›å¤å®Œæˆ** è¿™ä¸¤ä¸ªæ—¶æœºè¿›è¡Œã€‚æ— è®º AI å›å¤æˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼Œéƒ½è¦ç•™ä¸‹å®Œæ•´çš„å¯¹è¯è®°å½•ï¼Œç¡®ä¿ç”¨æˆ·èƒ½å¤Ÿäº†è§£å®Œæ•´çš„äº¤äº’å†å²ã€‚

å¯ä»¥åœ¨ `ChatHistoryServiceImpl` ä¸­æä¾›ç»Ÿä¸€çš„ä¿å­˜æ¥å£ï¼š

```java
@Override
public boolean addChatMessage(Long appId, String message, String messageType, Long userId) {
    ThrowUtils.throwIf(appId == null || appId <= 0, ErrorCode.PARAMS_ERROR, "åº”ç”¨IDä¸èƒ½ä¸ºç©º");
    ThrowUtils.throwIf(StrUtil.isBlank(message), ErrorCode.PARAMS_ERROR, "æ¶ˆæ¯å†…å®¹ä¸èƒ½ä¸ºç©º");
    ThrowUtils.throwIf(StrUtil.isBlank(messageType), ErrorCode.PARAMS_ERROR, "æ¶ˆæ¯ç±»å‹ä¸èƒ½ä¸ºç©º");
    ThrowUtils.throwIf(userId == null || userId <= 0, ErrorCode.PARAMS_ERROR, "ç”¨æˆ·IDä¸èƒ½ä¸ºç©º");
    // éªŒè¯æ¶ˆæ¯ç±»å‹æ˜¯å¦æœ‰æ•ˆ
    ChatHistoryMessageTypeEnum messageTypeEnum = ChatHistoryMessageTypeEnum.getEnumByValue(messageType);
    ThrowUtils.throwIf(messageTypeEnum == null, ErrorCode.PARAMS_ERROR, "ä¸æ”¯æŒçš„æ¶ˆæ¯ç±»å‹: " + messageType);
    ChatHistory chatHistory = ChatHistory.builder()
            .appId(appId)
            .message(message)
            .messageType(messageType)
            .userId(userId)
            .build();
    return this.save(chatHistory);
}
```

ç„¶ååœ¨ `AppServiceImpl` çš„ `chatToGenCode` æ–¹æ³•ä¸­é›†æˆå¯¹è¯å†å²ä¿å­˜é€»è¾‘ã€‚è¿™é‡Œåˆ©ç”¨äº† Flux å“åº”å¼ç¼–ç¨‹çš„ç‰¹æ€§ï¼Œå¯ä»¥åœ¨æµå¼å“åº”çš„è¿‡ç¨‹ä¸­æ”¶é›†å®Œæ•´çš„ AI å›å¤ï¼š

```java
@Resource
private ChatHistoryService chatHistoryService;

@Override
public Flux<String> chatToGenCode(Long appId, String message, User loginUser) {
    // ... å‰é¢çœç•¥
    // 4. è·å–åº”ç”¨çš„ä»£ç ç”Ÿæˆç±»å‹
    String codeGenTypeStr = app.getCodeGenType();
    CodeGenTypeEnum codeGenTypeEnum = CodeGenTypeEnum.getEnumByValue(codeGenTypeStr);
    if (codeGenTypeEnum == null) {
        throw new BusinessException(ErrorCode.SYSTEM_ERROR, "ä¸æ”¯æŒçš„ä»£ç ç”Ÿæˆç±»å‹");
    }
    // 5. é€šè¿‡æ ¡éªŒåï¼Œæ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°å¯¹è¯å†å²
    chatHistoryService.addChatMessage(appId, message, ChatHistoryMessageTypeEnum.USER.getValue(), loginUser.getId());
    // 6. è°ƒç”¨ AI ç”Ÿæˆä»£ç ï¼ˆæµå¼ï¼‰
    Flux<String> contentFlux = aiCodeGeneratorFacade.generateAndSaveCodeStream(message, codeGenTypeEnum, appId);
    // 7. æ”¶é›†AIå“åº”å†…å®¹å¹¶åœ¨å®Œæˆåè®°å½•åˆ°å¯¹è¯å†å²
    StringBuilder aiResponseBuilder = new StringBuilder();
    return contentFlux
            .map(chunk -> {
                // æ”¶é›†AIå“åº”å†…å®¹
                aiResponseBuilder.append(chunk);
                return chunk;
            })
            .doOnComplete(() -> {
                // æµå¼å“åº”å®Œæˆåï¼Œæ·»åŠ AIæ¶ˆæ¯åˆ°å¯¹è¯å†å²
                String aiResponse = aiResponseBuilder.toString();
                if (StrUtil.isNotBlank(aiResponse)) {
                    chatHistoryService.addChatMessage(appId, aiResponse, ChatHistoryMessageTypeEnum.AI.getValue(), loginUser.getId());
                }
            })
            .doOnError(error -> {
                // å¦‚æœAIå›å¤å¤±è´¥ï¼Œä¹Ÿè¦è®°å½•é”™è¯¯æ¶ˆæ¯
                String errorMessage = "AIå›å¤å¤±è´¥: " + error.getMessage();
                chatHistoryService.addChatMessage(appId, errorMessage, ChatHistoryMessageTypeEnum.AI.getValue(), loginUser.getId());
            });
}
```

#### 2ã€å…³è”åˆ é™¤

å½“åº”ç”¨è¢«åˆ é™¤æ—¶ï¼Œéœ€è¦åŒæ­¥æ¸…ç†å¯¹è¯å†å²æ•°æ®ã€‚

åœ¨ `ChatHistoryServiceImpl` ä¸­æä¾›æ ¹æ® appId åˆ é™¤çš„æ–¹æ³•ï¼š

```java
@Override
public boolean deleteByAppId(Long appId) {
    ThrowUtils.throwIf(appId == null || appId <= 0, ErrorCode.PARAMS_ERROR, "åº”ç”¨IDä¸èƒ½ä¸ºç©º");
    QueryWrapper queryWrapper = QueryWrapper.create()
            .eq("appId", appId);
    return this.remove(queryWrapper);
}
```

ç„¶ååœ¨ `AppServiceImpl` ä¸­é‡å†™ `removeById` æ–¹æ³•ï¼Œå®ç°å…³è”åˆ é™¤ï¼š

```java
/**
 * åˆ é™¤åº”ç”¨æ—¶å…³è”åˆ é™¤å¯¹è¯å†å²
 *
 * @param id åº”ç”¨ID
 * @return æ˜¯å¦æˆåŠŸ
 */
@Override
public boolean removeById(Serializable id) {
    if (id == null) {
        return false;
    }
    // è½¬æ¢ä¸º Long ç±»å‹
    Long appId = Long.valueOf(id.toString());
    if (appId <= 0) {
        return false;
    }
    // å…ˆåˆ é™¤å…³è”çš„å¯¹è¯å†å²
    try {
        chatHistoryService.deleteByAppId(appId);
    } catch (Exception e) {
        // è®°å½•æ—¥å¿—ä½†ä¸é˜»æ­¢åº”ç”¨åˆ é™¤
        log.error("åˆ é™¤åº”ç”¨å…³è”å¯¹è¯å†å²å¤±è´¥: {}", e.getMessage());
    }
    // åˆ é™¤åº”ç”¨
    return super.removeById(id);
}
```

è¿™é‡Œé‡‡ç”¨äº†å®¹é”™è®¾è®¡ï¼Œå³ä½¿å¯¹è¯â å†å²åˆ é™¤å¤±è´¥ï¼Œä¹Ÿä¸â ä¼šé˜»æ­¢åº”ç”¨çš„åˆ é™¤æ“ä½œï¼Œåªæ˜¯è®°å½•é”™è¯¯æ—¥å¿—ï¼Œç¡®ä¿æ ¸å¿ƒä¸šåŠ¡çš„ç¨³å®šæ€§ã€‚

#### 3ã€æ¸¸æ ‡æŸ¥è¯¢

æ¸¸æ ‡æŸ¥è¯¢æ˜¯æœ¬èŠ‚çš„æŠ€æœ¯é‡ç‚¹ï¼Œå¼€å‘æ—¶ä¸€å®šè¦ä»”ç»†ã€‚

1ï¼‰å…ˆåœ¨ `model.dto.chathistory` åŒ…ä¸‹æ–°å»ºåŒ…å«æ¸¸æ ‡å­—æ®µçš„è¯·æ±‚å¯¹è±¡ï¼š

```java
@EqualsAndHashCode(callSuper = true)
@Data
public class ChatHistoryQueryRequest extends PageRequest implements Serializable {

    /**
     * id
     */
    private Long id;

    /**
     * æ¶ˆæ¯å†…å®¹
     */
    private String message;

    /**
     * æ¶ˆæ¯ç±»å‹ï¼ˆuser/aiï¼‰
     */
    private String messageType;

    /**
     * åº”ç”¨id
     */
    private Long appId;

    /**
     * åˆ›å»ºç”¨æˆ·id
     */
    private Long userId;

    /**
     * æ¸¸æ ‡æŸ¥è¯¢ - æœ€åä¸€æ¡è®°å½•çš„åˆ›å»ºæ—¶é—´
     * ç”¨äºåˆ†é¡µæŸ¥è¯¢ï¼Œè·å–æ—©äºæ­¤æ—¶é—´çš„è®°å½•
     */
    private LocalDateTime lastCreateTime;

    private static final long serialVersionUID = 1L;
}
```

2ï¼‰åœ¨ `ChatHistoryServiceImpl` å¼€å‘æŸ¥è¯¢åŒ…è£…ç±»çš„æ„é€ æ–¹æ³•ï¼š

```java
/**
 * è·å–æŸ¥è¯¢åŒ…è£…ç±»
 *
 * @param chatHistoryQueryRequest
 * @return
 */
@Override
public QueryWrapper getQueryWrapper(ChatHistoryQueryRequest chatHistoryQueryRequest) {
    QueryWrapper queryWrapper = QueryWrapper.create();
    if (chatHistoryQueryRequest == null) {
        return queryWrapper;
    }
    Long id = chatHistoryQueryRequest.getId();
    String message = chatHistoryQueryRequest.getMessage();
    String messageType = chatHistoryQueryRequest.getMessageType();
    Long appId = chatHistoryQueryRequest.getAppId();
    Long userId = chatHistoryQueryRequest.getUserId();
    LocalDateTime lastCreateTime = chatHistoryQueryRequest.getLastCreateTime();
    String sortField = chatHistoryQueryRequest.getSortField();
    String sortOrder = chatHistoryQueryRequest.getSortOrder();
    // æ‹¼æ¥æŸ¥è¯¢æ¡ä»¶
    queryWrapper.eq("id", id)
            .like("message", message)
            .eq("messageType", messageType)
            .eq("appId", appId)
            .eq("userId", userId);
    // æ¸¸æ ‡æŸ¥è¯¢é€»è¾‘ - åªä½¿ç”¨ createTime ä½œä¸ºæ¸¸æ ‡
    if (lastCreateTime != null) {
        queryWrapper.lt("createTime", lastCreateTime);
    }
    // æ’åº
    if (StrUtil.isNotBlank(sortField)) {
        queryWrapper.orderBy(sortField, "ascend".equals(sortOrder));
    } else {
        // é»˜è®¤æŒ‰åˆ›å»ºæ—¶é—´é™åºæ’åˆ—
        queryWrapper.orderBy("createTime", false);
    }
    return queryWrapper;
}
```

3ï¼‰åœ¨ `ChatHistoryServiceImpl` ç¼–å†™æ ¸å¿ƒçš„æ¸¸æ ‡æŸ¥è¯¢æœåŠ¡æ–¹æ³•ï¼š

```java
@Override
public Page<ChatHistory> listAppChatHistoryByPage(Long appId, int pageSize,
                                                  LocalDateTime lastCreateTime,
                                                  User loginUser) {
    ThrowUtils.throwIf(appId == null || appId <= 0, ErrorCode.PARAMS_ERROR, "åº”ç”¨IDä¸èƒ½ä¸ºç©º");
    ThrowUtils.throwIf(pageSize <= 0 || pageSize > 50, ErrorCode.PARAMS_ERROR, "é¡µé¢å¤§å°å¿…é¡»åœ¨1-50ä¹‹é—´");
    ThrowUtils.throwIf(loginUser == null, ErrorCode.NOT_LOGIN_ERROR);
    // éªŒè¯æƒé™ï¼šåªæœ‰åº”ç”¨åˆ›å»ºè€…å’Œç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹
    App app = appService.getById(appId);
    ThrowUtils.throwIf(app == null, ErrorCode.NOT_FOUND_ERROR, "åº”ç”¨ä¸å­˜åœ¨");
    boolean isAdmin = UserConstant.ADMIN_ROLE.equals(loginUser.getUserRole());
    boolean isCreator = app.getUserId().equals(loginUser.getId());
    ThrowUtils.throwIf(!isAdmin && !isCreator, ErrorCode.NO_AUTH_ERROR, "æ— æƒæŸ¥çœ‹è¯¥åº”ç”¨çš„å¯¹è¯å†å²");
    // æ„å»ºæŸ¥è¯¢æ¡ä»¶
    ChatHistoryQueryRequest queryRequest = new ChatHistoryQueryRequest();
    queryRequest.setAppId(appId);
    queryRequest.setLastCreateTime(lastCreateTime);
    QueryWrapper queryWrapper = this.getQueryWrapper(queryRequest);
    // æŸ¥è¯¢æ•°æ®
    return this.page(Page.of(1, pageSize), queryWrapper);
}
```

4ï¼‰æœ€ååœ¨ `ChatHistoryController` å¼€å‘æ¸¸æ ‡æŸ¥è¯¢æ¥å£ï¼š

```java
/**
 * åˆ†é¡µæŸ¥è¯¢æŸä¸ªåº”ç”¨çš„å¯¹è¯å†å²ï¼ˆæ¸¸æ ‡æŸ¥è¯¢ï¼‰
 *
 * @param appId          åº”ç”¨ID
 * @param pageSize       é¡µé¢å¤§å°
 * @param lastCreateTime æœ€åä¸€æ¡è®°å½•çš„åˆ›å»ºæ—¶é—´
 * @param request        è¯·æ±‚
 * @return å¯¹è¯å†å²åˆ†é¡µ
 */
@GetMapping("/app/{appId}")
public BaseResponse<Page<ChatHistory>> listAppChatHistory(@PathVariable Long appId,
                                                          @RequestParam(defaultValue = "10") int pageSize,
                                                          @RequestParam(required = false) LocalDateTime lastCreateTime,
                                                          HttpServletRequest request) {
    User loginUser = userService.getLoginUser(request);
    Page<ChatHistory> result = chatHistoryService.listAppChatHistoryByPage(appId, pageSize, lastCreateTime, loginUser);
    return ResultUtils.success(result);
}
```

#### 4ã€ç®¡ç†å‘˜æŸ¥è¯¢åŠŸèƒ½

ç®¡ç†å‘˜å¯ä»¥åˆ†é¡µæŸ¥è¯¢æ‰€æœ‰åº”ç”¨çš„â å¯¹è¯å†å²æ¶ˆæ¯åˆ—è¡¨ï¼Œâ æŒ‰ç…§æ—¶é—´é™åºæ’åºã€‚

è¿™ä¸ªåŠŸèƒ½æ¯”è¾ƒç®€å•ï¼Œç›´æ¥å¼€å‘åˆ†é¡µæŸ¥è¯¢æ¥å£å°±å¥½ï¼š

```java
/**
 * ç®¡ç†å‘˜åˆ†é¡µæŸ¥è¯¢æ‰€æœ‰å¯¹è¯å†å²
 *
 * @param chatHistoryQueryRequest æŸ¥è¯¢è¯·æ±‚
 * @return å¯¹è¯å†å²åˆ†é¡µ
 */
@PostMapping("/admin/list/page/vo")
@AuthCheck(mustRole = UserConstant.ADMIN_ROLE)
public BaseResponse<Page<ChatHistory>> listAllChatHistoryByPageForAdmin(@RequestBody ChatHistoryQueryRequest chatHistoryQueryRequest) {
    ThrowUtils.throwIf(chatHistoryQueryRequest == null, ErrorCode.PARAMS_ERROR);
    long pageNum = chatHistoryQueryRequest.getPageNum();
    long pageSize = chatHistoryQueryRequest.getPageSize();
    // æŸ¥è¯¢æ•°æ®
    QueryWrapper queryWrapper = chatHistoryService.getQueryWrapper(chatHistoryQueryRequest);
    Page<ChatHistory> result = chatHistoryService.page(Page.of(pageNum, pageSize), queryWrapper);
    return ResultUtils.success(result);
}
```

___

æ¥ä¸‹æ¥å°±å¯ä»¥æµ‹è¯•äº†ï¼Œå¦‚æœåœ¨å¼€å‘è¿‡ç¨‹ä¸­é‡åˆ°å¾ªç¯ä¾èµ–é—®é¢˜å¯¼è‡´é¡¹ç›®æ— æ³•å¯åŠ¨ï¼Œå¯ä»¥ä½¿ç”¨ `@Lazy` æ³¨è§£è§£å†³ã€‚æ¯”å¦‚åœ¨ `ChatHistoryServiceImpl` å¼•å…¥ AppService æ—¶æ·»åŠ æ³¨è§£ï¼š

```java
@Resource
@Lazy
private AppService appService;
```

## å››ã€å¯¹è¯å†å²å‰ç«¯å¼€å‘

åç«¯å¼€å‘å®Œæˆåï¼Œè®°å¾—å…ˆæ‰§è¡Œ `openapi` å‘½ä»¤ï¼Œæ ¹æ®æ¥å£ç”Ÿæˆå‰ç«¯è¯·æ±‚å’Œæ•°æ®æ¨¡å‹ä»£ç ã€‚

### åŠŸèƒ½å®ç° - Vibe Coding

è¿™æ¬¡çš„å‰ç«¯å¼€å‘é‡å¹¶ä¸å¤§ï¼Œæ ¸å¿ƒå°± 2 ç‚¹ï¼š

1.  ä¿®æ”¹åº”ç”¨å¯¹è¯é¡µé¢ï¼ŒåŠ è½½å¯¹è¯å†å²
2.  æ–°å¢å¯¹è¯ç®¡ç†é¡µé¢

å¯ä»¥ç›´æ¥äº¤ç»™ AI æ¥ç”Ÿæˆï¼š

```markdown
ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„å‰ç«¯å¼€å‘ï¼Œå¸®æˆ‘æ ¹æ®ä¸‹åˆ—ä¿¡æ¯ï¼Œå‚è€ƒé¡¹ç›®å·²æœ‰çš„ä»£ç é£æ ¼ï¼Œç”Ÿæˆç¬¦åˆè¦æ±‚çš„å®Œæ•´ä»£ç ã€‚

## éœ€æ±‚

1ï¼‰ä¿®æ”¹åº”ç”¨å¯¹è¯é¡µé¢ã€‚
- è¿›å…¥åº”ç”¨å¯¹è¯é¡µé¢æ—¶ï¼Œå‰ç«¯è°ƒç”¨æ¸¸æ ‡æŸ¥è¯¢å¯¹è¯å†å²æ¥å£ï¼Œæ ¹æ®åº”ç”¨ id åŠ è½½ä¸€æ¬¡æœ€è¿‘ 10 æ¡å¯¹è¯å†å²æ¶ˆæ¯ï¼ŒæŒ‰ç…§æ¶ˆæ¯åˆ›å»ºæ—¶é—´çš„å‡åºå±•ç¤ºåœ¨å¯¹è¯åŒºåŸŸï¼ˆåŒºåˆ† AI å’Œç”¨æˆ·æ¶ˆæ¯ï¼‰ã€‚
- å¦‚æœæ¶ˆæ¯æ•°é‡è¶…è¿‡ 10 æ¡ï¼ˆ10 æ¡ä¸ºä¸€é¡µï¼‰ï¼Œå¯ä»¥ç‚¹æ¶ˆæ¯ä¸Šæ–¹çš„åŠ è½½æ›´å¤šï¼Œåˆ©ç”¨æ¸¸æ ‡åŠ è½½ä¸‹ä¸€é¡µå†å²æ¶ˆæ¯ã€‚(æˆ‘æƒ³å‰ç«¯éœ€è¦ç»´æŠ¤å·²åŠ è½½çš„æ¶ˆæ¯åˆ—è¡¨)
- ä¿®æ”¹è‡ªåŠ¨å‘é€åˆå§‹æ¶ˆæ¯çš„é€»è¾‘ã€‚ç§»é™¤ä¹‹å‰é¡µé¢ url çš„ view å‚æ•°ï¼Œå¦‚æœæ˜¯è‡ªå·±çš„ appï¼Œå¹¶ä¸”æ²¡æœ‰å¯¹è¯å†å²ï¼Œæ‰è‡ªåŠ¨å°† initPrompt ä½œä¸ºç¬¬ä¸€æ¡æ¶ˆæ¯è§¦å‘å¯¹è¯ã€‚
- ä¿®æ”¹ç½‘ç«™å±•ç¤ºçš„é€»è¾‘ã€‚è¿›å…¥é¡µé¢æ—¶ï¼Œå¦‚æœ app æœ‰è‡³å°‘ 2 æ¡å¯¹è¯è®°å½•ï¼Œä¹Ÿå±•ç¤ºå¯¹åº”çš„ç½‘ç«™ã€‚

2ï¼‰æ–°å¢å¯¹è¯ç®¡ç†é¡µé¢ã€‚å®Œå…¨å‚è€ƒåº”ç”¨ç®¡ç†é¡µé¢å®ç°

## åç«¯æ¥å£

å·²ç»åœ¨ @api ç›®å½•ä¸‹ç”Ÿæˆäº†åç«¯è¯·æ±‚ä»£ç å’Œæ•°æ®ç±»å‹ä¿¡æ¯ã€‚
```

AI ç”Ÿæˆçš„ä»£ç å¦‚ä¸‹ï¼š

1ï¼‰è·¯ç”±æ–‡ä»¶æ–°å¢å¯¹è¯ç®¡ç†é¡µï¼š

```typescript
{
  path: '/admin/chatManage',
  name: 'å¯¹è¯ç®¡ç†',
  component: ChatManagePage,
},
```

2ï¼‰ä¿®æ”¹åº”ç”¨å¯¹è¯ç”Ÿæˆé¡µé¢ï¼Œå®Œæ•´ä»£ç å¦‚ä¸‹ï¼š

```vue
<template>
  <div id="appChatPage">
    <!-- é¡¶éƒ¨æ  -->
    <div class="header-bar">
      <div class="header-left">
        <h1 class="app-name">{{ appInfo?.appName || 'ç½‘ç«™ç”Ÿæˆå™¨' }}</h1>
      </div>
      <div class="header-right">
        <a-button type="default" @click="showAppDetail">
          <template #icon>
            <InfoCircleOutlined />
          </template>
          åº”ç”¨è¯¦æƒ…
        </a-button>
        <a-button type="primary" @click="deployApp" :loading="deploying">
          <template #icon>
            <CloudUploadOutlined />
          </template>
          éƒ¨ç½²æŒ‰é’®
        </a-button>
      </div>
    </div>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <div class="main-content">
      <!-- å·¦ä¾§å¯¹è¯åŒºåŸŸ -->
      <div class="chat-section">
        <!-- æ¶ˆæ¯åŒºåŸŸ -->
        <div class="messages-container" ref="messagesContainer">
          <!-- åŠ è½½æ›´å¤šæŒ‰é’® -->
          <div v-if="hasMoreHistory" class="load-more-container">
            <a-button type="link" @click="loadMoreHistory" :loading="loadingHistory" size="small">
              åŠ è½½æ›´å¤šå†å²æ¶ˆæ¯
            </a-button>
          </div>
          <div v-for="(message, index) in messages" :key="index" class="message-item">
            <div v-if="message.type === 'user'" class="user-message">
              <div class="message-content">{{ message.content }}</div>
              <div class="message-avatar">
                <a-avatar :src="loginUserStore.loginUser.userAvatar" />
              </div>
            </div>
            <div v-else class="ai-message">
              <div class="message-avatar">
                <a-avatar :src="aiAvatar" />
              </div>
              <div class="message-content">
                <MarkdownRenderer v-if="message.content" :content="message.content" />
                <div v-if="message.loading" class="loading-indicator">
                  <a-spin size="small" />
                  <span>AI æ­£åœ¨æ€è€ƒ...</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ç”¨æˆ·æ¶ˆæ¯è¾“å…¥æ¡† -->
        <div class="input-container">
          <div class="input-wrapper">
            <a-tooltip v-if="!isOwner" title="æ— æ³•åœ¨åˆ«äººçš„ä½œå“ä¸‹å¯¹è¯å“¦~" placement="top">
              <a-textarea
                v-model:value="userInput"
                placeholder="è¯·æè¿°ä½ æƒ³ç”Ÿæˆçš„ç½‘ç«™ï¼Œè¶Šè¯¦ç»†æ•ˆæœè¶Šå¥½å“¦"
                :rows="4"
                :maxlength="1000"
                @keydown.enter.prevent="sendMessage"
                :disabled="isGenerating || !isOwner"
              />
            </a-tooltip>
            <a-textarea
              v-else
              v-model:value="userInput"
              placeholder="è¯·æè¿°ä½ æƒ³ç”Ÿæˆçš„ç½‘ç«™ï¼Œè¶Šè¯¦ç»†æ•ˆæœè¶Šå¥½å“¦"
              :rows="4"
              :maxlength="1000"
              @keydown.enter.prevent="sendMessage"
              :disabled="isGenerating"
            />
            <div class="input-actions">
              <a-button
                type="primary"
                @click="sendMessage"
                :loading="isGenerating"
                :disabled="!isOwner"
              >
                <template #icon>
                  <SendOutlined />
                </template>
              </a-button>
            </div>
          </div>
        </div>
      </div>
      <!-- å³ä¾§ç½‘é¡µå±•ç¤ºåŒºåŸŸ -->
      <div class="preview-section">
        <div class="preview-header">
          <h3>ç”Ÿæˆåçš„ç½‘é¡µå±•ç¤º</h3>
          <div class="preview-actions">
            <a-button v-if="previewUrl" type="link" @click="openInNewTab">
              <template #icon>
                <ExportOutlined />
              </template>
              æ–°çª—å£æ‰“å¼€
            </a-button>
          </div>
        </div>
        <div class="preview-content">
          <div v-if="!previewUrl && !isGenerating" class="preview-placeholder">
            <div class="placeholder-icon">ğŸŒ</div>
            <p>ç½‘ç«™æ–‡ä»¶ç”Ÿæˆå®Œæˆåå°†åœ¨è¿™é‡Œå±•ç¤º</p>
          </div>
          <div v-else-if="isGenerating" class="preview-loading">
            <a-spin size="large" />
            <p>æ­£åœ¨ç”Ÿæˆç½‘ç«™...</p>
          </div>
          <iframe
            v-else
            :src="previewUrl"
            class="preview-iframe"
            frameborder="0"
            @load="onIframeLoad"
          ></iframe>
        </div>
      </div>
    </div>

    <!-- åº”ç”¨è¯¦æƒ…å¼¹çª— -->
    <AppDetailModal
      v-model:open="appDetailVisible"
      :app="appInfo"
      :show-actions="isOwner || isAdmin"
      @edit="editApp"
      @delete="deleteApp"
    />

    <!-- éƒ¨ç½²æˆåŠŸå¼¹çª— -->
    <DeploySuccessModal
      v-model:open="deployModalVisible"
      :deploy-url="deployUrl"
      @open-site="openDeployedSite"
    />
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted, nextTick, onUnmounted, computed } from 'vue'
import { useRoute, useRouter } from 'vue-router'
import { message } from 'ant-design-vue'
import { useLoginUserStore } from '@/stores/loginUser'
import {
  getAppVoById,
  deployApp as deployAppApi,
  deleteApp as deleteAppApi,
} from '@/api/appController'
import { listAppChatHistory } from '@/api/chatHistoryController'
import { CodeGenTypeEnum } from '@/utils/codeGenTypes'
import request from '@/request'

import MarkdownRenderer from '@/components/MarkdownRenderer.vue'
import AppDetailModal from '@/components/AppDetailModal.vue'
import DeploySuccessModal from '@/components/DeploySuccessModal.vue'
import aiAvatar from '@/assets/aiAvatar.png'
import { API_BASE_URL, getStaticPreviewUrl } from '@/config/env'

import {
  CloudUploadOutlined,
  SendOutlined,
  ExportOutlined,
  InfoCircleOutlined,
} from '@ant-design/icons-vue'

const route = useRoute()
const router = useRouter()
const loginUserStore = useLoginUserStore()

// åº”ç”¨ä¿¡æ¯
const appInfo = ref<API.AppVO>()
const appId = ref<any>()

// å¯¹è¯ç›¸å…³
interface Message {
  type: 'user' | 'ai'
  content: string
  loading?: boolean
  createTime?: string
}

const messages = ref<Message[]>([])
const userInput = ref('')
const isGenerating = ref(false)
const messagesContainer = ref<HTMLElement>()

// å¯¹è¯å†å²ç›¸å…³
const loadingHistory = ref(false)
const hasMoreHistory = ref(false)
const lastCreateTime = ref<string>()
const historyLoaded = ref(false)

// é¢„è§ˆç›¸å…³
const previewUrl = ref('')
const previewReady = ref(false)

// éƒ¨ç½²ç›¸å…³
const deploying = ref(false)
const deployModalVisible = ref(false)
const deployUrl = ref('')

// æƒé™ç›¸å…³
const isOwner = computed(() => {
  return appInfo.value?.userId === loginUserStore.loginUser.id
})

const isAdmin = computed(() => {
  return loginUserStore.loginUser.userRole === 'admin'
})

// åº”ç”¨è¯¦æƒ…ç›¸å…³
const appDetailVisible = ref(false)

// æ˜¾ç¤ºåº”ç”¨è¯¦æƒ…
const showAppDetail = () => {
  appDetailVisible.value = true
}

// åŠ è½½å¯¹è¯å†å²
const loadChatHistory = async (isLoadMore = false) => {
  if (!appId.value || loadingHistory.value) return
  loadingHistory.value = true
  try {
    const params: API.listAppChatHistoryParams = {
      appId: appId.value,
      pageSize: 10,
    }
    // å¦‚æœæ˜¯åŠ è½½æ›´å¤šï¼Œä¼ é€’æœ€åä¸€æ¡æ¶ˆæ¯çš„åˆ›å»ºæ—¶é—´ä½œä¸ºæ¸¸æ ‡
    if (isLoadMore && lastCreateTime.value) {
      params.lastCreateTime = lastCreateTime.value
    }
    const res = await listAppChatHistory(params)
    if (res.data.code === 0 && res.data.data) {
      const chatHistories = res.data.data.records || []
      if (chatHistories.length > 0) {
        // å°†å¯¹è¯å†å²è½¬æ¢ä¸ºæ¶ˆæ¯æ ¼å¼ï¼Œå¹¶æŒ‰æ—¶é—´æ­£åºæ’åˆ—ï¼ˆè€æ¶ˆæ¯åœ¨å‰ï¼‰
        const historyMessages: Message[] = chatHistories
          .map((chat) => ({
            type: (chat.messageType === 'user' ? 'user' : 'ai') as 'user' | 'ai',
            content: chat.message || '',
            createTime: chat.createTime,
          }))
          .reverse() // åè½¬æ•°ç»„ï¼Œè®©è€æ¶ˆæ¯åœ¨å‰
        if (isLoadMore) {
          // åŠ è½½æ›´å¤šæ—¶ï¼Œå°†å†å²æ¶ˆæ¯æ·»åŠ åˆ°å¼€å¤´
          messages.value.unshift(...historyMessages)
        } else {
          // åˆå§‹åŠ è½½ï¼Œç›´æ¥è®¾ç½®æ¶ˆæ¯åˆ—è¡¨
          messages.value = historyMessages
        }
        // æ›´æ–°æ¸¸æ ‡
        lastCreateTime.value = chatHistories[chatHistories.length - 1]?.createTime
        // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æ›´å¤šå†å²
        hasMoreHistory.value = chatHistories.length === 10
      } else {
        hasMoreHistory.value = false
      }
      historyLoaded.value = true
    }
  } catch (error) {
    console.error('åŠ è½½å¯¹è¯å†å²å¤±è´¥ï¼š', error)
    message.error('åŠ è½½å¯¹è¯å†å²å¤±è´¥')
  } finally {
    loadingHistory.value = false
  }
}

// åŠ è½½æ›´å¤šå†å²æ¶ˆæ¯
const loadMoreHistory = async () => {
  await loadChatHistory(true)
}

// è·å–åº”ç”¨ä¿¡æ¯
const fetchAppInfo = async () => {
  const id = route.params.id as string
  if (!id) {
    message.error('åº”ç”¨IDä¸å­˜åœ¨')
    router.push('/')
    return
  }

  appId.value = id

  try {
    const res = await getAppVoById({ id: id as unknown as number })
    if (res.data.code === 0 && res.data.data) {
      appInfo.value = res.data.data
      
      // å…ˆåŠ è½½å¯¹è¯å†å²
      await loadChatHistory()
      // å¦‚æœæœ‰è‡³å°‘2æ¡å¯¹è¯è®°å½•ï¼Œå±•ç¤ºå¯¹åº”çš„ç½‘ç«™
      if (messages.value.length >= 2) {
        updatePreview()
      }
      // æ£€æŸ¥æ˜¯å¦éœ€è¦è‡ªåŠ¨å‘é€åˆå§‹æç¤ºè¯
      // åªæœ‰åœ¨æ˜¯è‡ªå·±çš„åº”ç”¨ä¸”æ²¡æœ‰å¯¹è¯å†å²æ—¶æ‰è‡ªåŠ¨å‘é€
      if (
        appInfo.value.initPrompt &&
        isOwner.value &&
        messages.value.length === 0 &&
        historyLoaded.value
      ) {
        await sendInitialMessage(appInfo.value.initPrompt)
      }
    } else {
      message.error('è·å–åº”ç”¨ä¿¡æ¯å¤±è´¥')
      router.push('/')
    }
  } catch (error) {
    console.error('è·å–åº”ç”¨ä¿¡æ¯å¤±è´¥ï¼š', error)
    message.error('è·å–åº”ç”¨ä¿¡æ¯å¤±è´¥')
    router.push('/')
  }
}

// å‘é€åˆå§‹æ¶ˆæ¯
const sendInitialMessage = async (prompt: string) => {
  // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
  messages.value.push({
    type: 'user',
    content: prompt,
  })

  // æ·»åŠ AIæ¶ˆæ¯å ä½ç¬¦
  const aiMessageIndex = messages.value.length
  messages.value.push({
    type: 'ai',
    content: '',
    loading: true,
  })

  await nextTick()
  scrollToBottom()

  // å¼€å§‹ç”Ÿæˆ
  isGenerating.value = true
  await generateCode(prompt, aiMessageIndex)
}

// å‘é€æ¶ˆæ¯
const sendMessage = async () => {
  if (!userInput.value.trim() || isGenerating.value) {
    return
  }

  const message = userInput.value.trim()
  userInput.value = ''

  // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
  messages.value.push({
    type: 'user',
    content: message,
  })

  // æ·»åŠ AIæ¶ˆæ¯å ä½ç¬¦
  const aiMessageIndex = messages.value.length
  messages.value.push({
    type: 'ai',
    content: '',
    loading: true,
  })

  await nextTick()
  scrollToBottom()

  // å¼€å§‹ç”Ÿæˆ
  isGenerating.value = true
  await generateCode(message, aiMessageIndex)
}

// ç”Ÿæˆä»£ç  - ä½¿ç”¨ EventSource å¤„ç†æµå¼å“åº”
const generateCode = async (userMessage: string, aiMessageIndex: number) => {
  let eventSource: EventSource | null = null
  let streamCompleted = false

  try {
    // è·å– axios é…ç½®çš„ baseURL
    const baseURL = request.defaults.baseURL || API_BASE_URL

    // æ„å»ºURLå‚æ•°
    const params = new URLSearchParams({
      appId: appId.value || '',
      message: userMessage,
    })

    const url = `${baseURL}/app/chat/gen/code?${params}`

    // åˆ›å»º EventSource è¿æ¥
    eventSource = new EventSource(url, {
      withCredentials: true,
    })

    let fullContent = ''

    // å¤„ç†æ¥æ”¶åˆ°çš„æ¶ˆæ¯
    eventSource.onmessage = function (event) {
      if (streamCompleted) return

      try {
        // è§£æJSONåŒ…è£…çš„æ•°æ®
        const parsed = JSON.parse(event.data)
        const content = parsed.d

        // æ‹¼æ¥å†…å®¹
        if (content !== undefined && content !== null) {
          fullContent += content
          messages.value[aiMessageIndex].content = fullContent
          messages.value[aiMessageIndex].loading = false
          scrollToBottom()
        }
      } catch (error) {
        console.error('è§£ææ¶ˆæ¯å¤±è´¥:', error)
        handleError(error, aiMessageIndex)
      }
    }

    // å¤„ç†doneäº‹ä»¶
    eventSource.addEventListener('done', function () {
      if (streamCompleted) return

      streamCompleted = true
      isGenerating.value = false
      eventSource?.close()

      // å»¶è¿Ÿæ›´æ–°é¢„è§ˆï¼Œç¡®ä¿åç«¯å·²å®Œæˆå¤„ç†
      setTimeout(async () => {
        await fetchAppInfo()
        updatePreview()
      }, 1000)
    })

    // å¤„ç†é”™è¯¯
    eventSource.onerror = function () {
      if (streamCompleted || !isGenerating.value) return
      // æ£€æŸ¥æ˜¯å¦æ˜¯æ­£å¸¸çš„è¿æ¥å…³é—­
      if (eventSource?.readyState === EventSource.CONNECTING) {
        streamCompleted = true
        isGenerating.value = false
        eventSource?.close()

        setTimeout(async () => {
          await fetchAppInfo()
          updatePreview()
        }, 1000)
      } else {
        handleError(new Error('SSEè¿æ¥é”™è¯¯'), aiMessageIndex)
      }
    }
  } catch (error) {
    console.error('åˆ›å»º EventSource å¤±è´¥ï¼š', error)
    handleError(error, aiMessageIndex)
  }
}

// é”™è¯¯å¤„ç†å‡½æ•°
const handleError = (error: unknown, aiMessageIndex: number) => {
  console.error('ç”Ÿæˆä»£ç å¤±è´¥ï¼š', error)
  messages.value[aiMessageIndex].content = 'æŠ±æ­‰ï¼Œç”Ÿæˆè¿‡ç¨‹ä¸­å‡ºç°äº†é”™è¯¯ï¼Œè¯·é‡è¯•ã€‚'
  messages.value[aiMessageIndex].loading = false
  message.error('ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•')
  isGenerating.value = false
}

// æ›´æ–°é¢„è§ˆ
const updatePreview = () => {
  if (appId.value) {
    const codeGenType = appInfo.value?.codeGenType || CodeGenTypeEnum.HTML
    const newPreviewUrl = getStaticPreviewUrl(codeGenType, appId.value)
    previewUrl.value = newPreviewUrl
    previewReady.value = true
  }
}

// æ»šåŠ¨åˆ°åº•éƒ¨
const scrollToBottom = () => {
  if (messagesContainer.value) {
    messagesContainer.value.scrollTop = messagesContainer.value.scrollHeight
  }
}

// éƒ¨ç½²åº”ç”¨
const deployApp = async () => {
  if (!appId.value) {
    message.error('åº”ç”¨IDä¸å­˜åœ¨')
    return
  }

  deploying.value = true
  try {
    const res = await deployAppApi({
      appId: appId.value as unknown as number,
    })

    if (res.data.code === 0 && res.data.data) {
      deployUrl.value = res.data.data
      deployModalVisible.value = true
      message.success('éƒ¨ç½²æˆåŠŸ')
    } else {
      message.error('éƒ¨ç½²å¤±è´¥ï¼š' + res.data.message)
    }
  } catch (error) {
    console.error('éƒ¨ç½²å¤±è´¥ï¼š', error)
    message.error('éƒ¨ç½²å¤±è´¥ï¼Œè¯·é‡è¯•')
  } finally {
    deploying.value = false
  }
}

// åœ¨æ–°çª—å£æ‰“å¼€é¢„è§ˆ
const openInNewTab = () => {
  if (previewUrl.value) {
    window.open(previewUrl.value, '_blank')
  }
}

// æ‰“å¼€éƒ¨ç½²çš„ç½‘ç«™
const openDeployedSite = () => {
  if (deployUrl.value) {
    window.open(deployUrl.value, '_blank')
  }
}

// iframeåŠ è½½å®Œæˆ
const onIframeLoad = () => {
  previewReady.value = true
}

// ç¼–è¾‘åº”ç”¨
const editApp = () => {
  if (appInfo.value?.id) {
    router.push(`/app/edit/${appInfo.value.id}`)
  }
}

// åˆ é™¤åº”ç”¨
const deleteApp = async () => {
  if (!appInfo.value?.id) return

  try {
    const res = await deleteAppApi({ id: appInfo.value.id })
    if (res.data.code === 0) {
      message.success('åˆ é™¤æˆåŠŸ')
      appDetailVisible.value = false
      router.push('/')
    } else {
      message.error('åˆ é™¤å¤±è´¥ï¼š' + res.data.message)
    }
  } catch (error) {
    console.error('åˆ é™¤å¤±è´¥ï¼š', error)
    message.error('åˆ é™¤å¤±è´¥')
  }
}

// é¡µé¢åŠ è½½æ—¶è·å–åº”ç”¨ä¿¡æ¯
onMounted(() => {
  fetchAppInfo()
})

// æ¸…ç†èµ„æº
onUnmounted(() => {
  // EventSource ä¼šåœ¨ç»„ä»¶å¸è½½æ—¶è‡ªåŠ¨æ¸…ç†
})
</script>

<style scoped>
#appChatPage {
  height: 100vh;
  display: flex;
  flex-direction: column;
  padding: 16px;
  background: #fdfdfd;
}

/* é¡¶éƒ¨æ  */
.header-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 16px;
}

.header-left {
  display: flex;
  align-items: center;
  gap: 12px;
}

.app-name {
  margin: 0;
  font-size: 18px;
  font-weight: 600;
  color: #1a1a1a;
}

.header-right {
  display: flex;
  gap: 12px;
}

/* ä¸»è¦å†…å®¹åŒºåŸŸ */
.main-content {
  flex: 1;
  display: flex;
  gap: 16px;
  padding: 8px;
  overflow: hidden;
}

/* å·¦ä¾§å¯¹è¯åŒºåŸŸ */
.chat-section {
  flex: 2;
  display: flex;
  flex-direction: column;
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  overflow: hidden;
}

.messages-container {
  flex: 1;
  padding: 16px;
  overflow-y: auto;
  scroll-behavior: smooth;
}

.message-item {
  margin-bottom: 12px;
}

.user-message {
  display: flex;
  justify-content: flex-end;
  align-items: flex-start;
  gap: 8px;
}

.ai-message {
  display: flex;
  justify-content: flex-start;
  align-items: flex-start;
  gap: 8px;
}

.message-content {
  max-width: 70%;
  padding: 12px 16px;
  border-radius: 12px;
  line-height: 1.5;
  word-wrap: break-word;
}

.user-message .message-content {
  background: #1890ff;
  color: white;
}

.ai-message .message-content {
  background: #f5f5f5;
  color: #1a1a1a;
  padding: 8px 12px;
}

.message-avatar {
  flex-shrink: 0;
}

.loading-indicator {
  display: flex;
  align-items: center;
  gap: 8px;
  color: #666;
}

/* åŠ è½½æ›´å¤šæŒ‰é’® */
.load-more-container {
  text-align: center;
  padding: 8px 0;
  margin-bottom: 16px;
}

/* è¾“å…¥åŒºåŸŸ */
.input-container {
  padding: 16px;
  background: white;
}

.input-wrapper {
  position: relative;
}

.input-wrapper .ant-input {
  padding-right: 50px;
}

.input-actions {
  position: absolute;
  bottom: 8px;
  right: 8px;
}

/* å³ä¾§é¢„è§ˆåŒºåŸŸ */
.preview-section {
  flex: 3;
  display: flex;
  flex-direction: column;
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  overflow: hidden;
}

.preview-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px;
  border-bottom: 1px solid #e8e8e8;
}

.preview-header h3 {
  margin: 0;
  font-size: 16px;
  font-weight: 600;
}

.preview-actions {
  display: flex;
  gap: 8px;
}

.preview-content {
  flex: 1;
  position: relative;
  overflow: hidden;
}

.preview-placeholder {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  color: #666;
}

.placeholder-icon {
  font-size: 48px;
  margin-bottom: 16px;
}

.preview-loading {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  color: #666;
}

.preview-loading p {
  margin-top: 16px;
}

.preview-iframe {
  width: 100%;
  height: 100%;
  border: none;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 1024px) {
  .main-content {
    flex-direction: column;
  }

  .chat-section,
  .preview-section {
    flex: none;
    height: 50vh;
  }
}

@media (max-width: 768px) {
  .header-bar {
    padding: 12px 16px;
  }

  .app-name {
    font-size: 16px;
  }

  .main-content {
    padding: 8px;
    gap: 8px;
  }

  .message-content {
    max-width: 85%;
  }
}
</style>
```

3ï¼‰æ–°å¢å¯¹è¯ç®¡ç†é¡µé¢ï¼Œå®Œæ•´ä»£ç å¦‚ä¸‹ï¼š

```vue
<template>
  <div id="chatManagePage">
    <!-- æœç´¢è¡¨å• -->
    <a-form layout="inline" :model="searchParams" @finish="doSearch">
      <a-form-item label="æ¶ˆæ¯å†…å®¹">
        <a-input v-model:value="searchParams.message" placeholder="è¾“å…¥æ¶ˆæ¯å†…å®¹" />
      </a-form-item>
      <a-form-item label="æ¶ˆæ¯ç±»å‹">
        <a-select
          v-model:value="searchParams.messageType"
          placeholder="é€‰æ‹©æ¶ˆæ¯ç±»å‹"
          style="width: 120px"
        >
          <a-select-option value="">å…¨éƒ¨</a-select-option>
          <a-select-option value="user">ç”¨æˆ·æ¶ˆæ¯</a-select-option>
          <a-select-option value="assistant">AIæ¶ˆæ¯</a-select-option>
        </a-select>
      </a-form-item>
      <a-form-item label="åº”ç”¨ID">
        <a-input v-model:value="searchParams.appId" placeholder="è¾“å…¥åº”ç”¨ID" />
      </a-form-item>
      <a-form-item label="ç”¨æˆ·ID">
        <a-input v-model:value="searchParams.userId" placeholder="è¾“å…¥ç”¨æˆ·ID" />
      </a-form-item>
      <a-form-item>
        <a-button type="primary" html-type="submit">æœç´¢</a-button>
      </a-form-item>
    </a-form>
    <a-divider />

    <!-- è¡¨æ ¼ -->
    <a-table
      :columns="columns"
      :data-source="data"
      :pagination="pagination"
      @change="doTableChange"
      :scroll="{ x: 1400 }"
    >
      <template #bodyCell="{ column, record }">
        <template v-if="column.dataIndex === 'message'">
          <a-tooltip :title="record.message">
            <div class="message-text">{{ record.message }}</div>
          </a-tooltip>
        </template>
        <template v-else-if="column.dataIndex === 'messageType'">
          <a-tag :color="record.messageType === 'user' ? 'blue' : 'green'">
            {{ record.messageType === 'user' ? 'ç”¨æˆ·æ¶ˆæ¯' : 'AIæ¶ˆæ¯' }}
          </a-tag>
        </template>
        <template v-else-if="column.dataIndex === 'createTime'">
          {{ formatTime(record.createTime) }}
        </template>
        <template v-else-if="column.key === 'action'">
          <a-space>
            <a-button type="primary" size="small" @click="viewAppChat(record.appId)">
              æŸ¥çœ‹å¯¹è¯
            </a-button>
            <a-popconfirm title="ç¡®å®šè¦åˆ é™¤è¿™æ¡æ¶ˆæ¯å—ï¼Ÿ" @confirm="deleteMessage(record.id)">
              <a-button danger size="small">åˆ é™¤</a-button>
            </a-popconfirm>
          </a-space>
        </template>
      </template>
    </a-table>
  </div>
</template>

<script lang="ts" setup>
import { computed, onMounted, reactive, ref } from 'vue'
import { useRouter } from 'vue-router'
import { message } from 'ant-design-vue'
import { listAllChatHistoryByPageForAdmin } from '@/api/chatHistoryController'
import { formatTime } from '@/utils/time'

const router = useRouter()

const columns = [
  {
    title: 'ID',
    dataIndex: 'id',
    width: 80,
    fixed: 'left',
  },
  {
    title: 'æ¶ˆæ¯å†…å®¹',
    dataIndex: 'message',
    width: 300,
  },
  {
    title: 'æ¶ˆæ¯ç±»å‹',
    dataIndex: 'messageType',
    width: 100,
  },
  {
    title: 'åº”ç”¨ID',
    dataIndex: 'appId',
    width: 80,
  },
  {
    title: 'ç”¨æˆ·ID',
    dataIndex: 'userId',
    width: 80,
  },
  {
    title: 'åˆ›å»ºæ—¶é—´',
    dataIndex: 'createTime',
    width: 160,
  },
  {
    title: 'æ“ä½œ',
    key: 'action',
    width: 180,
    fixed: 'right',
  },
]

// æ•°æ®
const data = ref<API.ChatHistory[]>([])
const total = ref(0)

// æœç´¢æ¡ä»¶
const searchParams = reactive<API.ChatHistoryQueryRequest>({
  pageNum: 1,
  pageSize: 10,
})

// è·å–æ•°æ®
const fetchData = async () => {
  try {
    const res = await listAllChatHistoryByPageForAdmin({
      ...searchParams,
    })
    if (res.data.data) {
      data.value = res.data.data.records ?? []
      total.value = res.data.data.totalRow ?? 0
    } else {
      message.error('è·å–æ•°æ®å¤±è´¥ï¼Œ' + res.data.message)
    }
  } catch (error) {
    console.error('è·å–æ•°æ®å¤±è´¥ï¼š', error)
    message.error('è·å–æ•°æ®å¤±è´¥')
  }
}

// é¡µé¢åŠ è½½æ—¶è¯·æ±‚ä¸€æ¬¡
onMounted(() => {
  fetchData()
})

// åˆ†é¡µå‚æ•°
const pagination = computed(() => {
  return {
    current: searchParams.pageNum ?? 1,
    pageSize: searchParams.pageSize ?? 10,
    total: total.value,
    showSizeChanger: true,
    showTotal: (total: number) => `å…± ${total} æ¡`,
  }
})

// è¡¨æ ¼å˜åŒ–å¤„ç†
const doTableChange = (page: { current: number; pageSize: number }) => {
  searchParams.pageNum = page.current
  searchParams.pageSize = page.pageSize
  fetchData()
}

// æœç´¢
const doSearch = () => {
  // é‡ç½®é¡µç 
  searchParams.pageNum = 1
  fetchData()
}

// æŸ¥çœ‹åº”ç”¨å¯¹è¯
const viewAppChat = (appId: number | undefined) => {
  if (appId) {
    router.push(`/app/chat/${appId}`)
  }
}

// åˆ é™¤æ¶ˆæ¯
const deleteMessage = async (id: number | undefined) => {
  if (!id) return

  try {
    // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦åç«¯æä¾›åˆ é™¤å¯¹è¯å†å²çš„æ¥å£
    // ç›®å‰å…ˆæ˜¾ç¤ºæˆåŠŸï¼Œå®é™…å®ç°éœ€è¦è°ƒç”¨åˆ é™¤æ¥å£
    message.success('åˆ é™¤æˆåŠŸ')
    // åˆ·æ–°æ•°æ®
    fetchData()
  } catch (error) {
    console.error('åˆ é™¤å¤±è´¥ï¼š', error)
    message.error('åˆ é™¤å¤±è´¥')
  }
}
</script>

<style scoped>
#chatManagePage {
  padding: 24px;
  background: white;
  margin-top: 16px;
}

.message-text {
  max-width: 300px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

:deep(.ant-table-tbody > tr > td) {
  vertical-align: middle;
}
</style>
```

å…¶ä¸­ï¼Œæ¸¸æ ‡æŸ¥è¯¢å’Œæ¶ˆæ¯åˆ—è¡¨ç»´æŠ¤æ˜¯å‰ç«¯çš„æŠ€æœ¯é‡ç‚¹ï¼Œä»£ç å¦‚ä¸‹ï¼š

```javascript
// æ ¸å¿ƒçŠ¶æ€å®šä¹‰
const messages = ref<Message[]>([])           // æ¶ˆæ¯åˆ—è¡¨
const loadingHistory = ref(false)            // åŠ è½½çŠ¶æ€
const hasMoreHistory = ref(false)            // æ˜¯å¦è¿˜æœ‰æ›´å¤šå†å²
const lastCreateTime = ref<string>()         // æ¸¸æ ‡ï¼šæœ€åä¸€æ¡æ¶ˆæ¯çš„åˆ›å»ºæ—¶é—´

// åŠ è½½å¯¹è¯å†å²çš„æ ¸å¿ƒé€»è¾‘
const loadChatHistory = async (isLoadMore = false) => {
  if (loadingHistory.value) return
  loadingHistory.value = true
  try {
    // æ„å»ºè¯·æ±‚å‚æ•°
    const params = {
      pageSize: 10,
      // å…³é”®ï¼šä½¿ç”¨æœ€åä¸€æ¡æ¶ˆæ¯æ—¶é—´ä½œä¸ºæ¸¸æ ‡
      lastCreateTime: isLoadMore ? lastCreateTime.value : undefined
    }
    const res = await api.getChatHistory(params)
    const chatHistories = res.data.records || []
    if (chatHistories.length > 0) {
      // å°†åç«¯æ•°æ®è½¬æ¢ä¸ºå‰ç«¯æ¶ˆæ¯æ ¼å¼
      const historyMessages = chatHistories
        .map(chat => ({
          type: chat.messageType === 'user' ? 'user' : 'ai',
          content: chat.message || '',
          createTime: chat.createTime,
        }))
        .reverse() // å…³é”®ï¼šåè½¬è®©è€æ¶ˆæ¯åœ¨å‰
      
      if (isLoadMore) {
        // åŠ è½½æ›´å¤šï¼šæ·»åŠ åˆ°åˆ—è¡¨å¼€å¤´
        messages.value.unshift(...historyMessages)
      } else {
        // åˆå§‹åŠ è½½ï¼šç›´æ¥è®¾ç½®
        messages.value = historyMessages
      }
      // å…³é”®ï¼šæ›´æ–°æ¸¸æ ‡ä¸ºæœ€è€æ¶ˆæ¯çš„æ—¶é—´
      lastCreateTime.value = chatHistories[chatHistories.length - 1]?.createTime
      // åˆ¤æ–­æ˜¯å¦è¿˜æœ‰æ›´å¤šæ•°æ®
      hasMoreHistory.value = chatHistories.length === 10
    } else {
      hasMoreHistory.value = false
    }
  } finally {
    loadingHistory.value = false
  }
}
```

è¿™æ®µä»£ç çš„é‡ç‚¹æ˜¯ï¼š

1.  çŠ¶æ€ç®¡ç†ï¼šé€šè¿‡ `lastCreateTime` ç»´æŠ¤æ¸¸æ ‡çŠ¶æ€ï¼Œç¡®ä¿åˆ†é¡µçš„è¿ç»­æ€§
2.  æ¶ˆæ¯æ’åºï¼šåç«¯è¿”å›çš„æ˜¯æ—¶é—´é™åºï¼Œå‰ç«¯éœ€è¦åè½¬åå†æ·»åŠ åˆ°åˆ—è¡¨
3.  å¢é‡åŠ è½½ï¼šæ–°æ¶ˆæ¯æ·»åŠ åˆ°æ•°ç»„å¼€å¤´ï¼Œä¿æŒæ—¶é—´é¡ºåºçš„æ­£ç¡®æ€§
4.  è¾¹ç•Œå¤„ç†ï¼šé€šè¿‡è¿”å›è®°å½•æ•°åˆ¤æ–­æ˜¯å¦è¿˜æœ‰æ›´å¤šæ•°æ®

### å¸¸è§é—®é¢˜ - æ¶ˆæ¯é¡ºåºç›¸å

åœ¨å¼€å‘è¿‡ç¨‹ä¸­å¯èƒ½ä¼šé‡åˆ°æ¶ˆæ¯é¡ºåºç›¸åçš„é—®é¢˜ï¼Œæ¯”å¦‚ä¸‹å›¾ï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/CRPI2mJTtQUN6mqV.webp)

å¯ä»¥è®© AI ä¿®å¤é—®é¢˜ï¼Œè½»è½»æ¾æ¾~

```markdown
ç›®å‰åŠ è½½åå±•ç¤ºçš„æ¶ˆæ¯é¡ºåºåäº†ï¼Œåº”è¯¥åƒèŠå¤©è®°å½•ä¸€æ ·ä¸Šæ–¹å±•ç¤ºè€çš„ï¼Œä¸‹æ–¹å±•ç¤ºæ–°çš„
```

é€šè¿‡è°ƒæ•´æ•°æ®å¤„ç†é€»è¾‘ï¼Œç¡®ä¿æ¶ˆæ¯æŒ‰ç…§æ­£ç¡®çš„æ—¶é—´é¡ºåºå±•ç¤ºï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/qdnQV6dpaIygAvPo.webp)

## äº”ã€å¯¹è¯è®°å¿†

### éœ€æ±‚åˆ†æ

å¾ˆå¤šæ—¶å€™ AI ç”Ÿæˆçš„ç½‘ç«™æ²¡â åŠæ³•ä¸€æ¬¡æ€§æ»¡è¶³ç”¨æˆ·â çš„éœ€æ±‚ï¼Œå› æ­¤éœ€è¦æä¾›ç½‘ç«™ä¿®æ”¹åŠŸèƒ½ã€‚

ä½†æ˜¯ç›®å‰æˆ‘ä»¬çš„ AI å¯¹è¯ä¼šæ–­ç‰‡å„¿â ï¼Œæ— æ³•è®°ä½ä¹‹å‰çš„å¯¹è¯å†…â å®¹ï¼Œæ¯æ¬¡ä¿®æ”¹å®é™…ä¸Šéƒ½æ˜¯é‡æ–°ç”Ÿæˆå®Œæ•´çš„ç½‘ç«™ï¼Œè€Œä¸æ˜¯åœ¨åŸæœ‰åŸºç¡€ä¸Šè¿›è¡Œä¿®æ”¹ã€‚

![](https://pic.code-nav.cn/course_picture/1608440217629360130/125NTnsKZVyx70x4.webp)

![](https://pic.code-nav.cn/course_picture/1608440217629360130/htOoznRCZHd8N2nV.webp)

è¿™ç§æƒ…å†µä¸‹ï¼Œç”¨æˆ·ä¸èƒ½è¿›è¡Œè¿­ä»£â å¼çš„ç½‘ç«™å¼€å‘ï¼Œæ¯æ¬¡â éƒ½æ˜¯å¼€ç›²ç›’ï¼Œæå¤§åœ°é™åˆ¶äº†å¹³å°çš„å®ç”¨æ€§ã€‚

### æ–¹æ¡ˆè®¾è®¡

è¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå°±è¦ç»™ AI å¢åŠ å¯¹è¯è®°å¿†èƒ½åŠ›ã€‚

#### ä¿å­˜åˆ°å“ªå„¿ï¼Ÿ

LangChain4j ä¸ä»…æä¾›äº†å¯¹è¯è®°å¿†èƒ½åŠ›â ï¼Œè€Œä¸”è¿˜èƒ½ç»“åˆ Redis æŒâ ä¹…åŒ–å¯¹è¯è®°å¿†ï¼Œéå¸¸çˆ½~â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‰â€‰â€‰â€‰â€‰â€‚â€‰â€‰â€‰â€‰â€‚â€‚â€‚â€‰â€‚â€‚

è¿™é‡Œå¯èƒ½æœ‰åŒå­¦ä¼šå¥½å¥‡ 2 ä¸ªé—®é¢˜ï¼š

1ï¼‰ä¸ºä»€ä¹ˆä¸ç›´æ¥ç”¨å†…å­˜æ¥å­˜å‚¨ä¼šè¯è®°å¿†ï¼Ÿ

é¦–å…ˆæ˜¯é‡å¯åä¼šä¸¢å¤±è®°å¿†ï¼›å…¶æ¬¡â å¦‚æœæ¯ä¸ªåº”ç”¨éƒ½åœ¨å†…â å­˜ä¸­ç»´æŠ¤å¯¹è¯å†å²ï¼Œå¾ˆå®¹æ˜“å‡ºç° OOM é—®é¢˜ã€‚

2ï¼‰ä¸ºä»€ä¹ˆä¸ç”¨ MySQL æ¥å­˜å‚¨ä¼šè¯è®°å¿†ï¼Ÿ

ä¸€æ–¹é¢æ˜¯å› ä¸º Redis ä½œä¸ºå†…å­˜æ•°æ®åº“ï¼Œåœ¨è¯»å†™â å¯¹è¯è®°å¿†æ—¶æ€§èƒ½æ›´é«˜ï¼›å¦ä¸€æ–¹é¢æ˜¯æ•°â æ®åº“ä¸­çš„å¯¹è¯å†å²è¡¨åŒ…å«å…¶ä»–ä¸šåŠ¡å­—æ®µï¼Œä¸é€‚åˆç›´æ¥äº¤ç»™ LangChain4j çš„å¯¹è¯è®°å¿†ç»„ä»¶ç®¡ç†ã€‚

â­ï¸ æ¨èå…ˆè§‚çœ‹é±¼çš® Redis å¯¼å­¦åŠ¨ç”»è§†é¢‘ï¼Œå°ç™½å¯æ‡‚ï¼š[https://www.bilibili.com/video/BV1a1sgzfE5d/](https://www.bilibili.com/video/BV1a1sgzfE5d/)

#### åŠ è½½å†å²

è¦æ³¨æ„ï¼Œ**Redis çš„å†…å­˜ä¹Ÿä¸æ˜¯æ— é™çš„ï¼** ä¸€èˆ¬æƒ…å†µä¸‹è¦ç»™å­˜å…¥ Redis çš„æ¯ä¸ª Key éƒ½è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´ï¼Œä¸èƒ½ä¸è¿‡æœŸã€‚æ‰€ä»¥è¿™å°±å¯èƒ½å¯¼è‡´ Redis çš„ä¼šè¯è®°å¿†è¢«åˆ é™¤çš„æƒ…å†µã€‚

æ€ä¹ˆè§£å†³å‘¢ï¼Ÿ

æ–¹æ¡ˆå¾ˆç®€å•ï¼Œä¹‹å‰æˆ‘ä»¬å·²ç»åœ¨æ•°æ®åº“ä¸­ä¿å­˜äº†ç”¨â æˆ·å’Œ AI çš„æ¶ˆæ¯ï¼Œåªéœ€è¦åœ¨â åˆå§‹åŒ–ä¼šè¯è®°å¿†æ—¶ï¼ŒåŠ è½½æœ€æ–°çš„å¯¹è¯è®°å½•åˆ° Redis ä¸­ï¼Œå°±èƒ½ç¡®ä¿ AI äº†è§£äº¤äº’å†å²ã€‚

æµç¨‹ï¼šAI å¯¹è¯ => ä»æ•°â æ®åº“ä¸­åŠ è½½å¯¹è¯å†å²â åˆ° Redis => Redis ä¸º AI æä¾›å¯¹è¯è®°å¿†

#### å¯¹è¯éš”ç¦»

æ­¤å¤–ï¼Œæ¯ä¸ªåº”ç”¨çš„å¯¹è¯è®°å¿†åº”è¯¥æ˜¯â ç›¸äº’éš”ç¦»çš„ï¼ŒLangâ Chain4j ä¹Ÿæä¾›äº†å¯¹è¯è®°å¿†éš”ç¦»çš„èƒ½åŠ›ï¼Œä¸‹é¢å¼€å‘å®ç°ä¸­ä¼šè®²è§£ã€‚

### å¼€å‘å®ç°

#### 1ã€å¼•å…¥ä¾èµ–

å‚è€ƒ [LangChain4j å®˜æ–¹æ–‡æ¡£](https://docs.langchain4j.dev/integrations/embedding-stores/redis)ï¼Œå¼•å…¥å¿…è¦çš„ä¾èµ–ï¼š

```xml
<dependency>
  <groupId>dev.langchain4j</groupId>
  <artifactId>langchain4j-community-redis-spring-boot-starter</artifactId>
  <version>1.1.0-beta7</version>
</dependency>
```

è¿™ä¸ªä¾èµ–ä¼šå¼•å…¥ Redis â çš„ Jedis å®¢â æˆ·ç«¯ï¼Œä»¥åŠä¸ LangChain4j çš„æ•´åˆç»„ä»¶ã€‚

#### 2ã€é…ç½® Redis

1ï¼‰åœ¨é…ç½®æ–‡ä»¶ä¸­æ·»åŠ  Redis è¿æ¥ä¿¡æ¯ï¼š

```yaml
spring:
  # redis
  data:
    redis:
      host: localhost
      port: 6379
      password: 
      ttl: 3600
```

æ³¨æ„ï¼Œè¿™é‡Œçš„ `ttl` ä¸æ˜¯è¿æ¥ Redis çš„è¶…æ—¶æ—¶é—´ï¼ˆtimeoutï¼‰ï¼Œè€Œæ˜¯è¿‡æœŸæ—¶é—´ï¼ˆå•ä½ï¼šç§’ï¼‰ï¼Œæˆ‘è¿™é‡Œè®¾ç½® 1 å°æ—¶ã€‚å‰é¢ä¹Ÿæåˆ°ï¼Œå¦‚æœæ¶ˆæ¯æ•°æ¯”è¾ƒå¤šï¼Œä¸è®¾ç½®çš„è¯ Redis å†…å­˜å¾ˆå®¹æ˜“å æ»¡ã€‚

![](https://pic.code-nav.cn/course_picture/1608440217629360130/wR4xJ0vzMdpkekWC.webp)

2ï¼‰åœ¨ `config` ä¸‹æ–°å»º Redis å¯¹è¯è®°å¿†å­˜å‚¨é…ç½®ç±»ï¼Œåˆå§‹åŒ– RedisChatMemoryStore çš„ Beanï¼š

```java
@Configuration
@ConfigurationProperties(prefix = "spring.data.redis")
@Data
public class RedisChatMemoryStoreConfig {

    private String host;

    private int port;

    private String password;

    private long ttl;

    @Bean
    public RedisChatMemoryStore redisChatMemoryStore() {
        return RedisChatMemoryStore.builder()
                .host(host)
                .port(port)
                .password(password)
                .ttl(ttl)
                .build();
    }
}
```

æ³¨æ„ï¼Œå¦‚æœä½ çš„ Redis â å¯†ç ä¸ä¸ºç©ºï¼Œä¸Šè¿°é…â ç½®ä¸­è¿˜è¦æ·»åŠ  user ç”¨æˆ·åé…ç½®ï¼š

```java
RedisChatMemoryStore.builder()
    .user("ä½ çš„ç”¨æˆ·å")
```

å¦‚æœä½ çš„å¯†ç ä¸ºç©ºï¼Œé‚£ä¹ˆå°±ä¸ç”¨æ·»åŠ äº†ï¼Œæ ¹æ®æƒ…å†µé€‰æ‹©å°±å¥½ã€‚

3ï¼‰åœ¨å¯åŠ¨ç±»ä¸­æ’é™¤ embeâ dding çš„è‡ªåŠ¨â è£…é…ï¼Œå› ä¸ºæœ¬é¡¹ç›®ç”¨ä¸åˆ°ï¼š

```java
@SpringBootApplication(exclude = {RedisEmbeddingStoreAutoConfiguration.class})
```

å¦åˆ™ä¼šæŠ¥é”™ï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/P8VPOiJyVZFMI8nI.webp)

#### 3ã€ä½¿ç”¨å¯¹è¯è®°å¿†

ä¸åŒ appId çš„å¯¹è¯è®°å¿†â æ˜¯ç‹¬ç«‹éš”ç¦»çš„ï¼Œåˆ©ç”¨â  LangChain4j å¯ä»¥æœ‰ 2 ç§å®ç°æ–¹æ¡ˆã€‚

##### æ–¹æ¡ˆ 1 - å†…ç½®éš”ç¦»æœºåˆ¶

å‚è€ƒ [å®˜æ–¹æ–‡æ¡£](https://docs.langchain4j.dev/tutorials/ai-services#chat-memory)ï¼Œå¯ä»¥ç»™ AI æœåŠ¡æ–¹æ³•å¢åŠ  `memoryId` æ³¨è§£å’Œå‚æ•°ï¼Œç„¶åé€šè¿‡ `chatMemoryProvider` ä¸ºæ¯ä¸ª appId åˆ†é…å¯¹è¯è®°å¿†ã€‚

ç”±äºæˆ‘ä»¬ç›®å‰ä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ª â AiServiceâ  å®ä¾‹ï¼Œå…ˆé‡‡ç”¨è¿™ç§æ–¹å¼ï¼Œå¥½åƒä¿®æ”¹æˆæœ¬æ›´ä½ã€‚

ä¿®æ”¹ AiService æ–¹â æ³•ï¼šâ€‚â€‚â€‚â€‚â€‚â€‚â€‚â â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‰â€‰â€‰â€‰â€‰â€‚â€‰â€‰â€‰â€‰â€‚â€‚â€‚â€‰â€‚â€‚

```java
interface AiCodeGeneratorService  {
    HtmlCodeResult generateHtmlCode(@MemoryId int memoryId, @UserMessage String userMessage);
}
```

åœ¨å·¥å‚ç±»ä¸­åˆ›å»º AI Service æ—¶ï¼Œæˆ‘ä»¬å¿…é¡»é€šè¿‡ `chatMemoryProvider` ä¸ºæ¯ä¸ª memoryId æ¥æ„é€ ä¸“å±çš„ MessageWindowChatMemoryã€‚æ³¨æ„ï¼Œå¿…é¡»ä¸º MessageWindowChatMemory è®¾ç½® idï¼Œå› ä¸ºä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ª Redis å­˜å‚¨å®ä¾‹ï¼Œå¦åˆ™ Redis ä¸­çš„å­˜å‚¨ key éƒ½æ˜¯ defaultï¼Œæ— æ³•åŒºåˆ†ä¸åŒçš„å¯¹è¯ã€‚

```java
private final RedisChatMemoryStore redisChatMemoryStore;

@Bean
public AiCodeGeneratorService aiCodeGeneratorService() {
    return AiServices.builder(AiCodeGeneratorService.class)
            .chatModel(chatModel)
            .streamingChatModel(streamingChatModel)
            // æ ¹æ® id æ„å»ºç‹¬ç«‹çš„å¯¹è¯è®°å¿†
            .chatMemoryProvider(memoryId -> MessageWindowChatMemory
                    .builder()
                    .id(memoryId)
                    .chatMemoryStore(redisChatMemoryStore)
                    .maxMessages(20)
                    .build())
            .build();
}
```

ç°åœ¨è°ƒç”¨ AI ç”Ÿæˆæ–¹æ³•æ—¶ï¼Œè¦å¤šä¼ ä¸€ä¸ª id å‚æ•°ï¼š

```java
generateHtmlCode(1, "ç”Ÿæˆåšå®¢ç½‘ç«™");
generateHtmlCode(2, "ç”Ÿæˆç”µå•†ç½‘ç«™");
```

ç¼–å†™å•å…ƒæµ‹è¯•ï¼Œæµ‹è¯• 2 åœºä¸åŒçš„å¯¹è¯ï¼š

```java
@Test
void testChatMemory() {
    HtmlCodeResult result = aiCodeGeneratorService.generateHtmlCode(1, "åšä¸ªç¨‹åºå‘˜é±¼çš®çš„å·¥å…·ç½‘ç«™ï¼Œæ€»ä»£ç é‡ä¸è¶…è¿‡ 20 è¡Œ");
    Assertions.assertNotNull(result);
    result = aiCodeGeneratorService.generateHtmlCode(1, "ä¸è¦ç”Ÿæˆç½‘ç«™ï¼Œå‘Šè¯‰æˆ‘ä½ åˆšåˆšåšäº†ä»€ä¹ˆï¼Ÿ");
    Assertions.assertNotNull(result);
    result = aiCodeGeneratorService.generateHtmlCode(2, "åšä¸ªç¨‹åºå‘˜é±¼çš®çš„å·¥å…·ç½‘ç«™ï¼Œæ€»ä»£ç é‡ä¸è¶…è¿‡ 20 è¡Œ");
    Assertions.assertNotNull(result);
    result = aiCodeGeneratorService.generateHtmlCode(2, "ä¸è¦ç”Ÿæˆç½‘ç«™ï¼Œå‘Šè¯‰æˆ‘ä½ åˆšåˆšåšäº†ä»€ä¹ˆï¼Ÿ");
    Assertions.assertNotNull(result);
}
```

æ‰§è¡Œå•å…ƒæµ‹è¯•ï¼Œåœ¨ Redisâ  ä¸­èƒ½çœ‹åˆ°å†å²å¯¹è¯â è®°å¿†ï¼Œæ¯ä¸ª id å¯¹åº”äº†ä¸€ä¸ª keyï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/GhXlr2rmwCUJPcf1.webp)

å¦‚æœä¸ä¼ å…¥ idï¼Œé»˜è®¤ä¸º defaultï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/jLcAI4BbE5dDOkxW.webp)

Redis ä¸­å­˜å‚¨çš„å†…å®¹ç»“æ„ï¼š

```json
[
  {
    "text": "ä½ æ˜¯ä¸€ä½èµ„æ·±çš„ Web å‰ç«¯å¼€å‘ä¸“å®¶ï¼Œç²¾é€š HTMLã€CSS å’ŒåŸç”Ÿ JavaScriptã€‚ä½ æ“…é•¿æ„å»ºå“åº”å¼ã€ç¾è§‚ä¸”ä»£ç æ•´æ´çš„å•é¡µé¢ç½‘ç«™ã€‚\n\nä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®ç”¨æˆ·æä¾›çš„ç½‘ç«™æè¿°ï¼Œç”Ÿæˆä¸€ä¸ªå®Œæ•´ã€ç‹¬ç«‹çš„å•é¡µé¢ç½‘ç«™ã€‚ä½ éœ€è¦ä¸€æ­¥æ­¥æ€è€ƒï¼Œå¹¶æœ€ç»ˆå°†æ‰€æœ‰ä»£ç æ•´åˆåˆ°ä¸€ä¸ª HTML æ–‡ä»¶ä¸­ã€‚\n\nçº¦æŸ:\n1. æŠ€æœ¯æ ˆ: åªèƒ½ä½¿ç”¨ HTMLã€CSS å’ŒåŸç”Ÿ JavaScriptã€‚\n2. ç¦æ­¢å¤–éƒ¨ä¾èµ–: ç»å¯¹ä¸å…è®¸ä½¿ç”¨ä»»ä½•å¤–éƒ¨ CSS æ¡†æ¶ã€JS åº“æˆ–å­—ä½“åº“ã€‚æ‰€æœ‰åŠŸèƒ½å¿…é¡»ç”¨åŸç”Ÿä»£ç å®ç°ã€‚\n3. ç‹¬ç«‹æ–‡ä»¶: å¿…é¡»å°†æ‰€æœ‰çš„ CSS ä»£ç éƒ½å†…è”åœ¨ `<head>` æ ‡ç­¾çš„ `<style>` æ ‡ç­¾å†…ï¼Œå¹¶å°†æ‰€æœ‰çš„ JavaScript ä»£ç éƒ½æ”¾åœ¨ `</body>` æ ‡ç­¾ä¹‹å‰çš„ `<script>` æ ‡ç­¾å†…ã€‚æœ€ç»ˆåªè¾“å‡ºä¸€ä¸ª `.html` æ–‡ä»¶ï¼Œä¸åŒ…å«ä»»ä½•å¤–éƒ¨æ–‡ä»¶å¼•ç”¨ã€‚\n4. å“åº”å¼è®¾è®¡: ç½‘ç«™å¿…é¡»æ˜¯å“åº”å¼çš„ï¼Œèƒ½å¤Ÿåœ¨æ¡Œé¢å’Œç§»åŠ¨è®¾å¤‡ä¸Šè‰¯å¥½æ˜¾ç¤ºã€‚è¯·ä¼˜å…ˆä½¿ç”¨ Flexbox æˆ– Grid è¿›è¡Œå¸ƒå±€ã€‚\n5. å†…å®¹å¡«å……: å¦‚æœç”¨æˆ·æè¿°ä¸­ç¼ºå°‘å…·ä½“æ–‡æœ¬æˆ–å›¾ç‰‡ï¼Œè¯·ä½¿ç”¨æœ‰æ„ä¹‰çš„å ä½ç¬¦ã€‚ä¾‹å¦‚ï¼Œæ–‡æœ¬å¯ä»¥ä½¿ç”¨ Lorem Ipsumï¼Œå›¾ç‰‡å¯ä»¥ä½¿ç”¨ https://picsum.photos çš„æœåŠ¡ (ä¾‹å¦‚ `<img src=\"https://picsum.photos/800/600\" alt=\"Placeholder Image\">`)ã€‚\n6. ä»£ç è´¨é‡: ä»£ç å¿…é¡»ç»“æ„æ¸…æ™°ã€æœ‰é€‚å½“çš„æ³¨é‡Šï¼Œæ˜“äºé˜…è¯»å’Œç»´æŠ¤ã€‚\n7. äº¤äº’æ€§: å¦‚æœç”¨æˆ·æè¿°äº†äº¤äº’åŠŸèƒ½ (å¦‚ Tab åˆ‡æ¢ã€å›¾ç‰‡è½®æ’­ã€è¡¨å•æäº¤æç¤ºç­‰)ï¼Œè¯·ä½¿ç”¨åŸç”Ÿ JavaScript æ¥å®ç°ã€‚\n8. å®‰å…¨æ€§: ä¸è¦åŒ…å«ä»»ä½•æœåŠ¡å™¨ç«¯ä»£ç æˆ–é€»è¾‘ã€‚æ‰€æœ‰åŠŸèƒ½éƒ½æ˜¯çº¯å®¢æˆ·ç«¯çš„ã€‚\n9. è¾“å‡ºæ ¼å¼: ä½ çš„æœ€ç»ˆè¾“å‡ºå¿…é¡»åŒ…å« HTML ä»£ç å—ï¼Œå¯ä»¥åœ¨ä»£ç å—ä¹‹å¤–æ·»åŠ è§£é‡Šã€æ ‡é¢˜æˆ–æ€»ç»“æ€§æ–‡å­—ã€‚æ ¼å¼å¦‚ä¸‹ï¼š\n\n```html\n... HTML ä»£ç  ...\n```",
    "type": "SYSTEM"
  },
  {
    "contents": [
      {
        "text": "åšä¸ªç¨‹åºå‘˜é±¼çš®çš„å·¥å…·ç½‘ç«™ï¼Œæ€»ä»£ç é‡ä¸è¶…è¿‡ 20 è¡Œ\nYou must answer strictly in the following JSON format: {\n\"htmlCode\": (HTMLä»£ç ; type: string),\n\"description\": (ç”Ÿæˆä»£ç çš„æè¿°; type: string)\n}",
        "type": "TEXT"
      }
    ],
    "type": "USER"
  },
  {
    "text": "{\n\"htmlCode\": \"<!DOCTYPE html>\\n<html lang=\\\"en\\\">\\n<head>\\n    <meta charset=\\\"UTF-8\\\">\\n    <meta name=\\\"viewport\\\" content=\\\"width=device-width, initial-scale=1.0\\\">\\n    <title>é±¼çš®çš„å·¥å…·ç½‘ç«™</title>\\n    <style>\\n        body {\\n            font-family: Arial, sans-serif;\\n            margin: 0;\\n            padding: 20px;\\n            display: flex;\\n            flex-direction: column;\\n            align-items: center;\\n            justify-content: center;\\n            height: 100vh;\\n            background-color: #f0f0f0;\\n        }\\n        h1 {\\n            color: #333;\\n        }\\n        .tool {\\n            background-color: white;\\n            padding: 20px;\\n            border-radius: 5px;\\n            box-shadow: 0 2px 4px rgba(0,0,0,0.1);\\n            margin-top: 20px;\\n        }\\n    </style>\\n</head>\\n<body>\\n    <h1>é±¼çš®çš„å·¥å…·ç½‘ç«™</h1>\\n    <div class=\\\"tool\\\">\\n        <p>è¿™æ˜¯ä¸€ä¸ªç®€å•çš„å·¥å…·ç½‘ç«™ï¼Œä¸“ä¸ºç¨‹åºå‘˜é±¼çš®è®¾è®¡ã€‚</p>\\n    </div>\\n</body>\\n</html>\",\n\"description\": \"è¿™æ˜¯ä¸€ä¸ªéå¸¸ç®€æ´çš„å·¥å…·ç½‘ç«™ï¼Œä¸“ä¸ºç¨‹åºå‘˜é±¼çš®è®¾è®¡ã€‚ç½‘ç«™åŒ…å«ä¸€ä¸ªæ ‡é¢˜å’Œä¸€ä¸ªç®€å•çš„å·¥å…·æè¿°åŒºåŸŸï¼Œä½¿ç”¨äº†åŸºæœ¬çš„HTMLå’ŒCSSæ¥å®ç°å“åº”å¼å¸ƒå±€ã€‚æ•´ä¸ªä»£ç é‡æ§åˆ¶åœ¨20è¡Œä»¥å†…ï¼Œç¬¦åˆè¦æ±‚ã€‚\"\n}",
    "toolExecutionRequests": [],
    "type": "AI"
  },
  {
    "contents": [
      {
        "text": "ä¸è¦ç”Ÿæˆç½‘ç«™ï¼Œå‘Šè¯‰æˆ‘ä½ åˆšåˆšåšäº†ä»€ä¹ˆï¼Ÿ\nYou must answer strictly in the following JSON format: {\n\"htmlCode\": (HTMLä»£ç ; type: string),\n\"description\": (ç”Ÿæˆä»£ç çš„æè¿°; type: string)\n}",
        "type": "TEXT"
      }
    ],
    "type": "USER"
  },
  {
    "text": "{\n\"htmlCode\": \"\",\n\"description\": \"æˆ‘åˆšåˆšåˆ›å»ºäº†ä¸€ä¸ªéå¸¸ç®€æ´çš„å·¥å…·ç½‘ç«™HTMLä»£ç ï¼Œä¸“ä¸ºç¨‹åºå‘˜é±¼çš®è®¾è®¡ã€‚è¿™ä¸ªç½‘ç«™åŒ…å«ä¸€ä¸ªæ ‡é¢˜å’Œä¸€ä¸ªç®€å•çš„å·¥å…·æè¿°åŒºåŸŸï¼Œä½¿ç”¨äº†åŸºæœ¬çš„HTMLå’ŒCSSæ¥å®ç°å“åº”å¼å¸ƒå±€ã€‚æ•´ä¸ªä»£ç é‡æ§åˆ¶åœ¨20è¡Œä»¥å†…ï¼Œç¬¦åˆç”¨æˆ·çš„è¦æ±‚ã€‚\"\n}",
    "toolExecutionRequests": [],
    "type": "AI"
  }
]
```

##### æ–¹æ¡ˆ 2 - AI Service éš”ç¦»

ä¹‹å‰æ‰€æœ‰åº”ç”¨å…±ç”¨åŒä¸€ä¸ª AI Service å®â ä¾‹ï¼Œå¦‚æœæƒ³éš”ç¦»ä¼šè¯è®°å¿†ï¼Œå¯ä»¥ç»™æ¯â ä¸ªåº”ç”¨åˆ†é…ä¸€ä¸ªä¸“å±çš„ AI Serviceï¼Œæ¯ä¸ª AI Service ç»‘å®šç‹¬ç«‹çš„å¯¹è¯è®°å¿†ã€‚

ä¿®æ”¹ AI Service â å·¥å‚ç±»ï¼Œæä¾›æ ¹æ® â appId è·å– AI Service æœåŠ¡çš„æ–¹æ³•ï¼š

```java
@Configuration
public class AiCodeGeneratorServiceFactory {

    @Resource
    private ChatModel chatModel;

    @Resource
    private StreamingChatModel streamingChatModel;

    @Resource
    private RedisChatMemoryStore redisChatMemoryStore;

    /**
     * æ ¹æ® appId è·å–æœåŠ¡
     */
    public AiCodeGeneratorService getAiCodeGeneratorService(long appId) {
        // æ ¹æ® appId æ„å»ºç‹¬ç«‹çš„å¯¹è¯è®°å¿†
        MessageWindowChatMemory chatMemory = MessageWindowChatMemory
                .builder()
                .id(appId)
                .chatMemoryStore(redisChatMemoryStore)
                .maxMessages(20)
                .build();
        return AiServices.builder(AiCodeGeneratorService.class)
                .chatModel(chatModel)
                .streamingChatModel(streamingChatModel)
                .chatMemory(chatMemory)
                .build();
    }
}
```

ä¸ºäº†ä¿è¯è·Ÿä¹‹å‰çš„ä»£ç å…¼å®¹ï¼Œä»â ç„¶é»˜è®¤æä¾›ä¸€ä¸ª Aâ I Service çš„ Beanï¼š

```java
/**
 * é»˜è®¤æä¾›ä¸€ä¸ª Bean
 */
@Bean
public AiCodeGeneratorService aiCodeGeneratorService() {
    return getAiCodeGeneratorService(0L);
}
```

#### 4ã€æœ¬åœ°ç¼“å­˜ä¼˜åŒ–

åŸºäºæ–¹æ¡ˆ 2ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ [Caffeine æœ¬åœ°ç¼“å­˜](https://github.com/ben-manes/caffeine) è¿›ä¸€æ­¥ä¼˜åŒ–æ€§èƒ½ã€‚

æ¯æ¬¡æ„é€ å®Œ appId å¯¹åº”çš„ AI æœåŠ¡å®ä¾‹åï¼Œåˆ©ç”¨ Caffâ eine ç¼“å­˜æ¥å­˜å‚¨ï¼Œä¹‹åç›¸åŒ appIdâ  å°±èƒ½ç›´æ¥è·å–åˆ° AI æœåŠ¡å®ä¾‹ï¼Œé¿å…é‡å¤æ„é€ ã€‚æ³¨æ„ï¼Œæœ¬åœ°ç¼“å­˜å ç”¨çš„æ˜¯å†…å­˜ï¼Œæ‰€ä»¥å¿…é¡»è®¾ç½®åˆç†çš„è¿‡æœŸç­–ç•¥é˜²æ­¢å†…å­˜æ³„æ¼ã€‚

å…ˆå¼•å…¥ Caffeine ä¾èµ–ï¼š

```xml
<dependency>
    <groupId>com.github.ben-manes.caffeine</groupId>
    <artifactId>caffeine</artifactId>
</dependency>
```

ä¼˜åŒ– AiCodeGenerâ atorServiâ ceFactoryï¼Œå¢åŠ ç¼“å­˜é€»è¾‘ï¼š

```java
/**
 * AI æœåŠ¡å®ä¾‹ç¼“å­˜
 * ç¼“å­˜ç­–ç•¥ï¼š
 * - æœ€å¤§ç¼“å­˜ 1000 ä¸ªå®ä¾‹
 * - å†™å…¥å 30 åˆ†é’Ÿè¿‡æœŸ
 * - è®¿é—®å 10 åˆ†é’Ÿè¿‡æœŸ
 */
private final Cache<Long, AiCodeGeneratorService> serviceCache = Caffeine.newBuilder()
        .maximumSize(1000)
        .expireAfterWrite(Duration.ofMinutes(30))
        .expireAfterAccess(Duration.ofMinutes(10))
        .removalListener((key, value, cause) -> {
            log.debug("AI æœåŠ¡å®ä¾‹è¢«ç§»é™¤ï¼ŒappId: {}, åŸå› : {}", key, cause);
        })
        .build();

/**
 * æ ¹æ® appId è·å–æœåŠ¡ï¼ˆå¸¦ç¼“å­˜ï¼‰
 */
public AiCodeGeneratorService getAiCodeGeneratorService(long appId) {
    return serviceCache.get(appId, this::createAiCodeGeneratorService);
}

/**
 * åˆ›å»ºæ–°çš„ AI æœåŠ¡å®ä¾‹
 */
private AiCodeGeneratorService createAiCodeGeneratorService(long appId) {
    log.info("ä¸º appId: {} åˆ›å»ºæ–°çš„ AI æœåŠ¡å®ä¾‹", appId);
    // æ ¹æ® appId æ„å»ºç‹¬ç«‹çš„å¯¹è¯è®°å¿†
    MessageWindowChatMemory chatMemory = MessageWindowChatMemory
            .builder()
            .id(appId)
            .chatMemoryStore(redisChatMemoryStore)
            .maxMessages(20)
            .build();
    return AiServices.builder(AiCodeGeneratorService.class)
            .chatModel(chatModel)
            .streamingChatModel(streamingChatModel)
            .chatMemory(chatMemory)
            .build();
}
```

æœ€åä¿®æ”¹ `AiCodeGeneratorFacade`ï¼Œæ‰€æœ‰æ–¹æ³•ä½¿ç”¨çš„ AI Service æ”¹ä¸ºé€šè¿‡å·¥å‚æ ¹æ® appId è·å– AI Serviceï¼š

```java
@Resource
private AiCodeGeneratorServiceFactory aiCodeGeneratorServiceFactory;

// æ ¹æ® appId è·å–å¯¹åº”çš„ AI æœåŠ¡å®ä¾‹
AiCodeGeneratorService aiCodeGeneratorService = aiCodeGeneratorServiceFactory.getAiCodeGeneratorService(appId);
```

ä½¿ç”¨è¿™ç§æ–¹æ¡ˆï¼Œä¸éœ€è¦æ”¹åŠ¨ Aâ I Serviceâ  æœ¬èº«çš„ä»£ç ï¼Œæ›´ç¬¦åˆå¼€é—­åŸåˆ™ã€‚

#### 5ã€å†å²å¯¹è¯åŠ è½½

æ ¹æ®æ–¹æ¡ˆï¼Œå¯¹è¯è®°å¿†åˆå§‹åŒ–æ—¶ï¼Œâ éœ€è¦ä»æ•°æ®åº“ä¸­åŠ è½½â å¯¹è¯å†å²åˆ°è®°å¿†ä¸­ã€‚

åœ¨ `ChatHistoryService` ä¸­å¼€å‘åŠ è½½æ–¹æ³•ï¼š

```java
@Override
public int loadChatHistoryToMemory(Long appId, MessageWindowChatMemory chatMemory, int maxCount) {
    try {
        // ç›´æ¥æ„é€ æŸ¥è¯¢æ¡ä»¶ï¼Œèµ·å§‹ç‚¹ä¸º 1 è€Œä¸æ˜¯ 0ï¼Œç”¨äºæ’é™¤æœ€æ–°çš„ç”¨æˆ·æ¶ˆæ¯
        QueryWrapper queryWrapper = QueryWrapper.create()
                .eq(ChatHistory::getAppId, appId)
                .orderBy(ChatHistory::getCreateTime, false)
                .limit(1, maxCount);
        List<ChatHistory> historyList = this.list(queryWrapper);
        if (CollUtil.isEmpty(historyList)) {
            return 0;
        }
        // åè½¬åˆ—è¡¨ï¼Œç¡®ä¿æŒ‰æ—¶é—´æ­£åºï¼ˆè€çš„åœ¨å‰ï¼Œæ–°çš„åœ¨åï¼‰
        historyList = historyList.reversed();
        // æŒ‰æ—¶é—´é¡ºåºæ·»åŠ åˆ°è®°å¿†ä¸­
        int loadedCount = 0;
        // å…ˆæ¸…ç†å†å²ç¼“å­˜ï¼Œé˜²æ­¢é‡å¤åŠ è½½
        chatMemory.clear();
        for (ChatHistory history : historyList) {
            if (ChatHistoryMessageTypeEnum.USER.getValue().equals(history.getMessageType())) {
                chatMemory.add(UserMessage.from(history.getMessage()));
                loadedCount++;
            } else if (ChatHistoryMessageTypeEnum.AI.getValue().equals(history.getMessageType())) {
                chatMemory.add(AiMessage.from(history.getMessage()));
                loadedCount++;
            }
        }
        log.info("æˆåŠŸä¸º appId: {} åŠ è½½äº† {} æ¡å†å²å¯¹è¯", appId, loadedCount);
        return loadedCount;
    } catch (Exception e) {
        log.error("åŠ è½½å†å²å¯¹è¯å¤±è´¥ï¼ŒappId: {}, error: {}", appId, e.getMessage(), e);
        // åŠ è½½å¤±è´¥ä¸å½±å“ç³»ç»Ÿè¿è¡Œï¼Œåªæ˜¯æ²¡æœ‰å†å²ä¸Šä¸‹æ–‡
        return 0;
    }
}
```

æ³¨æ„ä¸Šè¿°ä»£ç ä¸­çš„å‡ ä¸ªé‡è¦ç»†èŠ‚ï¼š

1.  æŸ¥è¯¢èµ·å§‹ç‚¹è®¾ç½®ä¸º 1 è€Œä¸æ˜¯ 0ï¼Œè¿™æ˜¯ä¸ºäº†æ’é™¤æœ€æ–°çš„ç”¨æˆ·æ¶ˆæ¯ã€‚å› ä¸ºåœ¨å¯¹è¯æµç¨‹ä¸­ï¼Œç”¨æˆ·æ¶ˆæ¯è¢«æ·»åŠ åˆ°æ•°æ®åº“åï¼ŒAI æœåŠ¡ä¹Ÿä¼šè‡ªåŠ¨å°†ç”¨æˆ·æ¶ˆæ¯æ·»åŠ åˆ°è®°å¿†ä¸­ï¼Œå¦‚æœä¸æ’é™¤ä¼šå¯¼è‡´æ¶ˆæ¯é‡å¤ã€‚
2.  æ³¨æ„åè½¬ä»æ•°æ®åº“ä¸­æŸ¥åˆ°çš„æ¶ˆæ¯åˆ—è¡¨ï¼Œç¡®ä¿åŠ è½½åˆ°è®°å¿†ä¸­çš„æ¶ˆæ¯æ˜¯æŒ‰æ—¶é—´æ­£åºçš„ã€‚
3.  åŠ è½½å‰å…ˆæ¸…ç† Redis ä¸­çš„å†å²å¯¹è¯è®°å¿†ï¼Œé˜²æ­¢é‡å¤åŠ è½½ã€‚

ç„¶åå°±å¯ä»¥åœ¨åˆå§‹åŒ– AI Seâ rvice çš„å¯¹è¯è®°â å¿†æ—¶è°ƒç”¨äº†ï¼Œè¿™ç›¸å½“äºæ˜¯æ‡’åŠ è½½ï¼Œå¯¹è¯æ—¶æ‰ä¼šåŠ è½½è®°å¿†ï¼ŒèŠ‚çº¦å†…å­˜ã€‚

```java
private AiCodeGeneratorService createAiCodeGeneratorService(long appId) {
    log.info("ä¸º appId: {} åˆ›å»ºæ–°çš„ AI æœåŠ¡å®ä¾‹", appId);
    // æ ¹æ® appId æ„å»ºç‹¬ç«‹çš„å¯¹è¯è®°å¿†
    MessageWindowChatMemory chatMemory = MessageWindowChatMemory
            .builder()
            .id(appId)
            .chatMemoryStore(redisChatMemoryStore)
            .maxMessages(20)
            .build();
    // ä»æ•°æ®åº“åŠ è½½å†å²å¯¹è¯åˆ°è®°å¿†ä¸­
    chatHistoryService.loadChatHistoryToMemory(appId, chatMemory, 20);
    return AiServices.builder(AiCodeGeneratorService.class)
            .chatModel(chatModel)
            .streamingChatModel(streamingChatModel)
            .chatMemory(chatMemory)
            .build();
}
```

æ•°æ®åŠ è½½è‚¯å®šæ˜¯è€—æ—¶æ“ä½œï¼Œæ‰€ä»¥â æˆ‘ä»¬å¼•å…¥æœ¬åœ°ç¼“å­˜çš„â å«é‡‘é‡åˆæé«˜äº†~

#### 6ã€æµ‹è¯•éªŒè¯

ç›´æ¥é€šè¿‡å‰ç«¯æµ‹è¯•éªŒè¯ï¼š

1ï¼‰é‡æ–°åˆ›å»ºåº”ç”¨ï¼Œè¿›è¡Œå¤šè½®å¯¹â è¯ï¼ŒæŸ¥çœ‹ Rediâ s ä¸­çš„è®°å¿†æ˜¯å¦æ­£ç¡®ä¿å­˜ï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/p0b4MMPfufZb2A2y.webp)

2ï¼‰æŸ¥çœ‹å†å²åº”ç”¨ï¼Œè¿›è¡Œå¯¹è¯ï¼Œâ æŸ¥çœ‹ Redis â ä¸­çš„å¯¹è¯è®°å¿†æ˜¯å¦æ­£ç¡®åŠ è½½ï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/bMEzjqbKbUBhD262.webp)

æµ‹è¯•å‘ç°ï¼Œå¯¹è¯è®°å¿†ä¸­çš„æ¶ˆæ¯æ•°æ˜¯æ­£ç¡®çš„ï¼Œç¾ä¸­ä¸è¶³çš„æ˜¯ç³»ç»Ÿæ¶ˆæ¯ä¸åœ¨æœ€å¼€å¤´ï¼Œâ ä½†è¿™ä¸ªå½±å“ä¸æ˜¯å¾ˆå¤§ã€‚å¦‚æœè¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥å°†â ç³»ç»Ÿæ¶ˆæ¯ä½œä¸ºæ¯ä¸ªåº”ç”¨çš„ç¬¬ä¸€æ¡æ¶ˆæ¯ä¿å­˜åˆ°å¯¹è¯å†å²ä¸­ï¼Œè¿™æ ·åŠ è½½æ—¶ç›´æ¥ä¸€èµ·åŠ è½½ï¼›ä½†æ˜¯è¿”å›ç»™å‰ç«¯æ—¶è¦è¿‡æ»¤æ‰ï¼Œå› ä¸ºç³»ç»Ÿæ¶ˆæ¯ä¸åº”è¯¥å¯¹ç”¨æˆ·å¯è§ã€‚

æ€»ä¹‹ï¼Œæ•ˆæœç¬¦åˆé¢„æœŸï¼ŒAI ç°â åœ¨èƒ½å¤ŸåŸºäºå†å²å¯¹è¯â è¿›è¡Œç½‘ç«™çš„è¿­ä»£ä¼˜åŒ–äº†ã€‚

![](https://pic.code-nav.cn/course_picture/1608440217629360130/qMgq71raieLJYpQd.webp)

## å…­ã€Redis åˆ†å¸ƒå¼ Session

æ—¢ç„¶å·²ç»æ•´åˆäº† Redisï¼Œæˆ‘ä»¬å¯ä»¥é¡ºä¾¿ä¼˜åŒ–ä¸€ä¸‹â ç”¨æˆ·ç™»å½•æ€çš„ç®¡ç†ã€‚ä¹‹å‰æ¯æ¬¡é‡å¯æœâ åŠ¡å™¨éƒ½éœ€è¦é‡æ–°ç™»å½•ï¼Œç°åœ¨å¯ä»¥ä½¿ç”¨ Redis ç®¡ç† Session ç™»å½•æ€ï¼Œå®ç°åˆ†å¸ƒå¼ä¼šè¯ç®¡ç†ã€‚

æ“ä½œæ–¹å¼ä¹Ÿå¾ˆç®€å•ï¼Œ1 åˆ†é’Ÿå°±èƒ½å®Œæˆã€‚

1ï¼‰å…ˆåœ¨ Maven ä¸­å¼•å…¥ `spring-session-data-redis` åº“ï¼š

```xml
<!-- Spring Session + Redis -->
<dependency>
    <groupId>org.springframework.session</groupId>
    <artifactId>spring-session-data-redis</artifactId>
</dependency>
```

2ï¼‰ä¿®æ”¹ `application.yml` é…ç½®æ–‡ä»¶ï¼Œæ›´æ”¹ Session çš„å­˜å‚¨æ–¹å¼å’Œè¿‡æœŸæ—¶é—´ï¼š

```yaml
spring: 
  # session é…ç½®
  session:
    store-type: redis
    # session 30 å¤©è¿‡æœŸ
    timeout: 2592000
server:
  port: 8123
  servlet:
    context-path: /api
    # cookie 30 å¤©è¿‡æœŸ
    session:
      cookie:
        max-age: 2592000
```

è¿™å°±æå®šäº†ï¼Œç°åœ¨ç”¨æˆ·çš„ç™»å½•çŠ¶æ€ä¼šä¿å­˜â åœ¨ Redis ä¸­ã€‚é‡å¯â æœåŠ¡å™¨åï¼Œä¸éœ€è¦é‡æ–°ç™»é™†ï¼Œå¹¶ä¸”åœ¨ Redis ä¸­å¯ä»¥çœ‹åˆ°ç™»å½•ç›¸å…³çš„ keyï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/Wyao9P50PJRZdnx6.webp)

## ä¸ƒã€æ‰©å±•æ€è·¯

é€šè¿‡æœ¬æœŸå¼€å‘ï¼Œå¹³å°å·²ç»å…·å¤‡äº†â å®Œæ•´çš„å¯¹è¯è®°å¿†èƒ½åŠ›â ï¼Œä½†è¿˜æœ‰å¾ˆå¤šå¯ä»¥ä¼˜åŒ–å’Œæ‰©å±•çš„æ–¹å‘ã€‚

#### 1ã€è®°å½•åº”ç”¨å¯¹è¯æ€»è½®æ¬¡

ç»Ÿè®¡æ¯ä¸ªåº”ç”¨çš„å¯¹è¯è½®æ•°ï¼Œè¿™ä¸ªâ æ•°æ®å¯ä»¥ç”¨äºåˆ†æç”¨â æˆ·ä½¿ç”¨ä¹ æƒ¯ï¼Œä¹Ÿå¯ä»¥ä½œä¸ºåº”ç”¨å¤æ‚åº¦çš„å‚è€ƒæŒ‡æ ‡ã€‚

#### 2ã€å¯¹è¯å†å²å¯¼å‡ºåŠŸèƒ½

æ”¯æŒå¯¼å‡ºå¯¹è¯è®°å½•ä¸º Markâ down æ–‡ä»¶ï¼Œæ–¹â ä¾¿ç”¨æˆ·ä¿å­˜å’Œåˆ†äº«å¼€å‘è¿‡ç¨‹ã€‚

#### 3ã€æ™ºèƒ½è®°å¿†ç®¡ç†ï¼ˆè¾ƒéš¾ï¼‰

åˆ©ç”¨ AI åˆ†æå¯¹è¯æ¬¡æ•°è¾ƒå¤šâ çš„åº”ç”¨ï¼Œæ™ºèƒ½æ€»ç»“è¿‡â å»çš„å¯¹è¯å†å²ï¼ŒèŠ‚çœ Token çš„åŒæ—¶ä¼˜åŒ–è®°å¿†æ•ˆæœã€‚

#### 4ã€å¤šäººåä½œå¯¹è¯ï¼ˆè¾ƒéš¾ï¼‰

å…è®¸å¤šä¸ªç”¨æˆ·å…±åŒå‚ä¸ä¸€ä¸ªåº”ç”¨çš„å¯¹è¯ï¼Œå®ç°å›¢é˜Ÿåä½œå¼€å‘ã€‚åœ¨ [ç¼–ç¨‹å¯¼èˆªçš„æ™ºèƒ½ååŒäº‘å›¾åº“é¡¹ç›®](https://www.codefather.cn/course/1864210260732116994) ä¸­ç»™å¤§å®¶è®²è§£è¿‡æ€ä¹ˆå®ç°å¤šäººååŒæ“ä½œã€‚


