
# 如何优化调用 AI 接口的 SSE 流式输出效果？

在实现 SSE 流式输出时，我做了两项关键优化，确保数据传输的可靠性和完整性。

1）解决数据丢失问题：我发现在标准的 SSE 流中，连续的空格或特定的换行符可能会在传输过程中丢失或被浏览器错误解析。为了解决这个问题，我们将每个数据块都封装在一个 JSON 对象中进行传输，比如 `{"d": "..."}`。前端在接收到数据后，再从这个 JSON 对象中解析出 `d` 字段的原始数据。这种方式确保了无论内容是什么，都能被完整、准确地传输，避免了因内容特殊性导致的数据损坏。

2）明确流结束事件：标准的 SSE 在连接关闭时会触发 `onclose` 事件，但这个事件无法区分是正常结束还是网络异常中断。为了让前端能够明确地知道 AI 已经完成了所有内容的生成，我们在所有数据块发送完毕后，会额外发送一个名为 `done` 的自定义事件。前端通过监听这个 `done` 事件，就可以确信数据流已正常结束，从而触发后续的代码保存和预览更新等操作，增强整个流程的健壮性。
