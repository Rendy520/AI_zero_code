
# 你认为本项目中最具技术挑战性的功能是哪一个？描述你解决这个挑战的完整过程。

我认为项目中技术挑战性最大的功能是可视化修改，因为它涉及复杂的前端跨窗口通信、后端 AI 大模型交互、以及浏览器安全机制的处理。

![null](https://pic.code-nav.cn/mianshiya/question_picture/markdown/yqSvHQLn_1753193884115-cb88f05d-6a8a-4be3-9efa-c02647ae1918_mianshiya.png)

我解决这个挑战的过程可以分为以下几个步骤：

1）最大的难题是如何让主应用页面精确地知道用户在 `iframe`中点击了哪个 DOM 元素，并安全地进行通信。我首先研究了业界类似产品（如美团 NoCode）的实现方式。发现它们有的实现了非常复杂的手动编辑器，成本过高；也有一些平台采用了与我们项目理念相似的 AI 修改模式。基于开发成本和项目 AI 驱动的核心定位，我们排除了手动编辑方案，决定采用“元素定位 + AI修改”的模式。即前端负责定位元素，后端 AI 负责理解修改意图并重写代码。

2）使用浏览器标准的 `postMessage` API 进行 `iframe` 和父窗口之间的安全跨窗口通信。面临的下一个问题是如何在 `iframe` 内部署监听脚本，我们对比了两种方案：

-   让AI生成代码时就带上监听逻辑。此方案被否决，因为它会“污染”用户最终下载的纯净源代码。
-   在用户进入编辑模式时，由父窗口动态地向 `iframe` 注入一个脚本。

最终我们选择了第二种方案，保证生成代码的纯净性。

3）动态注入脚本要求父子窗口必须同源。为了在开发环境中实现这一点，我们配置了 Vite 的开发服务器代理，将后端的静态文件服务接口代理到与前端应用相同的源，绕过浏览器的同源策略限制。

4）创建一个 `VisualEditor.ts` 模块来封装所有与可视化编辑相关的复杂逻辑。它负责在进入编辑模式时向`iframe`注入脚本。注入的脚本会监听 `click` 事件，为被点击的元素生成一个唯一的CSS选择器路径，然后通过 `postMessage` 将元素信息发送回父页面。父页面监听`message`事件，接收并展示被选中元素的信息。当用户提交修改时，前端会将选中的元素信息与用户的自然语言指令拼接成一个更丰富的 Prompt。后端 AI 接收到这个 Prompt 后，就能更精确地理解修改的上下文。

5）在后端处理层面，最初的实现遇到了问题。测试发现，AI 在收到修改指令后，只返回了被修改代码的片段。导致后端在保存文件时，用这个文本片段覆盖了整个网站的 HTML 代码，导致页面完全损坏。为了解决这个问题，我们优化了系统提示词，在原生 HTML 和多文件模式的 Prompt 中都增加了严格约束AI必须始终输出包含完整页面代码的一个或多个代码块，确保修改文件的完整性。

6）对于 Vue 工程这类更复杂的项目，全量返回所有文件内容是不现实的。所以我们设计了增量修改方案，利用AI的工具调用能力，为 AI 提供了一系列更精细的文件操作工具，包括：读取单个文件、递归获取目录结构、删除单个文件以及修改单个文件。同时，我们再次修改了 Vue 工程模式的系统提示词，引导 AI 在执行修改任务时，必须先使用工具读取和理解现有代码，然后利用文件修改工具进行精确的内容替换。

通过这种分层解决方案，平台最终实现了对不同复杂度应用的高效且稳定的可视化修改能力。
