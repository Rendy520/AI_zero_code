
# 如果要为平台增加多人实时协作编辑同一个应用的功能，你会怎么做？

增加多人实时协作编辑功能，我会基于 WebSocket 技术来构建一个事件驱动的实时通信架构。这种架构能够保证低延迟和双向通信，是实现协同编辑的标准方案。

具体实现思路如下：

1）技术选型：选用WebSocket。与SSE的单向推送不同，WebSocket提供全双工通信，客户端和服务端能随时互相发送消息，对于需要双向同步操作的协同编辑来说非常重要。

2）后端设计：

-   使用 Spring Boot 集成 WebSocket，创建一个专门处理协同编辑消息的端点。当用户进入某个应用的协作模式时，前端会与该端点建立 WebSocket 连接。
-   后端需要维护一个会话池，按 `appId` 对连接进行分组。这样，当一个用户对某个应用进行修改时，后端可以将更新消息广播给所有正在协作此应用的其他用户。
-   为了避免复杂的实时合并算法和数据冲突，还需要一个合适的“编辑锁”机制。同一时间只允许一个用户获得某个元素或代码块的编辑权，其他用户在此期间只能作为观察者接收更新。当持锁用户完成编辑或断开连接时，锁被释放，其他用户可以申请获得。
-   事件驱动模型：用户的每一个修改操作都会被封装成一个编辑事件。后端接收到这个事件后，完成对应用文件的修改，然后将一个更新事件广播给该`appId`下的所有客户端。

3）前端设计：

-   当用户进入协作模式时，前端初始化WebSocket客户端，连接到后端服务。
-   前端需要监听来自服务器的`onmessage`事件。收到更新事件后，前端会相应地更新界面，最直接的方式是重新加载预览`iframe`，展示其他协作者修改后的最新网站状态。
-   当用户执行一个编辑操作时，前端会构建一个包含操作类型和数据的事件消息，通过 WebSocket 发送给服务器。
-   前端 UI 需要根据是否持有编辑锁来动态切换。比如，当未获得锁时，输入框和编辑按钮应被禁用，只显示他人的操作结果。

4）数据一致性：所有修改都实际在后端执行，后端负责修改存储在服务器上的代码文件，作为数据的唯一来源，前端的实时更新只是对后端状态变化的一个响应式展现。
