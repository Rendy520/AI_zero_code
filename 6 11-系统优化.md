---
created: 2025-12-29T15:55:06 (UTC +08:00)
tags: [,Java,Python,JavaScript,å‰ç«¯,Cè¯­è¨€,C++,Goè¯­è¨€,ç¨‹åºå‘˜,ç¼–ç¨‹å­¦ä¹ ,ITæ•™ç¨‹,è‡ªå­¦ç¼–ç¨‹,è½¯ä»¶å¼€å‘,é¡¹ç›®å®æˆ˜,ç¼–ç¨‹å¯¼èˆª,å¼€å‘è€…äº¤æµç¤¾åŒº,ç¼–ç¨‹èµ„æº,è®¡ç®—æœº]
source: https://www.codefather.cn/course/1948291549923344386/section/1955850416717950978
author: 
---

# 11 - ç³»ç»Ÿä¼˜åŒ– - ã€å¤§å‚å¿…å¤‡ã€‘LangChain4j + å·¥ä½œæµ

> ## Excerpt
> æœ¬èŠ‚é‡ç‚¹ ä»»ä½•é¡¹ç›®éƒ½æ˜¯å…ˆå®Œæˆå†å®Œç¾ï¼Œç»è¿‡çš„å­¦ä¹ ï¼Œæˆ‘ä»¬çš„ AI é›¶ä»£ç åº”ç”¨ç”Ÿæˆå¹³å°å·²ç»å…·å¤‡äº†å®Œæ•´çš„åŠŸèƒ½ã€‚ä½†æ˜¯ï¼Œä½œä¸ºä¸€ä¸ªæœ‰è¿½æ±‚çš„ç¨‹åºå‘˜ï¼Œæ€ä¹ˆèƒ½æ»¡è¶³äº â€œèƒ½è·‘å°±è¡Œâ€ å‘¢ï¼Ÿè¿™ä¸€èŠ‚å’±ä»¬å°±ä»å¤šä¸ªç»´åº¦å¯¹ã€‚ç¼–ç¨‹å¯¼èˆªæ•™ç¨‹åˆ†äº«ï¼Œåšæ‚¨ç¼–ç¨‹å­¦ä¹ è·¯ä¸Šçš„å¯¼èˆªå‘˜ã€‚

---
## æœ¬èŠ‚é‡ç‚¹

ä»»ä½•é¡¹ç›®éƒ½æ˜¯å…ˆå®Œæˆå†å®Œç¾ï¼Œç»è¿‡çš„å­¦ä¹ ï¼Œæˆ‘ä»¬çš„ AI é›¶ä»£ç åº”ç”¨ç”Ÿæˆâ å¹³å°å·²ç»å…·å¤‡äº†å®Œæ•´çš„åŠŸèƒ½ã€‚ä½†æ˜¯ï¼Œä½œä¸ºä¸€ä¸ªæœ‰è¿½â æ±‚çš„ç¨‹åºå‘˜ï¼Œæ€ä¹ˆèƒ½æ»¡è¶³äº â€œèƒ½è·‘å°±è¡Œâ€ å‘¢ï¼Ÿè¿™ä¸€èŠ‚å’±ä»¬å°±ä»å¤šä¸ªç»´åº¦å¯¹ç³»ç»Ÿè¿›è¡Œå…¨é¢ä¼˜åŒ–ï¼Œè®©å®ƒä»ç©å…·é¡¹ç›®çœŸæ­£èœ•å˜ä¸ºç”Ÿäº§çº§åˆ«çš„åº”ç”¨ã€‚

æœ¬èŠ‚å°†ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢è¿›è¡Œç³»ç»Ÿä¼˜åŒ–ï¼š

-   æ€§èƒ½ä¼˜åŒ–ï¼š
    
    -   AI å¹¶å‘è°ƒç”¨ï¼šè§£å†³ç›®å‰åªèƒ½åŒæ—¶å¤„ç†ä¸€ä¸ª AI è¯·æ±‚çš„ç“¶é¢ˆé—®é¢˜
    -   Redis ç¼“å­˜ï¼šé€šè¿‡ç¼“å­˜ä¸»é¡µç²¾é€‰å†…å®¹æå‡å“åº”é€Ÿåº¦
-   å®æ—¶æ€§ä¼˜åŒ–ï¼š
    
    -   å®æ—¶æµè§ˆï¼šç¡®ä¿ç”¨æˆ·ç”Ÿæˆç½‘ç«™åèƒ½ç«‹åˆ»çœ‹åˆ°æœ€æ–°æ•ˆæœ
-   å®‰å…¨æ€§ä¼˜åŒ–ï¼š
    
    -   æµé‡ä¿æŠ¤ï¼šä¸º AI å¯¹è¯æ¥å£å®ç°é™æµé™é¢‘æœºåˆ¶
    -   Prompt å®¡æŸ¥ï¼šé˜²èŒƒæ¶æ„è¾“å…¥å’Œæ³¨å…¥æ”»å‡»
-   ç¨³å®šæ€§ä¼˜åŒ–ï¼š
    
    -   é‡è¯•ç­–ç•¥ï¼šé€šè¿‡æŠ¤è½¨æœºåˆ¶æå‡ç³»ç»Ÿå®¹é”™èƒ½åŠ›
    -   å·¥å…·è°ƒç”¨ä¼˜åŒ–ï¼šè§£å†³ AI å·¥å…·è°ƒç”¨çš„æ— é™å¾ªç¯é—®é¢˜
-   æˆæœ¬ä¼˜åŒ–ï¼š
    
    -   AI å¤§æ¨¡å‹æˆæœ¬æ§åˆ¶ï¼šæ ¹æ®ä¸åŒåœºæ™¯é€‰æ‹©åˆé€‚çš„æ¨¡å‹

## ä¸€ã€æ€§èƒ½ä¼˜åŒ–

### AI å¹¶å‘è°ƒç”¨é—®é¢˜

#### é—®é¢˜åˆ†æ

åœ¨å®é™…ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å‘ç°äº†ä¸€ä¸ªä¸¥é‡çš„æ€§èƒ½ç“¶é¢ˆï¼šå½“å¤šâ ä¸ªç”¨æˆ·åŒæ—¶ä½¿ç”¨å¹³å°æ—¶ï¼Œåªæœ‰ç¬¬ä¸€ä¸ªç”¨â æˆ·çš„ AI è¯·æ±‚èƒ½å¤Ÿæ­£å¸¸å¤„ç†ï¼Œåç»­çš„è¯·æ±‚éƒ½ä¼šè¢«é˜»å¡ï¼Œéœ€è¦ç­‰å¾…å‰é¢çš„è¯·æ±‚å®Œå…¨å¤„ç†å®Œæ¯•åæ‰èƒ½å¼€å§‹æ‰§è¡Œã€‚

ç”¨æˆ·é‡è¾ƒå°‘æ—¶å¯èƒ½ä¸å¤ªæ˜æ˜¾ï¼Œä½†éšç€å¹³å°ç”¨æˆ·çš„å¢é•¿ï¼Œè¿™ä¸ªé—®é¢˜ä¼šå˜å¾—è¶Šå‘ä¸¥â é‡ã€‚æƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœæœ‰ 10 ä¸ªç”¨æˆ·åŒæ—¶æƒ³è¦ç”Ÿæˆç½‘ç«™ï¼Œâ ç¬¬ 10 ä¸ªç”¨æˆ·å¯èƒ½éœ€è¦ç­‰å¾…å‡ åˆ†é’Ÿä»¥ä¸Šæ‰èƒ½çœ‹åˆ° AI å¼€å§‹å“åº”ï¼Œè‚¯å®šä¸è¡Œâ€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‰â€‰â€‰â€‰â€‰â€‚â€‰â€‰â€‰â€‰â€‚â€‚â€‚â€‰â€‚â€‚

é‚£ä¹ˆï¼Œè¿™ä¸ªé—®é¢˜çš„æ ¹æºåœ¨å“ªé‡Œå‘¢ï¼Ÿ

ç»è¿‡åˆ†æï¼Œå‘ç°é—®é¢˜å‡ºåœ¨ AI å¤§æ¨¡å‹çš„ `ChatModel` é‡‡ç”¨äº†å•ä¾‹æ¨¡å¼ã€‚è™½ç„¶ `StreamingChatModel` è¿”å›çš„æ˜¯ Flux å“åº”å¼æµï¼Œè¡¨é¢ä¸Šçœ‹èµ·æ¥æ˜¯å¼‚æ­¥çš„ï¼Œä½†å…¶åº•å±‚çš„ `SpringRestClient.execute()` æ–¹æ³•å†…éƒ¨å®é™…ä¸Šæ˜¯åŒæ­¥è§£ææ•°æ®æµçš„ï¼Œå¯¼è‡´äº†ä¸²è¡Œæ‰§è¡Œé—®é¢˜ã€‚

å®Œæ•´è°ƒç”¨é“¾å¦‚å›¾ï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/Bfme5jUmFhwLzknW.webp)

ä¸ºäº†éªŒè¯è¿™ä¸ªåˆ†æï¼Œæˆ‘å†™äº†ä¸ªå•å…ƒæµ‹è¯•ï¼Œå‘ç°å³ä½¿æ˜¯ä¸åŒçš„ AI Service å®ä¾‹ï¼Œåªè¦ä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ª `ChatModel`ï¼Œä¾ç„¶ä¼šå‡ºç°é˜»å¡ç°è±¡ã€‚

#### è§£å†³æ–¹æ¡ˆ - å¤šä¾‹æ¨¡å¼

å¯»æ‰¾è§£å†³æ–¹æ¡ˆçš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘å‘ç° LangChain4j å®˜æ–¹æåˆ°ï¼Œä½¿ç”¨ä¸åŒçš„å¯¹è¯è®°å¿† id å°±èƒ½è§£å†³å¹¶å‘é—®é¢˜ï¼ˆå‚è€ƒ [GitHub Issue #2755](https://github.com/langchain4j/langchain4j/issues/2755)ï¼‰ã€‚ä½†å…¶å®è¿™åªæ˜¯ä¸€ä¸ªæ•·è¡çš„å›ç­”ï¼Œç»è¿‡å®é™…æµ‹è¯•ï¼Œæˆ‘ä»¬å‘ç°ä½¿ç”¨ä¸åŒçš„ id è™½ç„¶èƒ½å¤ŸåŒºåˆ†ä¸åŒç”¨æˆ·çš„å¯¹è¯ï¼Œä½†å¹¶æ²¡æœ‰è§£å†³å¹¶å‘é˜»å¡çš„æ ¸å¿ƒé—®é¢˜ã€‚

æ‰€ä»¥è§£å†³é—®é¢˜çš„å…³é”®å°±æ˜¯ï¼š**å“ªå„¿é˜»å¡ï¼Œå°±é’ˆå¯¹å“ªå„¿è§£å†³ã€‚**

å¯ä»¥ä¸ºæ¯æ¬¡ AI Serviâ ce è°ƒç”¨ä½¿ç”¨ç‹¬ç«‹â ç”Ÿæˆçš„ ChatModel å®ä¾‹ã€‚

æœ‰ 2 ç§å…·ä½“çš„æ–¹æ³•ï¼š

1.  å·¥å‚æ¨¡å¼ï¼šç¼–å†™ä¸€ä¸ªä¸“é—¨çš„å·¥å‚ç±»ï¼Œæä¾›åˆ›å»ºæ–° ChatModel å®ä¾‹çš„æ–¹æ³•
2.  Spring å¤šä¾‹æ¨¡å¼ï¼šåˆ©ç”¨ Spring çš„ Bean ä½œç”¨åŸŸæœºåˆ¶ï¼Œä» Spring å®¹å™¨ä¸­è·å–æ–°çš„ ChatModel å®ä¾‹

ä¹‹å‰æˆ‘ä»¬å·²ç»å­¦ä¹ è¿‡å·¥å‚æ–¹æ¡ˆï¼Œæ­¤å¤„é€‰æ‹© Spriâ ng å¤šä¾‹æ¨¡å¼å®ç°ã€‚å®ƒæ›´ç¬¦åˆ â Spring çš„è®¾è®¡ç†å¿µå’Œæœ€ä½³å®è·µï¼Œè€Œä¸”ä»£ç å®ç°æ›´åŠ ç®€æ´ï¼ˆä¸ç”¨å¼€å‘æ–°çš„ç±»ï¼‰ï¼Œç»´æŠ¤æˆæœ¬ä¹Ÿæ›´ä½ã€‚

#### å¼€å‘å®ç°

1ï¼‰å‡†å¤‡é…ç½®æ–‡ä»¶

é¦–å…ˆï¼Œåœ¨é…ç½®æ–‡ä»¶ä¸­ä¸ºä¸åŒç±»å‹çš„ Aâ I æ¨¡å‹æ·»åŠ ä¸“é—¨çš„é…ç½®â å‚æ•°ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯å¯ä»¥æ ¹æ®ä¸åŒçš„ä½¿ç”¨åœºæ™¯é€‰æ‹©æœ€é€‚åˆçš„æ¨¡å‹é…ç½®ï¼š

```yaml
# AI æ¨¡å‹é…ç½®
langchain4j:
  open-ai:
    # æ¨ç† AI æ¨¡å‹é…ç½®ï¼ˆç”¨äºå¤æ‚çš„æ¨ç†ä»»åŠ¡ï¼‰
    reasoning-streaming-chat-model:
      base-url: https://api.deepseek.com
      api-key: <Your API Key>
      model-name: deepseek-reasoner
      max-tokens: 32768
      temperature: 0.1
      log-requests: true
      log-responses: true
    # æ™ºèƒ½è·¯ç”± AI æ¨¡å‹é…ç½®ï¼ˆç”¨äºç®€å•çš„åˆ†ç±»ä»»åŠ¡ï¼‰
    routing-chat-model:
      base-url: https://api.deepseek.com
      api-key: <Your API Key>
      model-name: deepseek-chat
      log-requests: true
      log-responses: true
```

æ¨ç†æ¨¡å‹ç”¨äºå¤æ‚çš„ä»£ç ç”Ÿæˆä»»åŠ¡ï¼Œè·¯â ç”±æ¨¡å‹ç”¨äºç®€å•çš„åˆ†ç±»â åˆ¤æ–­ã€‚è¿™ç§åˆ†å±‚è®¾è®¡æ—¢ä¿è¯äº†åŠŸèƒ½çš„å®Œæ•´æ€§ï¼Œåˆä¸ºåç»­çš„æˆæœ¬ä¼˜åŒ–æ‰“ä¸‹äº†åŸºç¡€ã€‚

ğŸ’¡ æ³¨æ„è¿™é‡Œæˆ‘ä»¬ä¸ºä¸åŒçš„æ¨¡å‹è®¾ç½®äº†ä¸åŒçš„å‚æ•°ã€‚æ¨ç†æ¨¡â å‹ä½¿ç”¨æ›´é«˜çš„ max-tokens â å’Œæ›´ä½çš„ temperature æ¥ä¿è¯è¾“å‡ºçš„ç¨³å®šæ€§ï¼›è·¯ç”±æ¨¡å‹åˆ™ç›¸å¯¹ç®€åŒ–é…ç½®ï¼Œå› ä¸ºå®ƒä¸»è¦ç”¨äºç®€å•çš„åˆ†ç±»ä»»åŠ¡ã€‚

2ï¼‰åˆ›å»ºå¤šä¾‹é…ç½®ç±»

éœ€è¦ä¸ºæ¯ç§æ¨¡å‹åˆ›å»ºå¯¹åº”çš„é…ç½®ç±»ã€‚è¿™é‡Œçš„å…³é”®æ˜¯ä½¿ç”¨ `@Scope("prototype")` æ³¨è§£ï¼Œå®ƒå‘Šè¯‰ Spring å®¹å™¨æ¯æ¬¡è·å– Bean æ—¶éƒ½åˆ›å»ºä¸€ä¸ªå…¨æ–°çš„å®ä¾‹ï¼Œè€Œä¸æ˜¯å¤ç”¨å•ä¾‹ã€‚

åœ¨ `config` åŒ…ä¸‹ç¼–å†™é€šç”¨æµå¼èŠå¤©æ¨¡å‹é…ç½®ï¼š

```java
@Configuration
@ConfigurationProperties(prefix = "langchain4j.open-ai.streaming-chat-model")
@Data
public class StreamingChatModelConfig {

    private String baseUrl;

    private String apiKey;

    private String modelName;

    private Integer maxTokens;

    private Double temperature;

    private boolean logRequests;

    private boolean logResponses;

    @Bean
    @Scope("prototype")
    public StreamingChatModel streamingChatModelPrototype() {
        return OpenAiStreamingChatModel.builder()
                .apiKey(apiKey)
                .baseUrl(baseUrl)
                .modelName(modelName)
                .maxTokens(maxTokens)
                .temperature(temperature)
                .logRequests(logRequests)
                .logResponses(logResponses)
                .build();
    }
}
```

æ¨ç†ä¸“ç”¨æµå¼æ¨¡å‹é…ç½®ï¼š

```java
@Configuration
@ConfigurationProperties(prefix = "langchain4j.open-ai.reasoning-streaming-chat-model")
@Data
public class ReasoningStreamingChatModelConfig {

    private String baseUrl;

    private String apiKey;

    private String modelName;

    private Integer maxTokens;

    private Double temperature;

    private Boolean logRequests = false;

    private Boolean logResponses = false;

    @Bean
    @Scope("prototype")
    public StreamingChatModel reasoningStreamingChatModelPrototype() {
        return OpenAiStreamingChatModel.builder()
                .apiKey(apiKey)
                .baseUrl(baseUrl)
                .modelName(modelName)
                .maxTokens(maxTokens)
                .temperature(temperature)
                .logRequests(logRequests)
                .logResponses(logResponses)
                .build();
    }
}
```

æ™ºèƒ½è·¯ç”±ä¸“ç”¨æ¨¡å‹é…ç½®ï¼š

```java
@Configuration
@ConfigurationProperties(prefix = "langchain4j.open-ai.routing-chat-model")
@Data
public class RoutingAiModelConfig {

    private String baseUrl;

    private String apiKey;

    private String modelName;

    private Integer maxTokens;

    private Double temperature;

    private Boolean logRequests = false;

    private Boolean logResponses = false;

    /**
     * åˆ›å»ºç”¨äºè·¯ç”±åˆ¤æ–­çš„ChatModel
     */
    @Bean
    @Scope("prototype")
    public ChatModel routingChatModelPrototype() {
        return OpenAiChatModel.builder()
                .apiKey(apiKey)
                .modelName(modelName)
                .baseUrl(baseUrl)
                .maxTokens(maxTokens)
                .temperature(temperature)
                .logRequests(logRequests)
                .logResponses(logResponses)
                .build();
    }
}
```

3ï¼‰ä¿®æ”¹å·¥å‚ç±»

æ›´æ–° `AiCodeGeneratorServiceFactory` ç±»ï¼Œè®©å®ƒæ ¹æ®ä»£ç ç”Ÿæˆç±»å‹é€‰æ‹©ä¸åŒçš„æ¨¡å‹é…ç½®ï¼š

```java
// æ ¹æ®ä»£ç ç”Ÿæˆç±»å‹é€‰æ‹©ä¸åŒçš„æ¨¡å‹é…ç½®
return switch (codeGenType) {
    case VUE_PROJECT -> {
        // ä½¿ç”¨å¤šä¾‹æ¨¡å¼çš„ StreamingChatModel è§£å†³å¹¶å‘é—®é¢˜
        StreamingChatModel reasoningStreamingChatModel = SpringContextUtil.getBean("reasoningStreamingChatModelPrototype", StreamingChatModel.class);
        yield AiServices.builder(AiCodeGeneratorService.class)
                .streamingChatModel(reasoningStreamingChatModel)
                .chatMemoryProvider(memoryId -> chatMemory)
                .tools(toolManager.getAllTools())
                .hallucinatedToolNameStrategy(toolExecutionRequest -> ToolExecutionResultMessage.from(
                        toolExecutionRequest, "Error: there is no tool called " + toolExecutionRequest.name()
                ))
                .build();
    }
    case HTML, MULTI_FILE -> {
        // ä½¿ç”¨å¤šä¾‹æ¨¡å¼çš„ StreamingChatModel è§£å†³å¹¶å‘é—®é¢˜
        StreamingChatModel openAiStreamingChatModel = SpringContextUtil.getBean("streamingChatModelPrototype", StreamingChatModel.class);
        yield AiServices.builder(AiCodeGeneratorService.class)
                .chatModel(chatModel)
                .streamingChatModel(openAiStreamingChatModel)
                .chatMemory(chatMemory)
                .build();
    }
    default -> throw new BusinessException(ErrorCode.SYSTEM_ERROR,
            "ä¸æ”¯æŒçš„ä»£ç ç”Ÿæˆç±»å‹: " + codeGenType.getValue());
};
```

åŒæ—¶ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºæ‰€æœ‰åŸæœ¬æ³¨å…¥ `ChatModel` çš„åœ°æ–¹æŒ‡å®šå…·ä½“çš„ Bean åç§°ï¼Œé¿å…å†²çªï¼š

```java
@Resource(name = "openAiChatModel")
private ChatModel chatModel;
```

è¿™æ ·ä¿®æ”¹åï¼Œæ¯ä¸ª AI æœåŠ¡å®ä¾‹éƒ½ä¼šè·å¾—ç‹¬ç«‹çš„ `StreamingChatModel`ï¼Œä»è€Œå½»åº•è§£å†³å¹¶å‘é˜»å¡é—®é¢˜ã€‚

4ï¼‰æ›´æ–°æ™ºèƒ½è·¯ç”±æœåŠ¡

åŒæ ·çš„æ€è·¯ï¼Œæ›´æ–°æ™ºèƒ½è·¯ç”± AI æœåŠ¡å·¥å‚ç±»ï¼š

```java
@Slf4j
@Configuration
public class AiCodeGenTypeRoutingServiceFactory {

    /**
     * åˆ›å»ºAIä»£ç ç”Ÿæˆç±»å‹è·¯ç”±æœåŠ¡å®ä¾‹
     */
    public AiCodeGenTypeRoutingService createAiCodeGenTypeRoutingService() {
        // åŠ¨æ€è·å–å¤šä¾‹çš„è·¯ç”± ChatModelï¼Œæ”¯æŒå¹¶å‘
        ChatModel chatModel = SpringContextUtil.getBean("routingChatModelPrototype", ChatModel.class);
        return AiServices.builder(AiCodeGenTypeRoutingService.class)
                .chatModel(chatModel)
                .build();
    }

    /**
     * é»˜è®¤æä¾›ä¸€ä¸ª Bean
     */
    @Bean
    public AiCodeGenTypeRoutingService aiCodeGenTypeRoutingService() {
        return createAiCodeGenTypeRoutingService();
    }
}
```

ç›¸åº”åœ°ï¼Œè°ƒç”¨æ™ºèƒ½è·¯ç”±æœåŠ¡çš„åœ°â æ–¹ä¹Ÿéœ€è¦è°ƒæ•´è·å–â é€»è¾‘ã€‚æ¯”å¦‚ AppServiceImpl ä¸­çš„è°ƒç”¨ï¼š

```java
@Resource
private AiCodeGenTypeRoutingServiceFactory aiCodeGenTypeRoutingServiceFactory;

@Override
public Long createApp(AppAddRequest appAddRequest, User loginUser) {
    // å‚æ•°æ ¡éªŒ
    String initPrompt = appAddRequest.getInitPrompt();
    ThrowUtils.throwIf(StrUtil.isBlank(initPrompt), ErrorCode.PARAMS_ERROR, "åˆå§‹åŒ– prompt ä¸èƒ½ä¸ºç©º");
    // ä½¿ç”¨ AI æ™ºèƒ½é€‰æ‹©ä»£ç ç”Ÿæˆç±»å‹ï¼ˆå¤šä¾‹æ¨¡å¼ï¼‰
    AiCodeGenTypeRoutingService routingService = aiCodeGenTypeRoutingServiceFactory.createAiCodeGenTypeRoutingService();
    CodeGenTypeEnum selectedCodeGenType = routingService.routeCodeGenType(initPrompt);
    // ... å…¶ä»–ä¸šåŠ¡é€»è¾‘
}
```

è¿˜æœ‰ RouterNode ä¸­çš„è°ƒç”¨ï¼š

```java
// è·å–AIè·¯ç”±æœåŠ¡å·¥å‚å¹¶åˆ›å»ºæ–°çš„è·¯ç”±æœåŠ¡å®ä¾‹
AiCodeGenTypeRoutingServiceFactory factory = SpringContextUtil.getBean(AiCodeGenTypeRoutingServiceFactory.class);
AiCodeGenTypeRoutingService routingService = factory.createAiCodeGenTypeRoutingService();
```

#### æµ‹è¯•éªŒè¯

ç¼–å†™ä¸€ä¸ªä¸“é—¨çš„å¹¶å‘æµ‹è¯•ç±»ï¼Œä½¿â ç”¨ Java 21â  çš„è™šæ‹Ÿçº¿ç¨‹ç‰¹æ€§å®ç°å¹¶å‘ï¼š

```java
@Slf4j
@SpringBootTest
public class AiConcurrentTest {

    @Resource
    private AiCodeGenTypeRoutingServiceFactory routingServiceFactory;

    @Test
    public void testConcurrentRoutingCalls() throws InterruptedException {
        String[] prompts = {
                "åšä¸€ä¸ªç®€å•çš„HTMLé¡µé¢",
                "åšä¸€ä¸ªå¤šé¡µé¢ç½‘ç«™é¡¹ç›®",
                "åšä¸€ä¸ªVueç®¡ç†ç³»ç»Ÿ"
        };
        // ä½¿ç”¨è™šæ‹Ÿçº¿ç¨‹å¹¶å‘æ‰§è¡Œ
        Thread[] threads = new Thread[prompts.length];
        for (int i = 0; i < prompts.length; i++) {
            final String prompt = prompts[i];
            final int index = i + 1;
            threads[i] = Thread.ofVirtual().start(() -> {
                AiCodeGenTypeRoutingService service = routingServiceFactory.createAiCodeGenTypeRoutingService();
                var result = service.routeCodeGenType(prompt);
                log.info("çº¿ç¨‹ {}: {} -> {}", index, prompt, result.getValue());
            });
        }
        // ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
        for (Thread thread : threads) {
            thread.join();
        }
    }
}
```

å‰é¢ä¹Ÿè®²è¿‡ï¼Œè™šæ‹Ÿçº¿ç¨‹æ˜¯ Java 19 å¼•å…¥çš„é¢„è§ˆç‰¹æ€§ï¼Œåœ¨ â Java 21 ä¸­æ­£å¼å‘å¸ƒã€‚ä¸ä¼ ç»Ÿçº¿ç¨‹ç›¸â æ¯”ï¼Œè™šæ‹Ÿçº¿ç¨‹æ›´åŠ è½»é‡çº§ï¼Œå¯ä»¥åˆ›å»ºæ•°ç™¾ä¸‡ä¸ªå®ä¾‹è€Œä¸ä¼šå¯¹ç³»ç»Ÿé€ æˆå¤ªå¤§è´Ÿæ‹…ï¼Œéå¸¸é€‚åˆ I/O å¯†é›†å‹ä»»åŠ¡çš„å¹¶å‘æµ‹è¯•ã€‚

è¿è¡Œè¿™ä¸ªæµ‹è¯•åï¼Œå¯ä»¥è§‚å¯Ÿåˆ°å‡ ä¹æ‰€æœ‰â çš„ AI è°ƒç”¨éƒ½æ˜¯åŒæ—¶â å®Œæˆçš„ï¼Œè¿™è¯´æ˜å¤šä¸ªçº¿ç¨‹èƒ½å¤Ÿå¹¶è¡Œå¤„ç† AI è¯·æ±‚ï¼Œå¹¶å‘é˜»å¡é—®é¢˜å¾—åˆ°äº†è§£å†³ã€‚

![](https://pic.code-nav.cn/course_picture/1608440217629360130/xDmc9o0p5MlnIugf.webp)

è¿˜å¯ä»¥é€šè¿‡å‰ç«¯åŒæ—¶å‘èµ·å¤šä¸ªå¯¹è¯æ¥è¿›ä¸€æ­¥éªŒè¯æ•ˆæœï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/BBY0Bqjiztz1hXzl.webp)

### Redis ç¼“å­˜ä¼˜åŒ–

è§£å†³äº†å¹¶å‘é—®é¢˜åï¼Œæˆ‘ä»¬ç»§ç»­ä¼˜åŒ–ç³»ç»Ÿçš„â å“åº”é€Ÿåº¦ã€‚å¯¹äºé‚£äº›è®¿é—®é¢‘â ç‡é«˜ä½†æ›´æ–°é¢‘ç‡ä½çš„æ•°æ®ï¼Œä½¿ç”¨ç¼“å­˜å¯ä»¥æ˜¾è‘—å‡å°‘æ•°æ®åº“æŸ¥è¯¢æ¬¡æ•°ï¼Œæå‡ç”¨æˆ·ä½“éªŒã€‚

#### ç¼“å­˜ç­–ç•¥è®¾è®¡

è®¾è®¡ç¼“å­˜æ—¶ä¸€èˆ¬è€ƒè™‘å‡ ä¸ªé—®é¢˜ï¼šâ å­˜ä»€ä¹ˆï¼Ÿæ€ä¹ˆå­˜ï¼Ÿå­˜â å¤šä¹…ï¼Ÿæ€ä¹ˆæ›´æ–°ï¼Ÿ

**ä¸€èˆ¬ç¼“å­˜é«˜é¢‘è®¿é—®çš„ã€ä½é¢‘æ›´æ–°çš„æ•°æ®ã€‚**

æ¯”å¦‚å¯¹äºæˆ‘ä»¬çš„é¡¹ç›®ï¼Œä¸»é¡µç²¾é€‰åº”ç”¨å°±å¾ˆé€‚åˆç¼“å­˜ã€‚å…·ä½“æ¥è¯´å°±æ˜¯ç¼“â å­˜å‰ 10 é¡µçš„ç²¾é€‰åº”ç”¨åˆ—è¡¨æ•°æ®ã€‚å› ä¸ºç»â å¤§å¤šæ•°ç”¨æˆ·åªä¼šæµè§ˆå‰å‡ é¡µçš„å†…å®¹ï¼Œå¾ˆå°‘æœ‰äººä¼šç¿»åˆ°ç¬¬ 10 é¡µä»¥åï¼›è€Œä¸”ç²¾é€‰åº”ç”¨æ˜¯ç”±ç®¡ç†å‘˜æ‰‹åŠ¨è®¾ç½®çš„ï¼Œæ›´æ–°é¢‘ç‡ç›¸å¯¹è¾ƒä½ã€‚

å¯¹äºè¿™ç§åœºæ™¯ï¼Œæˆ‘ä»¬é‡‡ç”¨æœ€ä¸»æµçš„ **æ—è·¯ç¼“å­˜** æ¨¡å¼ï¼š

-   æŸ¥è¯¢æ—¶å…ˆæ£€æŸ¥ç¼“å­˜ï¼Œå‘½ä¸­åˆ™ç›´æ¥è¿”å›
-   ç¼“å­˜æœªå‘½ä¸­åˆ™æŸ¥è¯¢æ•°æ®åº“ï¼Œå¹¶å°†ç»“æœå†™å…¥ç¼“å­˜
-   è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´ï¼Œæ— éœ€ä¸»åŠ¨åˆ é™¤ç¼“å­˜

![](https://pic.code-nav.cn/course_picture/1608440217629360130/i5kDFnP2JUSgWlT9.webp)

è€Œ Spring Data â Redis ç»„ä»¶æâ ä¾›çš„ç¼“å­˜æ³¨è§£ï¼Œæ­£å¥½èƒ½å¤Ÿæ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ï¼Œä¸‹é¢æˆ‘ä»¬å°±æ¥å¼€å‘å®ç°ã€‚

ğŸ’¡ é™¤äº†æ—è·¯ç¼“å­˜æ¨¡å¼å¤–ï¼Œå¸¸ç”¨çš„ç¼“å­˜è¯»å†™ç­–ç•¥è¿˜æœ‰è¯»å†™ç©¿é€ã€å¼‚æ­¥ç¼“å­˜å†™å…¥ã€‚å¯ä»¥çœ‹è¿™é“ç»å…¸é¢è¯•é¢˜æ¥å­¦ä¹ ï¼š[Redis ä¸­çš„ä¸‰ç§é«˜æ•ˆç¼“å­˜è¯»å†™ç­–ç•¥æ˜¯ä»€ä¹ˆï¼Ÿ](https://www.mianshiya.com/question/1776560599812018178#)

æ­¤å¤–ï¼Œä½¿ç”¨ç¼“å­˜æ—¶ï¼Œæœ‰ä¸€äº›æ³¨æ„äº‹é¡¹ï¼Œå¯ä»¥çœ‹è¿™é“ç»å…¸é¢è¯•é¢˜æ¥å­¦ä¹ ï¼š[Redis ä¸­çš„ç¼“å­˜å‡»ç©¿ã€ç¼“å­˜ç©¿é€å’Œç¼“å­˜é›ªå´©æ˜¯ä»€ä¹ˆï¼Ÿ](https://www.mianshiya.com/question/1780933295672946690)

#### å¼€å‘å®ç°

1ï¼‰é¦–å…ˆç¡®ä¿ Redis é…ç½®æ­£ç¡®

ä¹‹å‰æˆ‘ä»¬åœ¨å¼•å…¥ `spring-session-data-redis` æ—¶å·²ç»è‡ªåŠ¨å¼•å…¥äº† `spring-data-redis`ï¼Œæ‰€ä»¥ä¸éœ€è¦é¢å¤–æ·»åŠ ä¾èµ–ã€‚

æ£€æŸ¥é…ç½®æ–‡ä»¶ä¸­çš„ Redis è¿æ¥ä¿¡æ¯ï¼š

```yaml
spring:
  data:
    redis:
      host: localhost
      port: 6379
      database: 0
      password:
      ttl: 3600  # ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰
```

2ï¼‰ç¼“å­˜å·¥å…·ç±»å®ç°

ä¸ºäº†ç”Ÿæˆä¸€è‡´ä¸”å”¯ä¸€çš„ç¼“å­˜é”®ï¼Œåœ¨ `utils` åŒ…ä¸‹åˆ›å»ºä¸€ä¸ªä¸“é—¨çš„ç¼“å­˜å·¥å…·ç±»ã€‚ç¼“å­˜é”®çš„ç”Ÿæˆæ€è·¯æ˜¯å°†å¤æ‚çš„å¯¹è±¡è½¬æ¢ä¸ºå›ºå®šé•¿åº¦çš„å“ˆå¸Œå€¼ï¼Œè¿™æ ·æ—¢ä¿è¯äº†ä¸åŒæŸ¥è¯¢è¯·æ±‚çš„ key å”¯ä¸€ï¼Œåˆé¿å…äº† key è¿‡é•¿çš„é—®é¢˜ï¼š

```java
/**
 * ç¼“å­˜ key ç”Ÿæˆå·¥å…·ç±»
 *
 * @author yupi
 */
public class CacheKeyUtils {

    /**
     * æ ¹æ®å¯¹è±¡ç”Ÿæˆç¼“å­˜key (JSON + MD5)
     *
     * @param obj è¦ç”Ÿæˆkeyçš„å¯¹è±¡
     * @return MD5å“ˆå¸Œåçš„ç¼“å­˜key
     */
    public static String generateKey(Object obj) {
        if (obj == null) {
            return DigestUtil.md5Hex("null");
        }
        // å…ˆè½¬JSONï¼Œå†MD5
        String jsonStr = JSONUtil.toJsonStr(obj);
        return DigestUtil.md5Hex(jsonStr);
    }
}
```

è¿™ä¸ªå·¥å…·ç±»ä¸»è¦ä½¿ç”¨ Hutool å·¥å…·åº“å®ç°ï¼Œå‡ ä¸ªè¦ç‚¹ï¼š

1.  JSON åºåˆ—åŒ–ï¼šç¡®ä¿å¯¹è±¡å†…å®¹çš„ä¸€è‡´æ€§ï¼Œç›¸åŒå†…å®¹çš„å¯¹è±¡ç”Ÿæˆç›¸åŒçš„å­—ç¬¦ä¸²
2.  MD5 å“ˆå¸Œï¼šå°†é•¿å­—ç¬¦ä¸²è½¬æ¢ä¸ºå›ºå®šé•¿åº¦çš„å­—ç¬¦ä¸²ï¼Œé¿å… Redis key è¿‡é•¿
3.  è¾¹ç•Œå¤„ç†ï¼šæ­£ç¡®å¤„ç† null å€¼å’Œç©ºå‚æ•°çš„æƒ…å†µ

3ï¼‰å¯ç”¨ç¼“å­˜åŠŸèƒ½

åœ¨ Spring Boot å¯åŠ¨ç±»ä¸Šæ·»åŠ  `@EnableCaching` æ³¨è§£ï¼Œæ”¯æŒ Spring Data ç¼“å­˜æ³¨è§£ï¼š

```java
@EnableCaching
@SpringBootApplication
public class YuAiCodeMotherApplication {
    public static void main(String[] args) {
        SpringApplication.run(YuAiCodeMotherApplication.class, args);
    }
}
```

4ï¼‰é…ç½®ç¼“å­˜ç®¡ç†å™¨

å¿…é¡»é…ç½® Redis ç¼“å­˜ç®¡ç†å™¨ `CacheManager`ï¼Œè¿™æ˜¯ Spring Cache çš„æ ¸å¿ƒç»„ä»¶ã€‚å¦‚æœä¸é…ç½®çš„è¯ï¼Œä½¿ç”¨ç¼“å­˜æ³¨è§£æ—¶å¯èƒ½ä¼šæŠ¥é”™ã€‚

![](https://pic.code-nav.cn/course_picture/1608440217629360130/pHjD7OXftSk8kGtZ.webp)

åœ¨ `config` åŒ…ä¸‹æ–°å¢ä»£ç ï¼š

```java
@Configuration
public class RedisCacheManagerConfig {

    @Resource
    private RedisConnectionFactory redisConnectionFactory;

    @Bean
    public CacheManager cacheManager() {
        // é…ç½® ObjectMapper æ”¯æŒ Java8 æ—¶é—´ç±»å‹
        ObjectMapper objectMapper = new ObjectMapper();
        objectMapper.registerModule(new JavaTimeModule());
        
        // é»˜è®¤é…ç½®
        RedisCacheConfiguration defaultConfig = RedisCacheConfiguration.defaultCacheConfig()
                .entryTtl(Duration.ofMinutes(30)) // é»˜è®¤ 30 åˆ†é’Ÿè¿‡æœŸ
                .disableCachingNullValues() // ç¦ç”¨ null å€¼ç¼“å­˜
                // key ä½¿ç”¨ String åºåˆ—åŒ–å™¨
                .serializeKeysWith(RedisSerializationContext.SerializationPair
                        .fromSerializer(new StringRedisSerializer()))
                // value ä½¿ç”¨ JSON åºåˆ—åŒ–å™¨ï¼ˆæ”¯æŒå¤æ‚å¯¹è±¡ï¼‰
                .serializeValuesWith(RedisSerializationContext.SerializationPair
                        .fromSerializer(new GenericJackson2JsonRedisSerializer(objectMapper)));
        
        return RedisCacheManager.builder(redisConnectionFactory)
                .cacheDefaults(defaultConfig)
                // é’ˆå¯¹ good_app_page é…ç½®5åˆ†é’Ÿè¿‡æœŸ
                .withCacheConfiguration("good_app_page",
                        defaultConfig.entryTtl(Duration.ofMinutes(5)))
                .build();
    }
}
```

è¿™ä¸ªé…ç½®çš„å‡ ä¸ªå…³é”®ç‚¹ï¼š

1.  åºåˆ—åŒ–å™¨é€‰æ‹©ï¼š`StringRedisSerializer` ç”¨äºåºåˆ—åŒ– keyï¼Œç¡®ä¿ Redis ä¸­çš„ key æ˜¯å¯è¯»çš„å­—ç¬¦ä¸²ï¼›`GenericJackson2JsonRedisSerializer` ç”¨äºåºåˆ—åŒ– valueï¼Œæ”¯æŒå¤æ‚å¯¹è±¡çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚
2.  æ—¶é—´ç±»å‹æ”¯æŒï¼šæ³¨å†Œ `JavaTimeModule` æ¥æ”¯æŒ Java 8 æ—¶é—´ç±»å‹ LocalDateTime
3.  å·®å¼‚åŒ–é…ç½®ï¼šæ—¢æä¾›äº†é»˜è®¤é…ç½®ï¼Œåˆä¸ºç‰¹å®šçš„ç¼“å­˜åŒºåŸŸè®¾ç½®ä¸åŒçš„è¿‡æœŸæ—¶é—´

ä½†æ˜¯è¦æ³¨æ„ï¼Œå¦‚æœå¯¹ value è¿›è¡Œ JSON åºåˆ—åŒ–ï¼Œå¯â èƒ½ä¼šå‡ºç°æ— æ³•ååºåˆ—åŒ–çš„æƒ…å†µï¼Œå› ä¸º Reâ dis ä¸­å¹¶æ²¡æœ‰å­˜å‚¨ Java ç±»çš„ä¿¡æ¯ï¼Œä¸çŸ¥é“è¦ååºåˆ—åŒ–æˆå“ªä¸ªç±»ï¼Œå°±ä¼šæŠ¥é”™ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥å…ˆæ³¨é‡Šæ‰è¿™äº›ä»£ç ï¼š

```java
// value ä½¿ç”¨ JSON åºåˆ—åŒ–å™¨ï¼ˆæ”¯æŒå¤æ‚å¯¹è±¡ï¼‰
// .serializeValuesWith(RedisSerializationContext.SerializationPair
//     .fromSerializer(new GenericJackson2JsonRedisSerializer(objectMapper)));
```

5ï¼‰åº”ç”¨ç¼“å­˜æ³¨è§£

åœ¨ `AppController` ä¸­ä¸ºç²¾é€‰åº”ç”¨åˆ—è¡¨æ¥å£æ·»åŠ ç¼“å­˜æ³¨è§£ï¼š

```java
@PostMapping("/good/list/page/vo")
@Cacheable(
        value = "good_app_page",
        key = "T(com.yupi.yuaicodemother.utils.CacheKeyUtils).generateKey(#appQueryRequest)",
        condition = "#appQueryRequest.pageNum <= 10"
)
public BaseResponse<Page<AppVO>> listGoodAppVOByPage(@RequestBody AppQueryRequest appQueryRequest) {
    // æ–¹æ³•å®ç°ä¿æŒä¸å˜...
}
```

è¿™é‡Œä½¿ç”¨äº† SpELï¼ˆSprâ ing Expreâ ssion Languageï¼‰è¡¨è¾¾å¼ï¼š

-   `T(ç±»å)`ï¼šç”¨äºè°ƒç”¨é™æ€æ–¹æ³•ï¼Œç”Ÿæˆç¼“å­˜ key
-   `#å‚æ•°å`ï¼šç”¨äºå¼•ç”¨æ–¹æ³•å‚æ•°
-   `condition`ï¼šè®¾ç½®ç¼“å­˜æ¡ä»¶ï¼Œåªæœ‰å‰ 10 é¡µæ‰ä¼šè¢«ç¼“å­˜

ğŸ’¡ å»ºè®®äº†è§£ä¸‹ç¼“å­˜æ³¨è§£çš„å·¥ä½œåŸç†ï¼Œæ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š

1.  æ–¹æ³•æ‰§è¡Œå‰ï¼šSpring æ ¹æ® key è¡¨è¾¾å¼ç”Ÿæˆç¼“å­˜é”®
2.  ç¼“å­˜æ£€æŸ¥ï¼šæ£€æŸ¥ Redis ä¸­æ˜¯å¦å­˜åœ¨è¯¥é”®å¯¹åº”çš„ç¼“å­˜æ•°æ®
3.  ç¼“å­˜å‘½ä¸­ï¼šå¦‚æœå­˜åœ¨ä¸”æœªè¿‡æœŸï¼Œç›´æ¥è¿”å›ç¼“å­˜æ•°æ®ï¼Œä¸æ‰§è¡Œæ–¹æ³•
4.  ç¼“å­˜æœªå‘½ä¸­ï¼šå¦‚æœä¸å­˜åœ¨ï¼Œæ‰§è¡Œæ–¹æ³•è·å–ç»“æœï¼Œå¹¶å°†ç»“æœå­˜å‚¨åˆ° Redis ä¸­
5.  è¿”å›ç»“æœï¼šè¿”å›æ–¹æ³•æ‰§è¡Œç»“æœ

#### æµ‹è¯•éªŒè¯

é€šè¿‡ Redis å®¢æˆ·ç«¯å¯ä»¥â è§‚å¯Ÿåˆ°ç¼“å­˜çš„æ•ˆæœã€‚â æ¯ä¸ªé¡µé¢çš„ç¼“å­˜éƒ½æœ‰ç‹¬ç«‹çš„ keyï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/B5fdz80oZ5hxvtPc.webp)

ç¼“å­˜çš„å†…å®¹ä»¥ JSON æ ¼å¼å­˜å‚¨ï¼Œä¾¿äºé˜…è¯»å’Œè°ƒè¯•ï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/oKlU5w6ox7u8SUy4.webp)

å¦‚æœæ²¡æœ‰é…ç½®åºåˆ—åŒ–å™¨ï¼ŒRedâ is ä¸­å­˜å‚¨çš„ä¼šæ˜¯â äºŒè¿›åˆ¶æ•°æ®ï¼Œä¸ä¾¿äºè°ƒè¯•ï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/OXPnL9Icvtr6HY1p.webp)

å¯ä»¥è‡ªè¡Œå¯¹æ¯”ä¸‹ä½¿ç”¨ç¼“å­˜å‰åçš„â æ¥å£å“åº”æ—¶é•¿ï¼Œçœ‹çœ‹â æ€§èƒ½ä¼˜åŒ–å¤šå°‘å€~

#### æ‰©å±•æ€è·¯

1ï¼‰CDN é™æ€èµ„æºåŠ é€Ÿï¼šå°†ç”Ÿæˆçš„ç½‘ç«™æ–‡ä»¶éƒ¨ç½²åˆ° CDN â æœåŠ¡å™¨ï¼Œé€šè¿‡å…¨çƒèŠ‚ç‚¹åˆ†å‘å‡å°‘è®¿é—®å»¶è¿Ÿã€‚â ç‰¹åˆ«æ˜¯å¯¹äºçƒ­é—¨åº”ç”¨ï¼Œå¯ä»¥æ˜¾è‘—æå‡ç”¨æˆ·è®¿é—®ä½“éªŒã€‚ä½†ç¼ºç‚¹å°±æ˜¯ä¼šäº§ç”Ÿé¢å¤–çš„æˆæœ¬ï¼Œæ³¨æ„é…ç½®å¥½å‘Šè­¦ï¼Œå®šæœŸçœ‹çœ‹ç›‘æ§ã€‚

æ¯•ç«Ÿâ€œä½¿ç”¨ CDNï¼Œé’±åŒ…ä¸¤è¡Œæ³ªâ€ï¼Œå¯ä¸æ˜¯è™šçš„ã€‚

2ï¼‰ç¼“å­˜çƒ­é—¨åº”ç”¨ï¼šç»Ÿè®¡åº”ç”¨çš„â è®¿é—®æ•°ï¼Œå¯¹å¯èƒ½è¢«é¢‘â ç¹è®¿é—®çš„åº”ç”¨è¯¦æƒ…å’Œå¯¹è¯åˆ—è¡¨è¿›è¡Œç¼“å­˜ï¼Œæé«˜åŠ è½½é€Ÿåº¦ã€‚

[ç¼–ç¨‹å¯¼èˆªçš„æ™ºèƒ½é¢è¯•åˆ·é¢˜å¹³å°é¡¹ç›®](https://www.codefather.cn/course/1826803928691945473) ç¬¬ 6 æœŸè®²è§£è¿‡åŸºäº HotKey å®ç°çš„çƒ­ç‚¹æ•°æ®è‡ªåŠ¨æ¢æµ‹å’Œç¼“å­˜èƒ½åŠ›ï¼Œå»ºè®®å­¦ä¹ ã€‚

## äºŒã€å®æ—¶æ€§ä¼˜åŒ–

### å½“å‰é—®é¢˜

ä¹‹å‰æœ‰æåˆ°ï¼Œå¦‚æœæ˜¯ Vue å·¥ç¨‹æ¨¡å¼ç”Ÿæˆï¼Œç”¨æˆ·åœ¨ AI ç”Ÿæˆå®Œä»£ç â åæ— æ³•å®æ—¶æµè§ˆåˆ°ç½‘ç«™æ•ˆæœï¼Œæˆ–è€…çœ‹åˆ°çš„è¿˜æ˜¯æ—§ç‰ˆæœ¬çš„â é¡µé¢ã€‚è¿™æ˜¯å› ä¸ºæˆ‘ä»¬ä¹‹å‰é‡‡ç”¨çš„æ˜¯å¼‚æ­¥æ‰“åŒ…ç­–ç•¥ï¼Œå½“ç”¨æˆ·çœ‹åˆ° AI å›å¤å®Œæˆæ—¶ï¼ŒVue é¡¹ç›®å¯èƒ½è¿˜åœ¨åå°æ„å»ºä¸­ï¼Œå­˜åœ¨æ—¶é—´å·®ã€‚

### è§£å†³æ–¹æ¡ˆ

#### æ–¹æ¡ˆè°ƒç ”

å®ç°å®æ—¶æµè§ˆçš„æ–¹æ¡ˆè¾ƒå¤šï¼Œè¿™é‡Œç›´æ¥é€šè¿‡ä¸€å¼ è¡¨æ ¼åˆ—ä¸¾ï¼š



|æ–¹æ¡ˆ|æ ¸å¿ƒæ€è·¯|ä¼˜ç‚¹|ç¼ºç‚¹|
|---|---|---|---|
|åŒæ­¥æ‰“åŒ…|æ”¹ä¸ºåŒæ­¥æ‰“åŒ…|ç¡®ä¿é¢„è§ˆå®Œå…¨å°±ç»ªï¼Œç”¨æˆ·ä½“éªŒå¥½|ç”¨æˆ·éœ€è¦ç­‰å¾…æ‰“åŒ…å®Œæˆï¼Œè€Œä¸”å¯èƒ½ä¼šå½±å“ç³»ç»Ÿæ€§èƒ½|
|è½®è¯¢è¯·æ±‚|å‰ç«¯è½®è¯¢æ‰“åŒ…çŠ¶æ€ï¼Œå®Œæˆååˆ·æ–°|å®ç°è¾ƒä¸ºç®€å•|è¯·æ±‚æ¬¡æ•°å¯èƒ½è¾ƒå¤šï¼Œå®æ—¶æ€§ä¸€èˆ¬|
|å¼‚æ­¥æ‰“åŒ… +â  è¿›åº¦åé¦ˆ|å¼‚æ­¥æ‰“åŒ…å®Œæˆåï¼Œé€šè¿‡ SSEï¼ˆæˆ– WebSocketï¼‰å‘â å‰ç«¯æ¨é€è¿›åº¦|å¼‚æ­¥æ‰“åŒ…åç¬¬ä¸€æ—¶é—´æ¨é€ç»™å‰ç«¯ï¼Œç”¨æˆ·ä½“éªŒå¥½|å®ç°å¤æ‚åº¦è¾ƒé«˜|
|é¢„è§ˆæœåŠ¡çƒ­æ›´æ–°|ç›‘å¬æ„å»ºæ–‡ä»¶ + WebSocket çƒ­æ›´æ–°|æ¥è¿‘å®æ—¶çš„é¢„è§ˆæ•ˆæœ|å®ç°å¤æ‚åº¦å¾ˆé«˜|

#### æœ€ç»ˆè§£å†³æ–¹æ¡ˆ

æ˜¾ç„¶ï¼Œæœ€ç®€å•ä¸”æœ‰æ•ˆçš„è§£å†³æ–¹æ¡ˆæ˜¯ **æ”¹ä¸ºåŒæ­¥æ‰“åŒ…**ã€‚é™¤äº†ç®€å•ä¹‹å¤–ï¼Œè¿˜èƒ½ä¿è¯é€»è¾‘æ›´åŠ ä¸€è‡´ã€‚

è®©æˆ‘ä»¬å›é¡¾ä¸€ä¸‹ä»£ç ç”Ÿæˆçš„æ•´ä½“æµç¨‹ï¼š

-   HTML æ¨¡å¼ï¼šç”Ÿæˆçš„æ–‡ä»¶ç›´æ¥ä¿å­˜ï¼Œç”¨æˆ·ç«‹å³å¯ä»¥è®¿é—®
-   Vue é¡¹ç›®æ¨¡å¼ï¼šç”Ÿæˆä»£ç åè¿˜éœ€è¦å®‰è£…ä¾èµ–å’Œæ„å»ºï¼Œç„¶åæ‰èƒ½è®¿é—®

ä»æœ¬è´¨ä¸Šè®²ï¼ŒVue é¡¹ç›®çš„å®‰è£…â ä¾èµ–å’Œæ„å»ºè¿‡ç¨‹å°±æ˜¯ä¸€â ç§ç‰¹æ®Šçš„æ–‡ä»¶ä¿å­˜æ“ä½œï¼Œç›®çš„éƒ½æ˜¯ä¸ºäº†è®©ç”¨æˆ·èƒ½å¤Ÿç«‹å³è®¿é—®ç”Ÿæˆçš„å†…å®¹ã€‚

### å¼€å‘å®ç°

1ï¼‰ç§»é™¤å¼‚æ­¥æ„å»ºé€»è¾‘

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä» `JsonMessageStreamHandler` çš„ `doOnComplete` æ–¹æ³•ä¸­ç§»é™¤æ„å»ºé€»è¾‘ï¼š

```java
.doOnComplete(() -> {
    // æµå¼å“åº”å®Œæˆåï¼Œä»…æ·»åŠ  AI æ¶ˆæ¯åˆ°å¯¹è¯å†å²
    String aiResponse = chatHistoryStringBuilder.toString();
    chatHistoryService.addChatMessage(appId, aiResponse, ChatHistoryMessageTypeEnum.AI.getValue(), loginUser.getId());
})
```

2ï¼‰åœ¨åˆé€‚ä½ç½®æ·»åŠ åŒæ­¥æ„å»º

ä¸ºäº†ä¿è¯è·Ÿå…¶ä»–æ¨¡å¼çš„ä¿å­˜æ—¶æœºä¸€è‡´ï¼Œåœ¨ `AiCodeGeneratorFacade` çš„ `processTokenStream` æ–¹æ³•ä¸­æ·»åŠ æ„å»ºé€»è¾‘æ˜¯æœ€åˆé€‚çš„äº†ï¼š

```java
.onCompleteResponse((ChatResponse response) -> {
    // æ‰§è¡Œ Vue é¡¹ç›®æ„å»ºï¼ˆåŒæ­¥æ‰§è¡Œï¼Œç¡®ä¿é¢„è§ˆæ—¶é¡¹ç›®å·²å°±ç»ªï¼‰
    String projectPath = AppConstant.CODE_OUTPUT_ROOT_DIR + File.separator + "vue_project_" + appId;
    vueProjectBuilder.buildProject(projectPath);
    sink.complete();
})
```

æ³¨æ„è¦è®©å¤–å±‚æ–¹æ³•é¢å¤–ä¼ é€’ appId å‚æ•°ã€‚

è¿™æ ·ä¿®æ”¹åï¼Œå½“ç”¨æˆ·çœ‹åˆ° AI â å›å¤å®Œæˆæ—¶ï¼ŒVue â é¡¹ç›®ä¹Ÿå·²ç»æ„å»ºå®Œæ¯•ï¼Œå¯ä»¥ç«‹å³è¿›è¡Œé¢„è§ˆï¼Œè½»æ¾è§£å†³äº†æ—¶é—´å·®é—®é¢˜ã€‚

### æ‰©å±•æ€è·¯

1ï¼‰æä¾›æ„å»ºçŠ¶æ€æŸ¥è¯¢æ¥å£ã€‚å¦‚â æœè¿˜å¸Œæœ›åç«¯å¼‚æ­¥æ„â å»ºï¼Œå‰ç«¯å¯ä»¥é€šè¿‡è½®è¯¢æ¥æ£€æµ‹æ„å»ºçŠ¶æ€ã€‚

ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```java
@GetMapping("/build/status/{appId}")
public BaseResponse<Map<String, Object>> getBuildStatus(@PathVariable Long appId, HttpServletRequest request) {
    // å‚æ•°æ ¡éªŒå’Œæƒé™æ£€æŸ¥
    ThrowUtils.throwIf(appId == null || appId <= 0, ErrorCode.PARAMS_ERROR, "åº”ç”¨IDæ— æ•ˆ");
    User loginUser = userService.getLoginUser(request);
    App app = appService.getById(appId);
    ThrowUtils.throwIf(app == null, ErrorCode.NOT_FOUND_ERROR, "åº”ç”¨ä¸å­˜åœ¨");
    
    if (!app.getUserId().equals(loginUser.getId()) && !UserConstant.ADMIN_ROLE.equals(loginUser.getUserRole())) {
        throw new BusinessException(ErrorCode.NO_AUTH_ERROR, "æ— æƒé™æŸ¥è¯¢æ„å»ºçŠ¶æ€");
    }
    // æ£€æŸ¥æ„å»ºçŠ¶æ€
    String projectPath = AppConstant.CODE_OUTPUT_ROOT_DIR + File.separator + "vue_project_" + appId;
    File projectDir = new File(projectPath);
    File distDir = new File(projectDir, "dist");
    Map<String, Object> buildStatus = new HashMap<>();
    buildStatus.put("appId", appId);
    buildStatus.put("projectExists", projectDir.exists());
    buildStatus.put("distExists", distDir.exists());
    buildStatus.put("isBuilding", false); // åŒæ­¥æ„å»ºæ¨¡å¼ä¸‹æ€»æ˜¯false
    if (distDir.exists()) {
        buildStatus.put("status", "completed");
        buildStatus.put("message", "æ„å»ºå·²å®Œæˆ");
        buildStatus.put("buildTime", distDir.lastModified());
    } else if (projectDir.exists()) {
        buildStatus.put("status", "pending");
        buildStatus.put("message", "é¡¹ç›®å·²ç”Ÿæˆï¼Œç­‰å¾…æ„å»º");
    } else {
        buildStatus.put("status", "not_found");
        buildStatus.put("message", "é¡¹ç›®ä¸å­˜åœ¨");
    }    
    return ResultUtils.success(buildStatus);
}
```

2ï¼‰æ„å»ºçŠ¶æ€å®æ—¶æ¨é€ï¼šåŸºäº SSE å®ç°æ„å»ºçŠ¶â æ€çš„å®æ—¶æ¨é€ï¼Œæ›¿ä»£åŒæ­¥æ‰“åŒ…å’Œè½®è¯¢â æœºåˆ¶ã€‚å½“æ„å»ºçŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ä¸»åŠ¨æ¨é€ç»™å‰ç«¯ï¼Œç”¨æˆ·ä½“éªŒå¯èƒ½ä¼šæ›´å¥½ï¼Œå¹¶ä¸”å‡å°‘äº†ä¸å¿…è¦çš„ç½‘ç»œè¯·æ±‚ã€‚

ï¼ˆå¦‚æœæ˜¯ä¸ºäº†å†™ç®€å†ï¼Œæ¨èä½¿ç”¨ â SSE æ¨é€æ–¹æ¡ˆï¼‰â€‚â â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‰â€‰â€‰â€‰â€‰â€‚â€‰â€‰â€‰â€‰â€‚â€‚â€‚â€‰â€‚â€‚

3ï¼‰Vite Dev Server é›†æˆï¼šé›†æˆ Vite â å¼€å‘æœåŠ¡å™¨ï¼Œå®ç°çœŸæ­£çš„å®æ—¶é¢„è§ˆåŠŸèƒ½ã€‚Aâ I ç”Ÿæˆä»£ç åç«‹å³å¯åŠ¨å¼€å‘æœåŠ¡å™¨ï¼Œè¿™æ ·ç”¨æˆ·å¯ä»¥å®æ—¶æŸ¥çœ‹åˆ°ä¿®æ”¹ä»£ç çš„æ•ˆæœï¼Œæ— éœ€ç­‰å¾…é‡æ–°æ„å»ºï¼Œè¿›ä¸€æ­¥æå‡ä½“éªŒã€‚

ç¾å›¢ NoCode å°±æ˜¯è¿™ä¹ˆå®ç°çš„ï¼Œâ æ¯”å¦‚åœ¨åŠ è½½ iframeâ  ä¸­çš„åº”ç”¨æ—¶ï¼Œä¼šæœ‰ä¸€äº› viteã€node\_modules ç›¸å…³çš„è¯·æ±‚ï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/jQjRcEitqppe5gRm.webp)

![](https://pic.code-nav.cn/course_picture/1608440217629360130/YWkoQyZOH3eBbsJ7.webp)

åŒ…æ‹¬ä¸€äº›çƒ­æ›´æ–°ç›¸å…³çš„ WebSocket è¿æ¥ï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/LcSZoEtAfRmYtRpK.webp)

ä½†æ˜¯é›†æˆ Vite Dev Server çš„å¼€å‘æˆæœ¬æå¤§ï¼Œéœ€è¦ä½¿ç”¨ Sprinâ g Boot ä¸ºæ¯ä¸ª Vue é¡¹ç›®åˆ†é…ä¸€ä¸ªç«¯å£æ¥è¿è¡Œâ  Dev Serverï¼Œè¦ä½œä¸ºä»£ç†è¿æ¥å‰ç«¯å’Œ Dev Serverï¼Œè¿˜è¦ç®¡ç† Dev Server å’Œç«¯å£èµ„æºï¼Œä¸æ¨èä½¿ç”¨è¿™ç§æ–¹æ¡ˆï¼Œäº†è§£å³å¯ã€‚

![](https://www.codefather.cn/_next/static/media/defaultCode.6873fc9a.png)

## ä¸‰ã€å®‰å…¨æ€§ä¼˜åŒ–

### æµé‡ä¿æŠ¤

éšç€å¹³å°ç”¨æˆ·çš„å¢é•¿ï¼Œæˆ‘ä»¬éœ€è¦å®ç°å¤šå±‚â çº§çš„æµé‡ä¿æŠ¤æœºåˆ¶ï¼Œé˜²æ­¢æ¶â æ„æ”»å‡»å’Œèµ„æºæ»¥ç”¨ã€‚AI å¯¹è¯æ¥å£ä½œä¸ºæœ€æ ¸å¿ƒä¹Ÿæ˜¯æˆæœ¬æœ€é«˜çš„åŠŸèƒ½ï¼Œæ›´éœ€è¦é‡ç‚¹ä¿æŠ¤ã€‚

#### å®ç°æ–¹æ¡ˆ - Redisson åˆ†å¸ƒå¼é™æµ

ä»å¼€å‘æˆæœ¬å’Œç¨³å®šçš„è§’åº¦ï¼Œé€‰æ‹©â ä½¿ç”¨åŸºäº Rediâ sson çš„åˆ†å¸ƒå¼é™æµæ¥å®ç°è¿™ä¸ªåŠŸèƒ½ã€‚

[Redisson](https://github.com/redisson/redisson) æ˜¯ä¸€ä¸ªåœ¨ Redis åŸºç¡€ä¸Šå®ç°çš„ Java é©»å†…å­˜æ•°æ®ç½‘æ ¼ã€‚å®ƒæä¾›äº†ä¸€ç³»åˆ—çš„åˆ†å¸ƒå¼ Java å¸¸ç”¨å¯¹è±¡ï¼ŒåŒ…æ‹¬é›†åˆã€é”ã€åŒæ­¥å™¨ã€åŸå­ç±»ã€å¸ƒéš†è¿‡æ»¤å™¨ã€é™æµå™¨ç­‰ã€‚ç›¸æ¯”äºç›´æ¥ä½¿ç”¨ Redis å®¢æˆ·ç«¯ï¼ŒRedisson æä¾›äº†æ›´é«˜å±‚æ¬¡çš„æŠ½è±¡ï¼Œè®©å¼€å‘è€…å¯ä»¥ **åƒä½¿ç”¨æœ¬åœ°å¯¹è±¡ä¸€æ ·ä½¿ç”¨åˆ†å¸ƒå¼å¯¹è±¡**ã€‚

![](https://pic.code-nav.cn/course_picture/1608440217629360130/zqFcJ1Hf23UmL8kR.webp)

å¯¹äºé™æµåŠŸèƒ½ï¼ŒRedisson å®ç°äº†[åŸºäºä»¤ç‰Œæ¡¶ç®—æ³•çš„ RRateLimiter](https://redisson.pro/docs/data-and-services/objects/#ratelimiter)ã€‚è¿™æ˜¯ç»å…¸çš„ç½‘ç»œæµé‡é€Ÿç‡é™åˆ¶ç®—æ³•ï¼Œå·¥ä½œåŸç†å¦‚ä¸‹ï¼š

1.  ä»¤ç‰Œæ¡¶ï¼šç³»ç»Ÿç»´æŠ¤ä¸€ä¸ªå›ºå®šå®¹é‡çš„ä»¤ç‰Œæ¡¶
2.  ä»¤ç‰Œç”Ÿæˆï¼šä»¥å›ºå®šçš„é€Ÿç‡å‘æ¡¶ä¸­æ·»åŠ ä»¤ç‰Œ
3.  è¯·æ±‚å¤„ç†ï¼šæ¯ä¸ªè¯·æ±‚éœ€è¦æ¶ˆè€—ä¸€ä¸ªä»¤ç‰Œæ‰èƒ½è¢«å¤„ç†
4.  é™æµæ•ˆæœï¼šå½“æ¡¶ä¸­æ²¡æœ‰ä»¤ç‰Œæ—¶ï¼Œè¯·æ±‚è¢«æ‹’ç»æˆ–æ’é˜Ÿ

è¿™ç§ç®—æ³•çš„ä¼˜åŠ¿åœ¨äºå…è®¸çªå‘æµâ é‡ï¼ˆæ¡¶ä¸­æœ‰è¶³å¤Ÿä»¤ç‰Œâ æ—¶ï¼‰ï¼ŒåŒæ—¶ä¿è¯é•¿æœŸçš„å¹³å‡é€Ÿç‡ä¸è¶…è¿‡è®¾å®šå€¼ã€‚

![](https://pic.code-nav.cn/course_picture/1608440217629360130/TjvM9IvGcnNXW77F.webp)

å¯ä»¥çœ‹è¿™é“é¢è¯•é¢˜ [äº†è§£å¸¸è§çš„é™æµç®—æ³•å’Œå®ç°åŸç†](https://www.mianshiya.com/question/1802901573531410433)ã€‚

ğŸ’¡ å¦‚æœæƒ³è¿›ä¸€æ­¥å­¦ä¹  Redissonï¼Œå¯ä»¥çœ‹ä¸‹ [ç¼–ç¨‹å¯¼èˆªçš„æ™ºèƒ½é¢è¯•åˆ·é¢˜å¹³å°é¡¹ç›®](https://www.codefather.cn/course/1826803928691945473) ç¬¬ 5 æœŸè®²çš„åŸºäº Redisson å®ç°é«˜æ•ˆç­¾åˆ°åŠŸèƒ½ï¼›å¦‚æœæƒ³å­¦ä¹  Sentinel é™æµï¼Œå¯ä»¥çœ‹ä¸‹ [ç¼–ç¨‹å¯¼èˆªçš„æ™ºèƒ½é¢è¯•åˆ·é¢˜å¹³å°é¡¹ç›®](https://www.codefather.cn/course/1826803928691945473) ç¬¬ 7 æœŸè®²çš„åŸºäº Sentinel å®ç°ç½‘ç«™æµé‡æ§åˆ¶å’Œç†”æ–­ã€‚

#### å¼€å‘å®ç°

è€ƒè™‘åˆ°é™æµæ˜¯ä¸€ä¸ªä¸ä¸šåŠ¡æ¾è€¦åˆçš„å¯é€‰åŠŸèƒ½ï¼Œä¸ºäº†ä¾¿äºç®¡ç†å’Œç»´æŠ¤ï¼Œä¸‹é¢æˆ‘ä»¬å°†æ‰€æœ‰é™æµç›¸å…³çš„ä»£ç éƒ½æ”¾åˆ° `ratelimit` åŒ…ä¸­ã€‚

1ï¼‰é¦–å…ˆå¼•å…¥ Redisson ä¾èµ–ï¼š

```xml
<!-- Redisson -->
<dependency>
    <groupId>org.redisson</groupId>
    <artifactId>redisson</artifactId>
    <version>3.50.0</version>
</dependency>
```

åœ¨ `ratelimiter.config` åŒ…ä¸‹ç¼–å†™ Redisson å®¢æˆ·ç«¯é…ç½®ï¼Œè¯»å– Redis ç›¸å…³é…ç½®å¹¶åˆå§‹åŒ– Redisson å®¢æˆ·ç«¯ Beanï¼š

```java
@Configuration
public class RedissonConfig {

    @Value("${spring.data.redis.host}")
    private String redisHost;

    @Value("${spring.data.redis.port}")
    private Integer redisPort;

    @Value("${spring.data.redis.password}")
    private String redisPassword;

    @Value("${spring.data.redis.database}")
    private Integer redisDatabase;

    @Bean
    public RedissonClient redissonClient() {
        Config config = new Config();
        String address = "redis://" + redisHost + ":" + redisPort;
        SingleServerConfig singleServerConfig = config.useSingleServer()
                .setAddress(address)
                .setDatabase(redisDatabase)
                .setConnectionMinimumIdleSize(1)
                .setConnectionPoolSize(10)
                .setIdleConnectionTimeout(30000)
                .setConnectTimeout(5000)
                .setTimeout(3000)
                .setRetryAttempts(3)
                .setRetryInterval(1500);
        // å¦‚æœæœ‰å¯†ç åˆ™è®¾ç½®å¯†ç 
        if (redisPassword != null && !redisPassword.isEmpty()) {
            singleServerConfig.setPassword(redisPassword);
        }
        return Redisson.create(config);
    }
}
```

2ï¼‰æ–°å¢ä¸€ä¸ª ErrorCoâ de è‡ªå®šä¹‰ä¸šåŠ¡å¼‚â å¸¸ç±»å‹ï¼Œä¾¿äºå‰ç«¯å±•ç¤ºé”™è¯¯ä¿¡æ¯ï¼š

```java
TOO_MANY_REQUEST(42900, "è¯·æ±‚è¿‡äºé¢‘ç¹"),
```

3ï¼‰åˆ›å»ºé™æµç±»å‹æšä¸¾ï¼Œæ”¯æŒæ¥â å£ã€ç”¨æˆ·ã€IP å¤šâ ä¸ªç»´åº¦çš„é™æµã€‚

åœ¨ `ratelimit.enums` åŒ…ä¸‹åˆ›å»ºæšä¸¾ç±»ï¼š

```java
public enum RateLimitType {
    
    /**
     * æ¥å£çº§åˆ«é™æµ
     */
    API,
    
    /**
     * ç”¨æˆ·çº§åˆ«é™æµ
     */
    USER,
    
    /**
     * IPçº§åˆ«é™æµ
     */
    IP
}
```

4ï¼‰ä¸ºäº†æ›´æ–¹ä¾¿ä½¿ç”¨é™æµï¼Œå¯ä»¥â åˆ›å»ºé™æµæ³¨è§£ï¼Œæä¾›â çµæ´»çš„é…ç½®é€‰é¡¹ã€‚

åœ¨ `ratelimit.annotation` åŒ…ä¸‹æ–°å»ºï¼š

```java
@Target({ElementType.METHOD})
@Retention(RetentionPolicy.RUNTIME)
public @interface RateLimit {
    
    /**
     * é™æµkeyå‰ç¼€
     */
    String key() default "";
    
    /**
     * æ¯ä¸ªæ—¶é—´çª—å£å…è®¸çš„è¯·æ±‚æ•°
     */
    int rate() default 10;
    
    /**
     * æ—¶é—´çª—å£ï¼ˆç§’ï¼‰
     */
    int rateInterval() default 1;
    
    /**
     * é™æµç±»å‹
     */
    RateLimitType limitType() default RateLimitType.USER;
    
    /**
     * é™æµæç¤ºä¿¡æ¯
     */
    String message() default "è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•";
}
```

5ï¼‰å®ç°é™æµåˆ‡é¢

åœ¨ `ratelimit.aspect` åŒ…ä¸‹åˆ›å»º `RateLimitAspect` åˆ‡é¢ç±»ï¼Œä½¿ç”¨ AOP é¢å‘åˆ‡é¢ç¼–ç¨‹æ¥å®ç°é™æµé€»è¾‘ã€‚

å…ˆå®šä¹‰åˆ‡é¢å’Œæ³¨å…¥ä¾èµ–ï¼š

```java
@Aspect
@Component
@Slf4j
public class RateLimitAspect {
    @Resource
    private RedissonClient redissonClient;
    @Resource
    private UserService userService;
}
```

ç¼–å†™æ ¸å¿ƒé™æµé€»è¾‘ï¼š

```java
@Before("@annotation(rateLimit)")
public void doBefore(JoinPoint point, RateLimit rateLimit) {
    String key = generateRateLimitKey(point, rateLimit);
    // ä½¿ç”¨Redissonçš„åˆ†å¸ƒå¼é™æµå™¨
    RRateLimiter rateLimiter = redissonClient.getRateLimiter(key);
    rateLimiter.expire(Duration.ofHours(1)); // 1 å°æ—¶åè¿‡æœŸ
    // è®¾ç½®é™æµå™¨å‚æ•°ï¼šæ¯ä¸ªæ—¶é—´çª—å£å…è®¸çš„è¯·æ±‚æ•°å’Œæ—¶é—´çª—å£
    rateLimiter.trySetRate(RateType.OVERALL, rateLimit.rate(), rateLimit.rateInterval(), RateIntervalUnit.SECONDS);
    // å°è¯•è·å–ä»¤ç‰Œï¼Œå¦‚æœè·å–å¤±è´¥åˆ™é™æµ
    if (!rateLimiter.tryAcquire(1)) {
        throw new BusinessException(ErrorCode.TOO_MANY_REQUEST, rateLimit.message());
    }
}
```

è¿™æ˜¯é™æµçš„æ ¸å¿ƒå…¥å£æ–¹æ³•ï¼Œåœ¨æ ‡æ³¨äº† `@RateLimit` æ³¨è§£çš„æ–¹æ³•æ‰§è¡Œå‰è¿›è¡Œæ‹¦æˆªã€‚ç”Ÿæˆé™æµ keyï¼Œè·å– Redisson é™æµå™¨ï¼Œè®¾ç½®é™æµè§„åˆ™ã€‚ç„¶åä½¿ç”¨ä»¤ç‰Œæ¡¶ç®—æ³•è¿›è¡Œé™æµåˆ¤æ–­ï¼Œè¶…é™æ—¶æŠ›å‡ºä¸šåŠ¡å¼‚å¸¸ã€‚

ğŸ’¡ æ³¨æ„ï¼Œä¸€å®šè¦ä¸ºé™æµå™¨è®¾ç½®â è¿‡æœŸæ—¶é—´ï¼Œå¦åˆ™ Reâ dis ä¸­çš„ key ä¼šæ°¸ä¸è¿‡æœŸï¼é•¿æ—¶é—´è¿è¡Œåå†…å­˜å ç”¨ä¼šè¶Šæ¥è¶Šé«˜ã€‚

ç¼–å†™ç”Ÿæˆé™æµ key çš„æ–¹æ³•ï¼š

```java
private String generateRateLimitKey(JoinPoint point, RateLimit rateLimit) {
    StringBuilder keyBuilder = new StringBuilder();
    keyBuilder.append("rate_limit:");
    // æ·»åŠ è‡ªå®šä¹‰å‰ç¼€
    if (!rateLimit.key().isEmpty()) {
        keyBuilder.append(rateLimit.key()).append(":");
    }
    // æ ¹æ®é™æµç±»å‹ç”Ÿæˆä¸åŒçš„key
    switch (rateLimit.limitType()) {
        case API:
            // æ¥å£çº§åˆ«ï¼šæ–¹æ³•å
            MethodSignature signature = (MethodSignature) point.getSignature();
            Method method = signature.getMethod();
            keyBuilder.append("api:").append(method.getDeclaringClass().getSimpleName())
                    .append(".").append(method.getName());
            break;
        case USER:
            // ç”¨æˆ·çº§åˆ«ï¼šç”¨æˆ·ID
            try {
                ServletRequestAttributes attributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();
                if (attributes != null) {
                    HttpServletRequest request = attributes.getRequest();
                    User loginUser = userService.getLoginUser(request);
                    keyBuilder.append("user:").append(loginUser.getId());
                } else {
                    // æ— æ³•è·å–è¯·æ±‚ä¸Šä¸‹æ–‡ï¼Œä½¿ç”¨IPé™æµ
                    keyBuilder.append("ip:").append(getClientIP());
                }
            } catch (BusinessException e) {
                // æœªç™»å½•ç”¨æˆ·ä½¿ç”¨IPé™æµ
                keyBuilder.append("ip:").append(getClientIP());
            }
            break;
        case IP:
            // IPçº§åˆ«ï¼šå®¢æˆ·ç«¯IP
            keyBuilder.append("ip:").append(getClientIP());
            break;
        default:
            throw new BusinessException(ErrorCode.SYSTEM_ERROR, "ä¸æ”¯æŒçš„é™æµç±»å‹");
    }
    return keyBuilder.toString();
}
```

è¿™æ®µä»£ç çœ‹èµ·æ¥å¤æ‚ï¼Œä½†åšçš„äº‹æƒ…å¾ˆå¥½ç†è§£ â€”â€” æ ¹æ®ä¸â åŒçš„é™æµç­–ç•¥ç”Ÿæˆå”¯ä¸€çš„ Redisâ  keyï¼ŒAPI çº§åˆ«æŒ‰æ–¹æ³•åã€ç”¨æˆ·çº§åˆ«æŒ‰ç”¨æˆ· IDã€IP çº§åˆ«æŒ‰å®¢æˆ·ç«¯ IPï¼Œä»è€Œæ”¯æŒä¸‰ç§é™æµç»´åº¦ã€‚

è¿™é‡Œè¿˜æœ‰ä¸ªé™çº§é€»è¾‘çš„å°è®¾è®¡ï¼Œâ ç”¨æˆ·çº§åˆ«é™æµè·å–ç”¨â æˆ·ä¿¡æ¯å¤±è´¥æ—¶è‡ªåŠ¨é™çº§ä¸º IP é™æµã€‚

è¿˜æœ‰ä¸€ä¸ªå·¥å…·æ–¹æ³•ï¼Œè·å–å®¢æˆ·ç«¯ IPï¼š

```java
private String getClientIP() {
    ServletRequestAttributes attributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();
    if (attributes == null) {
        return "unknown";
    }
    HttpServletRequest request = attributes.getRequest();
    String ip = request.getHeader("X-Forwarded-For");
    if (ip == null || ip.isEmpty() || "unknown".equalsIgnoreCase(ip)) {
        ip = request.getHeader("X-Real-IP");
    }
    if (ip == null || ip.isEmpty() || "unknown".equalsIgnoreCase(ip)) {
        ip = request.getRemoteAddr();
    }
    // å¤„ç†å¤šçº§ä»£ç†çš„æƒ…å†µ
    if (ip != null && ip.contains(",")) {
        ip = ip.split(",")[0].trim();
    }
    return ip != null ? ip : "unknown";
}
```

6ï¼‰åº”ç”¨é™æµæ³¨è§£

åœ¨å…³é”®çš„ AI å¯¹è¯æ¥å£ä¸Šä½¿ç”¨é™æµæ³¨è§£ï¼š

```java
@GetMapping(value = "/chat/gen/code", produces = MediaType.TEXT_EVENT_STREAM_VALUE)
@RateLimit(limitType = RateLimitType.USER, rate = 5, rateInterval = 60, message = "AI å¯¹è¯è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•")
public Flux<ServerSentEvent<String>> chatToGenCode(@RequestParam Long appId,
                                                   @RequestParam String message,
                                                   HttpServletRequest request) {
    // æ–¹æ³•å®ç°...
}
```

è¿™æ ·é…ç½®åï¼Œæ¯ä¸ªç”¨æˆ·åœ¨ 60â  ç§’å†…æœ€å¤šåªèƒ½å‘èµ·â  5 æ¬¡ AI å¯¹è¯è¯·æ±‚ï¼Œè¶…è¿‡é™åˆ¶ä¼šè¿”å›å‹å¥½çš„é”™è¯¯æç¤ºã€‚

#### æµ‹è¯•éªŒè¯

é€šè¿‡å¿«é€Ÿè¿ç»­å‘èµ·å¤šä¸ªè¯·æ±‚æ¥æµ‹è¯•é™æµæ•ˆæœï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/22pqlXAPONjLsPiZ.webp)

å¯ä»¥åœ¨ Redis ä¸­è§‚å¯Ÿåˆ°é™æµå™¨çš„å·¥ä½œçŠ¶æ€ï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/vvqeQi9f80jew9cq.webp)

![](https://pic.code-nav.cn/course_picture/1608440217629360130/NRo4UoyJbld4PN4T.webp)

é€šè¿‡ `TTL` å‘½ä»¤å¯ä»¥æŸ¥çœ‹ key çš„å‰©ä½™è¿‡æœŸæ—¶é—´ï¼š

```shell
ttl rate_limit:user:302588523967918080
```

![](https://pic.code-nav.cn/course_picture/1608440217629360130/4x7D6wDouKrFmgqU.webp)

#### ä¼˜åŒ– SSE é”™è¯¯å¤„ç†

åœ¨æµ‹è¯•è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å‘ç°äº†ä¸€ä¸ªé—®é¢˜ï¼šå½“é™æµè§¦å‘æ—¶â ï¼Œå‰ç«¯æ— æ³•æ­£ç¡®æ˜¾ç¤ºåç«¯è¿”å›çš„é”™è¯¯â ä¿¡æ¯ã€‚è¿™æ˜¯å› ä¸ºé™æµå¼‚å¸¸åœ¨è¿›å…¥ SSE æ¥å£ä¹‹å‰å°±è¢«æŠ›å‡ºäº†ï¼Œæ²¡æœ‰é€šè¿‡æµå¼è¿”å›ï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†ã€‚

æ€è·¯æ˜¯ï¼šå°†é™æµå¼‚å¸¸æ¶ˆæ¯ä¹Ÿä½œä¸º SSE è¿”å›ç»™å‰ç«¯ã€‚

SSE æ˜¯ä¸€ç§æœåŠ¡å™¨å‘å®¢æˆ·ç«¯æ¨é€æ•°æ®çš„æŠ€æœ¯ï¼Œå®ƒåŸºäº HTTP åè®®ï¼Œä½¿ç”¨ `text/event-stream` åª’ä½“ç±»å‹ã€‚SSE æ¶ˆæ¯çš„æ ‡å‡†æ ¼å¼æ˜¯ï¼š

```plain
event: äº‹ä»¶ç±»å‹
data: æ•°æ®å†…å®¹
```

ä¼˜åŒ–å…¨å±€å¼‚å¸¸å¤„ç†å™¨ï¼Œè®©å®ƒèƒ½å¤Ÿæ­£ç¡®å¤„ç† SSE è¯·æ±‚çš„å¼‚å¸¸ï¼š

```java
@Hidden
@RestControllerAdvice
@Slf4j
public class GlobalExceptionHandler {

    @ExceptionHandler(BusinessException.class)
    public BaseResponse<?> businessExceptionHandler(BusinessException e) {
        log.error("BusinessException", e);
        // å°è¯•å¤„ç† SSE è¯·æ±‚
        if (handleSseError(e.getCode(), e.getMessage())) {
            return null;
        }
        // å¯¹äºæ™®é€šè¯·æ±‚ï¼Œè¿”å›æ ‡å‡† JSON å“åº”
        return ResultUtils.error(e.getCode(), e.getMessage());
    }

    @ExceptionHandler(RuntimeException.class)
    public BaseResponse<?> runtimeExceptionHandler(RuntimeException e) {
        log.error("RuntimeException", e);
        // å°è¯•å¤„ç† SSE è¯·æ±‚
        if (handleSseError(ErrorCode.SYSTEM_ERROR.getCode(), "ç³»ç»Ÿé”™è¯¯")) {
            return null;
        }
        return ResultUtils.error(ErrorCode.SYSTEM_ERROR, "ç³»ç»Ÿé”™è¯¯");
    }

    /**
     * å¤„ç†SSEè¯·æ±‚çš„é”™è¯¯å“åº”
     * 
     * @param errorCode é”™è¯¯ç 
     * @param errorMessage é”™è¯¯ä¿¡æ¯
     * @return trueè¡¨ç¤ºæ˜¯SSEè¯·æ±‚å¹¶å·²å¤„ç†ï¼Œfalseè¡¨ç¤ºä¸æ˜¯SSEè¯·æ±‚
     */
    private boolean handleSseError(int errorCode, String errorMessage) {
        ServletRequestAttributes attributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();
        if (attributes == null) {
            return false;
        }
        HttpServletRequest request = attributes.getRequest();
        HttpServletResponse response = attributes.getResponse();
        // åˆ¤æ–­æ˜¯å¦æ˜¯SSEè¯·æ±‚ï¼ˆé€šè¿‡Acceptå¤´æˆ–URLè·¯å¾„ï¼‰
        String accept = request.getHeader("Accept");
        String uri = request.getRequestURI();
        if ((accept != null && accept.contains("text/event-stream")) || 
            uri.contains("/chat/gen/code")) {
            try {
                // è®¾ç½®SSEå“åº”å¤´
                response.setContentType("text/event-stream");
                response.setCharacterEncoding("UTF-8");
                response.setHeader("Cache-Control", "no-cache");
                response.setHeader("Connection", "keep-alive");
                // æ„é€ é”™è¯¯æ¶ˆæ¯çš„SSEæ ¼å¼
                Map<String, Object> errorData = Map.of(
                    "error", true,
                    "code", errorCode,
                    "message", errorMessage
                );
                String errorJson = JSONUtil.toJsonStr(errorData);
                // å‘é€ä¸šåŠ¡é”™è¯¯äº‹ä»¶ï¼ˆé¿å…ä¸æ ‡å‡†erroräº‹ä»¶å†²çªï¼‰
                String sseData = "event: business-error\ndata: " + errorJson + "\n\n";
                response.getWriter().write(sseData);
                response.getWriter().flush();
                // å‘é€ç»“æŸäº‹ä»¶
                response.getWriter().write("event: done\ndata: {}\n\n");
                response.getWriter().flush();
                // è¡¨ç¤ºå·²å¤„ç†SSEè¯·æ±‚
                return true;
            } catch (IOException ioException) {
                log.error("Failed to write SSE error response", ioException);
                // å³ä½¿å†™å…¥å¤±è´¥ï¼Œä¹Ÿè¡¨ç¤ºè¿™æ˜¯SSEè¯·æ±‚
                return true;
            }
        }
        return false;
    }
}
```

ä»£ç ä¸­æœ‰ä¸ªå°ç»†èŠ‚ï¼Œæˆ‘ä»¬ä½¿ç”¨è‡ªå®šä¹‰çš„ `business-error` äº‹ä»¶ç±»å‹æ¥åŒºåˆ†ä¸šåŠ¡å¼‚å¸¸å’Œè¿æ¥å¼‚å¸¸ï¼Œé¿å…ä¸æµè§ˆå™¨é»˜è®¤çš„ `error` äº‹ä»¶å†²çªã€‚

ç›¸åº”åœ°ï¼Œå‰ç«¯ AppChatâ Page ä¹Ÿéœ€è¦æ·»â åŠ å¯¹è‡ªå®šä¹‰é”™è¯¯äº‹ä»¶çš„å¤„ç†ï¼š

```typescript
// å¤„ç†business-erroräº‹ä»¶ï¼ˆåç«¯é™æµç­‰é”™è¯¯ï¼‰
eventSource.addEventListener('business-error', function (event: MessageEvent) {
  if (streamCompleted) return

  try {
    const errorData = JSON.parse(event.data)
    console.error('SSEä¸šåŠ¡é”™è¯¯äº‹ä»¶:', errorData)

    // æ˜¾ç¤ºå…·ä½“çš„é”™è¯¯ä¿¡æ¯
    const errorMessage = errorData.message || 'ç”Ÿæˆè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯'
    messages.value[aiMessageIndex].content = `âŒ ${errorMessage}`
    messages.value[aiMessageIndex].loading = false
    message.error(errorMessage)

    streamCompleted = true
    isGenerating.value = false
    eventSource?.close()
  } catch (parseError) {
    console.error('è§£æé”™è¯¯äº‹ä»¶å¤±è´¥:', parseError, 'åŸå§‹æ•°æ®:', event.data)
    handleError(new Error('æœåŠ¡å™¨è¿”å›é”™è¯¯'), aiMessageIndex)
  }
})
```

ä¼˜åŒ–åçš„æ•ˆæœï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/AOxBA4JhuSoPEBzm.webp)

åç«¯è¿”å›çš„ SSE æ ¼å¼ï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/uHN5ZiLZMio5YUaI.webp)

### Prompt å®‰å…¨å®¡æŸ¥ - æŠ¤è½¨æœºåˆ¶

é™¤äº†æµé‡ä¿æŠ¤ï¼Œæˆ‘ä»¬è¿˜éœ€è¦é˜²èŒƒâ æ¶æ„è¾“å…¥å’Œ Proâ mpt æ³¨å…¥æ”»å‡»ã€‚

ç¾å›¢ NoCode ä¹Ÿæœ‰ä¸€äº›â é˜²æŠ¤çš„ç­–ç•¥ï¼Œæ¯”å¦‚åœ¨â å°† prompt äº¤ç»™ AI æ‰§è¡Œä¹‹å‰ï¼Œä¼šè¿›è¡Œä¸€æ¬¡å®¡æ ¸ï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/RtS89dWhUxnfwOjL.webp)

![](https://pic.code-nav.cn/course_picture/1608440217629360130/LwGH7tBI2A0X2zU0.webp)

åŸºäº [LangChain4j çš„æŠ¤è½¨åŠŸèƒ½](https://docs.langchain4j.dev/tutorials/guardrails)ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°å¾ˆè½»æ¾åœ°å®ç°è°ƒç”¨ AI å‰çš„å®¡æŸ¥èƒ½åŠ›ã€‚

#### ä»€ä¹ˆæ˜¯æŠ¤è½¨ Guardrailsï¼Ÿ

æŠ¤è½¨æ˜¯ AI åº”ç”¨ä¸­çš„å®‰å…¨æœºåˆ¶ï¼Œç±»â ä¼¼äºé“è·¯ä¸Šçš„æŠ¤æ ï¼Œç”¨äºâ é˜²æ­¢æ¶æ„çš„ Prompt è¾“å…¥ã€é˜²æ­¢ AI æ¨¡å‹äº§ç”Ÿä¸å½“æˆ–æœ‰å®³çš„å†…å®¹ã€‚

å…¶å®æˆ‘ä»¬æŠŠå®ƒç†è§£ä¸ºæ‹¦æˆªå™¨å°±å¥½äº†ï¼ŒæŠ¤è½¨åˆ†ä¸ºä¸¤ç§ï¼š

-   è¾“å…¥æŠ¤è½¨ï¼ˆInput Guardrailsï¼‰ï¼šåœ¨ç”¨æˆ·è¾“å…¥ä¼ é€’ç»™ AI æ¨¡å‹ä¹‹å‰è¿›è¡Œæ£€æŸ¥å’Œè¿‡æ»¤
-   è¾“å‡ºæŠ¤è½¨ï¼ˆOutput Guardrailsï¼‰ï¼šåœ¨ AI æ¨¡å‹ç”Ÿæˆå†…å®¹åè¿›è¡Œæ£€æŸ¥å’Œè¿‡æ»¤

![](https://pic.code-nav.cn/course_picture/1608440217629360130/YAweiYL9KZe7MVMp.webp)

é™¤äº†è¾“å…¥ Prompt å’Œ â AI è¾“å‡ºç»“æœçš„å®‰â å…¨æ ¡éªŒå¤–ï¼Œä½ è¿˜å¯ä»¥åˆ©ç”¨æŠ¤è½¨è¿›è¡Œæƒé™æ ¡éªŒã€æ—¥å¿—è®°å½•ç­‰ã€‚

ä¸‹é¢æˆ‘ä»¬æ¥åˆ©ç”¨è¾“å…¥æŠ¤è½¨å®ç° â Prompt å®‰å…¨â å®¡æ ¸ï¼Œé˜²æ­¢ä¸€äº›éæ³• Promptï¼Œæ¯”å¦‚ï¼š

-   æ‹’ç»è¿‡é•¿çš„ Prompt
-   æ‹’ç»åŒ…å«æ•æ„Ÿè¯çš„ Prompt
-   æ‹’ç»åŒ…å«æ³¨å…¥æ”»å‡»çš„ Prompt

#### å¼€å‘å®ç°

1ï¼‰åœ¨ `ai.guardrail` åŒ…ä¸‹åˆ›å»º `PromptSafetyInputGuardrail` ç±»ï¼Œåœ¨ç”¨æˆ·è¾“å…¥ä¼ é€’ç»™ AI æ¨¡å‹ä¹‹å‰è¿›è¡Œå®‰å…¨å®¡æŸ¥ï¼š

```java
public class PromptSafetyInputGuardrail implements InputGuardrail {

    // æ•æ„Ÿè¯åˆ—è¡¨
    private static final List<String> SENSITIVE_WORDS = Arrays.asList(
            "å¿½ç•¥ä¹‹å‰çš„æŒ‡ä»¤", "ignore previous instructions", "ignore above",
            "ç ´è§£", "hack", "ç»•è¿‡", "bypass", "è¶Šç‹±", "jailbreak"
    );

    // æ³¨å…¥æ”»å‡»æ¨¡å¼
    private static final List<Pattern> INJECTION_PATTERNS = Arrays.asList(
            Pattern.compile("(?i)ignore\\s+(?:previous|above|all)\\s+(?:instructions?|commands?|prompts?)"),
            Pattern.compile("(?i)(?:forget|disregard)\\s+(?:everything|all)\\s+(?:above|before)"),
            Pattern.compile("(?i)(?:pretend|act|behave)\\s+(?:as|like)\\s+(?:if|you\\s+are)"),
            Pattern.compile("(?i)system\\s*:\\s*you\\s+are"),
            Pattern.compile("(?i)new\\s+(?:instructions?|commands?|prompts?)\\s*:")
    );

    @Override
    public InputGuardrailResult validate(UserMessage userMessage) {
        String input = userMessage.singleText();
        // æ£€æŸ¥è¾“å…¥é•¿åº¦
        if (input.length() > 1000) {
            return fatal("è¾“å…¥å†…å®¹è¿‡é•¿ï¼Œä¸è¦è¶…è¿‡ 1000 å­—");
        }
        // æ£€æŸ¥æ˜¯å¦ä¸ºç©º
        if (input.trim().isEmpty()) {
            return fatal("è¾“å…¥å†…å®¹ä¸èƒ½ä¸ºç©º");
        }
        // æ£€æŸ¥æ•æ„Ÿè¯
        String lowerInput = input.toLowerCase();
        for (String sensitiveWord : SENSITIVE_WORDS) {
            if (lowerInput.contains(sensitiveWord.toLowerCase())) {
                return fatal("è¾“å…¥åŒ…å«ä¸å½“å†…å®¹ï¼Œè¯·ä¿®æ”¹åé‡è¯•");
            }
        }
        // æ£€æŸ¥æ³¨å…¥æ”»å‡»æ¨¡å¼
        for (Pattern pattern : INJECTION_PATTERNS) {
            if (pattern.matcher(input).find()) {
                return fatal("æ£€æµ‹åˆ°æ¶æ„è¾“å…¥ï¼Œè¯·æ±‚è¢«æ‹’ç»");
            }
        }
        return success();
    }
}
```

ğŸ’¡ æ³¨æ„è¿™é‡Œå®ç°çš„åªæ˜¯åŸºç¡€æ£€æµ‹ï¼Œå®é™…ç”Ÿâ äº§ç¯å¢ƒä¸­å¯èƒ½éœ€è¦æ›´å¤æ‚çš„æ£€â æµ‹é€»è¾‘ï¼ŒåŒ…æ‹¬ä½¿ç”¨ AI æ¨¡å‹ã€æˆ–è€…æ•æ„Ÿè¯å†…å®¹å®¡æ ¸æœåŠ¡æ¥æ£€æµ‹æ›´å¤æ‚çš„æ”»å‡»æ¨¡å¼ã€‚

2ï¼‰é›†æˆæŠ¤è½¨åˆ° AI æœåŠ¡

åœ¨ AI æœåŠ¡å·¥å‚ä¸­é›†æˆè¾“å…¥æŠ¤è½¨ï¼š

```java
yield AiServices.builder(AiCodeGeneratorService.class)
        .streamingChatModel(reasoningStreamingChatModel)
        .chatMemoryProvider(memoryId -> chatMemory)
        .tools(toolManager.getAllTools())
        .inputGuardrails(new PromptSafetyInputGuardrail())  // æ·»åŠ è¾“å…¥æŠ¤è½¨
        .build();
```

å¦‚æœä½ åªæƒ³ç»™æŸä¸ªæ–¹æ³•ä½¿ç”¨æŠ¤è½¨ï¼Œå¯ä»¥ç”¨ä¸‹é¢è¿™ç§å†™æ³•ï¼š

```java
public interface Assistant {
    @InputGuardrails({ FirstInputGuardrail.class, SecondInputGuardrail.class })
    String chat(String question);
    
    String doSomethingElse(String question);
}
```

#### æµ‹è¯•éªŒè¯

é€šè¿‡è¾“å…¥ä¸€äº›æ¶æ„å†…å®¹æ¥æµ‹è¯•æŠ¤è½¨æ•ˆæœï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/iai7xkCGpSEOft1K.webp)

åç«¯å¯ä»¥çœ‹åˆ°æŠ¤è½¨è¾“å‡ºçš„å¼‚å¸¸ä¿¡â æ¯ï¼šâ€‚â€‚â€‚â€‚â€‚â€‚â€‚â â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‰â€‰â€‰â€‰â€‰â€‚â€‰â€‰â€‰â€‰â€‚â€‚â€‚â€‰â€‚â€‚

![](https://pic.code-nav.cn/course_picture/1608440217629360130/CO7vn5Lqu4IsOzgZ.webp "null")

#### æ‰©å±•æ€è·¯

1ï¼‰æ™ºèƒ½æ•æ„Ÿè¯æ£€æµ‹ï¼šæ¥å…¥é˜¿é‡Œäº‘å†…å®¹å®‰å…¨æœåŠ¡æˆ–è°ƒâ ç”¨ä¸“é—¨çš„ AI å¤§æ¨¡å‹è¿›è¡Œæ•æ„Ÿâ è¯æ£€æµ‹ï¼Œç›¸æ¯”é™æ€å…³é”®è¯åŒ¹é…ï¼Œèƒ½å¤Ÿè¯†åˆ«æ›´å¤æ‚çš„è¯­ä¹‰æ”»å‡»å’Œéšæ™¦è¡¨è¾¾ï¼Œæå‡æ£€æµ‹å‡†ç¡®ç‡å’Œè¦†ç›–é¢ã€‚

2ï¼‰åŠ¨æ€é…ç½®ç®¡ç†ï¼šé›†æˆ Nacos é…ç½®ä¸­å¿ƒå®â ç°æ•æ„Ÿè¯åº“çš„åŠ¨æ€ç»´æŠ¤ï¼Œæ”¯æŒçƒ­æ›´â æ–°æ•æ„Ÿè¯è§„åˆ™ï¼Œæ— éœ€é‡å¯æœåŠ¡ã€‚ç®¡ç†å‘˜å¯ä»¥é€šè¿‡é…ç½®ä¸­å¿ƒå®æ—¶è°ƒæ•´æ£€æµ‹ç­–ç•¥ï¼Œå¿«é€Ÿå“åº”æ–°çš„æ”»å‡»æ¨¡å¼ã€‚

[ç¼–ç¨‹å¯¼èˆªçš„æ™ºèƒ½é¢è¯•åˆ·é¢˜å¹³å°é¡¹ç›®](https://www.codefather.cn/course/1826803928691945473) ç¬¬ 7 æœŸè®²è§£è¿‡ Nacos çš„ç”¨æ³•å’Œå®æˆ˜ã€‚

3ï¼‰Prompt é‡å†™ï¼šåˆ©ç”¨æŠ¤è½¨æœºåˆ¶å®ç° Prompt çš„é‡å†™åŠŸâ èƒ½ï¼Œå½“æ£€æµ‹åˆ°æ½œåœ¨é£é™©å†…å®¹æ—¶ï¼Œè‡ªåŠ¨ç§»é™¤æˆ–æ›¿æ¢â æ•æ„Ÿä¿¡æ¯ï¼ˆé¡ºä¾¿ä¼˜åŒ– Prompt çš„ä¸“ä¸šæ€§ã€æˆ–è€…é˜²æ­¢è¶…å‡ºå¤§æ¨¡å‹çš„èƒ½åŠ›ï¼‰ï¼Œè€Œä¸æ˜¯ç›´æ¥æ‹’ç»è¯·æ±‚ï¼Œåœ¨ä¿è¯å®‰å…¨çš„åŒæ—¶æå‡ç”¨æˆ·ä½“éªŒã€‚

4ï¼‰å®šåˆ¶åŒ–é”™è¯¯åé¦ˆï¼šä¼˜åŒ–åç«¯â å¼‚å¸¸å¤„ç†å™¨é€»è¾‘ï¼Œæ•â è·æŠ¤è½¨å¼‚å¸¸å¹¶é€šè¿‡ SSE å‘å‰ç«¯æ¨é€å‡†ç¡®çš„é”™è¯¯ä¿¡æ¯ã€‚

5ï¼‰å®¡æŸ¥è®°å½•ï¼šé€šè¿‡æ—¥å¿—æˆ–æ•°æ®åº“è®°å½•â æ‰€æœ‰æ‹¦æˆªäº‹ä»¶çš„è¯¦ç»†ä¿¡æ¯â ï¼ŒåŒ…æ‹¬è§¦å‘è§„åˆ™ã€ç”¨æˆ·ä¿¡æ¯ã€å¤„ç†ç»“æœç­‰ï¼Œä¾¿äºæˆ‘ä»¬æŒç»­ä¼˜åŒ–ç³»ç»Ÿå®‰å…¨æ€§ã€‚

## å››ã€ç¨³å®šæ€§ä¼˜åŒ–

### é‡è¯•ç­–ç•¥ - è¾“å‡ºæŠ¤è½¨

ç”±äºå¤§æ¨¡å‹è°ƒç”¨å­˜åœ¨ä¸€å®šä¸ç¡®å®šæ€§ï¼Œæœ‰æ—¶å€™å¯èƒ½è¿”å›ä¸ç¬¦åˆé¢„æœŸçš„å†…â å®¹ã€æˆ–è€…å›å¤ä¸­æ–­ã€‚æ‰€ä»¥ä¸ºäº†æå‡ç³»ç»Ÿçš„ç¨³å®šâ æ€§ï¼Œæˆ‘ä»¬éœ€è¦è®©å¤§æ¨¡å‹è°ƒç”¨å¤±è´¥æ—¶èƒ½å¤Ÿè‡ªåŠ¨é‡è¯•ï¼Œå¹¶ä¸”è¿˜å¯ä»¥å®ç°è‡ªå®šä¹‰çš„é‡è¯•ç­–ç•¥ï¼Œåœ¨ AI å“åº”å†…å®¹ä¸ç¬¦åˆè¦æ±‚æ—¶ä¹Ÿè‡ªåŠ¨é‡è¯•ã€‚

#### LangChain4j é‡è¯•æœºåˆ¶

å…¶å® LangChain4j çš„ ChatModel å¯¹è±¡æœ¬èº«å°±æ”¯æŒé‡è¯•ï¼Œå¯ä»¥é€šè¿‡é…ç½® `max-retries` å‚æ•°ä¿®æ”¹é‡è¯•æ¬¡æ•°ï¼ˆé»˜è®¤å€¼æ˜¯ 2ï¼‰ï¼š

```yaml
langchain4j:
  open-ai:
    chat-model:
      max-retries: 3
```

æ„é€  ChatModel æ—¶ä¹Ÿå¯ä»¥è®¾ç½®é‡è¯•æ¬¡æ•°ï¼š

```java
OpenAiChatModel.builder()
    .maxRetries(3)
    .build();
```

å¦‚æœæƒ³è‡ªå·±å†³å®šé‡è¯•æ—¶æœºå’Œç­–ç•¥ï¼Œå¯ä»¥åˆ©ç”¨ [LangChain4j çš„è¾“å‡ºæŠ¤è½¨](https://docs.langchain4j.dev/tutorials/guardrails#output-guardrail-outcomes)ï¼Œå¯ä»¥å¯¹ AI çš„å“åº”ç»“æœè¿›è¡Œæ£€æµ‹å’Œå¤„ç†ï¼Œå¹¶ä¸”æä¾›äº†å¤šç§ç»“æœç±»å‹ã€‚

å…¶ä¸­æœ€æœ‰ç”¨çš„å‡ ç§æ˜¯ï¼š

-   `success()`ï¼šå…è®¸å“åº”é€šè¿‡
-   `retry()`ï¼šä½¿ç”¨ç›¸åŒçš„è¾“å…¥é‡æ–°è°ƒç”¨ AI
-   `reprompt()`ï¼šæ·»åŠ é¢å¤–çš„æç¤ºä¿¡æ¯åé‡æ–°è°ƒç”¨ AI
-   `fatal()`ï¼šä¸­æ–­ AI å“åº”ï¼ŒæŠ›å‡ºå¼‚å¸¸

#### å¼€å‘å®ç°

1ï¼‰åœ¨ `ai.guardrail` åŒ…ä¸‹åˆ›å»º `RetryOutputGuardrail` ç±»æ¥æ£€æŸ¥ AI å“åº”çš„è´¨é‡ï¼Œå½“å“åº”ä¸ç¬¦åˆè¦æ±‚æ—¶ï¼Œè¿”å› reprompt ä½¿ç”¨æ–°çš„æç¤ºè¯é‡æ–°ç”Ÿæˆï¼š

```java
public class RetryOutputGuardrail implements OutputGuardrail {

    @Override
    public OutputGuardrailResult validate(AiMessage responseFromLLM) {
        String response = responseFromLLM.text();
        // æ£€æŸ¥å“åº”æ˜¯å¦ä¸ºç©ºæˆ–è¿‡çŸ­
        if (response == null || response.trim().isEmpty()) {
            return reprompt("å“åº”å†…å®¹ä¸ºç©º", "è¯·é‡æ–°ç”Ÿæˆå®Œæ•´çš„å†…å®¹");
        }
        if (response.trim().length() < 10) {
            return reprompt("å“åº”å†…å®¹è¿‡çŸ­", "è¯·æä¾›æ›´è¯¦ç»†çš„å†…å®¹");
        }
        // æ£€æŸ¥æ˜¯å¦åŒ…å«æ•æ„Ÿä¿¡æ¯æˆ–ä¸å½“å†…å®¹
        if (containsSensitiveContent(response)) {
            return reprompt("åŒ…å«æ•æ„Ÿä¿¡æ¯", "è¯·é‡æ–°ç”Ÿæˆå†…å®¹ï¼Œé¿å…åŒ…å«æ•æ„Ÿä¿¡æ¯");
        }
        return success();
    }
    
    /**
     * æ£€æŸ¥æ˜¯å¦åŒ…å«æ•æ„Ÿå†…å®¹
     */
    private boolean containsSensitiveContent(String response) {
        String lowerResponse = response.toLowerCase();
        String[] sensitiveWords = {
            "å¯†ç ", "password", "secret", "token", 
            "api key", "ç§é’¥", "è¯ä¹¦", "credential"
        };
        for (String word : sensitiveWords) {
            if (lowerResponse.contains(word)) {
                return true;
            }
        }
        return false;
    }
}
```

å®é™…ç”Ÿäº§ç¯å¢ƒï¼Œå¯¹ AI çš„å“åº”æ£€æµ‹å¯ä»¥æ›´ä¸¥æ ¼äº›ã€‚

2ï¼‰é›†æˆåˆ° AI æœåŠ¡

åœ¨ AI æœåŠ¡å·¥å‚ `AiCodeGeneratorServiceFactory` ä¸­é›†æˆè¾“å‡ºæŠ¤è½¨ï¼š

```java
yield AiServices.builder(AiCodeGeneratorService.class)
        .chatModel(chatModel)
        .streamingChatModel(openAiStreamingChatModel)
        .chatMemory(chatMemory)
        .inputGuardrails(new PromptSafetyInputGuardrail())
        .outputGuardrails(new RetryOutputGuardrail())
        .build();
```

ğŸ’¡ è¿˜å¯ä»¥é€šè¿‡æŠ¤è½¨é…ç½®ç±»æ¥è®¾ç½®æœ€å¤§é‡è¯•æ¬¡æ•°ï¼š

```java
OutputGuardrailsConfig outputGuardrailsConfig = OutputGuardrailsConfig.builder()
        .maxRetries(3)
        .build();
```

åœ¨æ„é€  AI Service æ—¶ä½¿ç”¨ï¼š

```java
return AiServices.builder(Assistant.class)
            .streamingChatModel(streamingChatModel)
            .outputGuardrails(new RetryOutputGuardrail())
            .outputGuardrailsConfig(outputGuardrailsConfig)
            .chatMemory(chatMemory)
            .build();
```

#### æµ‹è¯•éªŒè¯

æˆ‘ä»¬å¯ä»¥æ•…æ„è®© AI è¿”å›å¾ˆçŸ­çš„å†…å®¹æ¥æµ‹è¯•è¾“å‡ºæŠ¤è½¨ï¼š

```markdown
ä½ åº”è¯¥åªå›å¤ "ä½ å¥½" è¿™ 2 ä¸ªå­—
```

å¯ä»¥çœ‹åˆ°æŠ¤è½¨æ‹¦æˆªåˆ°äº† AI çš„å“åº”ï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/9oEpc8hjbqwxbafO.webp)

ä»æ—¥å¿—ä¸­å¯ä»¥çœ‹åˆ°ï¼Œè¾“å‡ºæŠ¤è½¨æ£€â æµ‹åˆ°å“åº”è¿‡çŸ­ï¼Œè‡ªåŠ¨â æ·»åŠ äº†é‡è¯•æç¤ºå¹¶é‡æ–°å‘é€äº†è¯·æ±‚ï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/vnTLMZI29R5Q20Tu.webp)

#### æ³¨æ„äº‹é¡¹

ç»è¿‡æµ‹è¯•ï¼Œå¦‚æœç”¨äº†è¾“å‡ºæŠ¤è½¨ï¼Œå¯èƒ½ä¼šå¯¼è‡´æµå¼â è¾“å‡ºçš„å“åº”ä¸åŠæ—¶ï¼Œç­‰åˆ° AIâ  è¾“å‡ºç»“æŸæ‰ä¸€èµ·è¿”å›ï¼Œæ‰€ä»¥å¦‚æœä¸ºäº†è¿½æ±‚æµå¼è¾“å‡ºæ•ˆæœï¼Œå»ºè®®ä¸è¦é€šè¿‡æŠ¤è½¨çš„æ–¹å¼è¿›è¡Œé‡è¯•ã€‚

å‚è€ƒ [å®˜æ–¹æ–‡æ¡£](https://docs.langchain4j.dev/tutorials/guardrails#output-guardrails-on-streaming-responses)ï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/vn7YElJgTeZzxorF.webp)

#### æ‰©å±•æ€è·¯

å¦‚æœæƒ³æ·±å…¥åˆ°æŸéƒ¨åˆ†ä¸šåŠ¡ç»†èŠ‚çš„é‡è¯•ï¼Œå¯ä»¥ä½¿ç”¨ [Guava Retrying åº“](https://github.com/rholder/guava-retrying)ï¼Œå‚è€ƒé±¼çš®çš„ [æ•™ç¨‹æ–‡ç« ](https://cloud.tencent.com/developer/article/1752086) å¾ˆå¿«å°±èƒ½ä¸Šæ‰‹ã€‚

### å·¥å…·è°ƒç”¨ä¼˜åŒ–

åœ¨å¤æ‚çš„ AI åº”ç”¨ä¸­ï¼ŒAIâ  å¯èƒ½ä¼šé™·å…¥å·¥å…·è°ƒâ ç”¨çš„æ— é™å¾ªç¯ã€‚ä¸ºäº†é˜²æ­¢è¿™ç§æƒ…å†µï¼Œå¯ä»¥é‡‡ç”¨ 2 ç§è§£å†³æ–¹æ¡ˆã€‚

#### æ–¹æ¡ˆ 1 - è®¾ç½®è°ƒç”¨å·¥å…·æ¬¡æ•°ä¸Šé™

æœ€ç®€å•çš„æ–¹æ³•æ˜¯é™åˆ¶ AI åœ¨â å•æ¬¡å¯¹è¯ä¸­è¿ç»­è°ƒç”¨â å·¥å…·çš„æœ€å¤§æ¬¡æ•°ã€‚åªéœ€è¦è¡¥å…… 1 è¡Œä»£ç ï¼š

```java
AiServices.builder(AiCodeGeneratorService.class)
    .maxSequentialToolsInvocations(20)  // æœ€å¤šè¿ç»­è°ƒç”¨ 20 æ¬¡å·¥å…·
    .build();
```

å½“è¾¾åˆ°è¿™ä¸ªé™åˆ¶æ—¶ï¼ŒLangCâ hain4j æ¡†æ¶â ä¼šå¼ºåˆ¶åœæ­¢å·¥å…·è°ƒç”¨å¾ªç¯ï¼Œé˜²æ­¢ AI é™·å…¥æ— é™å¾ªç¯çŠ¶æ€ã€‚

#### æ–¹æ¡ˆ 2 - æä¾›é€€å‡ºå·¥å…·

è¿˜å¯ä»¥ä¸º AI æä¾›ä¸€ä¸ªä¸“é—¨çš„é€€å‡ºå·¥å…·ï¼Œè®©å®ƒèƒ½å¤Ÿä¸»åŠ¨ç»“æŸå·¥å…·è°ƒç”¨å¾ªç¯ã€‚åœ¨ `ai.tools` åŒ…ä¸‹æ–°å»ºä¸€ä¸ªç»§æ‰¿äº† BaseTool çš„å·¥å…·ç±»ï¼Œè¿™æ ·å¯ä»¥è¢« ToolManager è‡ªåŠ¨æ³¨å†Œï¼š

```java
@Slf4j
@Component
public class ExitTool extends BaseTool {

    @Override
    public String getToolName() {
        return "exit";
    }

    @Override
    public String getDisplayName() {
        return "é€€å‡ºå·¥å…·è°ƒç”¨";
    }

    /**
     * é€€å‡ºå·¥å…·è°ƒç”¨
     * å½“ä»»åŠ¡å®Œæˆæˆ–æ— éœ€ç»§ç»­ä½¿ç”¨å·¥å…·æ—¶è°ƒç”¨æ­¤æ–¹æ³•
     *
     * @return é€€å‡ºç¡®è®¤ä¿¡æ¯
     */
    @Tool("å½“ä»»åŠ¡å·²å®Œæˆæˆ–æ— éœ€ç»§ç»­è°ƒç”¨å·¥å…·æ—¶ï¼Œä½¿ç”¨æ­¤å·¥å…·é€€å‡ºæ“ä½œï¼Œé˜²æ­¢å¾ªç¯")
    public String exit() {
        log.info("AI è¯·æ±‚é€€å‡ºå·¥å…·è°ƒç”¨");
        return "ä¸è¦ç»§ç»­è°ƒç”¨å·¥å…·ï¼Œå¯ä»¥è¾“å‡ºæœ€ç»ˆç»“æœäº†";
    }

    @Override
    public String generateToolExecutedResult(JSONObject arguments) {
        return "\n\n[æ‰§è¡Œç»“æŸ]\n\n";
    }
}
```

è¿™ç§æ–¹æ¡ˆçš„ä¼˜åŠ¿åœ¨äºç»™äº† AI æ›´å¤šçš„ä¸»åŠ¨â æƒã€‚AI å¯ä»¥æ ¹æ®ä»»â åŠ¡å®Œæˆæƒ…å†µä¸»åŠ¨åˆ¤æ–­æ˜¯å¦éœ€è¦ç»§ç»­è°ƒç”¨å·¥å…·ï¼Œè€Œä¸æ˜¯è¢«åŠ¨åœ°ç­‰å¾…è¾¾åˆ°è°ƒç”¨æ¬¡æ•°ä¸Šé™ã€‚

ğŸ’¡ é€€å‡ºå·¥å…·çš„æ•ˆæœå…¶å®åœ¨è‡ªä¸»å®ç°çš„å¤šæ­¥éª¤æ™ºèƒ½ä½“ä¸­æ•ˆæœæ›´â å¥½ã€‚æ‰€ä»¥æˆ‘å»ºè®®å¦‚æœä½ çš„åº”ç”¨ä¸­å¾ˆâ å°‘å‡ºç°å·¥å…·è°ƒç”¨å¾ªç¯çš„é—®é¢˜ï¼Œå¯ä»¥åªä½¿ç”¨æ–¹æ¡ˆ 1ã€‚å› ä¸ºæ¯å¤šä¸€ä¸ªå·¥å…·éƒ½ä¼šå¢åŠ ç³»ç»Ÿçš„å¤æ‚æ€§å’Œä¸ç¨³å®šæ€§ã€‚

æ­¤å¤–ï¼Œè¿˜å¯ä»¥å°è¯•ä¸‹é¢çš„æ–¹æ³•ï¼š

1.  è°ƒå¤§å¯¹è¯è®°å¿†çš„å®¹é‡ï¼Œå¦åˆ™ AI ä¼šä¸­é€”æ–­ç‰‡å„¿ï¼Œå¿˜è®°å·²ç»ç”Ÿæˆäº†å“ªäº›æ–‡ä»¶
2.  å°è¯•æ¢å…¶ä»–çš„ AI å¤§æ¨¡å‹
3.  ä¼˜åŒ–æç¤ºè¯

## äº”ã€æˆæœ¬ä¼˜åŒ–

### AI å¤§æ¨¡å‹æˆæœ¬æ§åˆ¶

åœ¨å®é™…è¿è¥ä¸­ï¼ŒAI å¤§æ¨¡å‹çš„è°ƒç”¨æˆâ æœ¬æ˜¯ä¸€ä¸ªä¸å¯å¿½è§†çš„â å› ç´ ã€‚ä¸åŒæ¨¡å‹çš„å®šä»·å·®å¼‚å¾ˆå¤§ï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®ä¸åŒçš„ä½¿ç”¨åœºæ™¯é€‰æ‹©åˆé€‚çš„æ¨¡å‹ã€‚

#### æˆæœ¬åˆ†æ

ä»¥é˜¿é‡Œäº‘ç™¾ç‚¼çš„å®šä»·ä¸ºä¾‹ï¼Œä¸åŒæ¨¡å‹ä¹‹é—´çš„æˆæœ¬å·®å¼‚éå¸¸æ˜¾è‘—ï¼š

![](https://pic.code-nav.cn/course_picture/1608440217629360130/LotAIkFuKsSC6css.webp)

![](https://pic.code-nav.cn/course_picture/1608440217629360130/eBHDfcR7AlFMaNo0.webp)

å¯¹äºæ™ºèƒ½è·¯ç”±è¿™ç§ç›¸å¯¹ç®€å•çš„åˆ†ç±»ä»»åŠ¡ï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥ä½¿ç”¨æˆæœ¬æ›´ä½çš„æ¨¡å‹ã€‚æ¯”å¦‚ç”¨é˜¿é‡Œäº‘ç™¾ç‚¼çš„ `qwen-turbo` æ¨¡å‹æ¥åˆ¤æ–­åº”è¯¥ä½¿ç”¨å“ªç§ä»£ç ç”Ÿæˆæ–¹æ¡ˆï¼Œå…¶ç™¾ä¸‡ tokens çš„è¾“å‡ºæˆæœ¬æ¯” deepseek-chat æ¨¡å‹ä¾¿å®œ 10 å€ä»¥ä¸Šï¼

#### æ™ºèƒ½è·¯ç”±æ¨¡å‹é…ç½®

é˜¿é‡Œäº‘ç™¾ç‚¼æ¨¡å‹ä¹Ÿå…¼å®¹ Open AIï¼Œå‚è€ƒ [å®˜æ–¹æ–‡æ¡£é…ç½®](https://help.aliyun.com/zh/model-studio/use-qwen-by-calling-api)ã€‚æˆ‘ä»¬å¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­ä¸ºæ™ºèƒ½è·¯ç”±æŒ‡å®šé˜¿é‡Œäº‘æ¨¡å‹çš„ base-urlã€api-key å’Œä½æˆæœ¬æ¨¡å‹ï¼Œå¹¶ä¸”é™åˆ¶ä¸€ä¸‹ max-tokens é˜²æ­¢æ„å¤–è¾“å‡ºï¼Œè¿›ä¸€æ­¥æ§åˆ¶æˆæœ¬ã€‚

```yaml
langchain4j:
  open-ai:
    routing-chat-model:
      base-url: https://dashscope.aliyuncs.com/compatible-mode/v1
      api-key: <Your API Key>
      model-name: qwen-turbo
      max-tokens: 100
      log-requests: true
      log-responses: true
```

è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨ä¸å½±å“ä»£ç ç”Ÿâ æˆè´¨é‡çš„å‰æä¸‹ï¼Œæ˜¾â è‘—é™ä½æ™ºèƒ½è·¯ç”±çš„æˆæœ¬ï¼Œè€Œä¸”å®æµ‹ä¸‹æ¥åˆ†ç±»é€Ÿåº¦ä¹Ÿå¿«äº†å¾ˆå¤š~

### æ‰©å±•æ€è·¯

1ï¼‰AI å“åº”ç¼“å­˜ï¼šå¯¹ä¸»é¡µç¤ºä¾‹ Prompt çš„è¾“å‡ºâ ã€æ™ºèƒ½è·¯ç”±ç»“æœç­‰è¿›è¡Œç¼“å­˜ã€‚å¯ä»¥ç›´æ¥â ç”¨å­—ç¬¦ä¸²åŒ¹é…ï¼Œè¿˜å¯ä»¥é€šè¿‡ç›¸ä¼¼åº¦ç®—æ³•åŒ¹é…ç”¨æˆ·è¾“å…¥ï¼Œå¤ç”¨å·²æœ‰ç»“æœï¼Œå¤§å¹…å‡å°‘ AI è°ƒç”¨æ¬¡æ•°å’Œæˆæœ¬ã€‚

2ï¼‰ç”¨æˆ·ç”¨é‡ç»Ÿè®¡ä¸åˆ†æï¼šå®ç°è¯¦ç»†çš„ç”¨é‡ç»Ÿè®¡ç³»ç»Ÿâ ï¼Œè®°å½•æ¯ä¸ªç”¨æˆ·çš„ AI è°ƒç”¨æ¬¡â æ•°ã€Token æ¶ˆè€—é‡ã€ç”Ÿæˆåº”ç”¨æ•°é‡ç­‰æŒ‡æ ‡ï¼Œå®ç°ç²¾ç»†åŒ–æˆæœ¬æ§åˆ¶ã€‚ï¼ˆæœ¬é¡¹ç›®åç»­ä¼šå¸¦å¤§å®¶å®ç°ï¼‰

3ï¼‰å­˜å‚¨æˆæœ¬ä¼˜åŒ–ï¼šå®šæœŸæ¸…ç† COS â å¯¹è±¡å­˜å‚¨ä¸­é•¿æœŸæœªè®¿é—®çš„åº”â ç”¨æ–‡ä»¶å’Œä¸´æ—¶æ„å»ºäº§ç‰©ï¼Œæˆ–è€…æ ¹æ®è®¿é—®é¢‘ç‡å’Œæ—¶é—´è‡ªåŠ¨è¿ç§»æ–‡ä»¶ï¼Œé™ä½å­˜å‚¨æˆæœ¬ã€‚

[ç¼–ç¨‹å¯¼èˆªçš„æ™ºèƒ½ååŒäº‘å›¾åº“é¡¹ç›®](https://www.codefather.cn/course/1864210260732116994) ç¬¬ 6 æœŸè®²è§£è¿‡æ•°æ®æ²‰é™ç­–ç•¥ï¼Œå»ºè®®å­¦ä¹ ã€‚

4ï¼‰æµé‡æˆæœ¬æ§åˆ¶ï¼šä¼˜åŒ– APâ I å’Œ SSE å“â åº”æ•°æ®ç»“æ„ï¼Œå‡å°‘ä¸å¿…è¦çš„å­—æ®µè¿”å›ï¼Œå‹ç¼©å“åº”ä½“ç§¯ï¼Œä»è€Œå‡å°‘æµé‡ã€‚

## æœ€å

é€šè¿‡æœ¬èŠ‚çš„ç³»ç»Ÿæ€§ä¼˜åŒ–ï¼Œæˆ‘ä»¬çš„ AI é›¶ä»£ç åº”ç”¨ç”Ÿâ æˆå¹³å°åœ¨å„ä¸ªæ–¹é¢éƒ½æœ‰äº†æå‡ï¼Œå¤§å®¶â è¦é‡ç‚¹å­¦ä¹ åˆ†æé—®é¢˜å’Œè§£å†³é—®é¢˜çš„æ€è·¯ï¼Œä¹‹åå¼€å‘ä»»ä½•é¡¹ç›®æ—¶ï¼Œæœ¬èƒ½åœ°æƒ³åˆ°å¯ä»¥ä»è¿™äº›è§’åº¦å»ä¼˜åŒ–ç³»ç»Ÿã€‚

è¿™äº›æŠ€æœ¯å’Œæ€è·¯ä¸ä»…é€‚ç”¨äº Aâ I åº”ç”¨ï¼Œä¹Ÿå¯ä»¥åº”â ç”¨åˆ°å…¶ä»–ç±»å‹çš„ç³»ç»Ÿä¸­ï¼Œä¸¾äº›ä¾‹å­ï¼š

1.  é™æµæœºåˆ¶ï¼šå¯ä»¥ç”¨äºä»»ä½•éœ€è¦ä¿æŠ¤çš„æ¥å£ï¼Œæ¯”å¦‚æ”¯ä»˜æ¥å£ã€çŸ­ä¿¡æ¥å£ç­‰
2.  ç¼“å­˜ç­–ç•¥ï¼šå¯ä»¥ç”¨äºä»»ä½•éœ€è¦æå‡æ€§èƒ½çš„åœºæ™¯ï¼Œæ¯”å¦‚å•†å“åˆ—è¡¨ã€ç”¨æˆ·ä¿¡æ¯ç­‰
3.  å¤šä¾‹æ¨¡å¼ï¼šå¯ä»¥ç”¨äºä»»ä½•éœ€è¦é¿å…èµ„æºç«äº‰çš„ç»„ä»¶ï¼Œæ¯”å¦‚æ–‡ä»¶å¤„ç†å™¨ã€ç½‘ç»œè¿æ¥æ± ç­‰
4.  æŠ¤è½¨æœºåˆ¶ï¼šå¯ä»¥æ‰©å±•åˆ°å…¶ä»–éœ€è¦å†…å®¹å®¡æ ¸çš„åœºæ™¯ï¼Œæ¯”å¦‚ç”¨æˆ·è¯„è®ºã€æ–‡ç« å‘å¸ƒç­‰

[ç¼–ç¨‹å¯¼èˆªçš„æ™ºèƒ½ååŒäº‘å›¾åº“é¡¹ç›®](https://www.codefather.cn/course/1864210260732116994) ç¬¬ 6 æœŸä¹Ÿç»™å¤§å®¶è®²äº†å¾ˆå¤šé’ˆå¯¹å›¾ç‰‡åœºæ™¯çš„ä¼˜åŒ–æŠ€å·§ï¼Œ[é±¼çš®çš„ä¿å§†çº§å†™ç®€å†æŒ‡å—](https://www.codefather.cn/course/1802644557818343425/section/1802644741965066241) ä¸­ä¹Ÿç»™å¤§å®¶åˆ†äº«äº† 14 ç§ä¼˜åŒ–é¡¹ç›®çš„è§’åº¦ï¼Œå¼ºçƒˆå»ºè®®å¤§å®¶å­¦ä¹ ã€‚

ä¸€å®šè¦è®°ä½ï¼Œç³»ç»Ÿä¼˜åŒ–æ˜¯ä¸€ä¸ªæŒç»­çš„è¿‡ç¨‹ï¼Œå»ºè®®å¤§å®¶â åœ¨å®é™…é¡¹ç›®ä¸­å¤šå®è·µã€å¤šæ€è€ƒï¼Œé€â æ­¥ç§¯ç´¯è‡ªå·±çš„ä¼˜åŒ–ç»éªŒå’Œæ–¹æ³•è®ºã€‚è®°ä½ï¼Œä¼˜åŒ–æ˜¯æ²¡æœ‰å°½å¤´çš„ï¼Œæ²¡æœ‰æœ€å¥½çš„ä¼˜åŒ–ï¼Œåªæœ‰æœ€åˆé€‚çš„ä¼˜åŒ–ï¼


